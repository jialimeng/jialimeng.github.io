<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="[TOC] 本文转自：博客园–Leo.cheng【https:&#x2F;&#x2F;www.cnblogs.com&#x2F;lcw&#x2F;p&#x2F;3297889.html】 【驱动】linux下I2C驱动架构全面分析I2C 概述　　I2C是philips提出的外设总线. 　　I2C只有两条线,一条串行数据线:SDA,一条是时钟线SCL ，使用SCL，SDA这两根信号线就实现了设备之间的数据交互，它方便了工程师的布线。 　　因此，I2">
<meta property="og:type" content="article">
<meta property="og:title" content="【转载】linux下I2C驱动架构全面分析">
<meta property="og:url" content="http://yoursite.com/2021/01/15/Linux/Driver/i2c/%E8%BD%AC%E8%BD%BD/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91linux%E4%B8%8BI2C%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84%E5%85%A8%E9%9D%A2%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Tech Blog">
<meta property="og:description" content="[TOC] 本文转自：博客园–Leo.cheng【https:&#x2F;&#x2F;www.cnblogs.com&#x2F;lcw&#x2F;p&#x2F;3297889.html】 【驱动】linux下I2C驱动架构全面分析I2C 概述　　I2C是philips提出的外设总线. 　　I2C只有两条线,一条串行数据线:SDA,一条是时钟线SCL ，使用SCL，SDA这两根信号线就实现了设备之间的数据交互，它方便了工程师的布线。 　　因此，I2">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://images0.cnblogs.com/blog/536940/201309/02225054-2c2abb8ed8da431390a03bcbfd6563df.png">
<meta property="og:image" content="https://images0.cnblogs.com/blog/536940/201309/02230534-eb154ee59ea04c8ca73efd7248b366ac.jpg">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://images0.cnblogs.com/blog/536940/201309/02234128-18be3750dd3a4494bd9d173d40284179.png">
<meta property="article:published_time" content="2021-01-15T08:41:02.000Z">
<meta property="article:modified_time" content="2021-01-15T08:49:39.478Z">
<meta property="article:author" content="David Meng">
<meta property="article:tag" content="i2c">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images0.cnblogs.com/blog/536940/201309/02225054-2c2abb8ed8da431390a03bcbfd6563df.png">

<link rel="canonical" href="http://yoursite.com/2021/01/15/Linux/Driver/i2c/%E8%BD%AC%E8%BD%BD/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91linux%E4%B8%8BI2C%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84%E5%85%A8%E9%9D%A2%E5%88%86%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>【转载】linux下I2C驱动架构全面分析 | Tech Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
    <a href="https://github.com/jialimeng" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Tech Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/15/Linux/Driver/i2c/%E8%BD%AC%E8%BD%BD/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91linux%E4%B8%8BI2C%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84%E5%85%A8%E9%9D%A2%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【转载】linux下I2C驱动架构全面分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-01-15 16:41:02 / Modified: 16:49:39" itemprop="dateCreated datePublished" datetime="2021-01-15T16:41:02+08:00">2021-01-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/" itemprop="url" rel="index"><span itemprop="name">Driver</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/i2c%E6%80%BB%E7%BA%BF%E9%A9%B1%E5%8A%A8/" itemprop="url" rel="index"><span itemprop="name">i2c总线驱动</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>[TOC]</p>
<p>本文转自：博客园–<a href="https://www.cnblogs.com/lcw/" target="_blank" rel="noopener">Leo.cheng</a>【<a href="https://www.cnblogs.com/lcw/p/3297889.html】" target="_blank" rel="noopener">https://www.cnblogs.com/lcw/p/3297889.html】</a></p>
<h1 id="【驱动】linux下I2C驱动架构全面分析"><a href="#【驱动】linux下I2C驱动架构全面分析" class="headerlink" title="【驱动】linux下I2C驱动架构全面分析"></a><a href="https://www.cnblogs.com/lcw/p/3297889.html" target="_blank" rel="noopener">【驱动】linux下I2C驱动架构全面分析</a></h1><h2 id="I2C-概述"><a href="#I2C-概述" class="headerlink" title="I2C 概述"></a>I2C 概述</h2><p>　　I2C是philips提出的外设总线.</p>
<p>　　I2C只有两条线,一条串行数据线:SDA,一条是时钟线SCL ，使用SCL，SDA这两根信号线就实现了设备之间的数据交互，它方便了工程师的布线。</p>
<p>　　因此，I2C总线被非常广泛地应用在EEPROM，实时钟，小型LCD等设备与CPU的接口中。</p>
<hr>
<h2 id="linux下的驱动思路"><a href="#linux下的驱动思路" class="headerlink" title="linux下的驱动思路"></a>linux下的驱动思路</h2><p>　　在linux系统下编写I2C驱动，目前主要有两种方法，一种是把I2C设备当作一个普通的字符设备来处理，另一种是利用linux下I2C驱动体系结构来完成。下面比较下这两种方法：<br>　　第一种方法：<br>　　　　优点：思路比较直接，不需要花很多时间去了解linux中复杂的I2C子系统的操作方法。<br>　　　　<strong>缺点</strong>：<br>  　　  要求工程师不仅要对I2C设备的操作熟悉，而且要熟悉I2C的适配器(I2C控制器)操作。<br>  　　  要求工程师对I2C的设备器及I2C的设备操作方法都比较熟悉，最重要的是写出的程序可以移植性差。<br>  　　  对内核的资源无法直接使用，因为内核提供的所有I2C设备器以及设备驱动都是基于I2C子系统的格式。</p>
<p>　　第一种方法的优点就是第二种方法的缺点，<br>　　第一种方法的缺点就是第二种方法的优点。</p>
<h2 id="I2C架构概述"><a href="#I2C架构概述" class="headerlink" title="I2C架构概述"></a>I2C架构概述</h2><p>　　Linux的I2C体系结构分为3个组成部分：</p>
<p>　　<strong>I2C核心</strong>：I2C核心提供了I2C总线驱动和设备驱动的注册，注销方法，I2C通信方法(”algorithm”)上层的，与具体适配器无关的代码以及探测设备，检测设备地址的上层代码等。</p>
<p>　　<strong>I2C总线驱动</strong>：I2C总线驱动是对I2C硬件体系结构中适配器端的实现，适配器可由CPU控制，甚至可以直接集成在CPU内部。</p>
<p>　　<strong>I2C设备驱动</strong>：I2C设备驱动(也称为客户驱动)是对I2C硬件体系结构中设备端的实现，设备一般挂接在受CPU控制的I2C适配器上，通过I2C适配器与CPU交换数据。</p>
<h2 id="linux驱动中i2c驱动架构"><a href="#linux驱动中i2c驱动架构" class="headerlink" title="linux驱动中i2c驱动架构"></a><strong>linux驱动中i2c驱动架构</strong></h2><p>　　<strong><img src="https://images0.cnblogs.com/blog/536940/201309/02225054-2c2abb8ed8da431390a03bcbfd6563df.png" alt="img"></strong></p>
<p>　　上图完整的描述了linux i2c驱动架构，虽然I2C硬件体系结构比较简单，但是i2c体系结构在linux中的实现却相当复杂。</p>
<p>　　那么我们<strong>如何编写特定i2c接口器件的驱动程序？就是说上述架构中的那些部分需要我们完成，而哪些是linux内核已经完善的或者是芯片提供商已经提供的？</strong></p>
<hr>
<h2 id="架构层次分类"><a href="#架构层次分类" class="headerlink" title="架构层次分类"></a>架构层次分类</h2><p>　　<strong>第一层</strong>：提供i2c adapter的硬件驱动，探测、初始化i2c adapter（如申请i2c的io地址和中断号），驱动soc控制的i2c adapter在硬件上产生信号（start、stop、ack）以及处理i2c中断。<strong>覆盖图中的硬件实现层</strong></p>
<p>　　<strong>第二层</strong>：提供i2c adapter的algorithm，用具体适配器的xxx_xferf()函数来填充i2c_algorithm的master_xfer函数指针，并把赋值后的i2c_algorithm再赋值给i2c_adapter的algo指针。<strong>覆盖图中的访问抽象层、i2c核心层</strong></p>
<p>　　<strong>第三层</strong>：实现i2c设备驱动中的i2c_driver接口，用具体的i2c device设备的attach_adapter()、detach_adapter()方法赋值给i2c_driver的成员函数指针。实现设备device与总线（或者叫adapter）的挂接。<strong>覆盖图中的driver驱动层</strong></p>
<p>　　<strong>第四层</strong>：实现i2c设备所对应的具体device的驱动，i2c_driver只是实现设备与总线的挂接，而挂接在总线上的设备则是千差万别的，所以要实现具体设备device的write()、read()、ioctl()等方法，赋值给file_operations，然后注册字符设备（多数是字符设备）。<strong>覆盖图中的driver驱动层</strong></p>
<p>　　第一层和第二层又叫i2c总线驱动(bus)，第三第四属于i2c设备驱动(device driver)。</p>
<p>　　在linux驱动架构中，几乎不需要驱动开发人员再添加bus，因为linux内核几乎集成所有总线bus，如usb、pci、i2c等等。并且总线bus中的(与特定硬件相关的代码)已由芯片提供商编写完成，例如三星的s3c-2440平台i2c总线bus为/drivers/i2c/buses/i2c-s3c2410.c</p>
<p>　　第三第四层与特定device相干的就需要驱动工程师来实现了。</p>
<hr>
<h2 id="Linux下I2C体系文件构架"><a href="#Linux下I2C体系文件构架" class="headerlink" title="Linux下I2C体系文件构架"></a>Linux下I2C体系文件构架</h2><p>　　在Linux内核源代码中的driver目录下包含一个i2c目录</p>
<p>　　<img src="https://images0.cnblogs.com/blog/536940/201309/02230534-eb154ee59ea04c8ca73efd7248b366ac.jpg" alt="img"></p>
<p>　　<strong>i2c-core.c</strong>这个文件实现了I2C核心的功能以及/proc/bus/i2c<em>接口。<br>　  *</em>i2c-dev.c<strong>实现了I2C适配器设备文件的功能，每一个I2C适配器都被分配一个设备。通过适配器访设备时的主设备号都为89，次设备号为0-255。I2c-dev.c并没有针对特定的设备而设计，只是提供了通用的read(),write(),和ioctl()等接口，应用层可以借用这些接口访问挂接在适配器上的I2C设备的存储空间或寄存器，并控制I2C设备的工作方式。<br>　　**busses</strong>文件夹这个文件中包含了一些I2C总线的驱动，如针对S3C2410，S3C2440，S3C6410等处理器的I2C控制器驱动为i2c-s3c2410.c.<br>　　<strong>algos</strong>文件夹实现了一些I2C总线适配器的algorithm.</p>
<hr>
<h2 id="重要的结构体"><a href="#重要的结构体" class="headerlink" title="重要的结构体"></a><strong>重要的结构体</strong></h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="i2c-driver"><a href="#i2c-driver" class="headerlink" title="i2c_driver"></a><strong>i2c_driver</strong></h3><p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> 1 struct i2c_driver &#123;</span><br><span class="line"> 2 unsigned int class;</span><br><span class="line"> 3 int (*attach_adapter)(struct i2c_adapter *);&#x2F;&#x2F;依附i2c_adapter函数指针</span><br><span class="line"> 4 int (*detach_adapter)(struct i2c_adapter *);&#x2F;&#x2F;脱离i2c_adapter函数指针</span><br><span class="line"> 5 int (*probe)(struct i2c_client *, const struct i2c_device_id *);</span><br><span class="line"> 6 int (*remove)(struct i2c_client *);</span><br><span class="line"> 7 void (*shutdown)(struct i2c_client *);</span><br><span class="line"> 8 int (*suspend)(struct i2c_client *, pm_message_t mesg);</span><br><span class="line"> 9 int (*resume)(struct i2c_client *);</span><br><span class="line">10 void (*alert)(struct i2c_client *, unsigned int data);</span><br><span class="line">11 int (*command)(struct i2c_client *client, unsigned int cmd, void*arg);&#x2F;&#x2F;命令列表</span><br><span class="line">12 struct device_driver driver;</span><br><span class="line">13 const struct i2c_device_id *id_table;&#x2F;&#x2F;该驱动所支持的设备ID表</span><br><span class="line">14 int (*detect)(struct i2c_client *, struct i2c_board_info *);</span><br><span class="line">15 const unsigned short *address_list;</span><br><span class="line">16 struct list_head clients;</span><br><span class="line">17 &#125;;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<h3 id="i2c-client"><a href="#i2c-client" class="headerlink" title="i2c_client"></a><strong>i2c_client</strong></h3><p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> 1 struct i2c_client &#123;</span><br><span class="line"> 2  unsigned short flags；&#x2F;&#x2F;标志  </span><br><span class="line"> 3  unsigned short addr; &#x2F;&#x2F;低7位为芯片地址  </span><br><span class="line"> 4  char name[I2C_NAME_SIZE];&#x2F;&#x2F;设备名称</span><br><span class="line"> 5  struct i2c_adapter *adapter;&#x2F;&#x2F;依附的i2c_adapter</span><br><span class="line"> 6  struct i2c_driver *driver;&#x2F;&#x2F;依附的i2c_driver </span><br><span class="line"> 7  struct device dev;&#x2F;&#x2F;设备结构体  </span><br><span class="line"> 8  int irq;&#x2F;&#x2F;设备所使用的结构体  </span><br><span class="line"> 9  struct list_head detected;&#x2F;&#x2F;链表头</span><br><span class="line">10  &#125;;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<h3 id="i2c-adapter"><a href="#i2c-adapter" class="headerlink" title="i2c_adapter"></a><strong>i2c_adapter</strong></h3><p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> 1 struct i2c_adapter &#123;</span><br><span class="line"> 2  struct module *owner;&#x2F;&#x2F;所属模块</span><br><span class="line"> 3  unsigned int id;&#x2F;&#x2F;algorithm的类型，定义于i2c-id.h,</span><br><span class="line"> 4  unsigned int class;    </span><br><span class="line"> 5  const struct i2c_algorithm *algo; &#x2F;&#x2F;总线通信方法结构体指针</span><br><span class="line"> 6  void *algo_data;&#x2F;&#x2F;algorithm数据</span><br><span class="line"> 7  struct rt_mutex bus_lock;&#x2F;&#x2F;控制并发访问的自旋锁</span><br><span class="line"> 8  int timeout;   </span><br><span class="line"> 9  int retries;&#x2F;&#x2F;重试次数</span><br><span class="line">10  struct device dev; &#x2F;&#x2F;适配器设备 </span><br><span class="line">11  int nr;</span><br><span class="line">12  char name[48];&#x2F;&#x2F;适配器名称</span><br><span class="line">13  struct completion dev_released;&#x2F;&#x2F;用于同步</span><br><span class="line">14  struct list_head userspace_clients;&#x2F;&#x2F;client链表头</span><br><span class="line">15 &#125;;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<h3 id="i2c-algorithm"><a href="#i2c-algorithm" class="headerlink" title="i2c_algorithm"></a><strong>i2c_algorithm</strong></h3><p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1 struct i2c_algorithm &#123;</span><br><span class="line">2 int (*master_xfer)(struct i2c_adapter *adap, struct i2c_msg *msgs, int num);&#x2F;&#x2F;I2C传输函数指针</span><br><span class="line">3 int (*smbus_xfer) (struct i2c_adapter *adap, u16 addr,unsigned short flags, char read_write,u8 command, int size, union </span><br><span class="line">4 i2c_smbus_data *data);&#x2F;&#x2F;smbus传输函数指针</span><br><span class="line">5 u32 (*functionality) (struct i2c_adapter *);&#x2F;&#x2F;返回适配器支持的功能</span><br><span class="line">6 &#125;;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<hr>
<h2 id="各结构体的作用与它们之间的关系"><a href="#各结构体的作用与它们之间的关系" class="headerlink" title="各结构体的作用与它们之间的关系"></a>各结构体的作用与它们之间的关系</h2><h3 id="i2c-adapter与i2c-algorithm"><a href="#i2c-adapter与i2c-algorithm" class="headerlink" title="i2c_adapter与i2c_algorithm"></a><strong>i2c_adapter与i2c_algorithm</strong></h3><p>　　i2c_adapter对应与物理上的一个适配器，而i2c_algorithm对应一套通信方法，一个i2c适配器需要i2c_algorithm中提供的（i2c_algorithm中的又是更下层与硬件相关的代码提供）通信函数来控制适配器上产生特定的访问周期。缺少i2c_algorithm的i2c_adapter什么也做不了，因此i2c_adapter中包含其使用i2c_algorithm的指针。</p>
<p>　　i2c_algorithm中的关键函数<strong>master_xfer()</strong>用于产生i2c访问周期需要的start stop ack信号，以i2c_msg（即i2c消息）为单位发送和接收通信数据。</p>
<p>　　i2c_msg也非常关键，调用驱动中的发送接收函数需要填充该结构体</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1 struct i2c_msg &#123;  </span><br><span class="line">2     __u16 addr; &#x2F;* slave address            *&#x2F;  </span><br><span class="line">3     __u16 flags;          </span><br><span class="line">4     __u16 len;      &#x2F;* msg length               *&#x2F;  </span><br><span class="line">5     __u8 *buf;      &#x2F;* pointer to msg data          *&#x2F;  </span><br><span class="line">6 &#125;;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<h3 id="i2c-driver和i2c-client"><a href="#i2c-driver和i2c-client" class="headerlink" title="i2c_driver和i2c_client"></a><strong>i2c_driver和i2c_client</strong></h3><p>　　i2c_driver对应一套驱动方法，其主要函数是attach_adapter()和detach_client()</p>
<p>　　i2c_client对应真实的i2c物理设备device，每个i2c设备都需要一个i2c_client来描述</p>
<p>　　i2c_driver与i2c_client的关系是一对多。一个i2c_driver上可以支持多个同等类型的i2c_client.</p>
<h3 id="i2c-adapter和i2c-client"><a href="#i2c-adapter和i2c-client" class="headerlink" title="i2c_adapter和i2c_client"></a><strong>i2c_adapter和i2c_client</strong></h3><p>　　i2c_adapter和i2c_client的关系与i2c硬件体系中适配器和设备的关系一致，即i2c_client依附于i2c_adapter,由于一个适配器上可以连接多个i2c设备，所以i2c_adapter中包含依附于它的i2c_client的链表。</p>
<p>　　</p>
<p>　　从i2c驱动架构图中可以看出，linux内核对i2c架构抽象了一个叫<strong>核心层core</strong>的中间件，它分离了设备驱动device driver和硬件控制的实现细节（如操作i2c的寄存器），core层不但为上面的设备驱动提供封装后的内核注册函数，而且还为小面的硬件事件提供注册接口（也就是i2c总线注册接口），可以说core层起到了承上启下的作用。</p>
<hr>
<h2 id="具体分析"><a href="#具体分析" class="headerlink" title="具体分析"></a>具体分析</h2><p>　　先看一下i2c-core为外部提供的核心函数（选取部分），i2c-core对应的源文件为<strong>i2c-core.c</strong>，位于内核目录/driver/i2c/i2c-core.c</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1 EXPORT_SYMBOL(i2c_add_adapter);  </span><br><span class="line">2 EXPORT_SYMBOL(i2c_del_adapter);  </span><br><span class="line">3 EXPORT_SYMBOL(i2c_del_driver);  </span><br><span class="line">4 EXPORT_SYMBOL(i2c_attach_client);  </span><br><span class="line">5 EXPORT_SYMBOL(i2c_detach_client);  </span><br><span class="line">6   </span><br><span class="line">7 EXPORT_SYMBOL(i2c_transfer);</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　<strong>i2c_transfer()</strong>函数：i2c_transfer()函数本身并不具备驱动适配器物理硬件完成消息交互的能力，它只是寻找到i2c_adapter对应的i2c_algorithm，并使用i2c_algorithm的master_xfer()函数真正的驱动硬件流程，代码清单如下，不重要的已删除。</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> 1 int i2c_transfer(struct i2c_adapter * adap, struct i2c_msg *msgs, int num)  </span><br><span class="line"> 2 &#123;  </span><br><span class="line"> 3     int ret;  </span><br><span class="line"> 4     if (adap-&gt;algo-&gt;master_xfer) &#123;&#x2F;&#x2F;如果master_xfer函数存在，则调用，否则返回错误  </span><br><span class="line"> 5         ret &#x3D; adap-&gt;algo-&gt;master_xfer(adap,msgs,num);&#x2F;&#x2F;这个函数在硬件相关的代码中给algorithm赋值  </span><br><span class="line"> 6         return ret;  </span><br><span class="line"> 7     &#125; else &#123;  </span><br><span class="line"> 8         return -ENOSYS;  </span><br><span class="line"> 9     &#125;  </span><br><span class="line">10 &#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　当一个具体的client被侦测到并被关联的时候，设备和sysfs文件将被注册。</p>
<p>　　相反的，在client被取消关联的时候，sysfs文件和设备也被注销，驱动开发人员在开发i2c设备驱动时，需要调用下列函数。程序清单如下</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> 1 int i2c_attach_client(struct i2c_client *client)  </span><br><span class="line"> 2 &#123;  </span><br><span class="line"> 3     ...  </span><br><span class="line"> 4     device_register(&amp;client-&gt;dev);  </span><br><span class="line"> 5     device_create_file(&amp;client-&gt;dev, &amp;dev_attr_client_name);  </span><br><span class="line"> 6     ...  </span><br><span class="line"> 7     return 0;  </span><br><span class="line"> 8 &#125;  </span><br><span class="line"> 9 </span><br><span class="line">10 </span><br><span class="line">11 [cpp] view plaincopy</span><br><span class="line">12 int i2c_detach_client(struct i2c_client *client)  </span><br><span class="line">13 &#123;  </span><br><span class="line">14     ...  </span><br><span class="line">15     device_remove_file(&amp;client-&gt;dev, &amp;dev_attr_client_name);  </span><br><span class="line">16     device_unregister(&amp;client-&gt;dev);  </span><br><span class="line">17     ...  </span><br><span class="line">18     return res;  </span><br><span class="line">19 &#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　<strong>i2c_add_adapter</strong>()函数和i2c_del_adapter()在i2c-davinci.c中有调用，稍后分析</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> 1 int i2c_add_adapter(struct i2c_adapter *adap)  </span><br><span class="line"> 2 &#123;  </span><br><span class="line"> 3     ...  </span><br><span class="line"> 4     device_register(&amp;adap-&gt;dev);  </span><br><span class="line"> 5     device_create_file(&amp;adap-&gt;dev, &amp;dev_attr_name);  </span><br><span class="line"> 6     ...  </span><br><span class="line"> 7     &#x2F;* inform drivers of new adapters *&#x2F;  </span><br><span class="line"> 8     list_for_each(item,&amp;drivers) &#123;  </span><br><span class="line"> 9         driver &#x3D; list_entry(item, struct i2c_driver, list);  </span><br><span class="line">10         if (driver-&gt;attach_adapter)  </span><br><span class="line">11             &#x2F;* We ignore the return code; if it fails, too bad *&#x2F;  </span><br><span class="line">12             driver-&gt;attach_adapter(adap);  </span><br><span class="line">13     &#125;  </span><br><span class="line">14     ...  </span><br><span class="line">15 &#125;  </span><br><span class="line">16 </span><br><span class="line">17 </span><br><span class="line">18 </span><br><span class="line">19 int i2c_del_adapter(struct i2c_adapter *adap)  </span><br><span class="line">20 &#123;  </span><br><span class="line">21     ...  </span><br><span class="line">22     list_for_each(item,&amp;drivers) &#123;  </span><br><span class="line">23         driver &#x3D; list_entry(item, struct i2c_driver, list);  </span><br><span class="line">24         if (driver-&gt;detach_adapter)  </span><br><span class="line">25             if ((res &#x3D; driver-&gt;detach_adapter(adap))) &#123;  </span><br><span class="line">26             &#125;  </span><br><span class="line">27     &#125;  </span><br><span class="line">28     ...  </span><br><span class="line">29     list_for_each_safe(item, _n, &amp;adap-&gt;clients) &#123;  </span><br><span class="line">30         client &#x3D; list_entry(item, struct i2c_client, list);  </span><br><span class="line">31   </span><br><span class="line">32         if ((res&#x3D;client-&gt;driver-&gt;detach_client(client))) &#123;  </span><br><span class="line">33   </span><br><span class="line">34         &#125;  </span><br><span class="line">35     &#125;  </span><br><span class="line">36     ...  </span><br><span class="line">37     device_remove_file(&amp;adap-&gt;dev, &amp;dev_attr_name);  </span><br><span class="line">38     device_unregister(&amp;adap-&gt;dev);  </span><br><span class="line">39   </span><br><span class="line">40 &#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　i2c-davinci.c是实现与硬件相关功能的代码集合，这部分是与平台相关的，也叫做i2c总线驱动，这部分代码是这样添加到系统中的</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> 1 static struct platform_driver davinci_i2c_driver &#x3D; &#123;  </span><br><span class="line"> 2     .probe      &#x3D; davinci_i2c_probe,  </span><br><span class="line"> 3     .remove     &#x3D; davinci_i2c_remove,  </span><br><span class="line"> 4     .driver     &#x3D; &#123;  </span><br><span class="line"> 5         .name   &#x3D; &quot;i2c_davinci&quot;,  </span><br><span class="line"> 6         .owner  &#x3D; THIS_MODULE,  </span><br><span class="line"> 7     &#125;,  </span><br><span class="line"> 8 &#125;;  </span><br><span class="line"> 9   </span><br><span class="line">10 &#x2F;* I2C may be needed to bring up other drivers *&#x2F;  </span><br><span class="line">11 static int __init davinci_i2c_init_driver(void)  </span><br><span class="line">12 &#123;  </span><br><span class="line">13     return platform_driver_register(&amp;davinci_i2c_driver);  </span><br><span class="line">14 &#125;  </span><br><span class="line">15 subsys_initcall(davinci_i2c_init_driver);  </span><br><span class="line">16   </span><br><span class="line">17 static void __exit davinci_i2c_exit_driver(void)  </span><br><span class="line">18 &#123;  </span><br><span class="line">19     platform_driver_unregister(&amp;davinci_i2c_driver);  </span><br><span class="line">20 &#125;  </span><br><span class="line">21 module_exit(davinci_i2c_exit_driver);</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　并且，i2c适配器控制硬件发送接收数据的函数在这里赋值给i2c-algorithm，i2c_davinci_xfer稍加修改就可以在裸机中控制i2c适配器</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1 static struct i2c_algorithm i2c_davinci_algo &#x3D; &#123;  </span><br><span class="line">2     .master_xfer    &#x3D; i2c_davinci_xfer,  </span><br><span class="line">3     .functionality  &#x3D; i2c_davinci_func,  </span><br><span class="line">4 &#125;;</span><br></pre></td></tr></table></figure>

<p>　　然后在davinci_i2c_probe函数中，将i2c_davinci_algo添加到添加到algorithm系统中</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 adap-&gt;algo &#x3D; &amp;i2c_davinci_algo;</span><br></pre></td></tr></table></figure>





<hr>
<h2 id="适配器驱动程序分析"><a href="#适配器驱动程序分析" class="headerlink" title="适配器驱动程序分析"></a>适配器驱动程序分析</h2><p>　　在linux系统中，适配器驱动位于linux目录下的\drivers\i2c\busses下，不同的处理器的适配器驱动程序设计有差异，但是总体思路不变。</p>
<p>　　在适配器的驱动中，实现两个结构体非常关键，也是整个适配器驱动的灵魂。</p>
<p>　　下面以某个适配器的驱动程序为例进行说明：</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> 1 static struct platform_driver tcc_i2c_driver &#x3D; &#123;</span><br><span class="line"> 2  .probe   &#x3D; tcc_i2c_probe,</span><br><span class="line"> 3  .remove   &#x3D; tcc_i2c_remove,</span><br><span class="line"> 4  .suspend  &#x3D; tcc_i2c_suspend_late,</span><br><span class="line"> 5  .resume   &#x3D; tcc_i2c_resume_early,</span><br><span class="line"> 6  .driver   &#x3D; &#123;</span><br><span class="line"> 7   .owner  &#x3D; THIS_MODULE,</span><br><span class="line"> 8   .name  &#x3D; &quot;tcc-i2c&quot;,</span><br><span class="line"> 9  &#125;,</span><br><span class="line">10 &#125;;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p> 　以上说明这个驱动是基于平台总线的，这样实现的目的是与CPU紧紧联系起来。</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1 static const struct i2c_algorithm tcc_i2c_algorithm &#x3D; &#123;</span><br><span class="line">2  .master_xfer &#x3D; tcc_i2c_xfer,</span><br><span class="line">3  .functionality &#x3D; tcc_i2c_func,</span><br><span class="line">4 &#125;;</span><br></pre></td></tr></table></figure>

<p>　　这个结构体也是非常的关键，这个结构体里面的函数<strong>tcc_i2c_xfer</strong>是适配器算法的实现，这个函数实现了适配器与I2C CORE的连接。</p>
<p>　　<strong>tcc_i2c_func</strong>是指该适配器所支持的功能。</p>
<p>　　tcc_i2c_xfer这个函数实质是实现I2C数据的发送与接收的处理过程。不同的处理器实现的方法不同，主要表现在寄存器的设置与中断的处理方法上。</p>
<p>　　把握上面的两点去分析适配器程序就简单多了。</p>
<hr>
<h2 id="I2C-core驱动程序分析"><a href="#I2C-core驱动程序分析" class="headerlink" title="I2C-core驱动程序分析"></a>I2C-core驱动程序分析</h2><p>　　在I2C-core.c这个函数中，把握下面的几个关键函数就可以了。</p>
<p><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="img"></p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> 1 &#x2F;&#x2F;增加&#x2F;删除i2c_adapter</span><br><span class="line"> 2 int i2c_add_adapter(struct i2c_adapter *adapter)</span><br><span class="line"> 3 int i2c_del_adapter(struct i2c_adapter *adap)</span><br><span class="line"> 4 </span><br><span class="line"> 5 &#x2F;&#x2F;增加&#x2F;删除i2c_driver</span><br><span class="line"> 6 int i2c_register_driver(struct module *owner, struct i2c_driver *driver)</span><br><span class="line"> 7 void i2c_del_driver(struct i2c_driver *driver)</span><br><span class="line"> 8 </span><br><span class="line"> 9 &#x2F;&#x2F;i2c_client依附&#x2F;脱离</span><br><span class="line">10 int i2c_attach_client(struct i2c_client *client)</span><br><span class="line">11 </span><br><span class="line">12 &#x2F;&#x2F;增加&#x2F;删除i2c_driver</span><br><span class="line">13 int i2c_register_driver(struct module *owner, struct i2c_driver *driver)</span><br><span class="line">14 void i2c_del_driver(struct i2c_driver *driver)</span><br><span class="line">15 </span><br><span class="line">16 &#x2F;&#x2F;i2c_client依附&#x2F;脱离</span><br><span class="line">17 int i2c_attach_client(struct i2c_client *client)</span><br><span class="line">18 int i2c_detach_client(struct i2c_client *client)</span><br><span class="line">19 </span><br><span class="line">20 &#x2F;&#x2F;I2C传输,发送和接收</span><br><span class="line">21 int i2c_master_send(struct i2c_client *client,const char *buf ,int count)</span><br><span class="line">22 int i2c_master_recv(struct i2c_client *client, char *buf ,int count)</span><br><span class="line">23 int i2c_transfer(struct i2c_adapter *adap, struct i2c_msg *msgs, int num)</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>　　I2c_transfer这个函数实现了core与adapter的联系。</p>
<hr>
<h2 id="代码调用层次图"><a href="#代码调用层次图" class="headerlink" title="代码调用层次图"></a>代码调用层次图</h2><p>　　有时候代码比任何文字描述都来得直接，但是过多的代码展示反而让人觉得枯燥。这个时候，需要一幅图来梳理一下上面的内容</p>
<p>　　<img src="https://images0.cnblogs.com/blog/536940/201309/02234128-18be3750dd3a4494bd9d173d40284179.png" alt="img"></p>
<p>　　上面这些代码的展示是告诉我们：linux内核和芯片提供商为我们的的驱动程序提供了 i2c驱动的框架，以及框架底层与硬件相关的代码的实现。</p>
<p>　　剩下的就是针对挂载在i2c两线上的i2c设备了device，而编写的即具体设备驱动了，这里的设备就是硬件接口外挂载的设备，而非硬件接口本身（soc硬件接口本身的驱动可以理解为总线驱动）</p>
<hr>
<h2 id="编写驱动需要完成的工作"><a href="#编写驱动需要完成的工作" class="headerlink" title="编写驱动需要完成的工作"></a>编写驱动需要完成的工作</h2><p>　　编写具体的I2C驱动时，工程师需要处理的主要工作如下：</p>
<p>　　1).提供I2C适配器的硬件驱动，探测，初始化I2C适配器(如申请I2C的I/O地址和中断号)，驱动CPU控制的I2C适配器从硬件上产生。</p>
<p>　　2).提供I2C控制的algorithm, 用具体适配器的xxx_xfer()函数填充i2c_algorithm的master_xfer指针，并把i2c_algorithm指针赋给i2c_adapter的algo指针。</p>
<p>　　3).实现I2C设备驱动中的i2c_driver接口，用具体yyy的yyy_probe()，yyy_remove()，yyy_suspend(),yyy_resume()函数指针和i2c_device_id设备ID表赋给i2c_driver的probe,remove,suspend,resume和id_table指针。</p>
<p>　　4).实现I2C设备所对应类型的具体驱动，i2c_driver只是实现设备与总线的挂接。</p>
<p>　　</p>
<p>　　上面的工作中前两个属于I2C总线驱动，后面两个属于I2C设备驱动。</p>
<hr>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p> <a href="http://blog.csdn.net/ghostyu" target="_blank" rel="noopener">http://blog.csdn.net/ghostyu</a></p>
<p><a href="http://blog.chinaunix.net/uid-25906157-id-3376728.html" target="_blank" rel="noopener">http://blog.chinaunix.net/uid-25906157-id-3376728.html</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/i2c/" rel="tag"># i2c</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/01/15/Linux/Driver/i2c/%E8%BD%AC%E8%BD%BD/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91Linux%20I2C%E5%AD%90%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%EF%BC%9A0-%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6%E4%BB%8B%E7%BB%8D/" rel="prev" title="【转载】Linux I2C子系统分析：0-整体框架介绍">
      <i class="fa fa-chevron-left"></i> 【转载】Linux I2C子系统分析：0-整体框架介绍
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/01/15/Linux/Driver/i2c/%E8%BD%AC%E8%BD%BD/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91I2C%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/" rel="next" title="【转载】I2C驱动框架分析">
      【转载】I2C驱动框架分析 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#【驱动】linux下I2C驱动架构全面分析"><span class="nav-number">1.</span> <span class="nav-text">【驱动】linux下I2C驱动架构全面分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#I2C-概述"><span class="nav-number">1.1.</span> <span class="nav-text">I2C 概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#linux下的驱动思路"><span class="nav-number">1.2.</span> <span class="nav-text">linux下的驱动思路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#I2C架构概述"><span class="nav-number">1.3.</span> <span class="nav-text">I2C架构概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#linux驱动中i2c驱动架构"><span class="nav-number">1.4.</span> <span class="nav-text">linux驱动中i2c驱动架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#架构层次分类"><span class="nav-number">1.5.</span> <span class="nav-text">架构层次分类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux下I2C体系文件构架"><span class="nav-number">1.6.</span> <span class="nav-text">Linux下I2C体系文件构架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重要的结构体"><span class="nav-number">1.7.</span> <span class="nav-text">重要的结构体</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#"><span class="nav-number">1.7.1.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#i2c-driver"><span class="nav-number">1.7.2.</span> <span class="nav-text">i2c_driver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#i2c-client"><span class="nav-number">1.7.3.</span> <span class="nav-text">i2c_client</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#i2c-adapter"><span class="nav-number">1.7.4.</span> <span class="nav-text">i2c_adapter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#i2c-algorithm"><span class="nav-number">1.7.5.</span> <span class="nav-text">i2c_algorithm</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#各结构体的作用与它们之间的关系"><span class="nav-number">1.8.</span> <span class="nav-text">各结构体的作用与它们之间的关系</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#i2c-adapter与i2c-algorithm"><span class="nav-number">1.8.1.</span> <span class="nav-text">i2c_adapter与i2c_algorithm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#i2c-driver和i2c-client"><span class="nav-number">1.8.2.</span> <span class="nav-text">i2c_driver和i2c_client</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#i2c-adapter和i2c-client"><span class="nav-number">1.8.3.</span> <span class="nav-text">i2c_adapter和i2c_client</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#具体分析"><span class="nav-number">1.9.</span> <span class="nav-text">具体分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#适配器驱动程序分析"><span class="nav-number">1.10.</span> <span class="nav-text">适配器驱动程序分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#I2C-core驱动程序分析"><span class="nav-number">1.11.</span> <span class="nav-text">I2C-core驱动程序分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码调用层次图"><span class="nav-number">1.12.</span> <span class="nav-text">代码调用层次图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编写驱动需要完成的工作"><span class="nav-number">1.13.</span> <span class="nav-text">编写驱动需要完成的工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文章"><span class="nav-number">1.14.</span> <span class="nav-text">参考文章</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="David Meng"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">David Meng</p>
  <div class="site-description" itemprop="description">冒险，创新，永不放弃</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">70</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/jialimeng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jialimeng" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jiali201209@163.com" title="E-Mail → mailto:jiali201209@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://ilinuxkernel.com/" title="http:&#x2F;&#x2F;ilinuxkernel.com" rel="noopener" target="_blank">Linux Kernel Exploration</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.wowotech.net/" title="http:&#x2F;&#x2F;www.wowotech.net" rel="noopener" target="_blank">蜗窝科技</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tinylab.org/" title="http:&#x2F;&#x2F;tinylab.org" rel="noopener" target="_blank">泰晓科技</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Meng</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
