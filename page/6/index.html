<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="冒险，创新，永不放弃">
<meta property="og:type" content="website">
<meta property="og:title" content="Tech Blog">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="Tech Blog">
<meta property="og:description" content="冒险，创新，永不放弃">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="David Meng">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Tech Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
    <a href="https://github.com/jialimeng" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Tech Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/30/IoT/%E8%93%9D%E7%89%99/nordic%20Soc%E5%BC%80%E5%8F%91/application%20timer%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/30/IoT/%E8%93%9D%E7%89%99/nordic%20Soc%E5%BC%80%E5%8F%91/application%20timer%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">application timer深入分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-30 13:33:59" itemprop="dateCreated datePublished" datetime="2020-09-30T13:33:59+08:00">2020-09-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-12 17:23:51" itemprop="dateModified" datetime="2020-10-12T17:23:51+08:00">2020-10-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/" itemprop="url" rel="index"><span itemprop="name">IoT</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/%E8%93%9D%E7%89%99/" itemprop="url" rel="index"><span itemprop="name">蓝牙</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/%E8%93%9D%E7%89%99/Nordic-Soc%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Nordic Soc开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>nRF52382,有两个外部晶振，一个为32.768kHz,另一个为32MHz。程序是在高频时钟32MHz下运行，而低频时钟32.768kHz提供时基供调度使用。之所以提供两个外部时钟，是为了芯片进入休眠后，减少功耗。芯片进入休眠，关闭32Mhz时钟，使用低频时钟来保持程序调度，达到了减少功耗目的。nRF52 SDK,使用了RTC0、RTC1和timer0定时器，其中，RTC1提供软件定时，暴露给用户使用,RTC0和timer0是蓝牙协议栈内部使用，用户看不到。下面分析基于RTC1的app_timer软件定时器的实现过程。</p>
<h2 id="app-timer-原理"><a href="#app-timer-原理" class="headerlink" title="app_timer 原理"></a>app_timer 原理</h2><p><strong>定时原理</strong></p>
<p>app_timer软件定时器是根据实时计数器RTC1比较事件来实现定时。nRF52382 实时计数器RTC拥有一个24位的计数器。RTC启动后，app_timer,通过不断调整比较寄存器CC0的值，计数器的值与比较的值匹配后，产生中断，处理app_timer设置的回调函数。</p>
<p>计数器的值与比较的值匹配，产生匹配事件，如下图所示：</p>
<p><img src="http://jiali.clouddn.com/20200930_001.png" alt=""></p>
<p>​                                                                                                                    COMPARE事件时序图</p>
<p><strong>app_timer软件设计</strong></p>
<p>软件定时器处理流程如下</p>
<p><img src="http://jiali.clouddn.com/20200930_002.png" alt="20200930_002"></p>
<h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p>初始化过程分析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">main</span><br><span class="line">|---&gt;timers_init()</span><br><span class="line">|   初始化app定时器</span><br><span class="line">	|---&gt;app_timer_init()</span><br><span class="line">	|   初始化RTC1，建立RTC1中断回调函数rtc_irq()</span><br><span class="line">	|---&gt;app_timer_create()</span><br><span class="line">	|   创建app超时事件处理回调函数,处理用户业务</span><br><span class="line">|---&gt;application_timers_start()</span><br><span class="line">|   启动创建的定时器</span><br><span class="line">    |---&gt;app_timer_start()</span><br><span class="line">    |    1、timer比较值</span><br><span class="line">    |    2、软件触发产生中断，提交timer请求</span><br><span class="line">        |---&gt;timer_req_schedule()</span><br><span class="line">        |    1、申请请求对象，然后放入FIFO</span><br><span class="line">        |    2、提交请求</span><br><span class="line">            |---&gt;timer_request_proc_trigger()</span><br><span class="line">            |   |---&gt; drv_rtc_irq_trigger()</span><br><span class="line">            |       |---&gt;NVIC_SetPendingIRQ(p_instance-&gt;irq)</span><br><span class="line">                    |   软件触发产生中断</span><br></pre></td></tr></table></figure>

<p>RTC1 中断处理过程分析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">drv_rtc_rtc_1_irq_handler</span><br><span class="line">|RTC1中断函数入口，在中断里面执行回调函数</span><br><span class="line">|---&gt;rtc_irq()</span><br><span class="line">    |---&gt;on_overflow_evt()</span><br><span class="line">    |    执行计数溢出事件</span><br><span class="line">    |---&gt;on_compare_evt()</span><br><span class="line">    |    执行CC0寄存器比较事件</span><br><span class="line">    |---&gt;on_compare1_evt()</span><br><span class="line">    |    执行CC1寄存器比较事件</span><br><span class="line">    |---&gt;timer_req_process()</span><br><span class="line">    |    处理app timer请求，并加入链表，标记为活动timer</span><br><span class="line">    |---&gt;rtc_update()</span><br><span class="line">    |    调度timer,并更新rtc1 CC0值</span><br><span class="line">        |---&gt;rtc_schedule()</span><br><span class="line">        |    比较值设置</span><br></pre></td></tr></table></figure>

<h2 id="关键代码注释"><a href="#关键代码注释" class="headerlink" title="关键代码注释"></a>关键代码注释</h2><p><strong>app_timer_init()函数</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ret_code_t app_timer_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    ret_code_t err_code;</span><br><span class="line">    drv_rtc_config_t config &#x3D; &#123;</span><br><span class="line">        .prescaler          &#x3D; APP_TIMER_CONFIG_RTC_FREQUENCY,&#x2F;&#x2F;分频系数</span><br><span class="line">        .interrupt_priority &#x3D; APP_TIMER_CONFIG_IRQ_PRIORITY&#x2F;&#x2F;优先级</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    err_code &#x3D; NRF_ATFIFO_INIT(m_req_fifo);</span><br><span class="line">    if (err_code !&#x3D; NRFX_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        return err_code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err_code &#x3D; drv_rtc_init(&amp;m_rtc_inst, &amp;config, rtc_irq); &#x2F;&#x2F;设置回调函数rtc_irq,在中断入口函数会执行回调函数</span><br><span class="line">    if (err_code !&#x3D; NRFX_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        return err_code;</span><br><span class="line">    &#125;</span><br><span class="line">    drv_rtc_overflow_enable(&amp;m_rtc_inst, true);</span><br><span class="line">	drv_rtc_compare_set(&amp;m_rtc_inst, 1, DRV_RTC_MAX_CNT &gt;&gt; 1, true);</span><br><span class="line">    if (APP_TIMER_KEEPS_RTC_ACTIVE)&#x2F;&#x2F;是否把RTC1设置为一直运行的状态</span><br><span class="line">    &#123;</span><br><span class="line">        drv_rtc_start(&amp;m_rtc_inst);&#x2F;&#x2F;启动RTC1计数器</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_global_active &#x3D; true;</span><br><span class="line">    return err_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ret_code_t drv_rtc_init(drv_rtc_t const * const  p_instance,</span><br><span class="line">                        drv_rtc_config_t const * p_config,</span><br><span class="line">                        drv_rtc_handler_t        handler)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(p_instance);</span><br><span class="line">    ASSERT(p_config);</span><br><span class="line">    ASSERT(handler);</span><br><span class="line"></span><br><span class="line">    ret_code_t err_code;</span><br><span class="line"></span><br><span class="line">    m_handlers[p_instance-&gt;instance_id] &#x3D; handler; &#x2F;&#x2F;存储回调函数</span><br><span class="line"></span><br><span class="line">    if (m_cb[p_instance-&gt;instance_id].state !&#x3D; NRFX_DRV_STATE_UNINITIALIZED)</span><br><span class="line">    &#123;</span><br><span class="line">        err_code &#x3D; NRF_ERROR_INVALID_STATE;</span><br><span class="line">        NRF_LOG_WARNING(&quot;RTC instance already initialized.&quot;);</span><br><span class="line">        return err_code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nrf_rtc_prescaler_set(p_instance-&gt;p_reg, p_config-&gt;prescaler);</span><br><span class="line">    NRFX_IRQ_PRIORITY_SET(p_instance-&gt;irq, p_config-&gt;interrupt_priority);</span><br><span class="line">    NRFX_IRQ_ENABLE(p_instance-&gt;irq);</span><br><span class="line"></span><br><span class="line">    m_cb[p_instance-&gt;instance_id].state &#x3D; NRFX_DRV_STATE_INITIALIZED;</span><br><span class="line">    m_cb[p_instance-&gt;instance_id].p_instance &#x3D; p_instance;</span><br><span class="line"></span><br><span class="line">    err_code &#x3D; NRF_SUCCESS;</span><br><span class="line">    NRF_LOG_INFO(&quot;RTC: initialized.&quot;);</span><br><span class="line">    return err_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;RTC回调函数，RTC1中断入口调用该函数</span><br><span class="line">static void rtc_irq(drv_rtc_t const * const  p_instance)</span><br><span class="line">&#123;</span><br><span class="line">    if (drv_rtc_overflow_pending(p_instance))&#x2F;&#x2F;发生溢出事件</span><br><span class="line">    &#123;</span><br><span class="line">        on_overflow_evt();</span><br><span class="line">    &#125;</span><br><span class="line">    if (drv_rtc_compare_pending(p_instance, 0))&#x2F;&#x2F;发生CC0比较事件</span><br><span class="line">    &#123;</span><br><span class="line">        on_compare_evt(p_instance);</span><br><span class="line">    &#125;</span><br><span class="line">    if (drv_rtc_compare_pending(p_instance, 1))&#x2F;&#x2F;发生CC1比较事件</span><br><span class="line">    &#123;</span><br><span class="line">        on_compare1_evt(p_instance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    timer_req_process(p_instance);  &#x2F;&#x2F;处理请求</span><br><span class="line">    rtc_update(p_instance);  &#x2F;&#x2F;调度app timer，更新比较值</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>app_timer_start()函数</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ret_code_t app_timer_start(app_timer_t * p_timer, uint32_t timeout_ticks, void * p_context)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(p_timer);</span><br><span class="line">    app_timer_t * p_t &#x3D; (app_timer_t *) p_timer;</span><br><span class="line"></span><br><span class="line">    if (p_t-&gt;active)</span><br><span class="line">    &#123;</span><br><span class="line">        return NRF_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p_t-&gt;p_context &#x3D; p_context;</span><br><span class="line">    p_t-&gt;end_val &#x3D; get_now() + timeout_ticks;&#x2F;&#x2F;设置app timer 时间戳</span><br><span class="line"></span><br><span class="line">    if (p_t-&gt;repeat_period)</span><br><span class="line">    &#123;</span><br><span class="line">        p_t-&gt;repeat_period &#x3D; timeout_ticks; &#x2F;&#x2F;设置循环运行的周期</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return timer_req_schedule(TIMER_REQ_START, p_t);&#x2F;&#x2F;软件触发RTC1中断,发起timer请求</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @brief Function for putting user request into the request queue</span><br><span class="line"> *&#x2F;</span><br><span class="line">static ret_code_t timer_req_schedule(app_timer_req_type_t type, app_timer_t * p_timer)</span><br><span class="line">&#123;</span><br><span class="line">    nrf_atfifo_item_put_t fifo_ctx;</span><br><span class="line">    timer_req_t * p_req;</span><br><span class="line">#if APP_TIMER_WITH_PROFILER</span><br><span class="line">    CRITICAL_REGION_ENTER();</span><br><span class="line">#endif</span><br><span class="line">    p_req &#x3D; nrf_atfifo_item_alloc(m_req_fifo, &amp;fifo_ctx);  &#x2F;&#x2F;申请请求对象资源</span><br><span class="line">#if APP_TIMER_WITH_PROFILER</span><br><span class="line">    if (p_req)</span><br><span class="line">    &#123;</span><br><span class="line">        ++m_current_user_op_queue_utilization;</span><br><span class="line">    &#125;</span><br><span class="line">    CRITICAL_REGION_EXIT();</span><br><span class="line">#endif &#x2F;* APP_TIMER_WITH_PROFILER *&#x2F;</span><br><span class="line">    if (p_req)</span><br><span class="line">    &#123;</span><br><span class="line">        p_req-&gt;type    &#x3D; type;</span><br><span class="line">        p_req-&gt;p_timer &#x3D; p_timer;</span><br><span class="line">        if (nrf_atfifo_item_put(m_req_fifo, &amp;fifo_ctx))&#x2F;&#x2F;加入FIFO</span><br><span class="line">        &#123;</span><br><span class="line">            timer_request_proc_trigger();&#x2F;&#x2F;软件触发RTC1中断</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            NRF_LOG_WARNING(&quot;Scheduling interrupted another scheduling.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return NRF_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        return NRF_ERROR_NO_MEM;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static inline void timer_request_proc_trigger(void)</span><br><span class="line">&#123;</span><br><span class="line">    drv_rtc_irq_trigger(&amp;m_rtc_inst);</span><br><span class="line">&#125;</span><br><span class="line">void drv_rtc_irq_trigger(drv_rtc_t const * const p_instance)</span><br><span class="line">&#123;</span><br><span class="line">    NVIC_SetPendingIRQ(p_instance-&gt;irq);  &#x2F;&#x2F;这是stm32，中断操作接口，作用是软件设置Irq，产生中断</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>处理请求timer_req_process()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @brief Function for processing user requests.</span><br><span class="line"> *</span><br><span class="line"> * Function is called only in the context of RTC interrupt.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void timer_req_process(drv_rtc_t const * const  p_instance)</span><br><span class="line">&#123;</span><br><span class="line">    nrf_atfifo_item_get_t fifo_ctx;</span><br><span class="line">    timer_req_t *         p_req &#x3D; nrf_atfifo_item_get(m_req_fifo, &amp;fifo_ctx);&#x2F;&#x2F;获取请求对象</span><br><span class="line"></span><br><span class="line">    while (p_req)</span><br><span class="line">    &#123;</span><br><span class="line">        switch (p_req-&gt;type)</span><br><span class="line">        &#123;</span><br><span class="line">            case TIMER_REQ_START:</span><br><span class="line">                if (!p_req-&gt;p_timer-&gt;active)</span><br><span class="line">                &#123;</span><br><span class="line">                    p_req-&gt;p_timer-&gt;active &#x3D; true;&#x2F;&#x2F;设置为活动状态</span><br><span class="line">                    nrf_sortlist_add(&amp;m_app_timer_sortlist, &amp;(p_req-&gt;p_timer-&gt;list_item));&#x2F;&#x2F;把请求timer加入链表</span><br><span class="line">                    NRF_LOG_INST_DEBUG(p_req-&gt;p_timer-&gt;p_log,&quot;Start request (expiring at %d&#x2F;0x%08x).&quot;,</span><br><span class="line">                                                  p_req-&gt;p_timer-&gt;end_val, p_req-&gt;p_timer-&gt;end_val);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            case TIMER_REQ_STOP:</span><br><span class="line">                if (p_req-&gt;p_timer &#x3D;&#x3D; mp_active_timer)</span><br><span class="line">                &#123;</span><br><span class="line">                    mp_active_timer &#x3D; NULL;</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    bool found &#x3D; nrf_sortlist_remove(&amp;m_app_timer_sortlist, &amp;(p_req-&gt;p_timer-&gt;list_item));</span><br><span class="line">                    if (!found)</span><br><span class="line">                    &#123;</span><br><span class="line">                         NRF_LOG_INFO(&quot;Timer not found on sortlist (stopping expired timer).&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                NRF_LOG_INST_DEBUG(p_req-&gt;p_timer-&gt;p_log,&quot;Stop request.&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case TIMER_REQ_STOP_ALL:</span><br><span class="line">                sorted_list_stop_all();</span><br><span class="line">                m_global_active &#x3D; true;</span><br><span class="line">                NRF_LOG_INFO(&quot;Stop all request.&quot;);</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">#if APP_TIMER_WITH_PROFILER</span><br><span class="line">        CRITICAL_REGION_ENTER();</span><br><span class="line">#endif</span><br><span class="line">        UNUSED_RETURN_VALUE(nrf_atfifo_item_free(m_req_fifo, &amp;fifo_ctx));</span><br><span class="line">#if APP_TIMER_WITH_PROFILER</span><br><span class="line">        if (m_max_user_op_queue_utilization &lt; m_current_user_op_queue_utilization)</span><br><span class="line">        &#123;</span><br><span class="line">            m_max_user_op_queue_utilization &#x3D; m_current_user_op_queue_utilization;</span><br><span class="line">        &#125;</span><br><span class="line">        --m_current_user_op_queue_utilization;</span><br><span class="line">        CRITICAL_REGION_EXIT();</span><br><span class="line">#endif &#x2F;* APP_TIMER_WITH_PROFILER *&#x2F;</span><br><span class="line">        p_req &#x3D; nrf_atfifo_item_get(m_req_fifo, &amp;fifo_ctx);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>rtc_update()函数,该函数是调度timer的核心功能，调度逻辑比较复杂</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @brief Function updates RTC.</span><br><span class="line"> *</span><br><span class="line"> * Function is called at the end of RTC interrupt when all new user request and&#x2F;or timer expiration</span><br><span class="line"> * occured. It configures RTC if there is any pending timer, reconfigures if the are timers with</span><br><span class="line"> * shorted timeout than active one or stops RTC if there is no active timers.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void rtc_update(drv_rtc_t const * const  p_instance)</span><br><span class="line">&#123;</span><br><span class="line">	while(1)</span><br><span class="line">    &#123;     </span><br><span class="line">		app_timer_t * p_next &#x3D; sortlist_peek();&#x2F;&#x2F;探测链表是否为空，空则返回NULL，否则返回当前节点</span><br><span class="line">        bool rtc_reconf &#x3D; false;</span><br><span class="line">        if (p_next) &#x2F;&#x2F;Candidate for active timer&#x2F;&#x2F;存在timer</span><br><span class="line">        &#123;</span><br><span class="line">            if (mp_active_timer &#x3D;&#x3D; NULL)&#x2F;&#x2F;判断是否已经存在活动的timer,即下一次比较事件发生的timer</span><br><span class="line">            &#123;</span><br><span class="line">                &#x2F;&#x2F;There is no active timer so candidate will become active timer.</span><br><span class="line">                rtc_reconf &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (p_next-&gt;end_val &lt; mp_active_timer-&gt;end_val)&#x2F;&#x2F;当前节点的定时时间与活动的timer定时时间比较</span><br><span class="line">            &#123;</span><br><span class="line">                &#x2F;&#x2F;Candidate has shorter timeout than current active timer. Candidate will replace active timer.</span><br><span class="line">                &#x2F;&#x2F;Active timer is put back into sorted list.</span><br><span class="line">                rtc_reconf &#x3D; true;</span><br><span class="line">                if (mp_active_timer-&gt;active)</span><br><span class="line">                &#123;</span><br><span class="line">                    NRF_LOG_INST_DEBUG(mp_active_timer-&gt;p_log, &quot;Timer preempted.&quot;);</span><br><span class="line">                    nrf_sortlist_add(&amp;m_app_timer_sortlist, &amp;mp_active_timer-&gt;list_item);&#x2F;&#x2F;抢占活动的timer,即放在活动timer的前面</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (rtc_reconf)</span><br><span class="line">            &#123;</span><br><span class="line">                bool rerun;</span><br><span class="line">                p_next &#x3D; sortlist_pop();&#x2F;&#x2F;取出当前节点timer</span><br><span class="line">                NRF_LOG_INST_DEBUG(p_next-&gt;p_log, &quot;Activating timer (CC:%d&#x2F;%08x).&quot;, p_next-&gt;end_val, p_next-&gt;end_val);</span><br><span class="line">                if (rtc_schedule(p_next, &amp;rerun))&#x2F;&#x2F;重新设置比较值，返回true</span><br><span class="line">                &#123;</span><br><span class="line">                    if (!APP_TIMER_KEEPS_RTC_ACTIVE &amp;&amp; (mp_active_timer &#x3D;&#x3D; NULL))</span><br><span class="line">                    &#123;                     									</span><br><span class="line">						drv_rtc_start(p_instance);&#x2F;&#x2F;启动rtc1，这里每次重新设置比较值后，都要启动rtc1,不会清零counter计数器</span><br><span class="line">                    &#125;</span><br><span class="line">                    mp_active_timer &#x3D; p_next;&#x2F;&#x2F;把当前节点timer设置为活动timer,即下一次比较事件发生时，处理当前timer的回调函数，</span><br><span class="line"></span><br><span class="line">                    if (rerun &#x3D;&#x3D; false)  &#x2F;&#x2F;rtc_schedule返回true，这里rerun为false</span><br><span class="line">                    &#123;</span><br><span class="line">                        &#x2F;&#x2F;RTC was successfully updated and sortlist was not updated. Function can be terminated.</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                else&#x2F;&#x2F;这里，说明调度过程，该timer定时已经到了，在rtc_schedule中已经处理timer回调函数，所以这里mp_active_timer为NULL</span><br><span class="line">                &#123;   &#x2F;&#x2F;比如，2个timer,timer1一个设置为500ms，timer2设置为1s.timer1两次定时到，重新调度，发现1s时间到，因此马上执行timer2</span><br><span class="line">                    &#x2F;&#x2F;If RTC driver indicated that timeout already occured a new candidate will be taken from sorted list.</span><br><span class="line">                    NRF_LOG_INST_DEBUG(p_next-&gt;p_log,&quot;Timer expired before scheduled to RTC.&quot;);</span><br><span class="line">                    mp_active_timer &#x3D; NULL;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                &#x2F;&#x2F;RTC will not be updated. Function can terminate.</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#x2F;&#x2F;No candidate for active timer.</span><br><span class="line">        &#123;</span><br><span class="line">            if (!APP_TIMER_KEEPS_RTC_ACTIVE &amp;&amp; (mp_active_timer &#x3D;&#x3D; NULL))</span><br><span class="line">            &#123;</span><br><span class="line">                drv_rtc_stop(p_instance);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>存在一个情况：两个timer发起请求，一个时间短，一个时间长，如果时间长的先发起请求，那么时间短后发起的请求，则会抢占时间长的。因此时间短的定时会先到来。</p>
<p>rtc_schedule函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @brief Function is configuring RTC driver to trigger timeout interrupt for given timer.</span><br><span class="line"> *</span><br><span class="line"> * It is possible that RTC driver will indicate that timeout already occured. In that case timer</span><br><span class="line"> * expires and function indicates that RTC was not configured.</span><br><span class="line"> *</span><br><span class="line"> * @param          p_timer Timer instance.</span><br><span class="line"> * @param [in,out] p_rerun Flag indicating that sortlist reevaluation is required.</span><br><span class="line"> *</span><br><span class="line"> * @return True if RTC was successfully configured, false if timer already expired and RTC was not</span><br><span class="line"> *         configured.</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line">static bool rtc_schedule(app_timer_t * p_timer, bool * p_rerun)</span><br><span class="line">&#123;</span><br><span class="line">    ret_code_t ret &#x3D; NRF_ERROR_TIMEOUT;</span><br><span class="line">    *p_rerun &#x3D; false;</span><br><span class="line">    int64_t remaining &#x3D; (int64_t)(p_timer-&gt;end_val - get_now());&#x2F;&#x2F;timer结束时间戳和当前时间戳比较</span><br><span class="line">	&#x2F;&#x2F;如果remaining大于0，说明timer定时的时间没有到来，则设置CC0寄存器的值</span><br><span class="line">    if (remaining &gt; 0) &#123;</span><br><span class="line">        uint32_t cc_val &#x3D; ((uint32_t)remaining &gt; APP_TIMER_RTC_MAX_VALUE) ?</span><br><span class="line">                (app_timer_cnt_get() + APP_TIMER_RTC_MAX_VALUE) : p_timer-&gt;end_val;</span><br><span class="line"></span><br><span class="line">        ret &#x3D; drv_rtc_windowed_compare_set(&amp;m_rtc_inst, 0, cc_val, APP_TIMER_SAFE_WINDOW);&#x2F;&#x2F;设置比较值</span><br><span class="line">        NRF_LOG_DEBUG(&quot;Setting CC to 0x%08x (err: %d)&quot;, cc_val &amp; DRV_RTC_MAX_CNT, ret);</span><br><span class="line">        if (ret &#x3D;&#x3D; NRF_SUCCESS)</span><br><span class="line">        &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        drv_rtc_compare_disable(&amp;m_rtc_inst, 0);</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F;如果ret &#x3D;&#x3D; NRF_ERROR_TIMEOUT，则表明当前节点timer的定时时间已经到了或者超时了，需要马上执行，不用再等下一次比较事件发生。</span><br><span class="line">    if (ret &#x3D;&#x3D; NRF_ERROR_TIMEOUT)</span><br><span class="line">    &#123;</span><br><span class="line">        *p_rerun &#x3D; timer_expire(p_timer);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        NRF_LOG_ERROR(&quot;Unexpected error: %d&quot;, ret);				</span><br><span class="line">        ASSERT(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定时时间到了处理函数timer_expire()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @brief Function called on timer expiration</span><br><span class="line"> * If end value is not reached it is assumed that it was partial expiration and time is put back</span><br><span class="line"> * into the list. Otherwise function calls user handler if timer was not stopped before. If timer</span><br><span class="line"> * is in repeated mode then timer is rescheduled.</span><br><span class="line"> *</span><br><span class="line"> * @param p_timer Timer instance.</span><br><span class="line"> *</span><br><span class="line"> * @return True if reevaluation of sortlist needed (becasue it was updated).</span><br><span class="line"> *&#x2F;</span><br><span class="line">static bool timer_expire(app_timer_t * p_timer)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(p_timer-&gt;handler);</span><br><span class="line">    bool ret &#x3D; false;</span><br><span class="line"></span><br><span class="line">    if ((m_global_active &#x3D;&#x3D; true) &amp;&amp; (p_timer !&#x3D; NULL) &amp;&amp; (p_timer-&gt;active))</span><br><span class="line">    &#123;</span><br><span class="line">        if (get_now() &gt;&#x3D; p_timer-&gt;end_val) &#123;</span><br><span class="line">            &#x2F;* timer expired *&#x2F;</span><br><span class="line">            if (p_timer-&gt;repeat_period &#x3D;&#x3D; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                p_timer-&gt;active &#x3D; false;</span><br><span class="line">            &#125;</span><br><span class="line">    #if APP_TIMER_CONFIG_USE_SCHEDULER</span><br><span class="line">            app_timer_event_t timer_event;</span><br><span class="line"></span><br><span class="line">            timer_event.timeout_handler &#x3D; p_timer-&gt;handler;</span><br><span class="line">            timer_event.p_context       &#x3D; p_timer-&gt;p_context;</span><br><span class="line">            uint32_t err_code &#x3D; app_sched_event_put(&amp;timer_event,</span><br><span class="line">                                                    sizeof(timer_event),</span><br><span class="line">                                                    scheduled_timeout_handler);</span><br><span class="line">            APP_ERROR_CHECK(err_code);</span><br><span class="line">    #else</span><br><span class="line">            NRF_LOG_DEBUG(&quot;Timer expired (context: %d)&quot;, (uint32_t)p_timer-&gt;p_context)</span><br><span class="line">            p_timer-&gt;handler(p_timer-&gt;p_context);&#x2F;&#x2F;执行app timer回调函数</span><br><span class="line">    #endif</span><br><span class="line">            &#x2F;* check active flag as it may have been stopped in the user handler *&#x2F;</span><br><span class="line">            if ((p_timer-&gt;repeat_period) &amp;&amp; (p_timer-&gt;active))</span><br><span class="line">            &#123;</span><br><span class="line">                p_timer-&gt;end_val +&#x3D; p_timer-&gt;repeat_period;&#x2F;&#x2F;更新时间戳</span><br><span class="line">                nrf_sortlist_add(&amp;m_app_timer_sortlist, &amp;p_timer-&gt;list_item);&#x2F;&#x2F;改变节点指向，放到链表末尾。</span><br><span class="line">                ret &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            nrf_sortlist_add(&amp;m_app_timer_sortlist, &amp;p_timer-&gt;list_item);</span><br><span class="line">            ret &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>参考：</p>
<p><a href="http://wywiot.com/nordic-ble-soc-sw-primary-howtouse-apptimer/" target="_blank" rel="noopener">NORDIC BLE SOC 软件入门-APPTIMER的使用</a></p>
<p><a href="https://www.cnblogs.com/iini/p/9347460.html" target="_blank" rel="noopener">定时模块app_timer用法及常见问题—nRF5 SDK模块系列二</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/03/ubuntu/%E7%A1%AC%E7%9B%98%E6%B5%8B%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/03/ubuntu/%E7%A1%AC%E7%9B%98%E6%B5%8B%E8%AF%95/" class="post-title-link" itemprop="url">硬盘测试</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-09-03 11:24:37 / Modified: 13:26:16" itemprop="dateCreated datePublished" datetime="2020-09-03T11:24:37+08:00">2020-09-03</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>拿到一块硬盘，需要了解硬盘的性能和坏块，下面总结如何检测坏块和性能测试做些什么事情。</p>
<h2 id="检测坏块"><a href="#检测坏块" class="headerlink" title="检测坏块"></a>检测坏块</h2><p>使用 badblocks检测硬盘坏块</p>
<p>badblocks -s//显示进度  -v//显示执行详细情况   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># badblocks -s -v &#x2F;dev&#x2F;sda</span><br><span class="line">正在检查从 0 到 244198583的块</span><br><span class="line">Checking for bad blocks (read-only test): ^C0.10% done, 0:04 elapsed</span><br><span class="line">Interrupted at block 272896</span><br></pre></td></tr></table></figure>

<p>$badblocks -s//显示进度 -w//以写去检测 -v//显示执行详细情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># badblocks -w -s -v &#x2F;dev&#x2F;sda1</span><br><span class="line">Checking for bad blocks in read-write mode</span><br><span class="line">From block 0 to 25607577</span><br><span class="line">Testing with pattern 0xaa: ^C0.73% done, 0:03 elapsed</span><br><span class="line"></span><br><span class="line">注意，不能以写的方式检测已经挂载的硬盘</span><br></pre></td></tr></table></figure>

<h2 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h2><p>1.测试磁盘读写速度使用hdparm或者dd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># hdparm -Tt &#x2F;dev&#x2F;sda</span><br><span class="line">&#x2F;dev&#x2F;sda:</span><br><span class="line">Timing cached reads:   </span><br><span class="line">1918 MB in  2.00 seconds &#x3D; 959.62 MB&#x2F;sec</span><br><span class="line">Timing buffered disk reads:  184 MB in  3.00 seconds &#x3D;  61.26 MB&#x2F;sec</span><br></pre></td></tr></table></figure>

<p>hdparm可检测，显示与设定IDE或SCSI硬盘的参数。</p>
<p>语法：</p>
<p>hdparm [-CfghiIqtTvyYZ][-a &lt;快取分区&gt;][-A &lt;0或1&gt;][-c ][-d &lt;0或1&gt;][-k &lt;0或1&gt;][-K &lt;0或1&gt;][-m &lt;分区数&gt;][-n &lt;0或1&gt;][-p ][-P &lt;分区数&gt;][-r &lt;0或1&gt;][-S &lt;时间&gt;][-u &lt;0或1&gt;][-W &lt;0或1&gt;][-X &lt;传输模式&gt;] [设备]<br>-a&lt;快取分区&gt; 设定读取文件时，预先存入块区的分区数，若不加上&lt;快取分区&gt;选项，则显示目前的设定。 -A&lt;0或1&gt; 启动或关闭读取文件时的快取功能。-c&lt;I/O模式&gt; 设定IDE32位I/O模式。 -C 检测IDE硬盘的电源管理模式。-d&lt;0或1&gt; 设定磁盘的DMA模式。-f 将内存缓冲区的数据写入硬盘，并清楚缓冲区。 -g 显示硬盘的磁轨，磁头，磁区等参数。-h 显示帮助。-i 显示硬盘的硬件规格信息，这些信息是在开机时由硬盘本身所提供。 -I 直接读取硬盘所提供的硬件规格信息。-k&lt;0或1&gt; 重设硬盘时，保留-dmu参数的设定。 -K&lt;0或1&gt; 重设硬盘时，保留-APSWXZ参数的设定。-m&lt;磁区数&gt; 设定硬盘多重分区存取的分区数。 -n&lt;0或1&gt; 忽略硬盘写入时所发生的错误。-p&lt;PIO模式&gt; 设定硬盘的PIO模式。 -P&lt;磁区数&gt; 设定硬盘内部快取的分区数。-q 在执行后续的参数时，不在屏幕上显示任何信息。 -r&lt;0或1&gt; 设定硬盘的读写模式。-S&lt;时间&gt; 设定硬盘进入省电模式前的等待时间。-t 评估硬盘的读取效率。 -T 评估硬盘快取的读取效率。-u&lt;0或1&gt; 在硬盘存取时，允许其他中断要求同时执行。-v 显示硬盘的相关设定。 -W&lt;0或1&gt; 设定硬盘的写入快取。-X&lt;传输模式&gt;  设定硬盘的传输模式。-y 使IDE硬盘进入省电模式。 -Y 使IDE硬盘进入睡眠模式。-Z 关闭某些Seagate硬盘的自动省电功能。</p>
<p>2.iostat测试IO瓶颈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iostat -x 1</span><br><span class="line">Device:         rrqm&#x2F;s   wrqm&#x2F;s     r&#x2F;s     w&#x2F;s   rsec&#x2F;s   wsec&#x2F;s avgrq-sz avgqu-sz   await  svctm  %util</span><br><span class="line">sda               0.00     0.00 2752.00    1.00 1409024.00     8.00   511.82     4.64    1.69   0.35  96.10</span><br></pre></td></tr></table></figure>

<p>3.fio测试随机读写性能</p>
<p>下载并安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;brick.kernel.dk&#x2F;snaps&#x2F;fio-2.2.5.tar.gz</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">yum install libaio-devel gcc  -y</span><br><span class="line">tar -zxvf fio-2.2.5.tar.gz</span><br><span class="line">cd fio-2.2.5</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>使用方法参考<a href="http://www.dbhelp.net/2018/01/09/linux%E6%B5%8B%E8%AF%95%E7%A3%81%E7%9B%98io%E6%80%A7%E8%83%BD%EF%BC%88%E9%9A%8F%E6%9C%BA%E8%AF%BB%E5%86%99%EF%BC%89.html" target="_blank" rel="noopener">http://www.dbhelp.net/2018/01/09/linux%E6%B5%8B%E8%AF%95%E7%A3%81%E7%9B%98io%E6%80%A7%E8%83%BD%EF%BC%88%E9%9A%8F%E6%9C%BA%E8%AF%BB%E5%86%99%EF%BC%89.html</a></p>
<h3 id="磁盘性能指标"><a href="#磁盘性能指标" class="headerlink" title="磁盘性能指标"></a>磁盘性能指标</h3><p>1.磁盘性能指标–IOPS</p>
<p>IOPS (Input/Output Per Second)即每秒的输入输出量(或读写次数)，是衡量磁盘性能的主要指标之一。IOPS是指单位时间内系统能处理的I/O请求数量，一般以每秒处理的I/O请求数量为单位，I/O请求通常为读或写数据操作请求</p>
<p> 随机读写频繁的应用，如小文件存储(图片)、OLTP数据库、邮件服务器，关注随机读写性能，IOPS是关键衡量指标。<br> 顺序读写频繁的应用，传输大量连续数据，如电视台的视频编辑，视频点播VOD(Video On Demand)，关注连续读写性能。数据吞吐量是关键衡量指标。</p>
<p>IOPS和数据吞吐量适用于不同的场合：<br>读取10000个1KB文件，用时10秒  Throught(吞吐量)=1MB/s ，IOPS=1000  追求IOPS<br>读取1个10MB文件，用时0.2秒  Throught(吞吐量)=50MB/s, IOPS=5  追求吞吐量</p>
<p>2.磁盘服务时间</p>
<p>传统磁盘本质上一种机械装置，如FC, SAS, SATA磁盘，转速通常为5400/7200/10K/15K rpm不等。影响磁盘的关键因素是磁盘服务时间，即磁盘完成一个I/O请求所花费的时间，它由寻道时间、旋转延迟和数据传输时间三部分构成。</p>
<p>寻道时间 Tseek是指将读写磁头移动至正确的磁道上所需要的时间。寻道时间越短，I/O操作越快，目前磁盘的平均寻道时间一般在3－15ms。<br>旋转延迟 Trotation是指盘片旋转将请求数据所在扇区移至读写磁头下方所需要的时间。旋转延迟取决于磁盘转速，通常使用磁盘旋转一周所需时间的1/2表示。比如，7200 rpm的磁盘平均旋转延迟大约为60*1000/7200/2 = 4.17ms，而转速为15000 rpm的磁盘其平均旋转延迟为2ms。<br>数据传输时间 Ttransfer是指完成传输所请求的数据所需要的时间，它取决于数据传输率，其值等于数据大小除以数据传输率。目前IDE/ATA能达到133MB/s，SATA II可达到300MB/s的接口数据传输率，数据传输时间通常远小于前两部分消耗时间。简单计算时可忽略。</p>
<p>常见磁盘平均物理寻道时间为：<br>7200转/分的STAT硬盘平均物理寻道时间是9ms<br>10000转/分的STAT硬盘平均物理寻道时间是6ms<br>15000转/分的SAS硬盘平均物理寻道时间是4ms</p>
<p>常见硬盘的旋转延迟时间为：</p>
<p>7200  rpm的磁盘平均旋转延迟大约为60*1000/7200/2 = 4.17ms</p>
<p>10000 rpm的磁盘平均旋转延迟大约为60*1000/10000/2 = 3ms，</p>
<p>15000 rpm的磁盘其平均旋转延迟约为60*1000/15000/2 = 2ms</p>
<p>参考：</p>
<p><a href="https://blog.51cto.com/wushank/1708168" target="_blank" rel="noopener">磁盘性能指标–IOPS、吞吐量及测试</a></p>
<p><a href="https://blog.csdn.net/qq_35298894/article/details/79022859" target="_blank" rel="noopener">Linux 测试 IO 性能（磁盘读写速度）</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/03/ubuntu/smartctl%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/03/ubuntu/smartctl%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">smartctl使用介绍</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-09-03 10:52:11 / Modified: 13:27:15" itemprop="dateCreated datePublished" datetime="2020-09-03T10:52:11+08:00">2020-09-03</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="http://zh.wikipedia.org/wiki/S.M.A.R.T." target="_blank" rel="noopener">S.M.A.R.T.</a> 是个用来检测硬盘健康状况的指标。SMART是一种磁盘自我分析检测技术，早在90年代末就基本得到了普及每一块硬盘（包括IDE、SCSI），在运行的时候都会将自身的若干参数记录下来，这些参数包括型号、容量、温度、密度、扇区、寻道时间、传输、误码率等。硬盘运行了几千小时后，很多内在的物理参数都会发生变化，某一参数超过报警阈值，则说明硬盘接近损坏，此时硬盘依然在工作，如果用户不理睬这个报警继续使用，那么硬盘将变得非常不可靠，随时可能故障。</p>
<h2 id="smart-安装"><a href="#smart-安装" class="headerlink" title="smart 安装"></a>smart 安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install smartmontools</span><br></pre></td></tr></table></figure>



<h2 id="smart使用方法"><a href="#smart使用方法" class="headerlink" title="smart使用方法"></a>smart使用方法</h2><p>smartctl -a <device> 检查该设备是否已经打开SMART技术。 smartctl -s on <device> 如果没有打开SMART技术，使用该命令打开SMART技术。 smartctl -t short <device> 后台检测硬盘，消耗时间短； smartctl -t long <device> 后台检测硬盘，消耗时间长； smartctl -C -t short <device> 前台检测硬盘，消耗时间短； smartctl -C -t long <device> 前台检测硬盘，消耗时间长。其实就是利用硬盘SMART的自检程序。 smartctl -X <device> 中断后台检测硬盘。 smartctl -l selftest <device> 显示硬盘检测日志。 smartctl -l error <device> 显示硬盘错误汇总。<br>首先通过dmesg工具，确认一下硬盘的设备符号。例如一个IDE硬盘连接到Primary IDE 总线上的Slave位置，硬盘设备符号是/dev/hdb，hdb中的h代表IDE，如果显示为sdb，则代表SATA和SCSI，最后一个字幕b代表Primary总线，第二块硬盘即Slave位置，确认硬盘是否打开了SMART支持：</p>
<p>1.查询硬盘是否开启smart支持</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># smartctl -i &#x2F;dev&#x2F;sda</span><br><span class="line">smartctl 5.40 2010-10-16 r3189 [i386-redhat-linux-gnu] (local build)</span><br><span class="line">Copyright (C) 2002-10 by Bruce Allen, http:&#x2F;&#x2F;smartmontools.sourceforge.net</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D; START OF INFORMATION SECTION &#x3D;&#x3D;&#x3D;</span><br><span class="line">Device Model:     HITACHI HTS543225L9SA00</span><br><span class="line">Serial Number:    090131FB2F32YLG28JEA</span><br><span class="line">Firmware Version: FBEZC48C</span><br><span class="line">User Capacity:    250,059,350,016 bytes</span><br><span class="line">Device is:        Not in smartctl database [for details use: -P showall]</span><br><span class="line">ATA Version is:   8</span><br><span class="line">ATA Standard is:  ATA-8-ACS revision 3f</span><br><span class="line">Local Time is:    Wed May 25 10:10:39 2011 CST</span><br><span class="line">SMART support is: Available - device has SMART capability.</span><br><span class="line">SMART support is: Enabled                          &#x2F;&#x2F;表示启用了smart支持</span><br></pre></td></tr></table></figure>

<p>2.如果看到SMART support is: Disabled表示SMART未启用，执行如下命令，启动SMART</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo smartctl -s on &#x2F;dev&#x2F;sda</span><br><span class="line">smartctl 5.41 2011-06-09 r3365 [x86_64-linux-3.8.0-31-generic] (local build)</span><br><span class="line">Copyright (C) 2002-11 by Bruce Allen, http:&#x2F;&#x2F;smartmontools.sourceforge.net</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D; START OF ENABLE&#x2F;DISABLE COMMANDS SECTION &#x3D;&#x3D;&#x3D;</span><br><span class="line">SMART Enabled.</span><br></pre></td></tr></table></figure>

<p>3.支持 SMART 后我们可以使用 <em>-H</em> 参数来手动检查硬盘、随身硬盘的建康状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># - 通过 (passed)。</span><br><span class="line">$ sudo smartctl -H &#x2F;dev&#x2F;sda</span><br><span class="line">smartctl 5.41 2011-06-09 r3365 [x86_64-linux-3.8.0-31-generic] (local build)</span><br><span class="line">Copyright (C) 2002-11 by Bruce Allen, http:&#x2F;&#x2F;smartmontools.sourceforge.net</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D; START OF READ SMART DATA SECTION &#x3D;&#x3D;&#x3D;</span><br><span class="line">SMART overall-health self-assessment test result: PASSED</span><br><span class="line"></span><br><span class="line"># - 失败 (failed)。</span><br><span class="line">$ sudo smartctl -H &#x2F;dev&#x2F;sda</span><br><span class="line">smartctl 5.41 2011-06-09 r3365 [x86_64-linux-3.8.0-31-generic] (local build)</span><br><span class="line">Copyright (C) 2002-11 by Bruce Allen, http:&#x2F;&#x2F;smartmontools.sourceforge.net</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D; START OF READ SMART DATA SECTION &#x3D;&#x3D;&#x3D;</span><br><span class="line">SMART overall-health self-assessment test result: FAILED!</span><br><span class="line">Drive failure expected in less than 24 hours. SAVE ALL DATA.</span><br><span class="line">Failed Attributes:</span><br><span class="line">ID# ATTRIBUTE_NAME          FLAG     VALUE WORST THRESH TYPE      UPDATED  WHEN_FAILED RAW_VALUE</span><br><span class="line">5 Reallocated_Sector_Ct   0x0033   004   004   005    Pre-fail  Always   FAILING_NOW 1887</span><br></pre></td></tr></table></figure>







<p>参考：</p>
<p><a href="https://www.w3cschool.cn/working_on_gnu_linux/working_on_gnu_linux-wqdu27ol.html" target="_blank" rel="noopener">GNU/Linux 检测硬盘健康状态：S.M.A.R.T.</a></p>
<p><a href="https://www.cnblogs.com/fiberhome/p/8275961.html" target="_blank" rel="noopener">Linux硬盘的检测–smartctl详细介绍</a></p>
<p><a href="https://www.cnblogs.com/xqzt/p/5512075.html" target="_blank" rel="noopener">硬盘SMART检测参数详解</a></p>
<p><a href="https://blog.csdn.net/watermelonbig/article/details/72871990" target="_blank" rel="noopener">smartctl检测物理磁盘健康度的测试结果解读</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/31/Linux/Kernel/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91linux%E5%86%85%E6%A0%B8%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6%E6%9C%BA%E5%88%B6%E6%BA%90%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/31/Linux/Kernel/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91linux%E5%86%85%E6%A0%B8%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6%E6%9C%BA%E5%88%B6%E6%BA%90%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB/" class="post-title-link" itemprop="url">linux内核写时复制机制源代码解读</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-08-31 13:24:10 / Modified: 13:37:27" itemprop="dateCreated datePublished" datetime="2020-08-31T13:24:10+08:00">2020-08-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Kernel/" itemprop="url" rel="index"><span itemprop="name">Kernel</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Kernel/%E8%BF%9B%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">进程</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文转载来自Linux阅码场：<a href="https://mp.weixin.qq.com/s/3YOnF9wQzW5B9cDWoKtTEA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/3YOnF9wQzW5B9cDWoKtTEA</a></p>
<p>作者简介</p>
<p>韩传华，就职于国内一家半导体公司，主要从事linux相关系统软件开发工作，负责Soc芯片BringUp及系统软件开发，乐于分享喜欢学习，喜欢专研Linux内核源代码。</p>
<p>写时复制技术（一下简称COW）是linux内核比较重要的一种机制，我们都知道：父进程fork子进程的时候，子进程会和父进程会以只读的方式共享所有私有的可写页，当有一方将要写的时候会发生COW缺页异常。那么究竟COW在linux内核中是如何触发？又是如何处理的呢？我们将在本文中以源代码情景分析的方式来解读神秘的写时COW，从源代码级别的角度彻底理解它。</p>
<p>需要说明的是:本文中所分析的内核源码时linux-5.0版本内核，使用arm64处理器架构，当然此文章发布时linux内核已经是linux-5.8.x，当你查看最新的内核源码的时候会发现变化并不是很大。本文主要会从下面几个方面去分析讨论写时复制：</p>
<p>1.fork子进程时内核为COW做了哪些准备<br>2.COW进程是如何触发的<br>3.内核时怎样处理COW这种缺页异常的<br>4.匿名页的reuse</p>
<h2 id="一，从fork说起"><a href="#一，从fork说起" class="headerlink" title="一，从fork说起"></a>一，从fork说起</h2><p>我们都知道，进程是通过fork进行创建的，fork创建子进程的时候会和父进程共享资源，如fs,file,mm等等，其中内存资源的共享是一下路径：<br>kernel/fork.c<br>_do_fork-&gt;copy_process-&gt;copy_mm</p>
<p>当然本文中讨论的是COW，暂时不详解其他资源共享以及内存资源共享的其他部分（后面的相关文章我们会讨论），copy_mm总体来说所作的工作是：分配mm_struct结构实例mm，拷贝父进程的old_mm到mm,创建自己的pgd页全局目录，然后会遍历父进程的vma链表为子进程建立vma链表（如代码段，数据段等等），然后就是比较关键的页的共享，linux内核为了效率考虑并不是拷贝父进程的所有物理页内容，而是通过复制页表来共享这些页。而在复制页表的时候，内核会判断这个页表条目是完全复制还是修改为只读来为COW缺页做准备。</p>
<p>共享父进程内存资源处理如下：</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/Ass1lsY6byuhcmomXpTGC8jxKCsr8icJ0ibHCQIn6mXIk082ibdUDjLKmgaBBHrLDGIfYiaB2s7R5Z38jia1XgaVtdg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="img"></p>
<p>以下我们主要分析copy_one_pte 拷贝页表条目的这一函数：<br>首先会处理一些页表项不为空但物理页不在内存中的情况（!pte_present(pte)分支）如被swap到交换分区中的页，接下来处理物理页在内存中的情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line">   774         |* If it&#39;s a COW mapping, write protect it both</span><br><span class="line">   775         |* in the parent and the child</span><br><span class="line">   776         |*&#x2F;</span><br><span class="line">   777         if (is_cow_mapping(vm_flags) &amp;&amp; pte_write(pte)) &#123;&#x2F;&#x2F;vma为私有可写  而且pte有可写属性</span><br><span class="line">   778                 ptep_set_wrprotect(src_mm, addr, src_pte);&#x2F;&#x2F;设置父进程页表项为只读</span><br><span class="line">   779                 pte &#x3D; pte_wrprotect(pte); &#x2F;&#x2F;为子进程设置只读的页表项值</span><br><span class="line">   780         &#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码块是判断当前页所在的vma是否是私有可写的属性而且父进程页表项是可写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">247 static inline bool is_cow_mapping(vm_flags_t flags)</span><br><span class="line">248 &#123;</span><br><span class="line">249         return (flags &amp; (VM_SHARED | VM_MAYWRITE)) &#x3D;&#x3D; VM_MAYWRITE;</span><br><span class="line">250 &#125;</span><br></pre></td></tr></table></figure>

<p>如果判断成立说明是COW的映射，则需要将父子进程页表修改为只读：<br>ptep_set_wrprotect(src_mm, addr, src_pte)将父进程的页表项修改为只读， pte = pte_wrprotect(pte)将子进程的即将写入的页表项值修改为只读（注意：修改之前pte为父进程原来的pte值，修改之后子进程pte还没有写入到对应的页表项条目中！）<br>修改页表项为只读的核心函数为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">152 static inline pte_t pte_wrprotect(pte_t pte)</span><br><span class="line">  153 &#123;</span><br><span class="line">  154         pte &#x3D; clear_pte_bit(pte, __pgprot(PTE_WRITE));&#x2F;&#x2F;清可写位</span><br><span class="line">  155         pte &#x3D; set_pte_bit(pte, __pgprot(PTE_RDONLY));&#x2F;&#x2F;置位只读位</span><br><span class="line">  156         return pte;</span><br><span class="line">  157</span><br></pre></td></tr></table></figure>

<p>再次回到copy_one_pte函数往下分析：<br>上面我们已经修改了父进程的页表项，也获得了子进程即将写入的页表项值pte(注意：现在还没有写入到子进程的页表项中，因为此时子进程的页表项值还没有被完全拼接号好)，接下来我们将要拼接子进程的页表项的值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">782         &#x2F;*</span><br><span class="line">   783         |* If it&#39;s a shared mapping, mark it clean in</span><br><span class="line">   784         |* the child</span><br><span class="line">   785         |*&#x2F;</span><br><span class="line">   786         if (vm_flags &amp; VM_SHARED) &#x2F;&#x2F;vma的属性为共享</span><br><span class="line">   787                 pte &#x3D; pte_mkclean(pte);&#x2F;&#x2F;设置页表项值为clean</span><br><span class="line">   788         pte &#x3D; pte_mkold(pte); &#x2F;&#x2F;设置页表项值为未被访问过即是清PTE_AF</span><br><span class="line">   789</span><br><span class="line">   790         page &#x3D; vm_normal_page(vma, addr, pte); &#x2F;&#x2F;获得pte对应的page结构（即是和父进程共享的页描述符）</span><br><span class="line">   791         if (page) &#123;</span><br><span class="line">   792                 get_page(page);&#x2F;&#x2F;增进page结构的引用计数</span><br><span class="line">   793                 page_dup_rmap(page, false);&#x2F;&#x2F;注意：不是拷贝rmap 而是增加page-&gt;_mapcount计数（页被映射计数）</span><br><span class="line">   794                 rss[mm_counter(page)]++;</span><br><span class="line">   795         &#125; else if (pte_devmap(pte)) &#123;</span><br><span class="line">   796                 page &#x3D; pte_page(pte);</span><br><span class="line">   797</span><br><span class="line">   798                 &#x2F;*</span><br><span class="line">   799                 |* Cache coherent device memory behave like regular page and</span><br><span class="line">   800                 |* not like persistent memory page. For more informations see</span><br><span class="line">   801                 |* MEMORY_DEVICE_CACHE_COHERENT in memory_hotplug.h</span><br><span class="line">   802                 |*&#x2F;</span><br><span class="line">   803                 if (is_device_public_page(page)) &#123;</span><br><span class="line">   804                         get_page(page);</span><br><span class="line">   805                         page_dup_rmap(page, false);</span><br><span class="line">   806                         rss[mm_counter(page)]++;</span><br><span class="line">   807                 &#125;</span><br><span class="line">   808         &#125;</span><br><span class="line">   809</span><br><span class="line">   810 out_set_pte:</span><br><span class="line">   811         set_pte_at(dst_mm, addr, dst_pte, pte);&#x2F;&#x2F;将拼接的页表项值写入到子进程的页表项中</span><br><span class="line">   812         return 0;</span><br></pre></td></tr></table></figure>

<p>以上过程就完成了对于需要写时复制的页，将父子进程的页表项改写为只读（这时候vma的属性是可写的），并共享相同的物理页，这为下面的COW缺页异常做好了页表级别的准备工作。</p>
<h2 id="二，COW缺页异常触发条件"><a href="#二，COW缺页异常触发条件" class="headerlink" title="二，COW缺页异常触发条件"></a>二，COW缺页异常触发条件</h2><p>当然如果父子进程仅仅是对COW共享的页面做只读访问，则通过各自的页表就能直接访问到对应的数据，一切都正常，一旦有一方去写，就会发生处理器异常，处理器会判断出是COW缺页异常：</p>
<p>arm64处理器处理过程：</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/Ass1lsY6byuhcmomXpTGC8jxKCsr8icJ0iaTAddeQdzA06YfwUcnPKjFC5Jksp3L1UzzTV35wTibiaEFlTBUibfP1gA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="img"></p>
<p>我们从handle_pte_fault函数开始分析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">3800         if (vmf-&gt;flags &amp; FAULT_FLAG_WRITE) &#123;&#x2F;&#x2F;vam可写</span><br><span class="line">  3801                 if (!pte_write(entry))&#x2F;&#x2F;页表项属性只读</span><br><span class="line">  3802                         return do_wp_page(vmf);&#x2F;&#x2F;处理cow</span><br><span class="line">  3803                 entry &#x3D; pte_mkdirty(entry);</span><br><span class="line">  3804         &#125;</span><br></pre></td></tr></table></figure>

<p>程序走到上面的判断说明：<strong>页表项存在，物理页存在内存，但是vma是可写，pte页表项是只读属性</strong>（这就是fork的时候所作的准备），这些条件也是COW缺页异常判断的条件。</p>
<h2 id="二-发生COW缺页异常"><a href="#二-发生COW缺页异常" class="headerlink" title="二,发生COW缺页异常"></a>二,发生COW缺页异常</h2><p>当内核判断了这次异常时COW缺页异常，就会调用do_wp_page进行处理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">2480 static vm_fault_t do_wp_page(struct vm_fault *vmf)</span><br><span class="line">2481         __releases(vmf-&gt;ptl)</span><br><span class="line">2482 &#123;</span><br><span class="line">2483         struct vm_area_struct *vma &#x3D; vmf-&gt;vma;</span><br><span class="line">2484</span><br><span class="line">2485         vmf-&gt;page &#x3D; vm_normal_page(vma, vmf-&gt;address, vmf-&gt;orig_pte);&#x2F;&#x2F;获得异常地址对应的page实例</span><br><span class="line">2486         if (!vmf-&gt;page) &#123;</span><br><span class="line">2487                 &#x2F;*</span><br><span class="line">2488                 |* VM_MIXEDMAP !pfn_valid() case, or VM_SOFTDIRTY clear on a</span><br><span class="line">2489                 |* VM_PFNMAP VMA.</span><br><span class="line">2490                 |*</span><br><span class="line">2491                 |* We should not cow pages in a shared writeable mapping.</span><br><span class="line">2492                 |* Just mark the pages writable and&#x2F;or call ops-&gt;pfn_mkwrite.</span><br><span class="line">2493                 |*&#x2F;</span><br><span class="line">2494                 if ((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) &#x3D;&#x3D;</span><br><span class="line">2495                                 |    (VM_WRITE|VM_SHARED))</span><br><span class="line">2496                         return wp_pfn_shared(vmf);&#x2F;&#x2F;处理共享可写映射</span><br><span class="line">2497</span><br><span class="line">2498                 pte_unmap_unlock(vmf-&gt;pte, vmf-&gt;ptl);</span><br><span class="line">2499                 return wp_page_copy(vmf);&#x2F;&#x2F;处理私有可写映射</span><br><span class="line">2500         &#125;</span><br></pre></td></tr></table></figure>

<p>2485行，获得发生异常时地址所在的page结构，如果没有page结构是使用页帧号的特殊映射，则通过wp_pfn_shared处理共享可写映射，wp_page_copy处理私有可写映射，当然这不是我们分析重点。</p>
<p>我们继续往下分析：<br>我们主要关注2522行，判断是否可以重新使用这个页，这个稍后在分析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2544         |* Ok, we need to copy. Oh, well..</span><br><span class="line">2545         |*&#x2F;</span><br><span class="line">2546         get_page(vmf-&gt;page);</span><br><span class="line">2547</span><br><span class="line">2548         pte_unmap_unlock(vmf-&gt;pte, vmf-&gt;ptl);</span><br><span class="line">2549         return wp_page_copy(vmf);</span><br></pre></td></tr></table></figure>

<p>2546行 增加原来的页的引用计数，防止被释放。<br>2548行 释放页表锁<br>2549行 这是COW处理的核心函数</p>
<p>我们下面将详细分析wp_page_copy函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">      * - Allocate a page, copy the content of the old page to the new one.</span><br><span class="line">2234  * - Handle book keeping and accounting - cgroups, mmu-notifiers, etc.</span><br><span class="line">2235  * - Take the PTL. If the pte changed, bail out and release the allocated page</span><br><span class="line">2236  * - If the pte is still the way we remember it, update the page table and all</span><br><span class="line">2237  *   relevant references. This includes dropping the reference the page-table</span><br><span class="line">2238  *   held to the old page, as well as updating the rmap.</span><br><span class="line">2239  * - In any case, unlock the PTL and drop the reference we took to the old page.</span><br><span class="line">2240  *&#x2F;</span><br><span class="line">2241 static vm_fault_t wp_page_copy(struct vm_fault *vmf)</span><br><span class="line">2242 &#123;</span><br><span class="line">2243         struct vm_area_struct *vma &#x3D; vmf-&gt;vma;</span><br><span class="line">2244         struct mm_struct *mm &#x3D; vma-&gt;vm_mm;</span><br><span class="line">2245         struct page *old_page &#x3D; vmf-&gt;page;</span><br><span class="line">2246         struct page *new_page &#x3D; NULL;</span><br><span class="line">2247         pte_t entry;</span><br><span class="line">2248         int page_copied &#x3D; 0;</span><br><span class="line">2249         struct mem_cgroup *memcg;</span><br><span class="line">2250         struct mmu_notifier_range range;</span><br><span class="line">2251</span><br><span class="line">2252         if (unlikely(anon_vma_prepare(vma)))</span><br><span class="line">2253                 goto oom;</span><br><span class="line">2254</span><br><span class="line">2255         if (is_zero_pfn(pte_pfn(vmf-&gt;orig_pte))) &#123;</span><br><span class="line">2256                 new_page &#x3D; alloc_zeroed_user_highpage_movable(vma,</span><br><span class="line">2257                                                         |     vmf-&gt;address);</span><br><span class="line">2258                 if (!new_page)</span><br><span class="line">2259                         goto oom;</span><br><span class="line">2260         &#125; else &#123;</span><br><span class="line">2261                 new_page &#x3D; alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma,</span><br><span class="line">2262                                 vmf-&gt;address);</span><br><span class="line">2263                 if (!new_page)</span><br><span class="line">2264                         goto oom;</span><br><span class="line">2265                 cow_user_page(new_page, old_page, vmf-&gt;address, vma);</span><br><span class="line">2266         &#125;</span><br></pre></td></tr></table></figure>

<p>2252行 关联一个anon_vma实例到vma<br>2255行 到 2259行 <strong>判断原来的页表项映射的页是0页，就分配高端可移动的页并用0初始化</strong><br>2261到2265行 <strong>如果不是0页，分配高端可移动的页，然后将原来的页拷贝到新页</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">2268         if (mem_cgroup_try_charge_delay(new_page, mm, GFP_KERNEL, &amp;memcg, false))</span><br><span class="line">2269                 goto oom_free_new;</span><br><span class="line">2270</span><br><span class="line">2271         __SetPageUptodate(new_page);</span><br><span class="line">2272</span><br><span class="line">2273         mmu_notifier_range_init(&amp;range, mm, vmf-&gt;address &amp; PAGE_MASK,</span><br><span class="line">2274                                 (vmf-&gt;address &amp; PAGE_MASK) + PAGE_SIZE);</span><br><span class="line">2275         mmu_notifier_invalidate_range_start(&amp;range);</span><br><span class="line">2276</span><br><span class="line">2277         &#x2F;*</span><br><span class="line">2278         |* Re-check the pte - we dropped the lock</span><br><span class="line">2279         |*&#x2F;</span><br><span class="line">2280         vmf-&gt;pte &#x3D; pte_offset_map_lock(mm, vmf-&gt;pmd, vmf-&gt;address, &amp;vmf-&gt;ptl);</span><br><span class="line">2281         if (likely(pte_same(*vmf-&gt;pte, vmf-&gt;orig_pte))) &#123;</span><br><span class="line">2282                 if (old_page) &#123;</span><br><span class="line">2283                         if (!PageAnon(old_page)) &#123;</span><br><span class="line">2284                                 dec_mm_counter_fast(mm,</span><br><span class="line">2285                                                 mm_counter_file(old_page));</span><br><span class="line">2286                                 inc_mm_counter_fast(mm, MM_ANONPAGES);</span><br><span class="line">2287                         &#125;</span><br><span class="line">2288                 &#125; else &#123;</span><br><span class="line">2289                         inc_mm_counter_fast(mm, MM_ANONPAGES);</span><br><span class="line">2290                 &#125;</span><br><span class="line">2291                 flush_cache_page(vma, vmf-&gt;address, pte_pfn(vmf-&gt;orig_pte));</span><br><span class="line">2292                 entry &#x3D; mk_pte(new_page, vma-&gt;vm_page_prot);</span><br><span class="line">2293                 entry &#x3D; maybe_mkwrite(pte_mkdirty(entry), vma);</span><br><span class="line">2294                 &#x2F;*</span><br><span class="line">2295                 |* Clear the pte entry and flush it first, before updating the</span><br><span class="line">2296                 |* pte with the new entry. This will avoid a race condition</span><br><span class="line">2297                 |* seen in the presence of one thread doing SMC and another</span><br><span class="line">2298                 |* thread doing COW.</span><br><span class="line">2299                 |*&#x2F;</span><br><span class="line">2300                 ptep_clear_flush_notify(vma, vmf-&gt;address, vmf-&gt;pte);</span><br><span class="line">2301                 page_add_new_anon_rmap(new_page, vma, vmf-&gt;address, false);</span><br><span class="line">2302                 mem_cgroup_commit_charge(new_page, memcg, false, false);</span><br><span class="line">2303                 lru_cache_add_active_or_unevictable(new_page, vma);</span><br><span class="line">2304                 &#x2F;*</span><br><span class="line">2305                 |* We call the notify macro here because, when using secondary</span><br><span class="line">2306                 |* mmu page tables (such as kvm shadow page tables), we want the</span><br><span class="line">2307                 |* new page to be mapped directly into the secondary page table.</span><br><span class="line">2308                 |*&#x2F;</span><br><span class="line">2309                 set_pte_at_notify(mm, vmf-&gt;address, vmf-&gt;pte, entry);</span><br><span class="line">2310                 update_mmu_cache(vma, vmf-&gt;address, vmf-&gt;pte);</span><br><span class="line">2311                 if (old_page) &#123;</span><br><span class="line">2312                         &#x2F;*</span><br><span class="line">2313                         |* Only after switching the pte to the new page may</span><br><span class="line">2314                         |* we remove the mapcount here. Otherwise another</span><br><span class="line">2315                         |* process may come and find the rmap count decremented</span><br><span class="line">2316                         |* before the pte is switched to the new page, and</span><br><span class="line">2317                         |* &quot;reuse&quot; the old page writing into it while our pte</span><br><span class="line">2318                         |* here still points into it and can be read by other</span><br><span class="line">2319                         |* threads.</span><br><span class="line">2320                         |*</span><br><span class="line">2321                         |* The critical issue is to order this</span><br><span class="line">2322                         |* page_remove_rmap with the ptp_clear_flush above.</span><br><span class="line">2323                         |* Those stores are ordered by (if nothing else,)</span><br><span class="line">2324                         |* the barrier present in the atomic_add_negative</span><br><span class="line">2325                         |* in page_remove_rmap.</span><br><span class="line">2326                         |*</span><br><span class="line">2327                         |* Then the TLB flush in ptep_clear_flush ensures that</span><br><span class="line">2328                         |* no process can access the old page before the</span><br><span class="line">2329                         |* decremented mapcount is visible. And the old page</span><br><span class="line">2330                         |* cannot be reused until after the decremented</span><br><span class="line">2331                         |* mapcount is visible. So transitively, TLBs to</span><br><span class="line">2332                         |* old page will be flushed before it can be reused.</span><br><span class="line">2333                         |*&#x2F;</span><br><span class="line">2334                         page_remove_rmap(old_page, false);</span><br><span class="line">2335                 &#125;</span><br><span class="line">2336</span><br><span class="line">2337                 &#x2F;* Free the old page.. *&#x2F;</span><br><span class="line">2338                 new_page &#x3D; old_page;</span><br><span class="line">2339                 page_copied &#x3D; 1;</span><br><span class="line">2340         &#125; else &#123;</span><br><span class="line">2341                 mem_cgroup_cancel_charge(new_page, memcg, false);</span><br><span class="line">2342         &#125;</span><br></pre></td></tr></table></figure>

<p>2271行 设置新的页标识位为PageUptodate，表示页中包含有效数据。<br>2280行 锁住页表<br>2281到2339行是发生缺页异常时获得页表项和现在锁住之后获得页表项内容相同的情况<br>2341 时页表项不同的情况<br>主要分析相同的情况：<br>2282到2290 主要时对页计数的统计<br>2291 cache中刷新页<br>2292行 由vma的访问权限和新页的页描述符来构建页表项的值<br>2293行 <strong>设置页表项值属性为脏和可写（如果vma有可写属性，这个时候将页表项修改为了可写，fork的时候修改为只读这个地方修改了回来）</strong><br>2300行 将页表项原有的值清除，然后刷新地址发生缺页地址对应的tlb（这一行操作很重要）<br>2301行 <strong>将新的物理页添加到vma对应的匿名页的反向映射中</strong><br>2303行 <strong>将新物理页添加到活跃或不可回收LRU链表中</strong><br>2309 行<strong>将构建好的页表项值写入到页表项条目中</strong>，这个时候页表项修改才会生效。<br>2334行 删除原来的页到虚拟页的反向映射，然后做了比较重要的一个操作为<strong>atomic_add_negative(-1, &amp;page-&gt;_mapcount)</strong>将页的页表映射计数减一。<br>2344到2347 递减旧页的引用计数 并释放页表锁<br>2353到2364行 如果已经映射了新的物理页，旧页被锁住在内存中，将旧页解锁。<br>到此就完成了写时复制过程。总结下：分配新的物理页，拷贝原来页的内容到新页，然后修改页表项内容指向新页并修改为可写（vma具备可写属性）。<br>前面我们遗留了一个问题没有讨论，那就是do_wp_page函数中处理reuse_swap_page的处理，所谓的单身匿名页面的处理。</p>
<h2 id="四，匿名页的reuse"><a href="#四，匿名页的reuse" class="headerlink" title="四，匿名页的reuse"></a>四，匿名页的reuse</h2><p>假设有如下情形发生：父进程P通过fork创建了子进程A,其中有一<strong>私有可写的匿名页</strong>page1被共享，这个时候内核会此页都映射到各自的虚拟内存页，并修改双方的页表属性为只读，page1的映射计数_mapcount为2， 这个时候假设子进程写page1,则发生COW异常，异常处理程序为子进程A分配了新页page2并和虚拟页建立映射关系，并改写了子进程页表项为可写，这个时候子进程可以随意的写page2而不会影响父进程，当然上面分析我们知道page1的映射计数_mapcount会递减1变为1，也就表面这个页page1被父进程所唯一映射，那么<strong>这个时候父进程再去写page1，会发生什么呢？还会发生COW去分配新的页吗?</strong><br>下面我们在源代码中寻找答案：</p>
<p>do_wp_page函数的2502到2541是我们分析重点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">2502         &#x2F;*</span><br><span class="line">2503         |* Take out anonymous pages first, anonymous shared vmas are</span><br><span class="line">2504         |* not dirty accountable.</span><br><span class="line">2505         |*&#x2F;</span><br><span class="line">2506         if (PageAnon(vmf-&gt;page) &amp;&amp; !PageKsm(vmf-&gt;page)) &#123;</span><br><span class="line">2507                 int total_map_swapcount;</span><br><span class="line">2508                 if (!trylock_page(vmf-&gt;page)) &#123;</span><br><span class="line">2509                         get_page(vmf-&gt;page);</span><br><span class="line">2510                         pte_unmap_unlock(vmf-&gt;pte, vmf-&gt;ptl);</span><br><span class="line">2511                         lock_page(vmf-&gt;page);</span><br><span class="line">2512                         vmf-&gt;pte &#x3D; pte_offset_map_lock(vma-&gt;vm_mm, vmf-&gt;pmd,</span><br><span class="line">2513                                         vmf-&gt;address, &amp;vmf-&gt;ptl);</span><br><span class="line">2514                         if (!pte_same(*vmf-&gt;pte, vmf-&gt;orig_pte)) &#123;</span><br><span class="line">2515                                 unlock_page(vmf-&gt;page);</span><br><span class="line">2516                                 pte_unmap_unlock(vmf-&gt;pte, vmf-&gt;ptl);</span><br><span class="line">2517                                 put_page(vmf-&gt;page);</span><br><span class="line">2518                                 return 0;</span><br><span class="line">2519                         &#125;</span><br><span class="line">2520                         put_page(vmf-&gt;page);</span><br><span class="line">2521                 &#125;</span><br><span class="line">2522                 if (reuse_swap_page(vmf-&gt;page, &amp;total_map_swapcount)) &#123;</span><br><span class="line">2523                         if (total_map_swapcount &#x3D;&#x3D; 1) &#123;</span><br><span class="line">2524                                 &#x2F;*</span><br><span class="line">2525                                 |* The page is all ours. Move it to</span><br><span class="line">2526                                 |* our anon_vma so the rmap code will</span><br><span class="line">2527                                 |* not search our parent or siblings.</span><br><span class="line">2528                                 |* Protected against the rmap code by</span><br><span class="line">2529                                 |* the page lock.</span><br><span class="line">2530                                 |*&#x2F;</span><br><span class="line">2524                                 &#x2F;*</span><br><span class="line">2525                                 |* The page is all ours. Move it to</span><br><span class="line">2526                                 |* our anon_vma so the rmap code will</span><br><span class="line">2527                                 |* not search our parent or siblings.</span><br><span class="line">2528                                 |* Protected against the rmap code by</span><br><span class="line">2529                                 |* the page lock.</span><br><span class="line">2530                                 |*&#x2F;</span><br><span class="line">2531                                 page_move_anon_rmap(vmf-&gt;page, vma);</span><br><span class="line">2532                         &#125;</span><br><span class="line">2533                         unlock_page(vmf-&gt;page);</span><br><span class="line">2534                         wp_page_reuse(vmf);</span><br><span class="line">2535                         return VM_FAULT_WRITE;</span><br><span class="line">2536                 &#125;</span><br><span class="line">2537                 unlock_page(vmf-&gt;page);</span><br><span class="line">2538         &#125; else if (unlikely((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) &#x3D;&#x3D;</span><br><span class="line">2539                                         (VM_WRITE|VM_SHARED))) &#123;</span><br><span class="line">2540                 return wp_page_shared(vmf);</span><br><span class="line">2541         &#125;</span><br></pre></td></tr></table></figure>

<p>2506行 对于<strong>匿名页面且非KSM</strong>页<br>2522行 <strong>判断是否这个页面只被我所拥有</strong>（total_map_swapcount &lt;= 0）<br>2534 调用wp_page_reuse处理（这是重点）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">2195 &#x2F;*</span><br><span class="line">2196  * Handle write page faults for pages that can be reused in the current vma</span><br><span class="line">2197  *</span><br><span class="line">2198  * This can happen either due to the mapping being with the VM_SHARED flag,</span><br><span class="line">2199  * or due to us being the last reference standing to the page. In either</span><br><span class="line">2200  * case, all we need to do here is to mark the page as writable and update</span><br><span class="line">2201  * any related book-keeping.</span><br><span class="line">2202  *&#x2F;</span><br><span class="line">2203 static inline void wp_page_reuse(struct vm_fault *vmf)</span><br><span class="line">2204         __releases(vmf-&gt;ptl)</span><br><span class="line">2205 &#123;</span><br><span class="line">2206         struct vm_area_struct *vma &#x3D; vmf-&gt;vma;</span><br><span class="line">2207         struct page *page &#x3D; vmf-&gt;page;</span><br><span class="line">2208         pte_t entry;</span><br><span class="line">2209         &#x2F;*</span><br><span class="line">2210         |* Clear the pages cpupid information as the existing</span><br><span class="line">2211         |* information potentially belongs to a now completely</span><br><span class="line">2212         |* unrelated process.</span><br><span class="line">2213         |*&#x2F;</span><br><span class="line">2214         if (page)</span><br><span class="line">2215                 page_cpupid_xchg_last(page, (1 &lt;&lt; LAST_CPUPID_SHIFT) - 1);</span><br><span class="line">2216</span><br><span class="line">2217         flush_cache_page(vma, vmf-&gt;address, pte_pfn(vmf-&gt;orig_pte));</span><br><span class="line">2218         entry &#x3D; pte_mkyoung(vmf-&gt;orig_pte);</span><br><span class="line">2219         entry &#x3D; maybe_mkwrite(pte_mkdirty(entry), vma);</span><br><span class="line">2220         if (ptep_set_access_flags(vma, vmf-&gt;address, vmf-&gt;pte, entry, 1))</span><br><span class="line">2221                 update_mmu_cache(vma, vmf-&gt;address, vmf-&gt;pte);</span><br><span class="line">2222         pte_unmap_unlock(vmf-&gt;pte, vmf-&gt;ptl);</span><br><span class="line">2223 &#125;</span><br></pre></td></tr></table></figure>

<p>代码中可以清晰看到：<br>2218行 <strong>设置页被访问</strong><br>2219行 <strong>设置页表项为脏，如果页所在的vma是可写属性则设置页表项值为可写</strong><br>2220行 <strong>将设置好的页表项值写入到页表项条目中</strong>（真正设置好了页表项），注意arm64中在ptep_set_access_flags刷新了页对应的tlb。</p>
<p>分析到这里，有关COW的机制已经全部分析完，当然这个过程涉及到了无数的技术细节，在此不再一一赘述，后面有机会会讨论到相关的内容。</p>
<h2 id="五，总结"><a href="#五，总结" class="headerlink" title="五，总结"></a>五，总结</h2><p>我们总结一下写时复制（COW）机制的整个过程：首先发生在父进程fork子进程的时候，父子进程会共享（此共享并不是我们通常所说的共享映射和私有映射，而是通过将页映射到每个进程页表形成共享）所有的私有可写的物理页，并将父子进程对应的页表项修改为只读，当有一方试图写共享的物理页，由于页表项属性是只读的会发生COW缺页异常，缺页异常处理程序会为写操作的一方分配新的物理页，并将原来共享的物理页内容拷贝到新页，然后建立新页的页表映射关系，这样写操作的进程就可以继续执行，不会影响另一方，父子进程对共享的私有页面访问就分道扬镳了，当共享的页面最终只有一个拥有者（即是其他映射页面到自己页表的进程都发生写时复制分配了新的物理页），这个时候如果拥有者进程想要写这个页就会重新使用这个页而不用分配新页。</p>
<p>下面给出实验代码案例：<br>程序中有一全局变量num=10 打印num的值, 然后fork子进程，在子进程中修改全局变量num=100 然后打印num的值,父进程中睡眠1s故意等待子进程先执行完， 然后再次打印num的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> 1 #include &lt;stdio.h&gt;</span><br><span class="line"> 2 #include &lt;unistd.h&gt;</span><br><span class="line"> 3 #include &lt;sys&#x2F;types.h&gt;</span><br><span class="line"> 4 </span><br><span class="line"> 5 </span><br><span class="line"> 6 int num &#x3D; 10;</span><br><span class="line"> 7 </span><br><span class="line"> 8 int main(int argc,char **argv)</span><br><span class="line"> 9 &#123;</span><br><span class="line">10 </span><br><span class="line">11         pid_t pid;</span><br><span class="line">12 </span><br><span class="line">13         printf(&quot;###%s:%d  pid&#x3D;%d num&#x3D;%d###\n&quot;, __func__, __LINE__,  getpid(), num);</span><br><span class="line">14 </span><br><span class="line">15 </span><br><span class="line">16         pid &#x3D; fork();</span><br><span class="line">17         if (pid &lt; 0) &#123;</span><br><span class="line">18                 printf(&quot;fail to fork\n&quot;);</span><br><span class="line">19                 return -1;</span><br><span class="line">20         &#125; else if (pid &#x3D;&#x3D; 0) &#123; &#x2F;&#x2F;child process</span><br><span class="line">21                 num &#x3D; 100;</span><br><span class="line">22                 printf(&quot;### This is child process pid&#x3D;%d  num&#x3D;%d###\n&quot;, getpid(), num);</span><br><span class="line">23                 _exit(0);</span><br><span class="line">24         &#125; else &#123; &#x2F;&#x2F;parent process</span><br><span class="line">25                 sleep(1);</span><br><span class="line">26                 printf(&quot;### This is parent process  pid&#x3D;%d  num&#x3D;%d###\n&quot;, getpid(), num);</span><br><span class="line">27                 _exit(0);</span><br><span class="line">28         &#125;</span><br><span class="line">29 </span><br><span class="line">30         return 0;</span><br><span class="line">31 &#125;</span><br></pre></td></tr></table></figure>

<p>大家可以思考一下：第13，22, 27分别得出的num是多少？<br>我们编译执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hanch@hanch-VirtualBox:~&#x2F;test&#x2F;COW$ gcc fork-cow-test.c -o fork-cow-test</span><br><span class="line">hanch@hanch-VirtualBox:~&#x2F;test&#x2F;COW$ .&#x2F;fork-cow-test </span><br><span class="line">###main:13  pid&#x3D;26844 num&#x3D;10###</span><br><span class="line">### This is child process pid&#x3D;26845  num&#x3D;100###</span><br><span class="line">### This is parent process  pid&#x3D;26844  num&#x3D;10###</span><br></pre></td></tr></table></figure>

<p>可以发现父进程中的全局变量num =10, 当fork子进程后对这个全局变量进行了修改使得num =100,实际上fork的时候已经将父子进程的num这个全局变量所在的页修改为了只读，然后共享这个页，当子进程写这个全局变量的时候发生了COW缺页异常，然而这对于应用程序来说是透明的，内核却在缺页异常处理中做了很多工作：主要是为子进程分配物理页，将父进程的num所在的页内容拷贝到子进程，然后将子进程的va所对应的的页表条目修改为可写和分配的物理页建立了映射关系，然后缺页异常就返回了（从内核空间返回到了用户空间），这个时候处理器会重新执行赋值操作指令，这个时候属于子进程的num才被改写为100，但是要明白这个时候父进程的num变量所在的页的读写属性还是只读，父进程再去写的时候依然会发生COW缺页异常。</p>
<p>最后我们用图说话来理解COW的整个过程：</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/Ass1lsY6byuhcmomXpTGC8jxKCsr8icJ0iauXplOlgzYu79CWfFziaaElzeXzEDjLPfwzyP1l3oHdLkR0HJfyFxMg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="img"></p>
<h1 id="END"><a href="#END" class="headerlink" title="(END)"></a>(END)</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/29/Linux/Driver/PCIe/PCI-Express%20%E5%A4%84%E7%90%86%E5%99%A8DMA%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/29/Linux/Driver/PCIe/PCI-Express%20%E5%A4%84%E7%90%86%E5%99%A8DMA%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">PCI-Express 处理器DMA实现方案</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-29 10:41:57" itemprop="dateCreated datePublished" datetime="2020-07-29T10:41:57+08:00">2020-07-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-02-07 16:12:47" itemprop="dateModified" datetime="2021-02-07T16:12:47+08:00">2021-02-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/" itemprop="url" rel="index"><span itemprop="name">Driver</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/PCIe/" itemprop="url" rel="index"><span itemprop="name">PCIe</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>工程项目中，使用PCIe主要是利用DMA机制，实现高速数据传输。曾经接触过一个项目，采用x86+FPGA方案实现高速数据采集。该方案，使用FPGA自带的PCIe核与x86进行DMA数据传输。本文讲解在x86下Linux 实现DMA的方案，不讲FPGA内部PCIe实现逻辑。</p>
<h2 id="DMA基础知识"><a href="#DMA基础知识" class="headerlink" title="DMA基础知识"></a>DMA基础知识</h2><p>在PCIE中有两种数据传输方式：</p>
<p><strong>DMA(Direct Memory Access)直接内存访问:</strong>在该模式下，数据传送不是由CPU负责处理，而是由一个特殊的处理器DMA控制器来完成，因此占用极少的CPU资源。</p>
<p><strong>PIO(Programmed Input-Output)，可编程输入输出:</strong>在该模式下，数据传送由CPU执行I/O端口指令来按照字节或更大的数据单位来处理，占用大量的CPU资源，数据传输速度也大大低于DMA模式。举例老说，在DMA方式下，如果copy文件的同时在播放mp3音乐，则不受丝毫影响；如果在PIO模式下，则会发现音乐声时断时续，这是因为大部分CPU资源被文件传输占用。</p>
<p>总的来说，DMA模式与PIO相比有很大优势，PIO数据传输直接由CPU执行，通常每次只能传输一个DW数据，在大量数据传输中会占用较多CPU资源，导致传输速度不足；然而对于大数据传输，DMA实现会带来更高的数据吞吐量，因为DMA硬件引擎不限于一个或两个DW传输。此外，DMA引擎通过直接传输数据来卸载CPU，从而通过较低的CPU利用率提高整个系统的性能。</p>
<p>DMA核的逻辑设计图如下</p>
<p><img src="http://jiali.clouddn.com/20200729_002.png" alt=""></p>
<p>硬件实现了DMA机制，Linux要做的事情：</p>
<ul>
<li>分配一块物理地址连续的内存区域，用于DMA传输</li>
<li>设置FPGA的BAR0空间的DMA起始地址寄存器</li>
<li>使能DMA传输</li>
</ul>
<h2 id="DMA写（FPGA往CPU的内存写数据）"><a href="#DMA写（FPGA往CPU的内存写数据）" class="headerlink" title="DMA写（FPGA往CPU的内存写数据）"></a>DMA写（FPGA往CPU的内存写数据）</h2><p>DMA参考设计图</p>
<p><img src="http://jiali.clouddn.com/20200729_003.png" alt=""></p>
<h3 id="工程实践"><a href="#工程实践" class="headerlink" title="工程实践"></a>工程实践</h3><p>FPGA PCIe总线的BAR0空间内的寄存器列表</p>
<p><img src="http://jiali.clouddn.com/20200729_004.png" alt=""></p>
<p>DMA控制寄存器列表如下：</p>
<p><img src="http://jiali.clouddn.com/20200729_005.png" alt=""></p>
<p>中断控制寄存器列表如下：</p>
<p><img src="http://jiali.clouddn.com/20200729_006.png" alt=""></p>
<p>DMA写内存实现过程如下：</p>
<p>(1)分配一块物理地址连续的内存区域，用于存储DMA传输过来的数据。</p>
<p>(2)配置好msi中断。</p>
<p>(3)配置突发长度寄存器。</p>
<p>(4)配置DMA的目的地址寄存器。</p>
<p>(5)使能DMA控制寄存器，启动DMA传输。</p>
<p>(6)FPGA向主机发起写TLP请求，并将数据放入TLP包中—连续发出多个写请求</p>
<p>(7)FPGA发送完数据后通过中断等形式通知主机DMA完成</p>
<p>(8)等待MSI中断，主机从内存中获取数据。在MSI中断处理服务函数，操作地址偏移和重新配置DMA的目的地址寄存器，然后再次使能DMA。</p>
<p>配置好之后，重复6-8顺序的动作。FPGA只管发数据，Linux驱动等待中断，中断来就读取DMA内存区域的数据，中间的过程都是硬件完成。</p>
<p><strong>注意：</strong></p>
<p>DMA写DDR请求，发送的是TLP包，所以需要两端设备约定好Max_Payload_Size.</p>
<p>往CPU的DDR地址0xfdaff040写入0x12345678，DDR地址0xfdaff040对应的PCIe总线域地址为0x3f6bfc10，一个简单的TLP写请求包的例子如下：</p>
<p><img src="http://jiali.clouddn.com/20200729_007.png" alt=""></p>
<p>软件实现方案</p>
<p><img src="http://jiali.clouddn.com/20200729_013.png" alt=""></p>
<h2 id="FPGA-读CPU的DDR数据过程"><a href="#FPGA-读CPU的DDR数据过程" class="headerlink" title="FPGA 读CPU的DDR数据过程"></a>FPGA 读CPU的DDR数据过程</h2><p><strong>DMA读内存的过程：</strong></p>
<p>(1)分配一块物理地址连续的内存区域。</p>
<p>(2)配置好msi中断。</p>
<p>(3)配置突发长度寄存器。</p>
<p>(4)配置DMA读取内存的地址寄存器。</p>
<p>(5)主机向该内存区域写入数据。</p>
<p>(6)使能DMA读内存控制寄存器，启动DMA传输。</p>
<p>(7)FPGA向主机发起读TLP请求—连续发出多个读请求。</p>
<p>(8)主机向FPGA返回CPLD包—连续返回多个CPLD。</p>
<p>(9)FPGA取出CPLD包中的有效数据。</p>
<p>(10)FPGA发送完数据后通过中断等形式通知主机DMA完成。</p>
<p>(11)主机收到MSI中断，操作地址偏移和重新配置DMA的目的地址寄存器，然后再次使能DMA，启动读操作；直到数据读取结束，不在使能DMA读控制寄存器。</p>
<h3 id="实践：实现FPGA升级功能"><a href="#实践：实现FPGA升级功能" class="headerlink" title="实践：实现FPGA升级功能"></a>实践：实现FPGA升级功能</h3><p>设计框架如下：</p>
<p><img src="http://jiali.clouddn.com/20200729_008.png" alt=""></p>
<p>FPGA升级功能相关寄存器列表</p>
<p><img src="http://jiali.clouddn.com/20200729_009.png" alt=""></p>
<p>操作过程如下图:</p>
<p><img src="http://jiali.clouddn.com/20200729_010.png" alt=""></p>
<p>软件实现流程</p>
<p><img src="http://jiali.clouddn.com/20200729_012.png" alt=""></p>
<h2 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h2><p>How does DMA work with PCI Express devices?</p>
<p>A PCI based bus has no “DMA Controller” in form of a chip or a sub circuit in the chipset. Every device on the bus can become a bus master. The main memory is always a slave.</p>
<p>Let’s assume you have build your own PCIe device card, which can act as an PCI master and your program (running on CPU) wants to send data from that card to main memory (4 MiB).</p>
<p>The device driver knows the memory mapping for that particular memory region from operating system (some keywords: memory mapped I/O, PCI bus enumeration, PCI BARs, ).</p>
<p>The driver transfers the command (write), source-address, destination-address and length to the device. This can be done by sending bytes to a special address inside an pre-defined BAR or by writing into the PCI config space. The DMA master on the cards checks these special regions for new tasks (scatter-gather lists). If so, theses tasks get enqueued.</p>
<p>Now the DMA master knows where to send, how many data. He will read the data from local memory and wrap it into 512 byte TLPs of max payload size (the max payload size on path device &lt;—&gt; main memory is known from enumeration) and send it to the destination address. The PCI address-based routing mechanisms direct these TLPs to the main memory.</p>
<p>参考：</p>
<p><a href="http://xillybus.com/tutorials/pci-express-tlp-pcie-primer-tutorial-guide-1" target="_blank" rel="noopener">Down to the TLP: How PCI express devices talk (Part I)</a></p>
<p><a href="http://www.hitechglobal.com/IPCores/DMA_Back_End.htm" target="_blank" rel="noopener">PCI Express Block DMA/SGDMA IP Solution</a></p>
<p><a href="https://www.cnblogs.com/chengqi521/p/8512510.html" target="_blank" rel="noopener">PCIE的DMA和PIO介绍</a></p>
<p><a href="https://blog.csdn.net/abcamus/article/details/76167747" target="_blank" rel="noopener">PCIe实践之路：DMA机制</a></p>
<p><a href="http://xilinx.eetrend.com/d6-xilinx/blog/2018-08/13333.html" target="_blank" rel="noopener">PCIe学习（二）——PCIe DMA关键模块分析之一</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/28/ubuntu/ubuntu%E4%B8%ADQT%E6%97%A0%E6%B3%95%E5%88%87%E6%8D%A2%E4%B8%AD%E6%96%87%E8%BE%93%E5%85%A5%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/28/ubuntu/ubuntu%E4%B8%ADQT%E6%97%A0%E6%B3%95%E5%88%87%E6%8D%A2%E4%B8%AD%E6%96%87%E8%BE%93%E5%85%A5%E6%B3%95/" class="post-title-link" itemprop="url">ubuntu中QT无法切换中文输入法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-28 13:41:31" itemprop="dateCreated datePublished" datetime="2020-07-28T13:41:31+08:00">2020-07-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-29 10:19:40" itemprop="dateModified" datetime="2020-07-29T10:19:40+08:00">2020-07-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ubuntu/" itemprop="url" rel="index"><span itemprop="name">ubuntu</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在ubuntu下，系统自带的输入法为fcitx+Sunpinyin,然而QtCreator无法使用系统自带的中文输入法。原因是前下载的QtCreator中没有适配当前输入法框架（ibus、fcitx）的libfcitxplatforminputcontextplugin.so动态库。</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>已经安装好的qt，且配置好环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export QT_PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;qt</span><br><span class="line">export PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;cmake&#x2F;bin:$QT_PATH&#x2F;5.4&#x2F;gcc_64&#x2F;bin:$QT_PATH&#x2F;Tools&#x2F;QtCreator&#x2F;bin:$PATH</span><br></pre></td></tr></table></figure>

<p>1、下载fcitx-libs 源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;fcitx&#x2F;fcitx-qt5.git</span><br></pre></td></tr></table></figure>

<p>2、编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd fcitx-qt5</span><br><span class="line">cmake .</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p>3、编译产生的 libfcitxplatforminputcontextplugin.so在fcitx-qt5/platforminputcontext下，拷贝这个so文件到 Qt5.5安装目录（非必须，因为安装后，会自动拷贝这个so文件到qt的安装目录）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd fcitx-qt5&#x2F;platforminputcontext </span><br><span class="line">cp libfcitxplatforminputcontextplugin.so &#x2F;usr&#x2F;local&#x2F;bin&#x2F;qt&#x2F;5.4&#x2F;gcc_64&#x2F;plugins&#x2F;platforminputcontexts -a</span><br><span class="line">cp libfcitxplatforminputcontextplugin.so &#x2F;usr&#x2F;local&#x2F;bin&#x2F;qt&#x2F;Tools&#x2F;QtCreator&#x2F;bin&#x2F;plugins&#x2F;platforminputcontexts -a</span><br></pre></td></tr></table></figure>

<p>4、重启QtCreator就可以使用系统自带的fcitx输入法了。</p>
<p><strong>编译fcitx-qt5库遇到缺失依赖库的问题：</strong></p>
<p>问题1：第一次编译 fcitx-qt5，会遇到的问题如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;fcitx-qt5# cmake .</span><br><span class="line">-- The C compiler identification is GNU 7.5.0</span><br><span class="line">-- The CXX compiler identification is GNU 7.5.0</span><br><span class="line">-- Check for working C compiler: &#x2F;usr&#x2F;bin&#x2F;cc</span><br><span class="line">-- Check for working C compiler: &#x2F;usr&#x2F;bin&#x2F;cc -- works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - done</span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - done</span><br><span class="line">-- Check for working CXX compiler: &#x2F;usr&#x2F;bin&#x2F;c++</span><br><span class="line">-- Check for working CXX compiler: &#x2F;usr&#x2F;bin&#x2F;c++ -- works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - done</span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - done</span><br><span class="line">CMake Error at CMakeLists.txt:8 (find_package):</span><br><span class="line">  Could not find a package configuration file provided by &quot;ECM&quot; (requested</span><br><span class="line">  version 1.4.0) with any of the following names:</span><br><span class="line"></span><br><span class="line">    ECMConfig.cmake</span><br><span class="line">    ecm-config.cmake</span><br><span class="line"></span><br><span class="line">  Add the installation prefix of &quot;ECM&quot; to CMAKE_PREFIX_PATH or set &quot;ECM_DIR&quot;</span><br><span class="line">  to a directory containing one of the above files.  If &quot;ECM&quot; provides a</span><br><span class="line">  separate development package or SDK, be sure it has been installed.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- Configuring incomplete, errors occurred!</span><br><span class="line">See also &quot;&#x2F;root&#x2F;fcitx-qt5&#x2F;CMakeFiles&#x2F;CMakeOutput.log&quot;.</span><br></pre></td></tr></table></figure>

<p>解决方法：</p>
<p>下载extra-cmake-modules</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# git clone https:&#x2F;&#x2F;github.com&#x2F;KDE&#x2F;extra-cmake-modules.git</span><br><span class="line">root@ubuntu:~# cd extra-cmake-modules&#x2F;</span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;extra-cmake-modules# cmake .</span><br><span class="line">-- Could NOT find Sphinx (missing:  Sphinx_BUILD_EXECUTABLE) (Required is at least version &quot;1.2&quot;)</span><br><span class="line">-- Found QCollectionGenerator: &#x2F;usr&#x2F;local&#x2F;bin&#x2F;qt&#x2F;5.4&#x2F;gcc_64&#x2F;bin&#x2F;qcollectiongenerator (found version &quot;1.0&quot;) </span><br><span class="line">-- The C compiler identification is GNU 7.5.0</span><br><span class="line">-- Check for working C compiler: &#x2F;usr&#x2F;bin&#x2F;cc</span><br><span class="line">-- Check for working C compiler: &#x2F;usr&#x2F;bin&#x2F;cc -- works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - done</span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - done</span><br><span class="line">-- WARNING: skipping tests that require PyQt</span><br><span class="line">-- </span><br><span class="line">-- The following features have been enabled:</span><br><span class="line"></span><br><span class="line"> * BUILD_TESTING , Build automated tests.</span><br><span class="line"></span><br><span class="line">-- The following OPTIONAL packages have been found:</span><br><span class="line"></span><br><span class="line"> * QCollectionGenerator , Qt help collection generator. , &lt;https:&#x2F;&#x2F;www.qt.io&#x2F;&gt;</span><br><span class="line">   Required to build Extra CMake Modules documentation in Qt Help format.</span><br><span class="line"> * Qt5LinguistTools , Qt5 linguist tools. , &lt;https:&#x2F;&#x2F;www.qt.io&#x2F;&gt;</span><br><span class="line">   Required to run tests for the ECMPoQmTools module.</span><br><span class="line"> * Qt5Core , Qt5 core library. , &lt;https:&#x2F;&#x2F;www.qt.io&#x2F;&gt;</span><br><span class="line">   Required to run tests for the ECMQtDeclareLoggingCategory module, and for some tests of the KDEInstallDirs module.</span><br><span class="line"> * Qt5Gui (required version &gt;&#x3D; 5.4.1)</span><br><span class="line"> * Qt5Network (required version &gt;&#x3D; 5.4.1)</span><br><span class="line"> * Qt5Qml (required version &gt;&#x3D; 5.4.1)</span><br><span class="line"> * Qt5Quick , Qt5 Quick library. , &lt;https:&#x2F;&#x2F;www.qt.io&#x2F;&gt;</span><br><span class="line">   Required to run tests for the ECMQMLModules module.</span><br><span class="line"></span><br><span class="line">-- The following features have been disabled:</span><br><span class="line"></span><br><span class="line"> * BUILD_HTML_DOCS , Generate HTML documentation for installed modules.</span><br><span class="line"> * BUILD_MAN_DOCS , Generate man page documentation for installed modules.</span><br><span class="line"> * BUILD_QTHELP_DOCS , Generate QtHelp documentation for installed modules.</span><br><span class="line"></span><br><span class="line">-- The following OPTIONAL packages have not been found:</span><br><span class="line"></span><br><span class="line"> * Sphinx (required version &gt;&#x3D; 1.2) , Tool to generate documentation. , &lt;https:&#x2F;&#x2F;www.sphinx-doc.org&#x2F;&gt;</span><br><span class="line">   Required to build documentation for Extra CMake Modules.</span><br><span class="line"></span><br><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">-- Build files have been written to: &#x2F;root&#x2F;extra-cmake-modules</span><br></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;extra-cmake-modules# make install</span><br><span class="line">Install the project...</span><br><span class="line">-- Install configuration: &quot;&quot;</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMSetupQtPluginMacroNames.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMAddAppIcon.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMFindQMLModule.cmake.in</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMAddQtDesignerPlugin.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMQtDeclareLoggingCategory.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMQmLoader.cpp.in</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMWinResolveSymlinks.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMUninstallTarget.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMMarkAsTest.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMQueryQmake.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMGenerateExportHeader.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMEnableSanitizers.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMOptionalAddSubdirectory.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMCoverageOption.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMQtDeclareLoggingCategory.cpp.in</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMConfiguredInstall.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMQMLModules.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMFindModuleHelpers.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMMarkNonGuiExecutable.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMPoQmTools.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMCreateQmFromPoFiles.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMGenerateDBusServiceFile.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMGenerateHeaders.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMPackageConfigHelpers.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMInstallIcons.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMQtDeclareLoggingCategory.h.in</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ecm_uninstall.cmake.in</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMGenerateQmlTypes.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMGeneratePriFile.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMSetupVersion.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMQchDoxygenLayout.xml</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMQchDoxygen.config.in</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMAddQch.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMAddTests.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMSourceVersionControl.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMVersionHeader.h.in</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMUseFindModules.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;modules&#x2F;ECMGeneratePkgConfigFile.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;test-modules&#x2F;test_execute_and_compare.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;kde-modules&#x2F;prefix.sh.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;kde-modules&#x2F;appstreamtest.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;kde-modules&#x2F;KDEClangFormat.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;kde-modules&#x2F;KDECompilerSettings.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;kde-modules&#x2F;KDEPackageAppTemplates.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;kde-modules&#x2F;clang-format.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;kde-modules&#x2F;KDECMakeSettings.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;kde-modules&#x2F;KDEFrameworkCompilerSettings.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;kde-modules&#x2F;KDEInstallDirs.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindXCB.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindWaylandScanner.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindX11_XCB.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindPythonModuleGeneration.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindOpenEXR.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindKF5.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindQtWaylandScanner.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindLibGit2.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindInotify.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindGperf.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindSeccomp.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindPhoneNumber.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindUDev.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindTaglib.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindSharedMimeInfo.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindQHelpGenerator.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindGLIB2.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindCanberra.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindSasl2.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;GeneratePythonBindingUmbrellaModule.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindEGL.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindPoppler.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindWayland.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindFontconfig.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindLibExiv2.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;ECMFindModuleHelpersStub.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindIcoTool.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;FindPulseAudio.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;rules_engine.py</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;run-sip.py</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;sip_generator.py</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;find-modules&#x2F;Qt5Ruleset.py</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;toolchain&#x2F;hasMainSymbol.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;toolchain&#x2F;deployment-file-qt514.json.in</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;toolchain&#x2F;ECMAndroidDeployQt.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;toolchain&#x2F;deployment-file.json.in</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;toolchain&#x2F;specifydependencies.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;toolchain&#x2F;Android.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;cmake&#x2F;ECMConfig.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;ECM&#x2F;cmake&#x2F;ECMConfigVersion.cmake</span><br></pre></td></tr></table></figure>

<p>问题2：再次编译fcitx-qt5，会遇到问题如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;fcitx-qt5# cmake .</span><br><span class="line">-- Performing Test SUPPORT_CXX11</span><br><span class="line">-- Performing Test SUPPORT_CXX11 - Success</span><br><span class="line">-- Found PkgConfig: &#x2F;usr&#x2F;bin&#x2F;pkg-config (found version &quot;0.29.1&quot;) </span><br><span class="line">-- Could NOT find XKBCommon_XKBCommon (missing:  XKBCommon_XKBCommon_LIBRARY XKBCommon_XKBCommon_INCLUDE_DIR) </span><br><span class="line">CMake Error at &#x2F;usr&#x2F;share&#x2F;cmake-3.5&#x2F;Modules&#x2F;FindPackageHandleStandardArgs.cmake:148 (message):</span><br><span class="line">  Could NOT find XKBCommon (missing: XKBCommon_LIBRARIES XKBCommon) (Required</span><br><span class="line">  is at least version &quot;0.5.0&quot;)</span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  &#x2F;usr&#x2F;share&#x2F;cmake-3.5&#x2F;Modules&#x2F;FindPackageHandleStandardArgs.cmake:388 (_FPHSA_FAILURE_MESSAGE)</span><br><span class="line">  cmake&#x2F;FindXKBCommon.cmake:30 (find_package_handle_standard_args)</span><br><span class="line">  CMakeLists.txt:33 (find_package)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- Configuring incomplete, errors occurred!</span><br><span class="line">See also &quot;&#x2F;root&#x2F;fcitx-qt5&#x2F;CMakeFiles&#x2F;CMakeOutput.log&quot;.</span><br></pre></td></tr></table></figure>

<p>解决方法：</p>
<p><a href="http://xkbcommon.org/" target="_blank" rel="noopener">http://xkbcommon.org/</a> 下载xkbcommon（本文下次0.8.4）</p>
<p>进入xkbcommon配置并编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;libxkbcommon-0.8.4# .&#x2F;configure --disable-x11</span><br><span class="line">checking for a BSD-compatible install... &#x2F;usr&#x2F;bin&#x2F;install -c</span><br><span class="line">checking whether build environment is sane... yes</span><br><span class="line">checking for a thread-safe mkdir -p... &#x2F;bin&#x2F;mkdir -p</span><br><span class="line">checking for gawk... no</span><br><span class="line">checking for mawk... mawk</span><br><span class="line">checking whether make sets $(MAKE)... yes</span><br><span class="line">checking whether make supports nested variables... yes</span><br><span class="line">checking whether to enable maintainer-specific portions of Makefiles... yes</span><br><span class="line">checking whether make supports the include directive... yes (GNU style)</span><br><span class="line">checking for gcc... gcc</span><br><span class="line">checking whether the C compiler works... yes</span><br><span class="line">checking for C compiler default output file name... a.out</span><br><span class="line">checking for suffix of executables... </span><br><span class="line">checking whether we are cross compiling... no</span><br><span class="line">checking for suffix of object files... o</span><br><span class="line">checking whether we are using the GNU C compiler... yes</span><br><span class="line">checking whether gcc accepts -g... yes</span><br><span class="line">checking for gcc option to accept ISO C89... none needed</span><br><span class="line">checking whether gcc understands -c and -o together... yes</span><br><span class="line">checking dependency style of gcc... gcc3</span><br><span class="line">checking how to run the C preprocessor... gcc -E</span><br><span class="line">checking for grep that handles long lines and -e... &#x2F;bin&#x2F;grep</span><br><span class="line">checking for egrep... &#x2F;bin&#x2F;grep -E</span><br><span class="line">checking for ANSI C header files... yes</span><br><span class="line">checking for sys&#x2F;types.h... yes</span><br><span class="line">checking for sys&#x2F;stat.h... yes</span><br><span class="line">checking for stdlib.h... yes</span><br><span class="line">checking for string.h... yes</span><br><span class="line">checking for memory.h... yes</span><br><span class="line">checking for strings.h... yes</span><br><span class="line">checking for inttypes.h... yes</span><br><span class="line">checking for stdint.h... yes</span><br><span class="line">checking for unistd.h... yes</span><br><span class="line">checking minix&#x2F;config.h usability... no</span><br><span class="line">checking minix&#x2F;config.h presence... no</span><br><span class="line">checking for minix&#x2F;config.h... no</span><br><span class="line">checking whether it is safe to define __EXTENSIONS__... yes</span><br><span class="line">checking build system type... x86_64-pc-linux-gnu</span><br><span class="line">checking host system type... x86_64-pc-linux-gnu</span><br><span class="line">checking how to print strings... printf</span><br><span class="line">checking for a sed that does not truncate output... &#x2F;bin&#x2F;sed</span><br><span class="line">checking for fgrep... &#x2F;bin&#x2F;grep -F</span><br><span class="line">checking for ld used by gcc... &#x2F;usr&#x2F;bin&#x2F;ld</span><br><span class="line">checking if the linker (&#x2F;usr&#x2F;bin&#x2F;ld) is GNU ld... yes</span><br><span class="line">checking for BSD- or MS-compatible name lister (nm)... &#x2F;usr&#x2F;bin&#x2F;nm -B</span><br><span class="line">checking the name lister (&#x2F;usr&#x2F;bin&#x2F;nm -B) interface... BSD nm</span><br><span class="line">checking whether ln -s works... yes</span><br><span class="line">checking the maximum length of command line arguments... 1572864</span><br><span class="line">checking how to convert x86_64-pc-linux-gnu file names to x86_64-pc-linux-gnu format... func_convert_file_noop</span><br><span class="line">checking how to convert x86_64-pc-linux-gnu file names to toolchain format... func_convert_file_noop</span><br><span class="line">checking for &#x2F;usr&#x2F;bin&#x2F;ld option to reload object files... -r</span><br><span class="line">checking for objdump... objdump</span><br><span class="line">checking how to recognize dependent libraries... pass_all</span><br><span class="line">checking for dlltool... no</span><br><span class="line">checking how to associate runtime and link libraries... printf %s\n</span><br><span class="line">checking for ar... ar</span><br><span class="line">checking for archiver @FILE support... @</span><br><span class="line">checking for strip... strip</span><br><span class="line">checking for ranlib... ranlib</span><br><span class="line">checking command to parse &#x2F;usr&#x2F;bin&#x2F;nm -B output from gcc object... ok</span><br><span class="line">checking for sysroot... no</span><br><span class="line">checking for a working dd... &#x2F;bin&#x2F;dd</span><br><span class="line">checking how to truncate binary pipes... &#x2F;bin&#x2F;dd bs&#x3D;4096 count&#x3D;1</span><br><span class="line">checking for mt... mt</span><br><span class="line">checking if mt is a manifest tool... no</span><br><span class="line">checking for dlfcn.h... yes</span><br><span class="line">checking for objdir... .libs</span><br><span class="line">checking if gcc supports -fno-rtti -fno-exceptions... no</span><br><span class="line">checking for gcc option to produce PIC... -fPIC -DPIC</span><br><span class="line">checking if gcc PIC flag -fPIC -DPIC works... yes</span><br><span class="line">checking if gcc static flag -static works... yes</span><br><span class="line">checking if gcc supports -c -o file.o... yes</span><br><span class="line">checking if gcc supports -c -o file.o... (cached) yes</span><br><span class="line">checking whether the gcc linker (&#x2F;usr&#x2F;bin&#x2F;ld -m elf_x86_64) supports shared libraries... yes</span><br><span class="line">checking whether -lc should be explicitly linked in... no</span><br><span class="line">checking dynamic linker characteristics... GNU&#x2F;Linux ld.so</span><br><span class="line">checking how to hardcode library paths into programs... immediate</span><br><span class="line">checking whether stripping libraries is possible... yes</span><br><span class="line">checking if libtool supports shared libraries... yes</span><br><span class="line">checking whether to build shared libraries... yes</span><br><span class="line">checking whether to build static libraries... yes</span><br><span class="line">checking for gcc option to accept ISO C99... none needed</span><br><span class="line">checking whether __clang__ is declared... no</span><br><span class="line">checking whether __INTEL_COMPILER is declared... no</span><br><span class="line">checking whether __SUNPRO_C is declared... no</span><br><span class="line">checking for pkg-config... &#x2F;usr&#x2F;bin&#x2F;pkg-config</span><br><span class="line">checking pkg-config is at least version 0.9.0... yes</span><br><span class="line">checking if gcc supports -Werror&#x3D;unknown-warning-option... no</span><br><span class="line">checking if gcc supports -Werror&#x3D;unused-command-line-argument... no</span><br><span class="line">checking if gcc supports -Wall... yes</span><br><span class="line">checking if gcc supports -Wpointer-arith... yes</span><br><span class="line">checking if gcc supports -Wmissing-declarations... yes</span><br><span class="line">checking if gcc supports -Wformat&#x3D;2... yes</span><br><span class="line">checking if gcc supports -Wstrict-prototypes... yes</span><br><span class="line">checking if gcc supports -Wmissing-prototypes... yes</span><br><span class="line">checking if gcc supports -Wnested-externs... yes</span><br><span class="line">checking if gcc supports -Wbad-function-cast... yes</span><br><span class="line">checking if gcc supports -Wold-style-definition... yes</span><br><span class="line">checking if gcc supports -Wdeclaration-after-statement... yes</span><br><span class="line">checking if gcc supports -Wunused... yes</span><br><span class="line">checking if gcc supports -Wuninitialized... yes</span><br><span class="line">checking if gcc supports -Wshadow... yes</span><br><span class="line">checking if gcc supports -Wmissing-noreturn... yes</span><br><span class="line">checking if gcc supports -Wmissing-format-attribute... yes</span><br><span class="line">checking if gcc supports -Wredundant-decls... yes</span><br><span class="line">checking if gcc supports -Wlogical-op... yes</span><br><span class="line">checking if gcc supports -Werror&#x3D;implicit... yes</span><br><span class="line">checking if gcc supports -Werror&#x3D;nonnull... yes</span><br><span class="line">checking if gcc supports -Werror&#x3D;init-self... yes</span><br><span class="line">checking if gcc supports -Werror&#x3D;main... yes</span><br><span class="line">checking if gcc supports -Werror&#x3D;missing-braces... yes</span><br><span class="line">checking if gcc supports -Werror&#x3D;sequence-point... yes</span><br><span class="line">checking if gcc supports -Werror&#x3D;return-type... yes</span><br><span class="line">checking if gcc supports -Werror&#x3D;trigraphs... yes</span><br><span class="line">checking if gcc supports -Werror&#x3D;array-bounds... yes</span><br><span class="line">checking if gcc supports -Werror&#x3D;write-strings... yes</span><br><span class="line">checking if gcc supports -Werror&#x3D;address... yes</span><br><span class="line">checking if gcc supports -Werror&#x3D;int-to-pointer-cast... yes</span><br><span class="line">checking if gcc supports -Werror&#x3D;pointer-to-int-cast... yes</span><br><span class="line">checking if gcc supports -pedantic... yes</span><br><span class="line">checking if gcc supports -Werror... yes</span><br><span class="line">checking if gcc supports -Werror&#x3D;attributes... yes</span><br><span class="line">Package xorg-macros was not found in the pkg-config search path.</span><br><span class="line">Perhaps you should add the directory containing &#96;xorg-macros.pc&#39;</span><br><span class="line">to the PKG_CONFIG_PATH environment variable</span><br><span class="line">No package &#39;xorg-macros&#39; found</span><br><span class="line">checking whether make supports nested variables... (cached) yes</span><br><span class="line">checking whether to build documentation... yes</span><br><span class="line">checking for doxygen... no</span><br><span class="line">configure: WARNING: doxygen not found - documentation targets will be skipped</span><br><span class="line">checking for inline... inline</span><br><span class="line">checking for pkg-config... (cached) &#x2F;usr&#x2F;bin&#x2F;pkg-config</span><br><span class="line">checking pkg-config is at least version 0.9.0... yes</span><br><span class="line">checking for bison... no</span><br><span class="line">checking for byacc... no</span><br><span class="line">checking for yacc... no</span><br><span class="line">checking for eaccess... yes</span><br><span class="line">checking for euidaccess... yes</span><br><span class="line">checking for mmap... yes</span><br><span class="line">checking for mkostemp... yes</span><br><span class="line">checking for posix_fallocate... yes</span><br><span class="line">checking for secure_getenv... yes</span><br><span class="line">checking for __secure_getenv... no</span><br><span class="line">checking for __builtin_expect... yes</span><br><span class="line">checking for __builtin_popcount... yes</span><br><span class="line">checking linux&#x2F;input.h usability... yes</span><br><span class="line">checking linux&#x2F;input.h presence... yes</span><br><span class="line">checking for linux&#x2F;input.h... yes</span><br><span class="line">checking if gcc supports -fvisibility&#x3D;hidden -fno-strict-aliasing -fsanitize-undefined-trap-on-error... yes</span><br><span class="line">checking if gcc supports -Wextra -Wno-unused-parameter -Wno-missing-field-initializers... yes</span><br><span class="line">checking if gcc supports -Wdocumentation -Wno-documentation-deprecated-sync... no</span><br><span class="line">checking whether the linker accepts -Wl,--no-undefined... yes</span><br><span class="line">checking whether the linker accepts -Wl,--version-script&#x3D;&quot;.&#x2F;xkbcommon.map&quot;... yes</span><br><span class="line">checking that generated files are newer than configure... done</span><br><span class="line">configure: creating .&#x2F;config.status</span><br><span class="line">config.status: creating Makefile</span><br><span class="line">config.status: creating xkbcommon.pc</span><br><span class="line">config.status: creating xkbcommon-x11.pc</span><br><span class="line">config.status: creating doc&#x2F;Doxyfile</span><br><span class="line">config.status: creating src&#x2F;config.h</span><br><span class="line">config.status: executing depfiles commands</span><br><span class="line">config.status: executing libtool commands</span><br><span class="line"></span><br><span class="line">        libxkbcommon 0.8.4</span><br><span class="line"></span><br><span class="line">        libxkbcommon:            yes</span><br><span class="line">        libxkbcommon-x11:        no</span><br><span class="line">        Wayland utilities:       no</span><br><span class="line">        documentation:           yes</span><br><span class="line"></span><br><span class="line">        default XKB rules:       evdev</span><br><span class="line">        default XKB model:       pc105</span><br><span class="line">        default XKB layout:      us</span><br><span class="line">        default XKB variant:     </span><br><span class="line">        default XKB options:     </span><br><span class="line"></span><br><span class="line">        prefix:                  &#x2F;usr&#x2F;local</span><br><span class="line">        includedir:              $&#123;prefix&#125;&#x2F;include</span><br><span class="line">        lib dir:                 $&#123;exec_prefix&#125;&#x2F;lib</span><br><span class="line">        datarootdir:             $&#123;prefix&#125;&#x2F;share</span><br><span class="line">        XKB config root:         &#x2F;usr&#x2F;share&#x2F;X11&#x2F;xkb</span><br><span class="line">        X11 locale root:         $&#123;datarootdir&#125;&#x2F;X11&#x2F;locale</span><br></pre></td></tr></table></figure>

<p>编译会出现如下错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;libxkbcommon-0.8.4# make</span><br><span class="line">  YACC     src&#x2F;xkbcomp&#x2F;parser.c</span><br><span class="line">.&#x2F;build-aux&#x2F;ylwrap: 行 176: yacc: 未找到命令</span><br><span class="line">Makefile:1705: recipe for target &#39;src&#x2F;xkbcomp&#x2F;parser.c&#39; failed</span><br><span class="line">make: *** [src&#x2F;xkbcomp&#x2F;parser.c] Error 127</span><br></pre></td></tr></table></figure>

<p>解决方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;libxkbcommon-0.8.4# apt-get install bison</span><br><span class="line">正在读取软件包列表... 完成</span><br><span class="line">正在分析软件包的依赖关系树       </span><br><span class="line">正在读取状态信息... 完成       </span><br><span class="line">下列软件包是自动安装的并且现在不需要了：</span><br><span class="line">  cpp-5 libisl15 libmpfr4</span><br><span class="line">使用&#39;apt autoremove&#39;来卸载它(它们)。</span><br><span class="line">将会同时安装下列软件：</span><br><span class="line">  libbison-dev</span><br><span class="line">建议安装：</span><br><span class="line">  bison-doc</span><br><span class="line">下列【新】软件包将被安装：</span><br><span class="line">  bison libbison-dev</span><br><span class="line">升级了 0 个软件包，新安装了 2 个软件包，要卸载 0 个软件包，有 1000 个软件包未被升级。</span><br><span class="line">需要下载 605 kB 的归档。</span><br><span class="line">解压缩后会消耗 1,811 kB 的额外空间。</span><br><span class="line">您希望继续执行吗？ [Y&#x2F;n] y</span><br><span class="line">获取:1 http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu bionic&#x2F;main amd64 libbison-dev amd64 2:3.0.4.dfsg-1build1 [339 kB]</span><br><span class="line">获取:2 http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu bionic&#x2F;main amd64 bison amd64 2:3.0.4.dfsg-1build1 [266 kB]</span><br><span class="line">已下载 605 kB，耗时 0秒 (1,369 kB&#x2F;s)</span><br><span class="line">正在选中未选择的软件包 libbison-dev:amd64。</span><br><span class="line">(正在读取数据库 ... 系统当前共安装有 129703 个文件和目录。)</span><br><span class="line">正准备解包 ...&#x2F;libbison-dev_2%3a3.0.4.dfsg-1build1_amd64.deb  ...</span><br><span class="line">正在解包 libbison-dev:amd64 (2:3.0.4.dfsg-1build1) ...</span><br><span class="line">正在选中未选择的软件包 bison。</span><br><span class="line">正准备解包 ...&#x2F;bison_2%3a3.0.4.dfsg-1build1_amd64.deb  ...</span><br><span class="line">正在解包 bison (2:3.0.4.dfsg-1build1) ...</span><br><span class="line">正在设置 libbison-dev:amd64 (2:3.0.4.dfsg-1build1) ...</span><br><span class="line">正在设置 bison (2:3.0.4.dfsg-1build1) ...</span><br><span class="line">update-alternatives: 使用 &#x2F;usr&#x2F;bin&#x2F;bison.yacc 来在自动模式中提供 &#x2F;usr&#x2F;bin&#x2F;yacc (yacc)</span><br><span class="line">正在处理用于 man-db (2.7.5-1) 的触发器 ...</span><br></pre></td></tr></table></figure>

<p>再次编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;libxkbcommon-0.8.4# make</span><br><span class="line">  YACC     src&#x2F;xkbcomp&#x2F;parser.c</span><br><span class="line">updating src&#x2F;xkbcomp&#x2F;parser.h</span><br><span class="line">make  all-am</span><br><span class="line">make[1]: Entering directory &#39;&#x2F;root&#x2F;libxkbcommon-0.8.4&#39;</span><br><span class="line">  CC       src&#x2F;compose&#x2F;parser.lo</span><br><span class="line">  CC       src&#x2F;compose&#x2F;paths.lo</span><br><span class="line">  CC       src&#x2F;compose&#x2F;state.lo</span><br><span class="line">  CC       src&#x2F;compose&#x2F;table.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;action.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;ast-build.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;compat.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;expr.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;include.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;keycodes.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;keymap.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;keymap-dump.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;keywords.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;parser.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;rules.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;scanner.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;symbols.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;types.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;vmod.lo</span><br><span class="line">  CC       src&#x2F;xkbcomp&#x2F;xkbcomp.lo</span><br><span class="line">  CC       src&#x2F;atom.lo</span><br><span class="line">  CC       src&#x2F;context.lo</span><br><span class="line">  CC       src&#x2F;context-priv.lo</span><br><span class="line">  CC       src&#x2F;keysym.lo</span><br><span class="line">  CC       src&#x2F;keysym-utf.lo</span><br><span class="line">  CC       src&#x2F;keymap.lo</span><br><span class="line">  CC       src&#x2F;keymap-priv.lo</span><br><span class="line">  CC       src&#x2F;state.lo</span><br><span class="line">  CC       src&#x2F;text.lo</span><br><span class="line">  CC       src&#x2F;utf8.lo</span><br><span class="line">  CC       src&#x2F;utils.lo</span><br><span class="line">  CCLD     libxkbcommon.la</span><br><span class="line">copying selected object files to avoid basename conflicts...</span><br><span class="line">make[1]: Leaving directory &#39;&#x2F;root&#x2F;libxkbcommon-0.8.4&#39;</span><br></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;libxkbcommon-0.8.4# make install</span><br><span class="line">make  install-am</span><br><span class="line">make[1]: Entering directory &#39;&#x2F;root&#x2F;libxkbcommon-0.8.4&#39;</span><br><span class="line">make[2]: Entering directory &#39;&#x2F;root&#x2F;libxkbcommon-0.8.4&#39;</span><br><span class="line"> &#x2F;bin&#x2F;mkdir -p &#39;&#x2F;usr&#x2F;local&#x2F;lib&#39;</span><br><span class="line"> &#x2F;bin&#x2F;bash .&#x2F;libtool   --mode&#x3D;install &#x2F;usr&#x2F;bin&#x2F;install -c   libxkbcommon.la &#39;&#x2F;usr&#x2F;local&#x2F;lib&#39;</span><br><span class="line">libtool: install: &#x2F;usr&#x2F;bin&#x2F;install -c .libs&#x2F;libxkbcommon.so.0.0.0 &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libxkbcommon.so.0.0.0</span><br><span class="line">libtool: install: (cd &#x2F;usr&#x2F;local&#x2F;lib &amp;&amp; &#123; ln -s -f libxkbcommon.so.0.0.0 libxkbcommon.so.0 || &#123; rm -f libxkbcommon.so.0 &amp;&amp; ln -s libxkbcommon.so.0.0.0 libxkbcommon.so.0; &#125;; &#125;)</span><br><span class="line">libtool: install: (cd &#x2F;usr&#x2F;local&#x2F;lib &amp;&amp; &#123; ln -s -f libxkbcommon.so.0.0.0 libxkbcommon.so || &#123; rm -f libxkbcommon.so &amp;&amp; ln -s libxkbcommon.so.0.0.0 libxkbcommon.so; &#125;; &#125;)</span><br><span class="line">libtool: install: &#x2F;usr&#x2F;bin&#x2F;install -c .libs&#x2F;libxkbcommon.lai &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libxkbcommon.la</span><br><span class="line">libtool: install: &#x2F;usr&#x2F;bin&#x2F;install -c .libs&#x2F;libxkbcommon.a &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libxkbcommon.a</span><br><span class="line">libtool: install: chmod 644 &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libxkbcommon.a</span><br><span class="line">libtool: install: ranlib &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libxkbcommon.a</span><br><span class="line">libtool: finish: PATH&#x3D;&quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;cmake&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;bin&#x2F;qt&#x2F;5.4&#x2F;gcc_64&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;bin&#x2F;qt&#x2F;Tools&#x2F;QtCreator&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;cuda&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin:&#x2F;usr&#x2F;games:&#x2F;usr&#x2F;local&#x2F;games:&#x2F;sbin&quot; ldconfig -n &#x2F;usr&#x2F;local&#x2F;lib</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">Libraries have been installed in:</span><br><span class="line">   &#x2F;usr&#x2F;local&#x2F;lib</span><br><span class="line"></span><br><span class="line">If you ever happen to want to link against installed libraries</span><br><span class="line">in a given directory, LIBDIR, you must either use libtool, and</span><br><span class="line">specify the full pathname of the library, or use the &#39;-LLIBDIR&#39;</span><br><span class="line">flag during linking and do at least one of the following:</span><br><span class="line">   - add LIBDIR to the &#39;LD_LIBRARY_PATH&#39; environment variable</span><br><span class="line">     during execution</span><br><span class="line">   - add LIBDIR to the &#39;LD_RUN_PATH&#39; environment variable</span><br><span class="line">     during linking</span><br><span class="line">   - use the &#39;-Wl,-rpath -Wl,LIBDIR&#39; linker flag</span><br><span class="line">   - have your system administrator add LIBDIR to &#39;&#x2F;etc&#x2F;ld.so.conf&#39;</span><br><span class="line"></span><br><span class="line">See any operating system documentation about shared libraries for</span><br><span class="line">more information, such as the ld(1) and ld.so(8) manual pages.</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line"> &#x2F;bin&#x2F;mkdir -p &#39;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;pkgconfig&#39;</span><br><span class="line"> &#x2F;usr&#x2F;bin&#x2F;install -c -m 644 xkbcommon.pc &#39;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;pkgconfig&#39;</span><br><span class="line"> &#x2F;bin&#x2F;mkdir -p &#39;&#x2F;usr&#x2F;local&#x2F;include&#x2F;xkbcommon&#39;</span><br><span class="line"> &#x2F;usr&#x2F;bin&#x2F;install -c -m 644 xkbcommon&#x2F;xkbcommon.h xkbcommon&#x2F;xkbcommon-compat.h xkbcommon&#x2F;xkbcommon-compose.h xkbcommon&#x2F;xkbcommon-keysyms.h xkbcommon&#x2F;xkbcommon-names.h &#39;&#x2F;usr&#x2F;local&#x2F;include&#x2F;xkbcommon&#39;</span><br><span class="line">make[2]: Leaving directory &#39;&#x2F;root&#x2F;libxkbcommon-0.8.4&#39;</span><br><span class="line">make[1]: Leaving directory &#39;&#x2F;root&#x2F;libxkbcommon-0.8.4&#39;</span><br></pre></td></tr></table></figure>

<p>问题3：再次编译，发现没安装cmake</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;fcitx-qt5# cmake .</span><br><span class="line">-- Found XKBCommon_XKBCommon: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libxkbcommon.so (found version &quot;0.8.4&quot;) </span><br><span class="line">-- Found XKBCommon: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libxkbcommon.so (found suitable version &quot;0.8.4&quot;, minimum required is &quot;0.5.0&quot;) found components:  XKBCommon </span><br><span class="line">CMake Error at CMakeLists.txt:36 (find_package):</span><br><span class="line">  By not providing &quot;FindFcitx.cmake&quot; in CMAKE_MODULE_PATH this project has</span><br><span class="line">  asked CMake to find a package configuration file provided by &quot;Fcitx&quot;, but</span><br><span class="line">  CMake did not find one.</span><br><span class="line"></span><br><span class="line">  Could not find a package configuration file provided by &quot;Fcitx&quot; (requested</span><br><span class="line">  version 4.2.8) with any of the following names:</span><br><span class="line"></span><br><span class="line">    FcitxConfig.cmake</span><br><span class="line">    fcitx-config.cmake</span><br><span class="line"></span><br><span class="line">  Add the installation prefix of &quot;Fcitx&quot; to CMAKE_PREFIX_PATH or set</span><br><span class="line">  &quot;Fcitx_DIR&quot; to a directory containing one of the above files.  If &quot;Fcitx&quot;</span><br><span class="line">  provides a separate development package or SDK, be sure it has been</span><br><span class="line">  installed.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- Configuring incomplete, errors occurred!</span><br><span class="line">See also &quot;&#x2F;root&#x2F;fcitx-qt5&#x2F;CMakeFiles&#x2F;CMakeOutput.log&quot;.</span><br></pre></td></tr></table></figure>

<p>安装cmake</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;fcitx-qt5# apt-get install cmake</span><br></pre></td></tr></table></figure>

<p>重新编译，还是有问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;fcitx-qt5# cmake .</span><br><span class="line">-- The C compiler identification is GNU 7.5.0</span><br><span class="line">-- The CXX compiler identification is GNU 7.5.0</span><br><span class="line">-- Check for working C compiler: &#x2F;usr&#x2F;bin&#x2F;cc</span><br><span class="line">-- Check for working C compiler: &#x2F;usr&#x2F;bin&#x2F;cc -- works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - done</span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - done</span><br><span class="line">-- Check for working CXX compiler: &#x2F;usr&#x2F;bin&#x2F;c++</span><br><span class="line">-- Check for working CXX compiler: &#x2F;usr&#x2F;bin&#x2F;c++ -- works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - done</span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - done</span><br><span class="line">CMake Error at CMakeLists.txt:36 (find_package):</span><br><span class="line">  By not providing &quot;FindFcitx.cmake&quot; in CMAKE_MODULE_PATH this project has</span><br><span class="line">  asked CMake to find a package configuration file provided by &quot;Fcitx&quot;, but</span><br><span class="line">  CMake did not find one.</span><br><span class="line"></span><br><span class="line">  Could not find a package configuration file provided by &quot;Fcitx&quot; (requested</span><br><span class="line">  version 4.2.8) with any of the following names:</span><br><span class="line"></span><br><span class="line">    FcitxConfig.cmake</span><br><span class="line">    fcitx-config.cmake</span><br><span class="line"></span><br><span class="line">  Add the installation prefix of &quot;Fcitx&quot; to CMAKE_PREFIX_PATH or set</span><br><span class="line">  &quot;Fcitx_DIR&quot; to a directory containing one of the above files.  If &quot;Fcitx&quot;</span><br><span class="line">  provides a separate development package or SDK, be sure it has been</span><br><span class="line">  installed.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- Configuring incomplete, errors occurred!</span><br><span class="line">See also &quot;&#x2F;root&#x2F;fcitx-qt5&#x2F;CMakeFiles&#x2F;CMakeOutput.log&quot;.</span><br></pre></td></tr></table></figure>

<p>解决方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;fcitx-qt5# apt-get install fcitx-libs-dev</span><br></pre></td></tr></table></figure>

<p>最后编译，成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;fcitx-qt5# cmake .</span><br><span class="line">-- Checking for module &#39;fcitx&#39;</span><br><span class="line">--   Found fcitx, version 4.2.9.6</span><br><span class="line">-- Checking for module &#39;fcitx-config&#39;</span><br><span class="line">--   Found fcitx-config, version 4.2.9.6</span><br><span class="line">-- Checking for module &#39;fcitx-utils&#39;</span><br><span class="line">--   Found fcitx-utils, version 4.2.9.6</span><br><span class="line">-- fcitx4-config found &#x2F;usr&#x2F;bin&#x2F;fcitx4-config</span><br><span class="line">-- Found Fcitx: 4.2.9.6 (Required is at least version &quot;4.2.8&quot;) </span><br><span class="line">-- Looking for dgettext</span><br><span class="line">-- Looking for dgettext - found</span><br><span class="line">-- Found LIBINTL: &#x2F;usr&#x2F;include  </span><br><span class="line">-- Performing Test COMPILER_HAS_HIDDEN_VISIBILITY</span><br><span class="line">-- Performing Test COMPILER_HAS_HIDDEN_VISIBILITY - Success</span><br><span class="line">-- Performing Test COMPILER_HAS_HIDDEN_INLINE_VISIBILITY</span><br><span class="line">-- Performing Test COMPILER_HAS_HIDDEN_INLINE_VISIBILITY - Success</span><br><span class="line">-- Performing Test COMPILER_HAS_DEPRECATED_ATTR</span><br><span class="line">-- Performing Test COMPILER_HAS_DEPRECATED_ATTR - Success</span><br><span class="line">-- The following OPTIONAL packages have been found:</span><br><span class="line"></span><br><span class="line"> * PkgConfig</span><br><span class="line"></span><br><span class="line">-- The following REQUIRED packages have been found:</span><br><span class="line"></span><br><span class="line"> * ECM (required version &gt;&#x3D; 1.4.0)</span><br><span class="line"> * Qt5DBus</span><br><span class="line"> * Qt5Widgets</span><br><span class="line"> * Qt5Concurrent</span><br><span class="line"> * Qt5 (required version &gt;&#x3D; 5.1.0)</span><br><span class="line"> * Qt5Gui (required version &gt;&#x3D; 5.1.0)</span><br><span class="line"> * XKBCommon (required version &gt;&#x3D; 0.5.0), Keyboard handling library using XKB data, &lt;http:&#x2F;&#x2F;xkbcommon.org&gt;</span><br><span class="line"> * Fcitx (required version &gt;&#x3D; 4.2.8)</span><br><span class="line"> * LibIntl</span><br><span class="line"> * Qt5Core</span><br><span class="line"></span><br><span class="line">-- Configuring done</span><br><span class="line">CMake Warning (dev) in guiwrapper&#x2F;CMakeLists.txt:</span><br><span class="line">  Policy CMP0071 is not set: Let AUTOMOC and AUTOUIC process GENERATED files.</span><br><span class="line">  Run &quot;cmake --help-policy CMP0071&quot; for policy details.  Use the cmake_policy</span><br><span class="line">  command to set the policy and suppress this warning.</span><br><span class="line"></span><br><span class="line">  For compatibility, CMake is excluding the GENERATED source file(s):</span><br><span class="line"></span><br><span class="line">    &quot;&#x2F;root&#x2F;fcitx-qt5&#x2F;guiwrapper&#x2F;ui_mainwindow.h&quot;</span><br><span class="line"></span><br><span class="line">  from processing by AUTOMOC.  If any of the files should be processed, set</span><br><span class="line">  CMP0071 to NEW.  If any of the files should not be processed, explicitly</span><br><span class="line">  exclude them by setting the source file property SKIP_AUTOMOC:</span><br><span class="line"></span><br><span class="line">    set_property(SOURCE file.h PROPERTY SKIP_AUTOMOC ON)</span><br><span class="line"></span><br><span class="line">This warning is for project developers.  Use -Wno-dev to suppress it.</span><br><span class="line"></span><br><span class="line">CMake Warning (dev) in quickphrase-editor&#x2F;CMakeLists.txt:</span><br><span class="line">  Policy CMP0071 is not set: Let AUTOMOC and AUTOUIC process GENERATED files.</span><br><span class="line">  Run &quot;cmake --help-policy CMP0071&quot; for policy details.  Use the cmake_policy</span><br><span class="line">  command to set the policy and suppress this warning.</span><br><span class="line"></span><br><span class="line">  For compatibility, CMake is excluding the GENERATED source file(s):</span><br><span class="line"></span><br><span class="line">    &quot;&#x2F;root&#x2F;fcitx-qt5&#x2F;quickphrase-editor&#x2F;ui_editordialog.h&quot;</span><br><span class="line">    &quot;&#x2F;root&#x2F;fcitx-qt5&#x2F;quickphrase-editor&#x2F;ui_batchdialog.h&quot;</span><br><span class="line">    &quot;&#x2F;root&#x2F;fcitx-qt5&#x2F;quickphrase-editor&#x2F;ui_editor.h&quot;</span><br><span class="line"></span><br><span class="line">  from processing by AUTOMOC.  If any of the files should be processed, set</span><br><span class="line">  CMP0071 to NEW.  If any of the files should not be processed, explicitly</span><br><span class="line">  exclude them by setting the source file property SKIP_AUTOMOC:</span><br><span class="line"></span><br><span class="line">    set_property(SOURCE file.h PROPERTY SKIP_AUTOMOC ON)</span><br><span class="line"></span><br><span class="line">This warning is for project developers.  Use -Wno-dev to suppress it.</span><br><span class="line"></span><br><span class="line">CMake Warning (dev) in platforminputcontext&#x2F;CMakeLists.txt:</span><br><span class="line">  Policy CMP0071 is not set: Let AUTOMOC and AUTOUIC process GENERATED files.</span><br><span class="line">  Run &quot;cmake --help-policy CMP0071&quot; for policy details.  Use the cmake_policy</span><br><span class="line">  command to set the policy and suppress this warning.</span><br><span class="line"></span><br><span class="line">  For compatibility, CMake is excluding the GENERATED source file(s):</span><br><span class="line"></span><br><span class="line">    &quot;&#x2F;root&#x2F;fcitx-qt5&#x2F;platforminputcontext&#x2F;inputcontextproxy.h&quot;</span><br><span class="line">    &quot;&#x2F;root&#x2F;fcitx-qt5&#x2F;platforminputcontext&#x2F;inputcontext1proxy.h&quot;</span><br><span class="line">    &quot;&#x2F;root&#x2F;fcitx-qt5&#x2F;platforminputcontext&#x2F;inputmethodproxy.h&quot;</span><br><span class="line">    &quot;&#x2F;root&#x2F;fcitx-qt5&#x2F;platforminputcontext&#x2F;inputmethod1proxy.h&quot;</span><br><span class="line"></span><br><span class="line">  from processing by AUTOMOC.  If any of the files should be processed, set</span><br><span class="line">  CMP0071 to NEW.  If any of the files should not be processed, explicitly</span><br><span class="line">  exclude them by setting the source file property SKIP_AUTOMOC:</span><br><span class="line"></span><br><span class="line">    set_property(SOURCE file.h PROPERTY SKIP_AUTOMOC ON)</span><br><span class="line"></span><br><span class="line">This warning is for project developers.  Use -Wno-dev to suppress it.</span><br><span class="line"></span><br><span class="line">-- Generating done</span><br><span class="line">-- Build files have been written to: &#x2F;root&#x2F;fcitx-qt5</span><br></pre></td></tr></table></figure>

<p>执行make</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;fcitx-qt5# make</span><br><span class="line">Scanning dependencies of target fcitx-scan-addons.target</span><br><span class="line">[  0%] Built target fcitx-scan-addons.target</span><br><span class="line">Scanning dependencies of target fcitx-modules.target</span><br><span class="line">[  0%] Built target fcitx-modules.target</span><br><span class="line">Scanning dependencies of target FcitxQt5DBusAddons_autogen</span><br><span class="line">[  1%] Automatic MOC for target FcitxQt5DBusAddons</span><br><span class="line">[  1%] Built target FcitxQt5DBusAddons_autogen</span><br><span class="line">Scanning dependencies of target FcitxQt5DBusAddons</span><br><span class="line">[  2%] Building CXX object dbusaddons&#x2F;CMakeFiles&#x2F;FcitxQt5DBusAddons.dir&#x2F;fcitxqtconnection.cpp.o</span><br><span class="line">[  4%] Building CXX object dbusaddons&#x2F;CMakeFiles&#x2F;FcitxQt5DBusAddons.dir&#x2F;fcitxqtformattedpreedit.cpp.o</span><br><span class="line">[  5%] Building CXX object dbusaddons&#x2F;CMakeFiles&#x2F;FcitxQt5DBusAddons.dir&#x2F;fcitxqtinputcontextproxy.cpp.o</span><br><span class="line">[  7%] Building CXX object dbusaddons&#x2F;CMakeFiles&#x2F;FcitxQt5DBusAddons.dir&#x2F;fcitxqtinputmethodproxy.cpp.o</span><br><span class="line">[  8%] Building CXX object dbusaddons&#x2F;CMakeFiles&#x2F;FcitxQt5DBusAddons.dir&#x2F;fcitxqtkeyboardlayout.cpp.o</span><br><span class="line">[ 10%] Building CXX object dbusaddons&#x2F;CMakeFiles&#x2F;FcitxQt5DBusAddons.dir&#x2F;fcitxqtkeyboardproxy.cpp.o</span><br><span class="line">[ 11%] Building CXX object dbusaddons&#x2F;CMakeFiles&#x2F;FcitxQt5DBusAddons.dir&#x2F;fcitxqtinputmethoditem.cpp.o</span><br><span class="line">[ 13%] Building CXX object dbusaddons&#x2F;CMakeFiles&#x2F;FcitxQt5DBusAddons.dir&#x2F;FcitxQt5DBusAddons_autogen&#x2F;mocs_compilation.cpp.o</span><br><span class="line">[ 14%] Linking CXX shared library libFcitxQt5DBusAddons.so</span><br><span class="line">[ 14%] Built target FcitxQt5DBusAddons</span><br><span class="line">Scanning dependencies of target FcitxQt5WidgetsAddons_autogen</span><br><span class="line">[ 16%] Automatic MOC for target FcitxQt5WidgetsAddons</span><br><span class="line">[ 16%] Built target FcitxQt5WidgetsAddons_autogen</span><br><span class="line">Scanning dependencies of target FcitxQt5WidgetsAddons</span><br><span class="line">[ 17%] Building CXX object widgetsaddons&#x2F;CMakeFiles&#x2F;FcitxQt5WidgetsAddons.dir&#x2F;fcitxqtconfiguifactory.cpp.o</span><br><span class="line">[ 19%] Building CXX object widgetsaddons&#x2F;CMakeFiles&#x2F;FcitxQt5WidgetsAddons.dir&#x2F;fcitxqtconfiguiplugin.cpp.o</span><br><span class="line">[ 20%] Building CXX object widgetsaddons&#x2F;CMakeFiles&#x2F;FcitxQt5WidgetsAddons.dir&#x2F;fcitxqtconfiguiwidget.cpp.o</span><br><span class="line">[ 22%] Building CXX object widgetsaddons&#x2F;CMakeFiles&#x2F;FcitxQt5WidgetsAddons.dir&#x2F;fcitxqtkeysequencewidget.cpp.o</span><br><span class="line">[ 23%] Building CXX object widgetsaddons&#x2F;CMakeFiles&#x2F;FcitxQt5WidgetsAddons.dir&#x2F;qtkeytrans.cpp.o</span><br><span class="line">[ 25%] Building CXX object widgetsaddons&#x2F;CMakeFiles&#x2F;FcitxQt5WidgetsAddons.dir&#x2F;FcitxQt5WidgetsAddons_autogen&#x2F;mocs_compilation.cpp.o</span><br><span class="line">[ 26%] Linking CXX shared library libFcitxQt5WidgetsAddons.so</span><br><span class="line">[ 26%] Built target FcitxQt5WidgetsAddons</span><br><span class="line">Scanning dependencies of target fcitx-qt5-gui-wrapper_autogen</span><br><span class="line">[ 27%] Automatic MOC for target fcitx-qt5-gui-wrapper</span><br><span class="line">[ 27%] Built target fcitx-qt5-gui-wrapper_autogen</span><br><span class="line">[ 29%] Generating ui_mainwindow.h</span><br><span class="line">Scanning dependencies of target fcitx-qt5-gui-wrapper</span><br><span class="line">[ 30%] Building CXX object guiwrapper&#x2F;CMakeFiles&#x2F;fcitx-qt5-gui-wrapper.dir&#x2F;main.cpp.o</span><br><span class="line">[ 32%] Building CXX object guiwrapper&#x2F;CMakeFiles&#x2F;fcitx-qt5-gui-wrapper.dir&#x2F;wrapperapp.cpp.o</span><br><span class="line">[ 33%] Building CXX object guiwrapper&#x2F;CMakeFiles&#x2F;fcitx-qt5-gui-wrapper.dir&#x2F;mainwindow.cpp.o</span><br><span class="line">[ 35%] Building CXX object guiwrapper&#x2F;CMakeFiles&#x2F;fcitx-qt5-gui-wrapper.dir&#x2F;fcitx-qt5-gui-wrapper_autogen&#x2F;mocs_compilation.cpp.o</span><br><span class="line">[ 36%] Linking CXX executable fcitx-qt5-gui-wrapper</span><br><span class="line">[ 36%] Built target fcitx-qt5-gui-wrapper</span><br><span class="line">Scanning dependencies of target fcitx-quickphrase-editor5_autogen</span><br><span class="line">[ 38%] Automatic MOC for target fcitx-quickphrase-editor5</span><br><span class="line">[ 38%] Built target fcitx-quickphrase-editor5_autogen</span><br><span class="line">[ 39%] Generating ui_editor.h</span><br><span class="line">[ 41%] Generating ui_editordialog.h</span><br><span class="line">[ 42%] Generating ui_batchdialog.h</span><br><span class="line">Scanning dependencies of target fcitx-quickphrase-editor5</span><br><span class="line">[ 44%] Building CXX object quickphrase-editor&#x2F;CMakeFiles&#x2F;fcitx-quickphrase-editor5.dir&#x2F;main.cpp.o</span><br><span class="line">[ 45%] Building CXX object quickphrase-editor&#x2F;CMakeFiles&#x2F;fcitx-quickphrase-editor5.dir&#x2F;model.cpp.o</span><br><span class="line">[ 47%] Building CXX object quickphrase-editor&#x2F;CMakeFiles&#x2F;fcitx-quickphrase-editor5.dir&#x2F;editor.cpp.o</span><br><span class="line">[ 48%] Building CXX object quickphrase-editor&#x2F;CMakeFiles&#x2F;fcitx-quickphrase-editor5.dir&#x2F;editordialog.cpp.o</span><br><span class="line">[ 50%] Building CXX object quickphrase-editor&#x2F;CMakeFiles&#x2F;fcitx-quickphrase-editor5.dir&#x2F;batchdialog.cpp.o</span><br><span class="line">[ 51%] Building CXX object quickphrase-editor&#x2F;CMakeFiles&#x2F;fcitx-quickphrase-editor5.dir&#x2F;filelistmodel.cpp.o</span><br><span class="line">[ 52%] Building CXX object quickphrase-editor&#x2F;CMakeFiles&#x2F;fcitx-quickphrase-editor5.dir&#x2F;fcitx-quickphrase-editor5_autogen&#x2F;mocs_compilation.cpp.o</span><br><span class="line">[ 54%] Linking CXX shared module libfcitx-quickphrase-editor5.so</span><br><span class="line">[ 54%] Built target fcitx-quickphrase-editor5</span><br><span class="line">Scanning dependencies of target fcitx-compile-mo.target</span><br><span class="line">[ 55%] Generating ..&#x2F;fcitx_cmake_cache&#x2F;mo&#x2F;ca&#x2F;fcitx-qt5.mo</span><br><span class="line">[ 57%] Generating ..&#x2F;fcitx_cmake_cache&#x2F;mo&#x2F;da&#x2F;fcitx-qt5.mo</span><br><span class="line">[ 58%] Generating ..&#x2F;fcitx_cmake_cache&#x2F;mo&#x2F;de&#x2F;fcitx-qt5.mo</span><br><span class="line">[ 60%] Generating ..&#x2F;fcitx_cmake_cache&#x2F;mo&#x2F;es&#x2F;fcitx-qt5.mo</span><br><span class="line">[ 61%] Generating ..&#x2F;fcitx_cmake_cache&#x2F;mo&#x2F;fr&#x2F;fcitx-qt5.mo</span><br><span class="line">[ 63%] Generating ..&#x2F;fcitx_cmake_cache&#x2F;mo&#x2F;ja&#x2F;fcitx-qt5.mo</span><br><span class="line">[ 64%] Generating ..&#x2F;fcitx_cmake_cache&#x2F;mo&#x2F;ko&#x2F;fcitx-qt5.mo</span><br><span class="line">[ 66%] Generating ..&#x2F;fcitx_cmake_cache&#x2F;mo&#x2F;ru&#x2F;fcitx-qt5.mo</span><br><span class="line">[ 67%] Generating ..&#x2F;fcitx_cmake_cache&#x2F;mo&#x2F;zh_CN&#x2F;fcitx-qt5.mo</span><br><span class="line">[ 69%] Generating ..&#x2F;fcitx_cmake_cache&#x2F;mo&#x2F;zh_TW&#x2F;fcitx-qt5.mo</span><br><span class="line">[ 69%] Built target fcitx-compile-mo.target</span><br><span class="line">Scanning dependencies of target fcitxplatforminputcontextplugin_autogen</span><br><span class="line">[ 70%] Automatic MOC for target fcitxplatforminputcontextplugin</span><br><span class="line">[ 70%] Built target fcitxplatforminputcontextplugin_autogen</span><br><span class="line">[ 72%] Generating inputmethod1proxy.cpp, inputmethod1proxy.h</span><br><span class="line">[ 73%] Generating inputcontextproxy.cpp, inputcontextproxy.h</span><br><span class="line">Warning: deprecated annotation &#39;com.trolltech.QtDBus.QtTypeName.In0&#39; found; suggest updating to &#39;org.qtproject.QtDBus.QtTypeName.In0&#39;</span><br><span class="line">[ 75%] Generating inputcontextproxy.moc</span><br><span class="line">[ 76%] Generating inputcontext1proxy.cpp, inputcontext1proxy.h</span><br><span class="line">Warning: deprecated annotation &#39;com.trolltech.QtDBus.QtTypeName.In0&#39; found; suggest updating to &#39;org.qtproject.QtDBus.QtTypeName.In0&#39;</span><br><span class="line">[ 77%] Generating inputcontext1proxy.moc</span><br><span class="line">[ 79%] Generating inputmethodproxy.cpp, inputmethodproxy.h</span><br><span class="line">[ 80%] Generating inputmethodproxy.moc</span><br><span class="line">[ 82%] Generating inputmethod1proxy.moc</span><br><span class="line">Scanning dependencies of target fcitxplatforminputcontextplugin</span><br><span class="line">[ 83%] Building CXX object platforminputcontext&#x2F;CMakeFiles&#x2F;fcitxplatforminputcontextplugin.dir&#x2F;fcitxinputcontextproxy.cpp.o</span><br><span class="line">[ 85%] Building CXX object platforminputcontext&#x2F;CMakeFiles&#x2F;fcitxplatforminputcontextplugin.dir&#x2F;fcitxqtdbustypes.cpp.o</span><br><span class="line">[ 86%] Building CXX object platforminputcontext&#x2F;CMakeFiles&#x2F;fcitxplatforminputcontextplugin.dir&#x2F;fcitxwatcher.cpp.o</span><br><span class="line">[ 88%] Building CXX object platforminputcontext&#x2F;CMakeFiles&#x2F;fcitxplatforminputcontextplugin.dir&#x2F;qfcitxplatforminputcontext.cpp.o</span><br><span class="line">[ 89%] Building CXX object platforminputcontext&#x2F;CMakeFiles&#x2F;fcitxplatforminputcontextplugin.dir&#x2F;main.cpp.o</span><br><span class="line">[ 91%] Building CXX object platforminputcontext&#x2F;CMakeFiles&#x2F;fcitxplatforminputcontextplugin.dir&#x2F;qtkey.cpp.o</span><br><span class="line">[ 92%] Building CXX object platforminputcontext&#x2F;CMakeFiles&#x2F;fcitxplatforminputcontextplugin.dir&#x2F;inputcontextproxy.cpp.o</span><br><span class="line">[ 94%] Building CXX object platforminputcontext&#x2F;CMakeFiles&#x2F;fcitxplatforminputcontextplugin.dir&#x2F;inputcontext1proxy.cpp.o</span><br><span class="line">[ 95%] Building CXX object platforminputcontext&#x2F;CMakeFiles&#x2F;fcitxplatforminputcontextplugin.dir&#x2F;inputmethodproxy.cpp.o</span><br><span class="line">[ 97%] Building CXX object platforminputcontext&#x2F;CMakeFiles&#x2F;fcitxplatforminputcontextplugin.dir&#x2F;inputmethod1proxy.cpp.o</span><br><span class="line">[ 98%] Building CXX object platforminputcontext&#x2F;CMakeFiles&#x2F;fcitxplatforminputcontextplugin.dir&#x2F;fcitxplatforminputcontextplugin_autogen&#x2F;mocs_compilation.cpp.o</span><br><span class="line">[100%] Linking CXX shared module libfcitxplatforminputcontextplugin.so</span><br><span class="line">[100%] Built target fcitxplatforminputcontextplugin</span><br></pre></td></tr></table></figure>

<p>执行make install</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;fcitx-qt5# make install </span><br><span class="line">[  0%] Built target fcitx-scan-addons.target</span><br><span class="line">[  0%] Built target fcitx-modules.target</span><br><span class="line">[  1%] Automatic MOC for target FcitxQt5DBusAddons</span><br><span class="line">[  1%] Built target FcitxQt5DBusAddons_autogen</span><br><span class="line">[ 14%] Built target FcitxQt5DBusAddons</span><br><span class="line">[ 16%] Automatic MOC for target FcitxQt5WidgetsAddons</span><br><span class="line">[ 16%] Built target FcitxQt5WidgetsAddons_autogen</span><br><span class="line">[ 26%] Built target FcitxQt5WidgetsAddons</span><br><span class="line">[ 27%] Automatic MOC for target fcitx-qt5-gui-wrapper</span><br><span class="line">[ 27%] Built target fcitx-qt5-gui-wrapper_autogen</span><br><span class="line">[ 36%] Built target fcitx-qt5-gui-wrapper</span><br><span class="line">[ 38%] Automatic MOC for target fcitx-quickphrase-editor5</span><br><span class="line">[ 38%] Built target fcitx-quickphrase-editor5_autogen</span><br><span class="line">[ 54%] Built target fcitx-quickphrase-editor5</span><br><span class="line">[ 69%] Built target fcitx-compile-mo.target</span><br><span class="line">[ 70%] Automatic MOC for target fcitxplatforminputcontextplugin</span><br><span class="line">[ 70%] Built target fcitxplatforminputcontextplugin_autogen</span><br><span class="line">[100%] Built target fcitxplatforminputcontextplugin</span><br><span class="line">Install the project...</span><br><span class="line">-- Install configuration: &quot;&quot;</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;cmake&#x2F;FcitxQt5DBusAddons&#x2F;FcitxQt5DBusAddonsConfig.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;cmake&#x2F;FcitxQt5DBusAddons&#x2F;FcitxQt5DBusAddonsConfigVersion.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;cmake&#x2F;FcitxQt5DBusAddons&#x2F;FcitxQt5DBusAddonsTargets.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;cmake&#x2F;FcitxQt5DBusAddons&#x2F;FcitxQt5DBusAddonsTargets-noconfig.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;include&#x2F;FcitxQt5&#x2F;fcitxqtdbusaddons_version.h</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libFcitxQt5DBusAddons.so.1.0</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libFcitxQt5DBusAddons.so.1</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libFcitxQt5DBusAddons.so</span><br><span class="line">-- Set runtime path of &quot;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;libFcitxQt5DBusAddons.so.1.0&quot; to &quot;&quot;</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;include&#x2F;FcitxQt5&#x2F;FcitxQtDBusAddons&#x2F;fcitxqtconnection.h</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;include&#x2F;FcitxQt5&#x2F;FcitxQtDBusAddons&#x2F;fcitxqtformattedpreedit.h</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;include&#x2F;FcitxQt5&#x2F;FcitxQtDBusAddons&#x2F;fcitxqtinputcontextproxy.h</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;include&#x2F;FcitxQt5&#x2F;FcitxQtDBusAddons&#x2F;fcitxqtinputmethodproxy.h</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;include&#x2F;FcitxQt5&#x2F;FcitxQtDBusAddons&#x2F;fcitxqtkeyboardlayout.h</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;include&#x2F;FcitxQt5&#x2F;FcitxQtDBusAddons&#x2F;fcitxqtkeyboardproxy.h</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;include&#x2F;FcitxQt5&#x2F;FcitxQtDBusAddons&#x2F;fcitxqtinputmethoditem.h</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;include&#x2F;FcitxQt5&#x2F;FcitxQtDBusAddons&#x2F;fcitxqtdbusaddons_export.h</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;cmake&#x2F;FcitxQt5WidgetsAddons&#x2F;FcitxQt5WidgetsAddonsConfig.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;cmake&#x2F;FcitxQt5WidgetsAddons&#x2F;FcitxQt5WidgetsAddonsConfigVersion.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;cmake&#x2F;FcitxQt5WidgetsAddons&#x2F;FcitxQt5WidgetsAddonsTargets.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;cmake&#x2F;FcitxQt5WidgetsAddons&#x2F;FcitxQt5WidgetsAddonsTargets-noconfig.cmake</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;include&#x2F;FcitxQt5&#x2F;fcitxqtwidgetsaddons_version.h</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libFcitxQt5WidgetsAddons.so.1.0</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libFcitxQt5WidgetsAddons.so.1</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libFcitxQt5WidgetsAddons.so</span><br><span class="line">-- Set runtime path of &quot;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;libFcitxQt5WidgetsAddons.so.1.0&quot; to &quot;&quot;</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;include&#x2F;FcitxQt5&#x2F;FcitxQtWidgetsAddons&#x2F;fcitxqtconfiguifactory.h</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;include&#x2F;FcitxQt5&#x2F;FcitxQtWidgetsAddons&#x2F;fcitxqtconfiguiplugin.h</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;include&#x2F;FcitxQt5&#x2F;FcitxQtWidgetsAddons&#x2F;fcitxqtconfiguiwidget.h</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;include&#x2F;FcitxQt5&#x2F;FcitxQtWidgetsAddons&#x2F;fcitxqtkeysequencewidget.h</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;include&#x2F;FcitxQt5&#x2F;FcitxQtWidgetsAddons&#x2F;fcitxqtwidgetsaddons_export.h</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;fcitx&#x2F;libexec&#x2F;fcitx-qt5-gui-wrapper</span><br><span class="line">-- Set runtime path of &quot;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;fcitx&#x2F;libexec&#x2F;fcitx-qt5-gui-wrapper&quot; to &quot;&quot;</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;fcitx&#x2F;qt&#x2F;libfcitx-quickphrase-editor5.so</span><br><span class="line">-- Set runtime path of &quot;&#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;fcitx&#x2F;qt&#x2F;libfcitx-quickphrase-editor5.so&quot; to &quot;&quot;</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;locale&#x2F;ca&#x2F;LC_MESSAGES&#x2F;fcitx-qt5.mo</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;locale&#x2F;da&#x2F;LC_MESSAGES&#x2F;fcitx-qt5.mo</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;locale&#x2F;de&#x2F;LC_MESSAGES&#x2F;fcitx-qt5.mo</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;locale&#x2F;es&#x2F;LC_MESSAGES&#x2F;fcitx-qt5.mo</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;locale&#x2F;fr&#x2F;LC_MESSAGES&#x2F;fcitx-qt5.mo</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;locale&#x2F;ja&#x2F;LC_MESSAGES&#x2F;fcitx-qt5.mo</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;locale&#x2F;ko&#x2F;LC_MESSAGES&#x2F;fcitx-qt5.mo</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;locale&#x2F;ru&#x2F;LC_MESSAGES&#x2F;fcitx-qt5.mo</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;locale&#x2F;zh_CN&#x2F;LC_MESSAGES&#x2F;fcitx-qt5.mo</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;share&#x2F;locale&#x2F;zh_TW&#x2F;LC_MESSAGES&#x2F;fcitx-qt5.mo</span><br><span class="line">-- Installing: &#x2F;usr&#x2F;local&#x2F;bin&#x2F;qt&#x2F;5.4&#x2F;gcc_64&#x2F;plugins&#x2F;platforminputcontexts&#x2F;libfcitxplatforminputcontextplugin.so</span><br><span class="line">-- Set runtime path of &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;qt&#x2F;5.4&#x2F;gcc_64&#x2F;plugins&#x2F;platforminputcontexts&#x2F;libfcitxplatforminputcontextplugin.so&quot; to &quot;&quot;</span><br></pre></td></tr></table></figure>

<p>查看发现QT的安装目录已经有libfcitxplatforminputcontextplugin.so</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~&#x2F;fcitx-qt5# ls &#x2F;usr&#x2F;local&#x2F;bin&#x2F;qt&#x2F;5.4&#x2F;gcc_64&#x2F;plugins&#x2F;platforminputcontexts</span><br><span class="line">libcomposeplatforminputcontextplugin.so  libfcitxplatforminputcontextplugin.so  libibusplatforminputcontextplugin.so</span><br></pre></td></tr></table></figure>

<p>最后，打开qt程序，发现已经可以使用中文输入法</p>
<p><img src="http://jiali.clouddn.com/20200729_001.png" alt=""></p>
<p>参考：</p>
<p><a href="https://my.oschina.net/lieefu/blog/505363?fromerr=NNm21wBS" target="_blank" rel="noopener">解决Qt5 Creator无法切换输入法（fcitx），Ubuntu中不能使用搜狗输入法录入汉字问题</a></p>
<p><a href="https://blog.csdn.net/tianminggenie/article/details/82909224" target="_blank" rel="noopener">Linux 下 Qt 5 无法切换中文输入法</a></p>
<p><a href="https://www.cnblogs.com/cposture/p/5397694.html" target="_blank" rel="noopener">Ubuntu 16.04 下 Qt 5.6 无法输入中文的问题</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/28/Linux/Driver/Input/Linux%20%E5%BA%94%E7%94%A8%E5%B1%82%E6%A8%A1%E6%8B%9F%E9%94%AE%E7%9B%98%E5%92%8C%E9%BC%A0%E6%A0%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/28/Linux/Driver/Input/Linux%20%E5%BA%94%E7%94%A8%E5%B1%82%E6%A8%A1%E6%8B%9F%E9%94%AE%E7%9B%98%E5%92%8C%E9%BC%A0%E6%A0%87/" class="post-title-link" itemprop="url">Linux 应用层模拟键盘和鼠标</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-28 10:56:24" itemprop="dateCreated datePublished" datetime="2020-07-28T10:56:24+08:00">2020-07-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-05 11:08:36" itemprop="dateModified" datetime="2021-01-05T11:08:36+08:00">2021-01-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/" itemprop="url" rel="index"><span itemprop="name">Driver</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/Input%E5%AD%90%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">Input子系统</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>利用Linux做一些产品，有时候需要应用程序向系统发送一些键盘的值来替代手动敲键盘。因此，应用程序如何实现向系统发送键盘和鼠标的值？有三种方法可以解决这个问题。方法如下：</p>
<ol>
<li>因为Linux使用input子系统管理鼠标和键盘，所以执行cat /proc/bus/input/devices，找出鼠标和键盘的属于哪个事件，然后调用open()和 write()。</li>
<li>有时候，鼠标和键盘都没有，第一种方法就行不通。使用uinput module就可以解决没有鼠标和键盘仍然可以发送键盘和鼠标事件。</li>
<li>模仿uinput模块，自己编写input的字符驱动设备，然后在该字符设备基础上，把键盘值发送给系统。</li>
</ol>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="键盘CTRL-SPACE实现"><a href="#键盘CTRL-SPACE实现" class="headerlink" title="键盘CTRL+SPACE实现"></a>键盘CTRL+SPACE实现</h3><p>方法1–直接使用键盘input事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">int SimulateKey(void)</span><br><span class="line">&#123;</span><br><span class="line">    struct input_event event;</span><br><span class="line">    int fd &#x3D; 0;</span><br><span class="line"></span><br><span class="line">    fd &#x3D; open(&quot;&#x2F;dev&#x2F;input&#x2F;event3&quot;, O_RDWR);</span><br><span class="line">    if(fd &lt;&#x3D; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        printf(&quot;&#x2F;dev&#x2F;input&#x2F;event3 fail\n&quot;);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;先发送一个CTRL按下事件</span><br><span class="line">    event.type &#x3D; EV_KEY;</span><br><span class="line">    event.value &#x3D; 1;</span><br><span class="line">    event.code &#x3D; KEY_LEFTCTRL;</span><br><span class="line">    gettimeofday(&amp;event.time,NULL);</span><br><span class="line">    write(fd,&amp;event,sizeof(event)) ;</span><br><span class="line">    &#x2F;&#x2F;发送同步事件</span><br><span class="line">    event.type &#x3D; EV_SYN;</span><br><span class="line">    event.code &#x3D; SYN_REPORT;</span><br><span class="line">    event.value &#x3D; 0;</span><br><span class="line">    write(fd, &amp;event, sizeof(event));</span><br><span class="line">    &#x2F;&#x2F;然后发送一个SPACE按下事件</span><br><span class="line">    memset(&amp;event, 0, sizeof(event));</span><br><span class="line">    gettimeofday(&amp;event.time, NULL);</span><br><span class="line">    event.type &#x3D; EV_KEY;</span><br><span class="line">    event.code &#x3D; KEY_SPACE;</span><br><span class="line">    event.value &#x3D; 1;</span><br><span class="line">    write(fd, &amp;event, sizeof(event));</span><br><span class="line">    &#x2F;&#x2F;发送一个释放SPACE事件</span><br><span class="line">    memset(&amp;event, 0, sizeof(event));</span><br><span class="line">    gettimeofday(&amp;event.time, NULL);</span><br><span class="line">    event.type &#x3D; EV_KEY;</span><br><span class="line">    event.code &#x3D; KEY_SPACE;</span><br><span class="line">    event.value &#x3D; 0;</span><br><span class="line">    write(fd, &amp;event, sizeof(event));</span><br><span class="line">    &#x2F;&#x2F;发送同步事件</span><br><span class="line">    event.type &#x3D; EV_SYN;</span><br><span class="line">    event.code &#x3D; SYN_REPORT;</span><br><span class="line">    event.value &#x3D; 0;</span><br><span class="line">    write(fd, &amp;event, sizeof(event));</span><br><span class="line">    &#x2F;&#x2F;发送释放CTRL事件</span><br><span class="line">    memset(&amp;event, 0, sizeof(event));</span><br><span class="line">    event.type &#x3D; EV_KEY;</span><br><span class="line">    event.value &#x3D; 0;</span><br><span class="line">    event.code &#x3D; KEY_LEFTCTRL;</span><br><span class="line">    gettimeofday(&amp;event.time,NULL);</span><br><span class="line">    write(fd,&amp;event,sizeof(event)) ;</span><br><span class="line">    &#x2F;&#x2F;发送同步事件</span><br><span class="line">    event.type &#x3D; EV_SYN;</span><br><span class="line">    event.code &#x3D; SYN_REPORT;</span><br><span class="line">    event.value &#x3D; 0;</span><br><span class="line">    write(fd, &amp;event, sizeof(event));</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法2–使用uinput模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">void SimulateKey(int fd)</span><br><span class="line">&#123;</span><br><span class="line">    struct input_event event;</span><br><span class="line">  </span><br><span class="line">    &#x2F;&#x2F;先发送一个CTRL按下事件</span><br><span class="line">    event.type &#x3D; EV_KEY;</span><br><span class="line">    event.value &#x3D; 1;</span><br><span class="line">    event.code &#x3D; KEY_LEFTCTRL;</span><br><span class="line">    gettimeofday(&amp;event.time,NULL);</span><br><span class="line">    write(fd,&amp;event,sizeof(event)) ;</span><br><span class="line">    &#x2F;&#x2F;发送同步事件</span><br><span class="line">    event.type &#x3D; EV_SYN;</span><br><span class="line">    event.code &#x3D; SYN_REPORT;</span><br><span class="line">    event.value &#x3D; 0;</span><br><span class="line">    write(fd, &amp;event, sizeof(event));</span><br><span class="line">    &#x2F;&#x2F;然后发送一个SPACE按下事件</span><br><span class="line">    memset(&amp;event, 0, sizeof(event));</span><br><span class="line">    gettimeofday(&amp;event.time, NULL);</span><br><span class="line">    event.type &#x3D; EV_KEY;</span><br><span class="line">    event.code &#x3D; KEY_SPACE;</span><br><span class="line">    event.value &#x3D; 1;</span><br><span class="line">    write(fd, &amp;event, sizeof(event));</span><br><span class="line">    &#x2F;&#x2F;发送一个释放SPACE事件</span><br><span class="line">    memset(&amp;event, 0, sizeof(event));</span><br><span class="line">    gettimeofday(&amp;event.time, NULL);</span><br><span class="line">    event.type &#x3D; EV_KEY;</span><br><span class="line">    event.code &#x3D; KEY_SPACE;</span><br><span class="line">    event.value &#x3D; 0;</span><br><span class="line">    write(fd, &amp;event, sizeof(event));</span><br><span class="line">    &#x2F;&#x2F;发送同步事件</span><br><span class="line">    event.type &#x3D; EV_SYN;</span><br><span class="line">    event.code &#x3D; SYN_REPORT;</span><br><span class="line">    event.value &#x3D; 0;</span><br><span class="line">    write(fd, &amp;event, sizeof(event));</span><br><span class="line">    &#x2F;&#x2F;发送释放CTRL事件</span><br><span class="line">    memset(&amp;event, 0, sizeof(event));</span><br><span class="line">    event.type &#x3D; EV_KEY;</span><br><span class="line">    event.value &#x3D; 0;</span><br><span class="line">    event.code &#x3D; KEY_LEFTCTRL;</span><br><span class="line">    gettimeofday(&amp;event.time,NULL);</span><br><span class="line">    write(fd,&amp;event,sizeof(event)) ;</span><br><span class="line">    &#x2F;&#x2F;发送同步事件</span><br><span class="line">    event.type &#x3D; EV_SYN;</span><br><span class="line">    event.code &#x3D; SYN_REPORT;</span><br><span class="line">    event.value &#x3D; 0;</span><br><span class="line">    write(fd, &amp;event, sizeof(event));</span><br><span class="line">&#125;</span><br><span class="line">void emit(int fd, int type, int code, int val)</span><br><span class="line">&#123;</span><br><span class="line">   struct input_event ie;</span><br><span class="line"></span><br><span class="line">   ie.type &#x3D; type;</span><br><span class="line">   ie.code &#x3D; code;</span><br><span class="line">   ie.value &#x3D; val;</span><br><span class="line">   &#x2F;* timestamp values below are ignored *&#x2F;</span><br><span class="line">   ie.time.tv_sec &#x3D; 0;</span><br><span class="line">   ie.time.tv_usec &#x3D; 0;</span><br><span class="line"></span><br><span class="line">   write(fd, &amp;ie, sizeof(ie));</span><br><span class="line">&#125;</span><br><span class="line">struct input_event event &#x3D; &#123;0&#125;;</span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">   struct uinput_setup usetup;</span><br><span class="line"></span><br><span class="line">   int fd &#x3D; open(&quot;&#x2F;dev&#x2F;uinput&quot;, O_WRONLY | O_NONBLOCK);</span><br><span class="line">	int i&#x3D;5;</span><br><span class="line"></span><br><span class="line">   &#x2F;*</span><br><span class="line">    * The ioctls below will enable the device that is about to be</span><br><span class="line">    * created, to pass key events, in this case the space key.</span><br><span class="line">    *&#x2F;</span><br><span class="line">    &#x2F;&#x2F;这里必须设置一下EVBIT类型和KEYBIT类型。这里设置为键盘类型，创建KEY_SPACE和KEY_LEFTCTRL键盘值</span><br><span class="line">   ioctl(fd, UI_SET_EVBIT, EV_KEY);</span><br><span class="line">   ioctl(fd, UI_SET_KEYBIT, KEY_SPACE);</span><br><span class="line">   ioctl(fd, UI_SET_KEYBIT, KEY_LEFTCTRL);</span><br><span class="line"></span><br><span class="line">   memset(&amp;usetup, 0, sizeof(usetup));</span><br><span class="line">   usetup.id.bustype &#x3D; BUS_USB;</span><br><span class="line">   usetup.id.vendor &#x3D; 0x1234; &#x2F;* sample vendor *&#x2F;</span><br><span class="line">   usetup.id.product &#x3D; 0x5678; &#x2F;* sample product *&#x2F;</span><br><span class="line">   strcpy(usetup.name, &quot;Example device&quot;);</span><br><span class="line"></span><br><span class="line">   ioctl(fd, UI_DEV_SETUP, &amp;usetup);</span><br><span class="line">   ioctl(fd, UI_DEV_CREATE);</span><br><span class="line"></span><br><span class="line">   &#x2F;*</span><br><span class="line">    * On UI_DEV_CREATE the kernel will create the device node for this</span><br><span class="line">    * device. We are inserting a pause here so that userspace has time</span><br><span class="line">    * to detect, initialize the new device, and can start listening to</span><br><span class="line">    * the event, otherwise it will not notice the event we are about</span><br><span class="line">    * to send. This pause is only needed in our example code!</span><br><span class="line">    *&#x2F;</span><br><span class="line">   sleep(1);</span><br><span class="line"></span><br><span class="line">   &#x2F;* Key press, report the event, send key release, and report again *&#x2F;</span><br><span class="line">  &#x2F;* emit(fd, EV_KEY, KEY_SPACE, 1);</span><br><span class="line">   emit(fd, EV_SYN, SYN_REPORT, 0);</span><br><span class="line">   emit(fd, EV_KEY, KEY_SPACE, 0);</span><br><span class="line">   emit(fd, EV_SYN, SYN_REPORT, 0);*&#x2F;</span><br><span class="line">   SimulateKey(fd);</span><br><span class="line"></span><br><span class="line">   &#x2F;*</span><br><span class="line">    * Give userspace some time to read the events before we destroy the</span><br><span class="line">    * device with UI_DEV_DESTOY.</span><br><span class="line">    *&#x2F;</span><br><span class="line">   sleep(1);</span><br><span class="line"></span><br><span class="line">   ioctl(fd, UI_DEV_DESTROY);</span><br><span class="line">   close(fd);</span><br><span class="line"></span><br><span class="line">   return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="鼠标实现"><a href="#鼠标实现" class="headerlink" title="鼠标实现"></a>鼠标实现</h3><p>略。</p>
<p>参考：</p>
<p><a href="https://www.kernel.org/doc/html/v4.12/input/uinput.html" target="_blank" rel="noopener">uinput module</a></p>
<p><a href="https://my.oschina.net/u/4382392/blog/3920785" target="_blank" rel="noopener">linux系统下，在用户空间应用程序中模拟发送系统键盘事件</a></p>
<p><a href="http://ghostbaby.github.io/blog/2013/08/19/linuxxia-ru-he-mo-ni-an-jian-shu-ru-he-mo-ni-shu-biao/" target="_blank" rel="noopener">Linux下如何模拟按键输入和模拟鼠标</a></p>
<p><a href="http://blog.chinaunix.net/uid-23381466-id-3883164.html" target="_blank" rel="noopener">driver: linux下如何模拟按键输入和模拟鼠标</a></p>
<p><a href="https://www.iteye.com/blog/sipgreen-1774676" target="_blank" rel="noopener">使用UInput模拟系统输入设备–键盘，鼠标，触摸屏</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/25/Linux/Driver/PCIe/PCIe%20MSI%E4%B8%AD%E6%96%AD%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/25/Linux/Driver/PCIe/PCIe%20MSI%E4%B8%AD%E6%96%AD%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">PCIe MSI中断机制详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-07-25 17:16:54 / Modified: 18:14:35" itemprop="dateCreated datePublished" datetime="2020-07-25T17:16:54+08:00">2020-07-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/" itemprop="url" rel="index"><span itemprop="name">Driver</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/PCIe/" itemprop="url" rel="index"><span itemprop="name">PCIe</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本节重点讲MSI中断原理及Linux 驱动如何使用MSI中断。MSI机制跟处理器体系架构有关系，由于处理器公开的MSI机制资料有限，所以不讲解具体的处理器如何处理MSI中断。。</p>
<h2 id="MSI机制"><a href="#MSI机制" class="headerlink" title="MSI机制"></a>MSI机制</h2><p>1、什么是MSI？</p>
<p>CPU设计一个特殊的寄存器，往这个寄存器写数据，就会触发中断。PCIe设备就是利用memory写操作，往处理器发送TLP存储器写请求，TLP携带MSI报文信息，从而触发中断。</p>
<p>2、如何封装MSI TLP请求？</p>
<p>先看看MSI报文格式如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200724_002.png" alt=""></p>
<p>Message Address,就是这个寄存器的地址（触发MSI中断的寄存器）。</p>
<p>Message Data,就是往Message Address地址写的数据。</p>
<p>TLP格式如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200722_009.png" alt=""></p>
<p>64位系统的TLP Head格式如下图所示：</p>
<p><img src="http://jiali.clouddn.com/20200722_012.png" alt=""></p>
<p>PCIe设备封装TLP，Address字段存放Message Address;Data Payload字段存放Message Data。设置好TLP，然后向CPU发送存储器写请求，就可以触发MSI中断了。</p>
<p>查看配置空间如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~#lspci -xxx -s 03:00.0</span><br><span class="line">03:00.0 Memory controller: Xilinx Corporation Device 8034</span><br><span class="line">00: ee 10 34 80 02 04 10 00 00 00 80 05 10 00 00 00</span><br><span class="line">10: 00 00 00 dc 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">20: 00 00 00 00 00 00 00 00 00 00 00 00 ee 10 07 00</span><br><span class="line">30: 00 00 00 00 80 00 00 00 00 00 00 00 0b 01 00 00</span><br><span class="line">40: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">50: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">60: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">70: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">80: 01 90 03 00 08 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">90: 05 c0 a5 00 98 04 e0 fe 00 00 00 00 00 00 00 00</span><br><span class="line">a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">b0: 11 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">c0: 10 00 02 00 02 80 e8 07 30 28 00 00 43 f0 43 00</span><br><span class="line">d0: 40 00 43 10 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">e0: 00 00 00 00 12 00 00 00 00 00 00 00 0e 00 00 00</span><br><span class="line">f0: 03 00 1f 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br></pre></td></tr></table></figure>

<p>MSI的配置寄存器地址从0x90开始，分析0x90开始的16个byte</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">90: 05 c0 a5 00 98 04 e0 fe 00 00 00 00 00 00 00 00</span><br></pre></td></tr></table></figure>

<p>可以看出64位系统的Message Address地址为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x0000-0000-fee0-0498</span><br></pre></td></tr></table></figure>

<p>Message Data字段的值为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x0000-0000-0000-0000</span><br></pre></td></tr></table></figure>



<h2 id="ARM处理器如何处理MSI中断"><a href="#ARM处理器如何处理MSI中断" class="headerlink" title="ARM处理器如何处理MSI中断"></a>ARM处理器如何处理MSI中断</h2><p>略。</p>
<h2 id="linux-PCIe驱动中如何使用MSI中断"><a href="#linux-PCIe驱动中如何使用MSI中断" class="headerlink" title="linux PCIe驱动中如何使用MSI中断"></a>linux PCIe驱动中如何使用MSI中断</h2><p>参考：</p>
<p><a href="http://www.voidcn.com/article/p-gqxmmahv-ny.html" target="_blank" rel="noopener">MSI及MSIX详解</a></p>
<p><a href="https://blog.csdn.net/pwl999/article/details/78208151" target="_blank" rel="noopener">PCI&amp;PCIE MSI中断</a></p>
<p><a href="https://blog.csdn.net/JuanA1/article/details/6746011" target="_blank" rel="noopener">PCI-E配置MSI中断流程解析</a></p>
<p><a href="https://xbuba.com/questions/36790833" target="_blank" rel="noopener">MSI中断如何在linux驱动程序中工作</a></p>
<p><a href="https://www.cnblogs.com/TheGrandDesign/archive/2011/08/22/2149746.html" target="_blank" rel="noopener">PCI Express设备驱动</a></p>
<p><a href="https://www.cnblogs.com/gunl/archive/2011/06/09/2076892.html" target="_blank" rel="noopener">MSI中断与Linux实现</a></p>
<p><a href="https://www.kernel.org/doc/html/latest/PCI/msi-howto.html" target="_blank" rel="noopener">linux PCI doc</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/25/Linux/Driver/PCIe/linux%E6%9F%A5%E7%9C%8BPCIe%E7%9A%84%E9%85%8D%E7%BD%AE%E7%A9%BA%E9%97%B4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/25/Linux/Driver/PCIe/linux%E6%9F%A5%E7%9C%8BPCIe%E7%9A%84%E9%85%8D%E7%BD%AE%E7%A9%BA%E9%97%B4/" class="post-title-link" itemprop="url">linux查看PCIe的配置空间</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-07-25 10:49:37 / Modified: 14:55:20" itemprop="dateCreated datePublished" datetime="2020-07-25T10:49:37+08:00">2020-07-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/" itemprop="url" rel="index"><span itemprop="name">Driver</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/PCIe/" itemprop="url" rel="index"><span itemprop="name">PCIe</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>操作系统完成PCI/PCIe的初始化后，建立了PCI总线树。在Linux中，用户空间如何访问PCI/PCIe的配置空间和查看PCIe设备信息呢？本节重点讲在应用层读取配置空间和显示PCI/PCIe设备信息。</p>
<h2 id="查看配置空间信息"><a href="#查看配置空间信息" class="headerlink" title="查看配置空间信息"></a>查看配置空间信息</h2><p>读取PCIe设备配置空间的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lspci</span><br></pre></td></tr></table></figure>

<p>lspci 是一个用来显示系统中所有PCI总线设备或连接到该总线上的所有设备的工具。</p>
<p>常用的几个参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">-v</span><br><span class="line">使得 lspci 以冗余模式显示所有设备的详细信息。</span><br><span class="line">-vv</span><br><span class="line">使得 lspci 以过冗余模式显示更详细的信息 (事实上是 PCI 设备能给出的所有东西)。这些数据的确切意义没有在此手册页中解释，如果你想知道更多，请参照 &#x2F;usr&#x2F;include&#x2F;linux&#x2F;pci.h 或者 PCI 规范。</span><br><span class="line">-vvv 显示设备所有可解析的信息</span><br><span class="line">-n</span><br><span class="line">以数字形式显示 PCI 生产厂商和设备号，而不是在 PCI ID 数据库中查找它们。</span><br><span class="line">-x</span><br><span class="line">以十六进制显示 配置空间 (configuration space) 的前64个字节映像 (标准头部信息)。此参数对调试驱动和 lspci 本身很有用。</span><br><span class="line">-xxx</span><br><span class="line">以十六进制显示所有配置空间的256Byte映像。此选项只有 root 可用，并且很多 PCI 设备在你试图读取配置空间的未定义部分时会崩溃 (此操作可能不违反PCI标准，但是它至少非常愚蠢)。</span><br><span class="line">-xxxx 以16进制显示整个PCIe配置空间（4096字节）。</span><br><span class="line">-t</span><br><span class="line">以树形方式显示包含所有总线、桥、设备和它们的连接的图表。</span><br><span class="line">-s [[]:][][.[]]</span><br><span class="line">仅显示指定总线、插槽上的设备或设备上的功能块信息。设备地址的任何部分都可以忽略，或以「*」代替 (意味著所有值)。所有数字都是十六进制。例如：「0：」指的是在0号总线上的所有设备；「0」指的是在任意总线上0号设备的所有功能块；「0.3」选择 了所有总线上0号设备的第三个功能块；「.4」则是只列出每一设备上的第四个功能块。</span><br><span class="line">-d []:[]</span><br><span class="line">只显示指定生产厂商和设备 ID 的设备。 这两个 ID 都以十六进制表示，可以忽略或者以「*」代替 (意味著所有值)。</span><br></pre></td></tr></table></figure>

<p>操作示例</p>
<p>示例1：只是简单显示目前所有的硬件设备</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~# lspci </span><br><span class="line">00:00.0 Host bridge: Intel Corporation Xeon E3-1200 v6&#x2F;7th Gen Core Processor Host Bridge&#x2F;DRAM Registers (rev 05)</span><br><span class="line">00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v5&#x2F;E3-1500 v5&#x2F;6th Gen Core Processor PCIe Controller (x16) (rev 05)</span><br><span class="line">00:08.0 System peripheral: Intel Corporation Xeon E3-1200 v5&#x2F;v6 &#x2F; E3-1500 v5 &#x2F; 6th&#x2F;7th Gen Core Processor Gaussian Mixture Model</span><br><span class="line">00:14.0 USB controller: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family USB 3.0 xHCI Controller (rev 31)</span><br><span class="line">00:14.2 Signal processing controller: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family Thermal Subsystem (rev 31)</span><br><span class="line">00:15.0 Signal processing controller: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family Serial IO I2C Controller #0 (rev 31)</span><br><span class="line">00:15.1 Signal processing controller: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family Serial IO I2C Controller #1 (rev 31)</span><br><span class="line">00:16.0 Communication controller: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family MEI Controller #1 (rev 31)</span><br><span class="line">00:16.3 Serial controller: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family KT Redirection (rev 31)</span><br><span class="line">00:17.0 SATA controller: Intel Corporation Q170&#x2F;Q150&#x2F;B150&#x2F;H170&#x2F;H110&#x2F;Z170&#x2F;CM236 Chipset SATA Controller [AHCI Mode] (rev 31)</span><br><span class="line">00:1c.0 PCI bridge: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family PCI Express Root Port #6 (rev f1)</span><br><span class="line">00:1d.0 PCI bridge: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family PCI Express Root Port #9 (rev f1)</span><br><span class="line">00:1f.0 ISA bridge: Intel Corporation Q170 Chipset LPC&#x2F;eSPI Controller (rev 31)</span><br><span class="line">00:1f.2 Memory controller: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family Power Management Controller (rev 31)</span><br><span class="line">00:1f.3 Audio device: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family HD Audio Controller (rev 31)</span><br><span class="line">00:1f.4 SMBus: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family SMBus (rev 31)</span><br><span class="line">00:1f.6 Ethernet controller: Intel Corporation Ethernet Connection (2) I219-LM (rev 31)</span><br><span class="line">01:00.0 VGA compatible controller: NVIDIA Corporation GP107 [GeForce GTX 1050 Ti] (rev a1)</span><br><span class="line">01:00.1 Audio device: NVIDIA Corporation GP107GL High Definition Audio Controller (rev a1)</span><br><span class="line">02:00.0 Ethernet controller: Intel Corporation I211 Gigabit Network Connection (rev 03)</span><br><span class="line">03:00.0 Memory controller: Xilinx Corporation Device 8034</span><br></pre></td></tr></table></figure>

<p>示例2：显示所有设备详细的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line">~# lspci -v</span><br><span class="line">00:00.0 Host bridge: Intel Corporation Xeon E3-1200 v6&#x2F;7th Gen Core Processor Host Bridge&#x2F;DRAM Registers (rev 05)</span><br><span class="line">	Subsystem: Intel Corporation Xeon E3-1200 v6&#x2F;7th Gen Core Processor Host Bridge&#x2F;DRAM Registers</span><br><span class="line">	Flags: bus master, fast devsel, latency 0</span><br><span class="line">	Capabilities: [e0] Vendor Specific Information: Len&#x3D;10 &lt;?&gt;</span><br><span class="line"></span><br><span class="line">00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v5&#x2F;E3-1500 v5&#x2F;6th Gen Core Processor PCIe Controller (x16) (rev 05) (prog-if 00 [Normal decode])</span><br><span class="line">	Flags: bus master, fast devsel, latency 0, IRQ 121</span><br><span class="line">	Bus: primary&#x3D;00, secondary&#x3D;01, subordinate&#x3D;01, sec-latency&#x3D;0</span><br><span class="line">	I&#x2F;O behind bridge: 0000e000-0000efff</span><br><span class="line">	Memory behind bridge: de000000-df0fffff</span><br><span class="line">	Prefetchable memory behind bridge: 00000000c0000000-00000000d1ffffff</span><br><span class="line">	Capabilities: [88] Subsystem: Intel Corporation Skylake PCIe Controller (x16)</span><br><span class="line">	Capabilities: [80] Power Management version 3</span><br><span class="line">	Capabilities: [90] MSI: Enable+ Count&#x3D;1&#x2F;1 Maskable- 64bit-</span><br><span class="line">	Capabilities: [a0] Express Root Port (Slot+), MSI 00</span><br><span class="line">	Capabilities: [100] Virtual Channel</span><br><span class="line">	Capabilities: [140] Root Complex Link</span><br><span class="line">	Capabilities: [d94] #19</span><br><span class="line">	Kernel driver in use: pcieport</span><br><span class="line">	Kernel modules: shpchp</span><br><span class="line"></span><br><span class="line">00:08.0 System peripheral: Intel Corporation Xeon E3-1200 v5&#x2F;v6 &#x2F; E3-1500 v5 &#x2F; 6th&#x2F;7th Gen Core Processor Gaussian Mixture Model</span><br><span class="line">	Subsystem: Intel Corporation Skylake Gaussian Mixture Model</span><br><span class="line">	Flags: fast devsel, IRQ 11</span><br><span class="line">	Memory at df252000 (64-bit, non-prefetchable) [disabled] [size&#x3D;4K]</span><br><span class="line">	Capabilities: [90] MSI: Enable- Count&#x3D;1&#x2F;1 Maskable- 64bit-</span><br><span class="line">	Capabilities: [dc] Power Management version 2</span><br><span class="line">	Capabilities: [f0] PCI Advanced Features</span><br><span class="line"></span><br><span class="line">00:14.0 USB controller: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family USB 3.0 xHCI Controller (rev 31) (prog-if 30 [XHCI])</span><br><span class="line">	Subsystem: Intel Corporation Sunrise Point-H USB 3.0 xHCI Controller</span><br><span class="line">	Flags: bus master, medium devsel, latency 0, IRQ 124</span><br><span class="line">	Memory at df230000 (64-bit, non-prefetchable) [size&#x3D;64K]</span><br><span class="line">	Capabilities: [70] Power Management version 2</span><br><span class="line">	Capabilities: [80] MSI: Enable+ Count&#x3D;1&#x2F;8 Maskable- 64bit+</span><br><span class="line">	Kernel driver in use: xhci_hcd</span><br><span class="line"></span><br><span class="line">00:14.2 Signal processing controller: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family Thermal Subsystem (rev 31)</span><br><span class="line">	Subsystem: Intel Corporation Sunrise Point-H Thermal subsystem</span><br><span class="line">	Flags: fast devsel, IRQ 18</span><br><span class="line">	Memory at df251000 (64-bit, non-prefetchable) [size&#x3D;4K]</span><br><span class="line">	Capabilities: [50] Power Management version 3</span><br><span class="line">	Capabilities: [80] MSI: Enable- Count&#x3D;1&#x2F;1 Maskable- 64bit-</span><br><span class="line">	Kernel driver in use: intel_pch_thermal</span><br><span class="line">	Kernel modules: intel_pch_thermal</span><br><span class="line"></span><br><span class="line">00:15.0 Signal processing controller: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family Serial IO I2C Controller #0 (rev 31)</span><br><span class="line">	Subsystem: Intel Corporation Sunrise Point-H Serial IO I2C Controller</span><br><span class="line">	Flags: bus master, fast devsel, latency 0, IRQ 16</span><br><span class="line">	Memory at df250000 (64-bit, non-prefetchable) [size&#x3D;4K]</span><br><span class="line">	Capabilities: [80] Power Management version 3</span><br><span class="line">	Capabilities: [90] Vendor Specific Information: Len&#x3D;14 &lt;?&gt;</span><br><span class="line">	Kernel driver in use: intel-lpss</span><br><span class="line">	Kernel modules: intel_lpss_pci</span><br><span class="line"></span><br><span class="line">00:15.1 Signal processing controller: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family Serial IO I2C Controller #1 (rev 31)</span><br><span class="line">	Subsystem: Intel Corporation Sunrise Point-H Serial IO I2C Controller</span><br><span class="line">	Flags: bus master, fast devsel, latency 0, IRQ 17</span><br><span class="line">	Memory at df24f000 (64-bit, non-prefetchable) [size&#x3D;4K]</span><br><span class="line">	Capabilities: [80] Power Management version 3</span><br><span class="line">	Capabilities: [90] Vendor Specific Information: Len&#x3D;14 &lt;?&gt;</span><br><span class="line">	Kernel driver in use: intel-lpss</span><br><span class="line">	Kernel modules: intel_lpss_pci</span><br><span class="line"></span><br><span class="line">00:16.0 Communication controller: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family MEI Controller #1 (rev 31)</span><br><span class="line">	Subsystem: Intel Corporation Sunrise Point-H CSME HECI</span><br><span class="line">	Flags: bus master, fast devsel, latency 0, IRQ 324</span><br><span class="line">	Memory at df24e000 (64-bit, non-prefetchable) [size&#x3D;4K]</span><br><span class="line">	Capabilities: [50] Power Management version 3</span><br><span class="line">	Capabilities: [8c] MSI: Enable+ Count&#x3D;1&#x2F;1 Maskable- 64bit+</span><br><span class="line">	Kernel driver in use: mei_me</span><br><span class="line">	Kernel modules: mei_me</span><br><span class="line"></span><br><span class="line">00:16.3 Serial controller: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family KT Redirection (rev 31) (prog-if 02 [16550])</span><br><span class="line">	Subsystem: Intel Corporation Sunrise Point-H KT Redirection</span><br><span class="line">	Flags: 66MHz, fast devsel, IRQ 19</span><br><span class="line">	I&#x2F;O ports at f060 [size&#x3D;8]</span><br><span class="line">	Memory at df24d000 (32-bit, non-prefetchable) [size&#x3D;4K]</span><br><span class="line">	Capabilities: [40] MSI: Enable- Count&#x3D;1&#x2F;1 Maskable- 64bit+</span><br><span class="line">	Capabilities: [50] Power Management version 3</span><br><span class="line">	Kernel driver in use: serial</span><br><span class="line"></span><br><span class="line">00:17.0 SATA controller: Intel Corporation Q170&#x2F;Q150&#x2F;B150&#x2F;H170&#x2F;H110&#x2F;Z170&#x2F;CM236 Chipset SATA Controller [AHCI Mode] (rev 31) (prog-if 01 [AHCI 1.0])</span><br><span class="line">	Subsystem: Intel Corporation Sunrise Point-H SATA controller [AHCI mode]</span><br><span class="line">	Flags: bus master, 66MHz, medium devsel, latency 0, IRQ 317</span><br><span class="line">	Memory at df248000 (32-bit, non-prefetchable) [size&#x3D;8K]</span><br><span class="line">	Memory at df24c000 (32-bit, non-prefetchable) [size&#x3D;256]</span><br><span class="line">	I&#x2F;O ports at f050 [size&#x3D;8]</span><br><span class="line">	I&#x2F;O ports at f040 [size&#x3D;4]</span><br><span class="line">	I&#x2F;O ports at f020 [size&#x3D;32]</span><br><span class="line">	Memory at df24b000 (32-bit, non-prefetchable) [size&#x3D;2K]</span><br><span class="line">	Capabilities: [80] MSI: Enable+ Count&#x3D;1&#x2F;1 Maskable- 64bit-</span><br><span class="line">	Capabilities: [70] Power Management version 3</span><br><span class="line">	Capabilities: [a8] SATA HBA v1.0</span><br><span class="line">	Kernel driver in use: ahci</span><br><span class="line">	Kernel modules: ahci</span><br><span class="line"></span><br><span class="line">00:1c.0 PCI bridge: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family PCI Express Root Port #6 (rev f1) (prog-if 00 [Normal decode])</span><br><span class="line">	Flags: bus master, fast devsel, latency 0, IRQ 122</span><br><span class="line">	Bus: primary&#x3D;00, secondary&#x3D;02, subordinate&#x3D;02, sec-latency&#x3D;0</span><br><span class="line">	I&#x2F;O behind bridge: 0000d000-0000dfff</span><br><span class="line">	Memory behind bridge: df100000-df1fffff</span><br><span class="line">	Capabilities: [40] Express Root Port (Slot+), MSI 00</span><br><span class="line">	Capabilities: [80] MSI: Enable+ Count&#x3D;1&#x2F;1 Maskable- 64bit-</span><br><span class="line">	Capabilities: [90] Subsystem: Intel Corporation Sunrise Point-H PCI Express Root Port</span><br><span class="line">	Capabilities: [a0] Power Management version 3</span><br><span class="line">	Capabilities: [100] Advanced Error Reporting</span><br><span class="line">	Capabilities: [140] Access Control Services</span><br><span class="line">	Capabilities: [200] L1 PM Substates</span><br><span class="line">	Capabilities: [220] #19</span><br><span class="line">	Kernel driver in use: pcieport</span><br><span class="line">	Kernel modules: shpchp</span><br><span class="line"></span><br><span class="line">00:1d.0 PCI bridge: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family PCI Express Root Port #9 (rev f1) (prog-if 00 [Normal decode])</span><br><span class="line">	Flags: bus master, fast devsel, latency 0, IRQ 123</span><br><span class="line">	Bus: primary&#x3D;00, secondary&#x3D;03, subordinate&#x3D;03, sec-latency&#x3D;0</span><br><span class="line">	Memory behind bridge: dc000000-ddffffff</span><br><span class="line">	Capabilities: [40] Express Root Port (Slot+), MSI 00</span><br><span class="line">	Capabilities: [80] MSI: Enable+ Count&#x3D;1&#x2F;1 Maskable- 64bit-</span><br><span class="line">	Capabilities: [90] Subsystem: Intel Corporation Sunrise Point-H PCI Express Root Port</span><br><span class="line">	Capabilities: [a0] Power Management version 3</span><br><span class="line">	Capabilities: [100] Advanced Error Reporting</span><br><span class="line">	Capabilities: [140] Access Control Services</span><br><span class="line">	Capabilities: [200] L1 PM Substates</span><br><span class="line">	Capabilities: [220] #19</span><br><span class="line">	Kernel driver in use: pcieport</span><br><span class="line">	Kernel modules: shpchp</span><br><span class="line"></span><br><span class="line">00:1f.0 ISA bridge: Intel Corporation Q170 Chipset LPC&#x2F;eSPI Controller (rev 31)</span><br><span class="line">	Subsystem: Intel Corporation Sunrise Point-H LPC Controller</span><br><span class="line">	Flags: bus master, medium devsel, latency 0</span><br><span class="line"></span><br><span class="line">00:1f.2 Memory controller: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family Power Management Controller (rev 31)</span><br><span class="line">	Subsystem: Intel Corporation Sunrise Point-H PMC</span><br><span class="line">	Flags: bus master, fast devsel, latency 0</span><br><span class="line">	Memory at df244000 (32-bit, non-prefetchable) [size&#x3D;16K]</span><br><span class="line"></span><br><span class="line">00:1f.3 Audio device: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family HD Audio Controller (rev 31)</span><br><span class="line">	Subsystem: Advantech Co. Ltd Sunrise Point-H HD Audio</span><br><span class="line">	Flags: bus master, fast devsel, latency 32, IRQ 325</span><br><span class="line">	Memory at df240000 (64-bit, non-prefetchable) [size&#x3D;16K]</span><br><span class="line">	Memory at df220000 (64-bit, non-prefetchable) [size&#x3D;64K]</span><br><span class="line">	Capabilities: [50] Power Management version 3</span><br><span class="line">	Capabilities: [60] MSI: Enable+ Count&#x3D;1&#x2F;1 Maskable- 64bit+</span><br><span class="line">	Kernel driver in use: snd_hda_intel</span><br><span class="line">	Kernel modules: snd_hda_intel</span><br><span class="line"></span><br><span class="line">00:1f.4 SMBus: Intel Corporation 100 Series&#x2F;C230 Series Chipset Family SMBus (rev 31)</span><br><span class="line">	Subsystem: Intel Corporation Sunrise Point-H SMBus</span><br><span class="line">	Flags: medium devsel, IRQ 11</span><br><span class="line">	Memory at df24a000 (64-bit, non-prefetchable) [size&#x3D;256]</span><br><span class="line">	I&#x2F;O ports at f000 [size&#x3D;32]</span><br><span class="line">	Kernel modules: i2c_i801</span><br><span class="line"></span><br><span class="line">00:1f.6 Ethernet controller: Intel Corporation Ethernet Connection (2) I219-LM (rev 31)</span><br><span class="line">	Subsystem: Intel Corporation Ethernet Connection (2) I219-LM</span><br><span class="line">	Flags: bus master, fast devsel, latency 0, IRQ 318</span><br><span class="line">	Memory at df200000 (32-bit, non-prefetchable) [size&#x3D;128K]</span><br><span class="line">	Capabilities: [c8] Power Management version 3</span><br><span class="line">	Capabilities: [d0] MSI: Enable+ Count&#x3D;1&#x2F;1 Maskable- 64bit+</span><br><span class="line">	Capabilities: [e0] PCI Advanced Features</span><br><span class="line">	Kernel driver in use: e1000e</span><br><span class="line">	Kernel modules: e1000e</span><br><span class="line"></span><br><span class="line">01:00.0 VGA compatible controller: NVIDIA Corporation GP107 [GeForce GTX 1050 Ti] (rev a1) (prog-if 00 [VGA controller])</span><br><span class="line">	Subsystem: NVIDIA Corporation Device 11bf</span><br><span class="line">	Flags: bus master, fast devsel, latency 0, IRQ 326</span><br><span class="line">	Memory at de000000 (32-bit, non-prefetchable) [size&#x3D;16M]</span><br><span class="line">	Memory at c0000000 (64-bit, prefetchable) [size&#x3D;256M]</span><br><span class="line">	Memory at d0000000 (64-bit, prefetchable) [size&#x3D;32M]</span><br><span class="line">	I&#x2F;O ports at e000 [size&#x3D;128]</span><br><span class="line">	[virtual] Expansion ROM at 000c0000 [disabled] [size&#x3D;128K]</span><br><span class="line">	Capabilities: [60] Power Management version 3</span><br><span class="line">	Capabilities: [68] MSI: Enable+ Count&#x3D;1&#x2F;1 Maskable- 64bit+</span><br><span class="line">	Capabilities: [78] Express Legacy Endpoint, MSI 00</span><br><span class="line">	Capabilities: [100] Virtual Channel</span><br><span class="line">	Capabilities: [250] Latency Tolerance Reporting</span><br><span class="line">	Capabilities: [128] Power Budgeting &lt;?&gt;</span><br><span class="line">	Capabilities: [420] Advanced Error Reporting</span><br><span class="line">	Capabilities: [600] Vendor Specific Information: ID&#x3D;0001 Rev&#x3D;1 Len&#x3D;024 &lt;?&gt;</span><br><span class="line">	Capabilities: [900] #19</span><br><span class="line">	Kernel driver in use: nvidia</span><br><span class="line">	Kernel modules: nvidiafb, nouveau, nvidia_drm, nvidia</span><br><span class="line"></span><br><span class="line">01:00.1 Audio device: NVIDIA Corporation GP107GL High Definition Audio Controller (rev a1)</span><br><span class="line">	Subsystem: NVIDIA Corporation Device 11bf</span><br><span class="line">	Flags: bus master, fast devsel, latency 0, IRQ 17</span><br><span class="line">	Memory at df080000 (32-bit, non-prefetchable) [size&#x3D;16K]</span><br><span class="line">	Capabilities: [60] Power Management version 3</span><br><span class="line">	Capabilities: [68] MSI: Enable- Count&#x3D;1&#x2F;1 Maskable- 64bit+</span><br><span class="line">	Capabilities: [78] Express Endpoint, MSI 00</span><br><span class="line">	Capabilities: [100] Advanced Error Reporting</span><br><span class="line">	Kernel driver in use: snd_hda_intel</span><br><span class="line">	Kernel modules: snd_hda_intel</span><br><span class="line"></span><br><span class="line">02:00.0 Ethernet controller: Intel Corporation I211 Gigabit Network Connection (rev 03)</span><br><span class="line">	Subsystem: Intel Corporation I211 Gigabit Network Connection</span><br><span class="line">	Flags: bus master, fast devsel, latency 0, IRQ 17</span><br><span class="line">	Memory at df100000 (32-bit, non-prefetchable) [size&#x3D;128K]</span><br><span class="line">	I&#x2F;O ports at d000 [size&#x3D;32]</span><br><span class="line">	Memory at df120000 (32-bit, non-prefetchable) [size&#x3D;16K]</span><br><span class="line">	Capabilities: [40] Power Management version 3</span><br><span class="line">	Capabilities: [50] MSI: Enable- Count&#x3D;1&#x2F;1 Maskable+ 64bit+</span><br><span class="line">	Capabilities: [70] MSI-X: Enable+ Count&#x3D;5 Masked-</span><br><span class="line">	Capabilities: [a0] Express Endpoint, MSI 00</span><br><span class="line">	Capabilities: [100] Advanced Error Reporting</span><br><span class="line">	Capabilities: [140] Device Serial Number c4-00-ad-ff-ff-3a-e7-2d</span><br><span class="line">	Capabilities: [1a0] Transaction Processing Hints</span><br><span class="line">	Kernel driver in use: igb</span><br><span class="line">	Kernel modules: igb</span><br><span class="line"></span><br><span class="line">03:00.0 Memory controller: Xilinx Corporation Device 8034</span><br><span class="line">	Subsystem: Xilinx Corporation Device 0007</span><br><span class="line">	Flags: fast devsel, IRQ 11</span><br><span class="line">	Memory at dc000000 (32-bit, non-prefetchable) [disabled] [size&#x3D;32M]</span><br><span class="line">	Capabilities: [80] Power Management version 3</span><br><span class="line">	Capabilities: [90] MSI: Enable- Count&#x3D;1&#x2F;4 Maskable- 64bit+</span><br><span class="line">	Capabilities: [c0] Express Endpoint, MSI 00</span><br><span class="line">	Capabilities: [100] Advanced Error Reporting</span><br><span class="line">	Capabilities: [300] #19</span><br></pre></td></tr></table></figure>

<p>示例3：显示具体设备更详细的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">~# lspci -vv -s 03:00.0</span><br><span class="line">03:00.0 Memory controller: Xilinx Corporation Device 8034</span><br><span class="line">	Subsystem: Xilinx Corporation Device 0007</span><br><span class="line">	Control: I&#x2F;O- Mem- BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx-</span><br><span class="line">	Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL&#x3D;fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-</span><br><span class="line">	Interrupt: pin A routed to IRQ 11</span><br><span class="line">	Region 0: Memory at dc000000 (32-bit, non-prefetchable) [disabled] [size&#x3D;32M]</span><br><span class="line">	Capabilities: [80] Power Management version 3</span><br><span class="line">		Flags: PMEClk- DSI- D1- D2- AuxCurrent&#x3D;0mA PME(D0-,D1-,D2-,D3hot-,D3cold-)</span><br><span class="line">		Status: D0 NoSoftRst+ PME-Enable- DSel&#x3D;0 DScale&#x3D;0 PME-</span><br><span class="line">	Capabilities: [90] MSI: Enable- Count&#x3D;1&#x2F;4 Maskable- 64bit+</span><br><span class="line">		Address: 0000000000000000  Data: 0000</span><br><span class="line">	Capabilities: [c0] Express (v2) Endpoint, MSI 00</span><br><span class="line">		DevCap:	MaxPayload 512 bytes, PhantFunc 0, Latency L0s &lt;64ns, L1 &lt;1us</span><br><span class="line">			ExtTag- AttnBtn- AttnInd- PwrInd- RBE+ FLReset-</span><br><span class="line">		DevCtl:	Report errors: Correctable- Non-Fatal- Fatal- Unsupported-</span><br><span class="line">			RlxdOrd+ ExtTag- PhantFunc- AuxPwr- NoSnoop+</span><br><span class="line">			MaxPayload 256 bytes, MaxReadReq 512 bytes</span><br><span class="line">		DevSta:	CorrErr- UncorrErr- FatalErr- UnsuppReq- AuxPwr- TransPend-</span><br><span class="line">		LnkCap:	Port #0, Speed 8GT&#x2F;s, Width x4, ASPM not supported, Exit Latency L0s unlimited, L1 unlimited</span><br><span class="line">			ClockPM- Surprise- LLActRep- BwNot- ASPMOptComp+</span><br><span class="line">		LnkCtl:	ASPM Disabled; RCB 64 bytes Disabled- CommClk+</span><br><span class="line">			ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt-</span><br><span class="line">		LnkSta:	Speed 8GT&#x2F;s, Width x4, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt-</span><br><span class="line">		DevCap2: Completion Timeout: Range B, TimeoutDis+, LTR-, OBFF Not Supported</span><br><span class="line">		DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-, LTR-, OBFF Disabled</span><br><span class="line">		LnkCtl2: Target Link Speed: 8GT&#x2F;s, EnterCompliance- SpeedDis-</span><br><span class="line">			 Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS-</span><br><span class="line">			 Compliance De-emphasis: -6dB</span><br><span class="line">		LnkSta2: Current De-emphasis Level: -3.5dB, EqualizationComplete+, EqualizationPhase1+</span><br><span class="line">			 EqualizationPhase2+, EqualizationPhase3+, LinkEqualizationRequest-</span><br><span class="line">	Capabilities: [100 v2] Advanced Error Reporting</span><br><span class="line">		UESta:	DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol-</span><br><span class="line">		UEMsk:	DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol-</span><br><span class="line">		UESvrt:	DLP+ SDES+ TLP- FCP+ CmpltTO- CmpltAbrt- UnxCmplt- RxOF+ MalfTLP+ ECRC- UnsupReq- ACSViol-</span><br><span class="line">		CESta:	RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr-</span><br><span class="line">		CEMsk:	RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+</span><br><span class="line">		AERCap:	First Error Pointer: 00, GenCap- CGenEn- ChkCap- ChkEn-</span><br><span class="line">	Capabilities: [300 v1] #19</span><br></pre></td></tr></table></figure>

<p>示例4：显示具体设备的256byte配置空间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~# lspci -xxx -s 03:00.0</span><br><span class="line">03:00.0 Memory controller: Xilinx Corporation Device 8034</span><br><span class="line">00: ee 10 34 80 00 00 10 00 00 00 80 05 10 00 00 00</span><br><span class="line">10: 00 00 00 dc 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">20: 00 00 00 00 00 00 00 00 00 00 00 00 ee 10 07 00</span><br><span class="line">30: 00 00 00 00 80 00 00 00 00 00 00 00 0b 01 00 00</span><br><span class="line">40: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">50: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">60: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">70: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">80: 01 90 03 00 08 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">90: 05 c0 84 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">b0: 11 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">c0: 10 00 02 00 02 80 e8 07 30 28 00 00 43 f0 43 00</span><br><span class="line">d0: 40 00 43 10 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">e0: 00 00 00 00 12 00 00 00 00 00 00 00 0e 00 00 00</span><br><span class="line">f0: 03 00 1f 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br></pre></td></tr></table></figure>

<p>示例5：显示总线树</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@ivus:~# lspci -tv</span><br><span class="line">-[0000:00]-+-00.0  Intel Corporation Xeon E3-1200 v6&#x2F;7th Gen Core Processor Host Bridge&#x2F;DRAM Registers</span><br><span class="line">           +-01.0-[01]--+-00.0  NVIDIA Corporation GP107 [GeForce GTX 1050 Ti]</span><br><span class="line">           |            \-00.1  NVIDIA Corporation GP107GL High Definition Audio Controller</span><br><span class="line">           +-08.0  Intel Corporation Xeon E3-1200 v5&#x2F;v6 &#x2F; E3-1500 v5 &#x2F; 6th&#x2F;7th Gen Core Processor Gaussian Mixture Model</span><br><span class="line">           +-14.0  Intel Corporation 100 Series&#x2F;C230 Series Chipset Family USB 3.0 xHCI Controller</span><br><span class="line">           +-14.2  Intel Corporation 100 Series&#x2F;C230 Series Chipset Family Thermal Subsystem</span><br><span class="line">           +-15.0  Intel Corporation 100 Series&#x2F;C230 Series Chipset Family Serial IO I2C Controller #0</span><br><span class="line">           +-15.1  Intel Corporation 100 Series&#x2F;C230 Series Chipset Family Serial IO I2C Controller #1</span><br><span class="line">           +-16.0  Intel Corporation 100 Series&#x2F;C230 Series Chipset Family MEI Controller #1</span><br><span class="line">           +-16.3  Intel Corporation 100 Series&#x2F;C230 Series Chipset Family KT Redirection</span><br><span class="line">           +-17.0  Intel Corporation Q170&#x2F;Q150&#x2F;B150&#x2F;H170&#x2F;H110&#x2F;Z170&#x2F;CM236 Chipset SATA Controller [AHCI Mode]</span><br><span class="line">           +-1c.0-[02]----00.0  Intel Corporation I211 Gigabit Network Connection</span><br><span class="line">           +-1d.0-[03]----00.0  Xilinx Corporation Device 8034</span><br><span class="line">           +-1f.0  Intel Corporation Q170 Chipset LPC&#x2F;eSPI Controller</span><br><span class="line">           +-1f.2  Intel Corporation 100 Series&#x2F;C230 Series Chipset Family Power Management Controller</span><br><span class="line">           +-1f.3  Intel Corporation 100 Series&#x2F;C230 Series Chipset Family HD Audio Controller</span><br><span class="line">           +-1f.4  Intel Corporation 100 Series&#x2F;C230 Series Chipset Family SMBus</span><br><span class="line">           \-1f.6  Intel Corporation Ethernet Connection (2) I219-LM</span><br></pre></td></tr></table></figure>

<p>示例6：查看厂家和设备号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~# lspci -n</span><br><span class="line">00:00.0 0600: 8086:591f (rev 05)</span><br><span class="line">00:01.0 0604: 8086:1901 (rev 05)</span><br><span class="line">00:08.0 0880: 8086:1911</span><br><span class="line">00:14.0 0c03: 8086:a12f (rev 31)</span><br><span class="line">00:14.2 1180: 8086:a131 (rev 31)</span><br><span class="line">00:15.0 1180: 8086:a160 (rev 31)</span><br><span class="line">00:15.1 1180: 8086:a161 (rev 31)</span><br><span class="line">00:16.0 0780: 8086:a13a (rev 31)</span><br><span class="line">00:16.3 0700: 8086:a13d (rev 31)</span><br><span class="line">00:17.0 0106: 8086:a102 (rev 31)</span><br><span class="line">00:1c.0 0604: 8086:a115 (rev f1)</span><br><span class="line">00:1d.0 0604: 8086:a118 (rev f1)</span><br><span class="line">00:1f.0 0601: 8086:a146 (rev 31)</span><br><span class="line">00:1f.2 0580: 8086:a121 (rev 31)</span><br><span class="line">00:1f.3 0403: 8086:a170 (rev 31)</span><br><span class="line">00:1f.4 0c05: 8086:a123 (rev 31)</span><br><span class="line">00:1f.6 0200: 8086:15b7 (rev 31)</span><br><span class="line">01:00.0 0300: 10de:1c82 (rev a1)</span><br><span class="line">01:00.1 0403: 10de:0fb9 (rev a1)</span><br><span class="line">02:00.0 0200: 8086:1539 (rev 03)</span><br><span class="line">03:00.0 0580: 10ee:8034</span><br></pre></td></tr></table></figure>

<p>解释最后一条信息的含义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">03:00.0 0580: 10ee:8034</span><br></pre></td></tr></table></figure>

<p>03:00.0代表什么意思？</p>
<p>就是 bus number = 03 ,device number = 00 function = 0 </p>
<p>0580就是Class code</p>
<p>10ee就是厂家ID</p>
<p>8034就是设备ID</p>
<h2 id="其他操作"><a href="#其他操作" class="headerlink" title="其他操作"></a>其他操作</h2><h3 id="修改配置空间"><a href="#修改配置空间" class="headerlink" title="修改配置空间"></a>修改配置空间</h3><p>在应用层修改配置空间的命令为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setpci</span><br></pre></td></tr></table></figure>

<h3 id="扫描PCI设备"><a href="#扫描PCI设备" class="headerlink" title="扫描PCI设备"></a>扫描PCI设备</h3><p>探测PCI/PCIe设备的命令为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scanpci</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a href="http://ilinuxkernel.com/?p=166" target="_blank" rel="noopener">Linux PCI/PCI-E设备配置空间读取与修改</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/22/Linux/Driver/PCIe/PCIe%E6%80%BB%E7%BA%BF%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/22/Linux/Driver/PCIe/PCIe%E6%80%BB%E7%BA%BF%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">PCIe总线基础知识</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-22 14:42:00" itemprop="dateCreated datePublished" datetime="2020-07-22T14:42:00+08:00">2020-07-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-25 14:21:21" itemprop="dateModified" datetime="2020-07-25T14:21:21+08:00">2020-07-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/" itemprop="url" rel="index"><span itemprop="name">Driver</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/PCIe/" itemprop="url" rel="index"><span itemprop="name">PCIe</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>PCIe,全称是PCI-Express（peripheral component interconnect express），这是一种高速串行计算机扩展总线标准。PCI总线使用并行总线结构，在同一条总线上的所有外部设备共享总线带宽，而PCIe总线使用高速串行差分总线，并采用端到端的连接方式，因此，在每一条PCIe链路中只能连接两个设备。两个设备之间的PCIe链路如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200722_001.png" alt=""></p>
<p>如果一条链路不够快，可以扩展多几个链路，犹如高速公路一样，车道越多，越少出现拥挤现象，开得越快。</p>
<p><img src="http://jiali.clouddn.com/20200722_002.png" alt=""></p>
<p>常见的PCIe插槽如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200724_007.png" alt=""></p>
<p>还有一些常见的PCIe设备如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200724_008.png" alt=""></p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="硬件接口"><a href="#硬件接口" class="headerlink" title="硬件接口"></a>硬件接口</h3><p>PCIe链路使用端到端的数据传送，每一个端口都包含了发送端（TX）和接收端（RX），硬件接口如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200722_003.png" alt=""></p>
<p>从图可以看出，在PCIe总线物理链路的一条PCIe数据通路（Lane）中，发送端和接收端各自有一组差分信号D-和D+，共4根线。一条PCIe总线链路中可以由多个Lane组成。使用差分信号，抗干扰性更强，因此PCIe总线可以在很高频率下正常工作。</p>
<p>PCIe链路可以支持x1、x2、x4、x8、x12、x16和x32宽度的PCIe链路。频率和编码关系如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200722_004.png" alt=""></p>
<p>8/10b编码就是10bit中含有8bit有效数据，128/130b编码就是130bit含有128位有效数据。在PCIe总线中，使用GT(Gigatransfer)计算PCIe链路的峰值带宽。计算公式如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">总线频率*数据位宽*2</span><br></pre></td></tr></table></figure>

<h3 id="电气信号"><a href="#电气信号" class="headerlink" title="电气信号"></a>电气信号</h3><p>略。</p>
<h3 id="拓扑结构"><a href="#拓扑结构" class="headerlink" title="拓扑结构"></a>拓扑结构</h3><p>一个通用处理器的PCIe总线拓扑结构如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200723_002.png" alt=""></p>
<p>整个PCIe拓扑结构是一个树形结构，Root Complex（RC）是树的根。RC为CPU代言，与整个计算机系统其它部分通讯，比如CPU通过它访问内存，通过它访问PCIe系统中的设备。大多数PCIe总线结构中，都包含了RC 、Switch 、PCIe-to-PCI桥和Endpoint（PCIe设备）组件。</p>
<p>实际上，Root Complex,简称RC。RC设计比较复杂，一个虚拟的处理器系统的RC设计如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200723_003.png" alt=""></p>
<p><strong>RC组件</strong></p>
<p>在一个处理器系统PCIe总线中，都有一个RC控制器，主要完成地址转换，和物理信号转换。类似HOST主桥的角色。具体的RC设计，看具体的处理器系统。</p>
<p><strong>Switch</strong></p>
<p>因为一条PCIe链路使用端到端的连接方式，所以，只能连接一个设备。为了一条PCIe链路能挂载多个EP，因此，需要Switch器件进行扩展。一个标准的Switch具有一个上游端口和多个下游端口。Switch内部结构如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200723_004.png" alt=""></p>
<h2 id="PCIe总线分层结构"><a href="#PCIe总线分层结构" class="headerlink" title="PCIe总线分层结构"></a>PCIe总线分层结构</h2><p>PCIe总线采用串行硬件接口，并以数据包(Packet)格式进行数据传输。数据包需要通过事务层和数据链路层，最后达到物理层，发送出去。PCIe总线的分层如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200722_005.png" alt=""></p>
<p><strong>事务层</strong>的主要职责是创建（发送）或者解析（接收）TLP (Transaction Layer packet)，流量控制，QoS，事务排序等。</p>
<p><strong>数据链路层</strong>的主要职责是创建（发送）或者解析（接收）DLLP(Data Link Layer packet)，Ack/Nak协议（链路层检错和纠错），流控，电源管理等。</p>
<p><strong>物理层</strong>的主要职责是处理所有的Packet数据物理传输，发送端数据分发到各个Lane传输（stripe），接收端把各个Lane上的数据汇总起来（De-stripe），每个Lane上加扰（Scramble，目的是让0和1分布均匀，去除信道的电磁干扰EMI）去扰（De-scramble)，以及8/10或者128/130编码解码，等等。</p>
<p>每一层都会定义包头包尾的数据格式。如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200722_007.png" alt=""></p>
<p>CPU与设备端数据交互的过程如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200722_008.png" alt=""></p>
<h2 id="事务层的TLP协议"><a href="#事务层的TLP协议" class="headerlink" title="事务层的TLP协议"></a>事务层的TLP协议</h2><p>事务层将接收PCIe设备产生的数据请求，并封装成TLP协议。FPGA PCIe的开发工作，就是在PCIe核下封装TLP协议，其他层次基本看不到。因此，重点讲一下TLP协议。TLP的基本格式如下：</p>
<p><img src="http://jiali.clouddn.com/20200722_009.png" alt=""></p>
<p>TLP头是最重要的标志，TLP Head包含了当前TLP的总线事务类型、路由信息等一系列信息。Data Payload 表示有效数据，Data Payload 长度与Max_Payload_Size、Max_Read_Request_Size和RCB参数相关。</p>
<p><strong>TLP Head格式</strong></p>
<p>一个Header大小可以是3DW，也可以是4DW。以4DW的Header为例，TLP的Header长下面样子：</p>
<p><img src="http://jiali.clouddn.com/20200722_011.png" alt=""></p>
<p>红色区域为所有TLP Header公共部分，所有Header都有这些；其它则是跟具体的TLP相关。</p>
<p>注释：</p>
<p><strong>Fmt</strong>：Format, 表明该TLP是否带有数据，Header是3DW还是4DW；</p>
<p><strong>Type</strong>：TLP类型，上一节提到的，Memory Read, Memory Write, Configuration Read, Configuration Write, Message和Completion，等等；</p>
<p><strong>R：</strong> Reserved，为0；</p>
<p><strong>TC</strong>: Traffic Class，TLP也分三六九等，优先级高的先得到服务。这里是3比特，说明可以分为8个等级，0-7，TC默认是0，数字越大，优先级越高；</p>
<p><strong>Attr:</strong> Attrbiute, 属性，前后共三个bit，先不说；</p>
<p><strong>TH</strong>: TLP Processing Hints，先不说；</p>
<p><strong>TD</strong>: TLP Digest，之前说ECRC可选，如果这个这个bit置起来，说明该TLP包含ECRC，接收端应该做CRC校验；</p>
<p><strong>EP</strong>: Poisoned data, 有毒的数据，远离，哈哈；</p>
<p><strong>AT</strong>: Address Type，地址种类，先不说；</p>
<p><strong>Length</strong>： Payload数据长度，1~1024，单位DW（4byte），所以TLP最大数据长度是4KB; 该长度总是DW的整数倍，如果TLP的数据不是DW的整数倍（不是4Byte的整数倍），则需要用到两个域：Last DW BE 和 1st DW BE。</p>
<p><strong>存储器读写请求的TLP</strong></p>
<p>64位的处理器系统的存储器读写请求的TLP格式如下图</p>
<p><img src="http://jiali.clouddn.com/20200722_012.png" alt=""></p>
<p>32位的处理器系统的存储器读写请求的TLP格式如下图</p>
<p><img src="http://jiali.clouddn.com/20200722_013.png" alt=""></p>
<p>Requester ID字段包含了生成这个TLP报文的PCIe设备的总线号（Bus Number）、设备号（Device Number）和功能号（Function Number）。因此，Requester ID就是源地址，其格式如下：</p>
<p><img src="http://jiali.clouddn.com/20200722_014.png" alt=""></p>
<p>Address:目的地址。PCIe设备，进行DMA操作，往处理器的DDR读写数据时候，需要获取DDR的内存地址，来填充Address。</p>
<p><strong>注意：</strong></p>
<p>基于厂家FPGA 的PCIe开发，主要是做事务层开发工作，封装TLP，对TLP接收和发送进行处理。因此，熟悉事务层的存储器、I/O和配置读写请求TLP过程很重要。曾经，CPU写FPGA PCIe设备的BAR地址空间的某个寄存器，因为FPGA 不返回TLP，导致CPU卡住。</p>
<p><strong>Data Payload参数</strong> </p>
<p>Max_Payload_Size参数存放PCIe设备<strong>实际使用</strong>的TLP有效负载的最大值。<strong>该参数由PCIe链路两端的设备协商决定，是PCIe设备进行数据传送时，实际使用的参数</strong>。当PCIe设备发送数据报文时，设置Max_Payload_Size参数决定TLP的Data Payload 长度的最大值。</p>
<p>Max_Payload_Size_Supported参数表示一个PCIe设备中TLP有效负载的最大值，这是由PCIe设备的硬件逻辑决定，软件不能更改。</p>
<p>Max_Payload_Size和Max_Payload_Size_Supported分别在PCI Express Capability结构中的Device Capability和Device Control寄存器中定义。</p>
<p>Max_Payload_Size可以设置为128byte、256byte、512byte和1024byte.在FPGA实际应用中，需要配置Max_Payload_Size和<strong>TLP</strong>的Length字段。FPGA的Max_Payload_Size配置如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200722_010.png" alt=""></p>
<p><strong>注意：</strong></p>
<p>当PCIe设备接收TLP时，该TLP的最大有效负载不能超过Max_Payload_Size（就是Length字段不能超过Max_Payload_Size），如果Length字段超过Length字段，则接收TLP的PCIe设备认为TLP非法。因此一次TLP传输数据失败。曾经，FPGA进行DMA操作，往CPU系统的DDR写数据，因为一次性把很大的数据量填充到TLP中，所以导致，CPU收不到数据。</p>
<h2 id="PCIe设备的配置空间"><a href="#PCIe设备的配置空间" class="headerlink" title="PCIe设备的配置空间"></a>PCIe设备的配置空间</h2><p>0x00<del>0xff,这段地址空间共256byte，PCI\PCI-X\PCIe都包含了这256byte配置空间。大多数PCI设备仅支持0x00</del>0x3f，这64byte的配置空间。此外，0x40~0xff，这段配置空间，主要存放一些与MSI或者MSI-X中断管理和电源管理相关的Capability结构。大多数PCI设备不支持MSI\MSI-X中断，而PCIe设备必须支持MSI\MSI-X中断机制(<strong>大多是PCIe设备使用MSI中断</strong>)。</p>
<p>64byte的配置空间如下图：</p>
<p><img src="http://jiali.clouddn.com/20200721_004.png" alt=""></p>
<p>另外，PCIe设备支持0x100<del>0xfff这段扩展配置空间。因此PCIe设备的配置空间最大位4k。0x100</del>0xfff这段空间，存放PCIe设备所独有的一些Capability结构，PCI设备是不能使用这段空间（事实上，PCI设备仅支持0x00~0x3f这段配置空间）。</p>
<p>PCIe设备的配置空间如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200723_005.png" alt=""></p>
<p><strong>注意：</strong></p>
<p>在实际工程中，在FPGA PCIe核设置好BAR配置空间的大小，系统软件根据大小分配PCIe总线地址空间。FPGA配置如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200724_001.png" alt=""></p>
<h2 id="MSI中断机制"><a href="#MSI中断机制" class="headerlink" title="MSI中断机制"></a>MSI中断机制</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>在PCI总线中，所有需要提交的中断请求，必须通过INTx引脚向处理器提交中断请求；而在PCIe总线中，PCIe设备向处理器提交中断，是通过MSI机制实现，不需要通过INTx引脚。</p>
<p>MSI机制就是使用存储器写请求TLP向处理器提交中断请求。这种MSI消息，也简称为MSI报文。此外MSI中断最多支持32个中断。32位和64位的MSI 报文协议结构如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200724_002.png" alt=""></p>
<p><strong>Message Control:</strong> 该字段存放当前PCIe设备使用的MSI机制进行中断请求的状态与控制信息。</p>
<p><strong>Message Address:</strong> 该字段存放MSI存储器写事务的目的地址低32位。</p>
<p><strong>Message Upper Address:</strong> 该字段存放MSI存储器写事务的目的地址高32位。</p>
<p>重点关注Message Control字段含义，如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200724_003.png" alt=""></p>
<h3 id="工程实践"><a href="#工程实践" class="headerlink" title="工程实践"></a>工程实践</h3><p>FPGA PCIe MSI控制器配置寄存器地址，如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200724_004.png" alt=""></p>
<p>MSI Control Register，如下图所示。</p>
<p><img src="http://jiali.clouddn.com/20200724_005.png" alt=""></p>
<p>通过MSI控制寄存器可将MSI中断配置成多消息中断模式，中断个数可通过Multiple Message Enable 配置，只读字段Multiple Message Capable表示系统分配给PCIe设备的中断向量数量。</p>
<p><strong>注意：</strong></p>
<p>曾经FPGA没有配置字段Multiple Message Capable，因为该字段默认为0,所以，无论怎么配置Multiple Message Enable，MSI只产生1个中断（0号MSI中断）。</p>
<p>FPGA PCIe设备中，cfg_interrupt_msi_int MSI各中断寄存器如下表所示。</p>
<p><img src="http://jiali.clouddn.com/20200724_006.png" alt=""></p>
<p>只要置位中断寄存器对应的Bit,就可以触发中断。例如，本次使用0，1，2号中断，在相应位置位就可以触发中断。</p>
<p>Linux MSI中断配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;1、申请四个中断</span><br><span class="line">pci_alloc_irq_vectors(pdev,1,4,PCI_IRQ_MSI);</span><br><span class="line">&#x2F;&#x2F;2、设置Multiple Message Enable字段为4</span><br><span class="line">control |&#x3D; 0x0020;</span><br><span class="line">pci_write_config_word(pdev,pdev-&gt;msi_cap+2,control);</span><br><span class="line">&#x2F;&#x2F;注册中断</span><br><span class="line">irq &#x3D; pci_irq_vector(pdev,0);</span><br><span class="line">err &#x3D; request_irq(irq, ps_pcie_intr_handler_no_msix, IRQF_SHARED, &quot;PCIE PS PCIe DMA Device&quot;, ptr_dma_desc_temp);</span><br><span class="line">irq &#x3D; pci_irq_vector(pdev,1);	</span><br><span class="line">err &#x3D; request_irq(irq, ps_pcie_intr_handler_no_msix_1, IRQF_SHARED, &quot;PCIE PS PCIe DMA Device_1&quot;, ptr_dma_desc_temp);</span><br><span class="line">irq &#x3D; pci_irq_vector(pdev,2);</span><br><span class="line">err &#x3D; request_irq(irq, ps_pcie_intr_handler_no_msix_2, IRQF_SHARED, &quot;PCIE PS PCIe DMA Device2&quot;, ptr_dma_desc_temp);</span><br><span class="line">&#x2F;&#x2F;编写中断函数</span><br><span class="line">略。。。</span><br></pre></td></tr></table></figure>









<p>参考：</p>
<p><a href="https://www.cnblogs.com/YINBin/p/10946247.html" target="_blank" rel="noopener">PCIe总线（协议简述）</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/26172972" target="_blank" rel="noopener">深入PCI与PCIe之一：硬件篇</a></p>
<p><a href="http://xilinx.eetrend.com/d6-xilinx/blog/2018-08/13327.html" target="_blank" rel="noopener">PCIe学习（一）：PCIe基础及生成PIO例程分析</a></p>
<p><a href="http://www.ssdfans.com/?p=8211" target="_blank" rel="noopener">老男孩读PCIe之一：从PCIe速度说起</a></p>
<p><a href="http://www.ssdfans.com/?p=8213" target="_blank" rel="noopener">老男孩读PCIe之二：PCIe拓扑结构</a></p>
<p><a href="http://www.ssdfans.com/?p=8214" target="_blank" rel="noopener">老男孩读PCIe之三：PCIe分层结构</a></p>
<p><a href="http://www.ssdfans.com/?p=8215" target="_blank" rel="noopener">老男孩读PCIe之四：TLP类型</a></p>
<p><a href="http://www.ssdfans.com/?p=8212" target="_blank" rel="noopener">老男孩读PCIe之五：TLP结构</a></p>
<p><a href="http://www.ssdfans.com/?p=8210" target="_blank" rel="noopener">老男孩读PCIe之六：配置和地址空间</a></p>
<p><a href="http://www.ssdfans.com/?p=8216" target="_blank" rel="noopener">老男孩读PCIe之七：TLP的路由</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="David Meng"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">David Meng</p>
  <div class="site-description" itemprop="description">冒险，创新，永不放弃</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">70</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/jialimeng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jialimeng" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jiali201209@163.com" title="E-Mail → mailto:jiali201209@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://ilinuxkernel.com/" title="http:&#x2F;&#x2F;ilinuxkernel.com" rel="noopener" target="_blank">Linux Kernel Exploration</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.wowotech.net/" title="http:&#x2F;&#x2F;www.wowotech.net" rel="noopener" target="_blank">蜗窝科技</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tinylab.org/" title="http:&#x2F;&#x2F;tinylab.org" rel="noopener" target="_blank">泰晓科技</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Meng</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
