<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="冒险，创新，永不放弃">
<meta property="og:type" content="website">
<meta property="og:title" content="Tech Blog">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="Tech Blog">
<meta property="og:description" content="冒险，创新，永不放弃">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="David Meng">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Tech Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
    <a href="https://github.com/jialimeng" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Tech Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/25/Linux/Driver/storage/Flash%20Memory/mmc/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91eMMC%E6%80%BB%E7%BA%BF%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/25/Linux/Driver/storage/Flash%20Memory/mmc/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91eMMC%E6%80%BB%E7%BA%BF%E5%8D%8F%E8%AE%AE/" class="post-title-link" itemprop="url">【转载】eMMC总线协议</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-12-25 10:55:32 / Modified: 10:58:51" itemprop="dateCreated datePublished" datetime="2020-12-25T10:55:32+08:00">2020-12-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/" itemprop="url" rel="index"><span itemprop="name">Driver</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/storage/Flash-Memory/" itemprop="url" rel="index"><span itemprop="name">Flash Memory</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/storage/Flash-Memory/mmc/" itemprop="url" rel="index"><span itemprop="name">mmc</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h2 id="1-eMMC-总线接口"><a href="#1-eMMC-总线接口" class="headerlink" title="1. eMMC 总线接口"></a>1. eMMC 总线接口</h2><p>eMMC 总线接口定义如下图所示：</p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_host_interfaces.png" alt="img"></p>
<p>各个信号的描述如下：</p>
<p><strong>CLK</strong></p>
<p>CLK 信号用于从 Host 端输出时钟信号，进行数据传输的同步和设备运作的驱动。<br>在一个时钟周期内，CMD 和 DAT0-7 信号上都可以支持传输 1 个比特，即 SDR (Single Data Rate) 模式。此外，DAT0-7 信号还支持配置为 DDR (Double Data Rate) 模式，在一个时钟周期内，可以传输 2 个比特。<br>Host 可以在通讯过程中动态调整时钟信号的频率（注，频率范围需要满足 Spec 的定义）。通过调整时钟频率，可以实现省电或者数据流控（避免 Over-run 或者 Under-run）功能。 在一些场景中，Host 端还可以关闭时钟，例如 eMMC 处于 Busy 状态时，或者接收完数据，进入 Programming State 时。</p>
<p><strong>CMD</strong></p>
<p>CMD 信号主要用于 Host 向 eMMC 发送 Command 和 eMMC 向 Host 发送对于的 Response。Command 和 Response 的细节会在后续章节中介绍。</p>
<p><strong>DAT0-7</strong></p>
<p>DAT0-7 信号主要用于 Host 和 eMMC 之间的数据传输。在 eMMC 上电或者软复位后，只有 DAT0 可以进行数据传输，完成初始化后，可配置 DAT0-3 或者 DAT0-7 进行数据传输，即数据总线可以配置为 4 bits 或者 8 bits 模式。</p>
<p><strong>Data Strobe</strong></p>
<p>Data Strobe 时钟信号由 eMMC 发送给 Host，频率与 CLK 信号相同，用于 Host 端进行数据接收的同步。Data Strobe 信号只能在 HS400 模式下配置启用，启用后可以提高数据传输的稳定性，省去总线 tuning 过程。</p>
<blockquote>
<p><strong>NOTE:</strong><br>Extended CSD byte[183] BUS_WIDTH 寄存器用于配置总线宽度和 Data Strobe</p>
</blockquote>
<h2 id="2-eMMC-总线模型"><a href="#2-eMMC-总线模型" class="headerlink" title="2. eMMC 总线模型"></a>2. eMMC 总线模型</h2><p>eMMC 总线中，可以有一个 Host，多个 eMMC Devices。总线上的所有通讯都由 Host 端以一个 Command 开发发起，Host 一次只能与一个 eMMC Device 通讯。</p>
<p>系统在上电启动后，Host 会为所有 eMMC Device 逐个分配地址（RCA，Relative device Address）。当 Host 需要和某一个 eMMC Device 通讯时，会先根据 RCA 选中该 eMMC Device，只有被选中的 eMMC Device 才会响应 Host 的 Command。</p>
<blockquote>
<p>NOTE:<br>更详细的工作原理请参考 <a href="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_modes.html" target="_blank" rel="noopener">eMMC 工作模式</a> 章节。</p>
</blockquote>
<h3 id="2-1-速率模式"><a href="#2-1-速率模式" class="headerlink" title="2.1 速率模式"></a>2.1 速率模式</h3><p>随着 eMMC 协议的版本迭代，eMMC 总线的速率越来越高。为了兼容旧版本的 eMMC Device，所有 Devices 在上电启动或者 Reset 后，都会先进入兼容速率模式（Backward Compatible Mode）。在完成 eMMC Devices 的初始化后，Host 可以通过特定的流程，让 Device 进入其他高速率模式，目前支持以下的几种速率模式。</p>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Data Rate</th>
<th>Bus Width</th>
<th>Frequency</th>
<th>Max Data Transfer (x8)</th>
</tr>
</thead>
<tbody><tr>
<td>Backward Compatible</td>
<td>Single</td>
<td>x1, x4, x8</td>
<td>0-26 MHz</td>
<td>26 MB/s</td>
</tr>
<tr>
<td>High Speed SDR</td>
<td>Single</td>
<td>x1, x4, x8</td>
<td>0-52 MHz</td>
<td>52 MB/s</td>
</tr>
<tr>
<td>High Speed DDR</td>
<td>Dual</td>
<td>x4, x8</td>
<td>0-52 MHz</td>
<td>104 MB/s</td>
</tr>
<tr>
<td>HS200</td>
<td>Single</td>
<td>x4, x8</td>
<td>0-200 MHz</td>
<td>200 MB/s</td>
</tr>
<tr>
<td>HS400</td>
<td>Dual</td>
<td>x8</td>
<td>0-200 MHz</td>
<td>400 MB/s</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>NOTE:</strong><br>Extended CSD byte[185] HS_TIMING 寄存器可以配置总线速率模式<br>Extended CSD byte[183] BUS_WIDTH 寄存器用于配置总线宽度和 Data Strobe</p>
</blockquote>
<h3 id="2-2-通信模型"><a href="#2-2-通信模型" class="headerlink" title="2.2 通信模型"></a>2.2 通信模型</h3><p>Host 与 eMMC Device 之间的通信都是由 Host 以一个 Command 开始发起的，eMMC Device 在完成 Command 所指定的任务后，则返回一个 Response。</p>
<h4 id="2-2-1-Read-Data"><a href="#2-2-1-Read-Data" class="headerlink" title="2.2.1 Read Data"></a>2.2.1 Read Data</h4><p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/multi_block_read.png" alt="img"></p>
<p>Host 从 eMMC Device 读取数据的流程如上图所示。</p>
<p>如果 Host 发送的是 Single Block Read 的 Command，那么 eMMC Device 只会发送一个 Block 的数据（一个 Block 的数据的字节数由 Host 设定或者为 eMMC Device 的默认值，更多细节请参考 <a href="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_modes.html" target="_blank" rel="noopener">eMMC 工作模式</a> 章节）。<br>如果 Host 发送的是 Multiple Block Read 的 Command，那么 eMMC Device 会持续发送数据，直到 Host 主动发送 Stop Command。</p>
<blockquote>
<p><strong>NOTE:</strong><br>从 eMMC Device 读数据都是按 Block 读取的。</p>
</blockquote>
<h4 id="2-2-2-Write-Data"><a href="#2-2-2-Write-Data" class="headerlink" title="2.2.2 Write Data"></a>2.2.2 Write Data</h4><p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/multi_block_write.png" alt="img"></p>
<p>Host 向 eMMC Device 写入数据的流程如上图所示。</p>
<p>如果 Host 发送的是 Single Block Write Command，那么 eMMC Device 只会将后续第一个 Block 的数据写入的存储器中。<br>如果 Host 发送的是 Multiple Block Write Command，那么 eMMC Device 会持续地将接收到的数据写入到存储器中，直到 Host 主动发送 Stop Command。</p>
<p>eMMC Device 在接收到一个 Block 的数据后，会进行 CRC 校验，然后将校验结果通过 CRC Token 发送给 Host。<br>发送完 CRC Token 后，如果 CRC 校验成功，eMMC Device 会将数据写入到内部存储器时，此时 DAT0 信号会拉低，作为 Busy 信号。Host 会持续检测 DAT0 信号，直到为高电平时，才会接着发送下一个 Block 的数据。如果 CRC 校验失败，那么 eMMC Device 不会进行数据写入，此次传输后续的数据都会被忽略。</p>
<blockquote>
<p><strong>NOTE:</strong><br>向 eMMC Device 写数据都是按 Block 写入的。</p>
</blockquote>
<h4 id="2-2-3-No-Data"><a href="#2-2-3-No-Data" class="headerlink" title="2.2.3 No Data"></a>2.2.3 No Data</h4><p>在 Host 与 eMMC Device 的通信中，有部分交互是不需要进行数据传输的，还有部分交互甚至不需要 eMMC Device 的回复 Response。</p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/no_resp_or_data.png" alt="img"></p>
<h4 id="2-2-4-Command"><a href="#2-2-4-Command" class="headerlink" title="2.2.4 Command"></a>2.2.4 Command</h4><p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/command_token_format.png" alt="img"></p>
<p>如上图所示，eMMC Command 由 48 Bits 组成，各个 Bits 的解析如下所示：</p>
<table>
<thead>
<tr>
<th>Description</th>
<th>Start Bit</th>
<th>Transmission Bit</th>
<th>Command Index</th>
<th>Argument</th>
<th>CRC7</th>
<th>End Bit</th>
</tr>
</thead>
<tbody><tr>
<td>Bit position</td>
<td>47</td>
<td>46</td>
<td>[45:40]</td>
<td>[39:8]</td>
<td>[7:1]</td>
<td>0</td>
</tr>
<tr>
<td>Width (bits)</td>
<td>1</td>
<td>1</td>
<td>6</td>
<td>32</td>
<td>7</td>
<td>1</td>
</tr>
<tr>
<td>Value</td>
<td>“0”</td>
<td>“1”</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>“1”</td>
</tr>
</tbody></table>
<p>Start Bit 固定为 “0”，在没有数据传输的情况下，CMD 信号保持高电平，当 Host 将 Start Bit 发送到总线上时，eMMC Device 可以很方便检测到该信号，并开始接收 Command。</p>
<p>Transmission Bit 固定为 “1”，指示了该数据包的传输方向为 Host 发送到 eMMC Device。</p>
<p>Command Index 和 Argument 为 Command 的具体内容，不同的 Command 有不同的 Index，不同的 Command 也有各自的 Argument。 更多的细节，请参考 <a href="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_commands.html" target="_blank" rel="noopener">eMMC Commands</a> 章节。</p>
<p>CRC7 是包含 Start Bit、Transmission Bit、 Command Index 和 Argument 内容的 CRC 校验值。</p>
<p>End Bit 为结束标志位，固定为”1”。</p>
<blockquote>
<p><strong>NOTE:</strong><br>CRC 校验简单来说，是发送方将需要传输的数据“除于”（模2除）一个约定的数，并将得到的余数附在数据上一并发送出去。接收方收到数据后，再做同样的“除法”，然后校验得到余数是否与接收的余数相同。如果不相同，那么意味着数据在传输过程中发生了改变。更多的细节不在本文展开描述，感兴趣的读者可以参考 <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check" target="_blank" rel="noopener">CRC wiki</a> 中的介绍。</p>
</blockquote>
<h4 id="2-2-5-Response"><a href="#2-2-5-Response" class="headerlink" title="2.2.5 Response"></a>2.2.5 Response</h4><p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/respone_token_format.png" alt="img"></p>
<p>eMMC Response 有两种长度的数据包，分别为 48 Bits 和 136 Bits。</p>
<p>Start Bit 与 Command 一样，固定为 “0”，在没有数据传输的情况下，CMD 信号保持高电平，当 eMMC Device 将 Start Bit 发送到总线上时，Host 可以很方便检测到该信号，并开始接收 Response。</p>
<p>Transmission Bit 固定为 “0”，指示了该数据包的传输方向为 eMMC Device 发送到 Host。</p>
<p>Content 为 Response 的具体内容，不同的 Command 会有不同的 Content。 更多的细节，请参考 <a href="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_responses.html" target="_blank" rel="noopener">eMMC Responses</a> 章节。</p>
<p>CRC7 是包含 Start Bit、Transmission Bit 和 Content 内容的 CRC 校验值。</p>
<p>End Bit 为结束标志位，固定为”1”。</p>
<h4 id="2-2-6-Data-Block"><a href="#2-2-6-Data-Block" class="headerlink" title="2.2.6 Data Block"></a>2.2.6 Data Block</h4><p>Data Block 由 Start Bit、Data、CRC16 和 End Bit 组成。以下是不同总线宽度和 Data Rate 下，Data Block 详细格式。</p>
<p><strong>1 Bit Bus SDR</strong></p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/1_bit_bus_sdr.png" alt="img"></p>
<p>CRC 为 Data 的 16 bit CRC 校验值，不包含 Start Bit。</p>
<p><strong>4 Bits Bus SDR</strong></p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/4_bits_bus_sdr.png" alt="img"></p>
<p>各个 Data Line 上的 CRC 为对应 Data Line 的 Data 的 16 bit CRC 校验值。</p>
<p><strong>8 Bits Bus SDR</strong></p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/8_bits_bus_sdr.png" alt="img"></p>
<p>各个 Data Line 上的 CRC 为对应 Data Line 的 Data 的16 bit CRC 校验值。</p>
<p><strong>4 Bits Bus DDR</strong></p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/4_bits_bus_ddr.png" alt="img"></p>
<p><strong>8 Bits Bus DDR</strong></p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/8_bits_bus_ddr.png" alt="img"></p>
<p>在 DDR 模式下，Data Line 在时钟的上升沿和下降沿都会传输数据，其中上升沿传输数据的奇数字节 （Byte 1,3,5 …），下降沿则传输数据的偶数字节（Byte 2,4,6 …）。<br>此外，在 DDR 模式下，1 个 Data Line 上有两个相互交织的 CRC16，上升沿的 CRC 比特组成 odd CRC16，下降沿的 CRC 比特组成 even CRC16。odd CRC16 用于校验该 Data Line 上所有上升沿比特组成的数据，even CRC16 则用于校验该 Data Line 上所有下降沿比特组成的数据。</p>
<blockquote>
<p><strong>NOTE:</strong><br>DDR 模式下使用两个 CRC16 作为校验，可能是为了更可靠的校验，选用 CRC16 而非 CRC32 则可能是出于兼容性设计的考虑。</p>
</blockquote>
<h4 id="2-2-7-CRC-Status-Token"><a href="#2-2-7-CRC-Status-Token" class="headerlink" title="2.2.7 CRC Status Token"></a>2.2.7 CRC Status Token</h4><p>在写数据传输中，eMMC Device 接收到 Host 发送的一个 Data Block 后，会进行 CRC 校验，如果校验成功，eMMC 会在对应的 Data Line 上向 Host 发回一个 Positive CRC status token (010)，如果校验失败，则会在对应的 Data Line 上发送一个 Negative CRC status token (101)。</p>
<blockquote>
<p><strong>NOTE:</strong><br>读数据时，Host 接收到 eMMC Device 发送的 Data Block 后，也会进行 CRC 校验，但是不管校验成功或者失败，都不会向 eMMC Device 发送 CRC Status Token。</p>
</blockquote>
<p>详细格式如下图所示：</p>
<p><strong>Positive CRC status token</strong></p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/positive_crc_status_token.png" alt="img"></p>
<p><strong>Negative CRC status token</strong></p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/negative_crc_status_token.png" alt="img"></p>
<h2 id="3-eMMC-总线测试过程"><a href="#3-eMMC-总线测试过程" class="headerlink" title="3. eMMC 总线测试过程"></a>3. eMMC 总线测试过程</h2><p>当 eMMC Device 处于 SDR 模式时，Host 可以发送 CMD19 命令，触发总线测试过程（Bus testing procedure），测试总线硬件上的连通性。如果 eMMC Device 支持总线测试，那么 eMMC Device 在接收到 CMD19 后，会发回对应的 Response，接着 eMMC Device 会发送一组固定的测试数据给 Host。Host 接收到数据后，检查数据正确与否，即可得知总线是否正确连通。</p>
<blockquote>
<p><strong>NOTE:</strong> 如果 eMMC Device 不支持总线测试，那么接收到 CMD19 时，不会发回 Response。<br>总线测试不支持在 DDR 模式下进行。</p>
</blockquote>
<p>测试数据如下所示：</p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/bus_testing_data.png" alt="img"></p>
<blockquote>
<p><strong>NOTE:</strong> 总线宽度为 1 时，只发送 DAT0 上的数据，总线宽度为 4 时，则只发送 DAT0-3 上的数据</p>
</blockquote>
<h2 id="4-eMMC-总线-Sampling-Tuning"><a href="#4-eMMC-总线-Sampling-Tuning" class="headerlink" title="4. eMMC 总线 Sampling Tuning"></a>4. eMMC 总线 Sampling Tuning</h2><p>由于芯片制造工艺、PCB 走线、电压、温度等因素的影响，数据信号从 eMMC Device 到达 Host 端的时间是存在差异的，Host 接收数据时采样的时间点也需要相应的进行调整。而 Host 端最佳采样时间点，则是通过 Sampling Tuning 流程得到。</p>
<blockquote>
<p><strong>NOTE:</strong><br>不同 eMMC Device 最佳的采样点可能不同，同一 eMMC Device 在不同的环境下运作时的最佳采样点也可能不同。<br>在 eMMC 标准中，定义了在 HS200 模式下可以进行 Sampling Tuning。</p>
</blockquote>
<h3 id="4-1-Sampling-Tuning-流程"><a href="#4-1-Sampling-Tuning-流程" class="headerlink" title="4.1 Sampling Tuning 流程"></a>4.1 Sampling Tuning 流程</h3><p>Sampling Tuning 是用于计算 Host 最佳采样时间点的流程，大致的流程如下：</p>
<ol>
<li>Host 将采样时间点重置为默认值</li>
<li>Host 向 eMMC Device 发送 Send Tuning Block 命令</li>
<li>eMMC Device 向 Host 发送固定的 Tuning Block 数据</li>
<li>Host 接收到 Tuning Block 并进行校验</li>
<li>Host 修改采样时点，重新从第 2 步开始执行，直到 Host 获取到一个有效采样时间点区间</li>
<li>Host 取有效采样时间点区间的中间值作为采样时间点，并推出 Tuning 流程</li>
</ol>
<blockquote>
<p><strong>NOTE:</strong><br>上述流程仅仅是一个示例。Tuning 流程执行的时机、频率和具体的步骤是由 Host 端的 eMMC Controller 具体实现而定的。</p>
</blockquote>
<h3 id="4-2-Tuning-Block-数据"><a href="#4-2-Tuning-Block-数据" class="headerlink" title="4.2 Tuning Block 数据"></a>4.2 Tuning Block 数据</h3><p>Tuning Block 是专门为了 Tuning 而设计的一组特殊数据。相对于普通的数据，这组特殊数据在传输过程中，会更高概率的出现 high SSO noise、deterministic jitter、ISI、timing errors 等问题。这组数据的具体内容如下所示：</p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/tuning_block_pattern.png" alt="img"></p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/tuning_block_on_data_lines.png" alt="img"></p>
<blockquote>
<p><strong>NOTE:</strong> 总线宽度为 1 时，只发送 DAT0 上的数据，总线宽度为 4 时，则只发送 DAT0-3 上的数据</p>
</blockquote>
<h2 id="5-参考资料"><a href="#5-参考资料" class="headerlink" title="5. 参考资料"></a>5. 参考资料</h2><ol>
<li><a href="http://www.jedec.org/sites/default/files/docs/JESD84-B51.pdf" target="_blank" rel="noopener">Embedded Multi-Media Card (e•MMC) Electrical Standard (5.1)</a> [PDF]</li>
<li><a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.296.5338&rep=rep1&type=pdf" target="_blank" rel="noopener">SD/MMC Controller, Hard Processor System (HPS) Technical Reference Manual (TRM)</a> [PDF]</li>
<li><a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check" target="_blank" rel="noopener">CRC wiki</a> [WEB]</li>
</ol>
<p><strong>注</strong>：本文转自蜗窝科技<a href="http://www.wowotech.net，来自【http://www.wowotech.net/basic_tech/emmc_bus_protocol.html】" target="_blank" rel="noopener">www.wowotech.net，来自【http://www.wowotech.net/basic_tech/emmc_bus_protocol.html】</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/25/Linux/Driver/storage/Flash%20Memory/mmc/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91eMMC%E5%88%86%E5%8C%BA%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/25/Linux/Driver/storage/Flash%20Memory/mmc/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91eMMC%E5%88%86%E5%8C%BA%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">【转载】eMMC分区管理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-12-25 10:48:04 / Modified: 10:54:24" itemprop="dateCreated datePublished" datetime="2020-12-25T10:48:04+08:00">2020-12-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/" itemprop="url" rel="index"><span itemprop="name">Driver</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/storage/Flash-Memory/" itemprop="url" rel="index"><span itemprop="name">Flash Memory</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/storage/Flash-Memory/mmc/" itemprop="url" rel="index"><span itemprop="name">mmc</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h2 id="1-Partitions-Overview"><a href="#1-Partitions-Overview" class="headerlink" title="1. Partitions Overview"></a>1. Partitions Overview</h2><p>eMMC 标准中，将内部的 Flash Memory 划分为 4 类区域，最多可以支持 8 个硬件分区，如下图所示：</p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_partitions.png" alt="img"></p>
<h3 id="1-1-概述"><a href="#1-1-概述" class="headerlink" title="1.1 概述"></a>1.1 概述</h3><p>一般情况下，Boot Area Partitions 和 RPMB Partition 的容量大小通常都为 4MB，部分芯片厂家也会提供配置的机会。General Purpose Partitions (GPP) 则在出厂时默认不被支持，即不存在这些分区，需要用户主动使能，并配置其所要使用的 GPP 的容量大小，GPP 的数量可以为 1 - 4 个，各个 GPP 的容量大小可以不一样。User Data Area (UDA) 的容量大小则为总容量大小减去其他分区所占用的容量。更多各个分区的细节将在后续小节中描述。</p>
<h3 id="1-2-分区编址"><a href="#1-2-分区编址" class="headerlink" title="1.2 分区编址"></a>1.2 分区编址</h3><p>eMMC 的每一个硬件分区的存储空间都是独立编址的，即访问地址为 0 - partition size。具体的数据读写操作实际访问哪一个硬件分区，是由 eMMC 的 Extended CSD register 的 PARTITION_CONFIG Field 中 的 Bit[2:0]: PARTITION_ACCESS 决定的，用户可以通过配置 PARTITION_ACCESS 来切换硬件分区的访问。也就是说，用户在访问特定的分区前，需要先发送命令，配置 PARTITION_ACCESS，然后再发送相关的数据访问请求。更多数据读写相关的细节，请参考 <a href="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_bus_protocol.html" target="_blank" rel="noopener">eMMC 总线协议</a> 章节。</p>
<p>eMMC 的各个硬件分区有其自身的功能特性，多分区的设计，为不同的应用场景提供了便利。</p>
<h2 id="2-Boot-Area-Partitions"><a href="#2-Boot-Area-Partitions" class="headerlink" title="2. Boot Area Partitions"></a>2. Boot Area Partitions</h2><p>Boot Area 包含两个 Boot Area Partitions，主要用于存储 Bootloader，支持 SOC 从 eMMC 启动系统。</p>
<h3 id="2-1-容量大小"><a href="#2-1-容量大小" class="headerlink" title="2.1 容量大小"></a>2.1 容量大小</h3><p>两个 Boot Area Partitions 的大小是完全一致的，由 Extended CSD register 的 BOOT_SIZE_MULT Field 决定，大小的计算公式如下：</p>
<p><strong>Size = 128Kbytes x BOOT_SIZE_MULT</strong></p>
<p>一般情况下，Boot Area Partition 的大小都为 4 MB，即 BOOT_SIZE_MULT 为 32，部分芯片厂家会提供改写 BOOT_SIZE_MULT 的功能来改变 Boot Area Partition 的容量大小。BOOT_SIZE_MULT 最大可以为 255，即 Boot Area Partition 的最大容量大小可以为 255 x 128 KB = 32640 KB = 31.875 MB。</p>
<h3 id="2-2-从-Boot-Area-启动"><a href="#2-2-从-Boot-Area-启动" class="headerlink" title="2.2 从 Boot Area 启动"></a>2.2 从 Boot Area 启动</h3><p>eMMC 中定义了 Boot State，在 Power-up、HW reset 或者 SW reset 后，如果满足一定的条件，eMMC 就会进入该 State。进入 Boot State 的条件如下：</p>
<p><strong>Original Boot Operation</strong><br>CMD 信号保持低电平不少于 74 个时钟周期，会触发 Original Boot Operation，进入 Boot State。</p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/original_boot.png" alt="img"></p>
<p><strong>Alternative Boot Operation</strong><br>在 74 个时钟周期后，在 CMD 信号首次拉低或者 Host 发送 CMD1 之前，Host 发送参数为 0xFFFFFFFA 的 COM0时，会触发 Alternative Boot Operation，进入 Boot State。</p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/alternative_boot.png" alt="img"></p>
<p>在 Boot State 下，如果有配置 BOOT_ACK，eMMC 会先发送 “010” 的 ACK 包，接着 eMMC 会将最大为 128Kbytes x BOOT_SIZE_MULT 的 Boot Data 发送给 Host。传输过程中，Host 可以通过拉高 CMD 信号 (Original Boot 中)，或者发送 Reset 命令 (Alternative Boot 中) 来中断 eMMC 的数据发送，完成 Boot Data 传输。</p>
<p>Boot Data 根据 Extended CSD register 的 PARTITION_CONFIG Field 的 Bit[5:3]:BOOT_PARTITION_ENABLE 的设定，可以从 Boot Area Partition 1、Boot Area Partition 2 或者 User Data Area 读出。</p>
<blockquote>
<p>Boot Data 存储在 Boot Area 比在 User Data Area 中要更加的安全，可以减少意外修改导致系统无法启动，同时无法更新系统的情况出现。</p>
</blockquote>
<p>（更多 Boot State 的细节，请参考 <a href="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_modes.html" target="_blank" rel="noopener">eMMC 工作模式</a> 的 Boot Mode 章节）</p>
<h3 id="2-3-写保护"><a href="#2-3-写保护" class="headerlink" title="2.3 写保护"></a>2.3 写保护</h3><p>通过设定 Extended CSD register 的 BOOT_WP Field，可以为两个 Boot Area Partition 独立配置写保护功能,以防止数据被意外改写或者擦出。</p>
<p>eMMC 中定义了两种 Boot Area 的写保护模式：</p>
<ol>
<li>Power-on write protection，使能后，如果 eMMC 掉电，写保护功能失效，需要每次 Power on 后进行配置</li>
<li>Permanent write protection，使能后，即使掉电也不会失效，主动进行关闭才会失效</li>
</ol>
<h2 id="3-RPMB-Partition"><a href="#3-RPMB-Partition" class="headerlink" title="3. RPMB Partition"></a>3. RPMB Partition</h2><p>RPMB（Replay Protected Memory Block）Partition 是 eMMC 中的一个具有安全特性的分区。<br>eMMC 在写入数据到 RPMB 时，会校验数据的合法性，只有指定的 Host 才能够写入，同时在读数据时，也提供了签名机制，保证 Host 读取到的数据是 RPMB 内部数据，而不是攻击者伪造的数据。</p>
<p>RPMB 在实际应用中，通常用于存储一些有防止非法篡改需求的数据，例如手机上指纹支付相关的公钥、序列号等。RPMB 可以对写入操作进行鉴权，但是读取并不需要鉴权，任何人都可以进行读取的操作，因此存储到 RPMB 的数据通常会进行加密后再存储。</p>
<h3 id="3-1-容量大小"><a href="#3-1-容量大小" class="headerlink" title="3.1 容量大小"></a>3.1 容量大小</h3><p>两个 RPMB Partition 的大小是由 Extended CSD register 的 BOOT_SIZE_MULT Field 决定，大小的计算公式如下：</p>
<p><strong>Size = 128Kbytes x BOOT_SIZE_MULT</strong></p>
<p>一般情况下，Boot Area Partition 的大小为 4 MB，即 RPMB_SIZE_MULT 为 32，部分芯片厂家会提供改写 RPMB_SIZE_MULT 的功能来改变 RPMB Partition 的容量大小。RPMB_SIZE_MULT 最大可以为 128，即 Boot Area Partition 的最大容量大小可以为 128 x 128 KB = 16384 KB = 16 MB。</p>
<h3 id="3-2-Replay-Protect-原理"><a href="#3-2-Replay-Protect-原理" class="headerlink" title="3.2 Replay Protect 原理"></a>3.2 Replay Protect 原理</h3><p>使用 eMMC 的产品，在产线生产时，会为每一个产品生产一个唯一的 256 bits 的 Secure Key，烧写到 eMMC 的 OTP 区域（只能烧写一次的区域），同时 Host 在安全区域中（例如：TEE）也会保留该 Secure Key。</p>
<p>在 eMMC 内部，还有一个RPMB Write Counter。RPMB 每进行一次合法的写入操作时，Write Counter 就会自动加一 。</p>
<p>通过 Secure Key 和 Write Counter 的应用，RMPB 可以实现数据读取和写入的 Replay Protect。</p>
<h4 id="RPMB-数据读取"><a href="#RPMB-数据读取" class="headerlink" title="RPMB 数据读取"></a>RPMB 数据读取</h4><p>RPMB 数据读取的流程如下：</p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/rpmb_r.png" alt="img"></p>
<ol>
<li>Host 向 eMMC 发起读 RPMB 的请求，同时生成一个 16 bytes 的随机数，发送给 eMMC。</li>
<li>eMMC 将请求的数据从 RPMB 中读出，并使用 Secure Key 通过 HMAC SHA-256 算法，计算读取到的数据和接收到的随机数拼接到一起后的签名。然后，eMMC 将读取到的数据、接收到的随机数、计算得到的签名一并发送给 Host。</li>
<li>Host 接收到 RPMB 的数据、随机数以及签名后，首先比较随机数是否与自己发送的一致，如果一致，再用同样的 Secure Key 通过 HMAC SHA-256 算法对数据和随机数组合到一起进行签名，如果签名与 eMMC 发送的签名是一致的，那么就可以确定该数据是从 RPMB 中读取到的正确数据，而不是攻击者伪造的数据。</li>
</ol>
<p>通过上述的读取流程，可以保证 Host 正确的读取到 RPMB 的数据。</p>
<h4 id="RPMB-数据写入"><a href="#RPMB-数据写入" class="headerlink" title="RPMB 数据写入"></a>RPMB 数据写入</h4><p>RPMB 数据写入的流程如下：</p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/rpmb_w.png" alt="img"></p>
<ol>
<li>Host 按照上面的读数据流程，读取 RPMB 的 Write Counter。</li>
<li>Host 将需要写入的数据和 Write Counter 拼接到一起并计算签名，然后将数据、Write Counter 以及签名一并发给 eMMC。</li>
<li>eMMC 接收到数据后，先对比 Write Counter 是否与当前的值相同，如果相同那么再对数据和 Write Counter 的组合进行签名，然后和 Host 发送过来的签名进行比较，如果签名相同则鉴权通过，将数据写入到 RPMB 中。</li>
</ol>
<p>通过上述的写入流程，可以保证 RPMB 不会被非法篡改。</p>
<p>更多 RPMB 相关的细节，可以参考 <a href="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_rpmb.html" target="_blank" rel="noopener">eMMC RPMB</a> 章节。</p>
<h2 id="4-General-Purpose-Partitions"><a href="#4-General-Purpose-Partitions" class="headerlink" title="4. General Purpose Partitions"></a>4. General Purpose Partitions</h2><p>eMMC 提供了 General Purpose Partitions (GPP)，主要用于存储系统和应用数据。在很多使用 eMMC 的产品中，GPP 都没有被启用，因为它在功能上与 UDA 类似，产品上直接使用 UDA 就可以满足需求。</p>
<h3 id="4-1-容量大小"><a href="#4-1-容量大小" class="headerlink" title="4.1 容量大小"></a>4.1 容量大小</h3><p>eMMC 最多可以支持 4 个 GPPs，每一个 GPP 的大小可以单独配置。用户可以通过设定 Extended CSD register 的以下三个 Field 来设 GPPx (x=1~4) 的容量大小：</p>
<ul>
<li>GP_SIZE_MULT_x_2</li>
<li>GP_SIZE_MULT_x_1</li>
<li>GP_SIZE_MULT_x_0</li>
</ul>
<p>GPPx 的容量计算公式如下：</p>
<p>Size = (GP_SIZE_MULT_x_2 * 2^16 + GP_SIZE_MULT_x_1 * 2^8 + GP_SIZE_MULT_x_0 * 2^0) * (Write protect group size)</p>
<p>Write protect group size = 512KB * HC_ERASE_GRP_SIZE * HC_WP_GRP_SIZE</p>
<blockquote>
<ul>
<li>eMMC 中，擦除和写保护都是按块进行的，上述表达式中的 HC_WP_GRP_SIZE 为写保护的操作块大小，HC_ERASE_GRP_SIZE 则为擦除操作的快的大小。</li>
<li>eMMC 芯片的 GPP 的配置通常是只能进行一次 (OTP)，一般会在产品量产阶段，在产线上进行。</li>
</ul>
</blockquote>
<h3 id="4-2-分区属性"><a href="#4-2-分区属性" class="headerlink" title="4.2 分区属性"></a>4.2 分区属性</h3><p>eMMC 标准中，为 GPP 定义了两类属性，Enhanced attribute 和 Extended attribute。每个 GPP 可以设定两类属性中的一种属性，不可以同时设定多个属性。</p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/gpp_attributes.png" alt="img"></p>
<p><strong>Enhanced attribute</strong></p>
<ul>
<li>Default, 未设定 Enhanced attribute。</li>
<li>Enhanced storage media， 设定 GPP 为 Enhanced storage media。</li>
</ul>
<p>在 eMMC 标准中，实际上并未定义设定 Enhanced attribute 后对 eMMC 的影响。Enhanced attribute 的具体作用，由芯片制造商定义。<br>在实际的产品中，设定 Enhanced storage media 后，一般是把该分区的存储介质从 MLC 改变为 SLC，提高该分区的读写性能、寿命以及稳定性。由于 1 个存储单元下，MLC 的容量是 SLC 的两倍，所以在总的存储单元数量一定的情况下，如果把原本为 MLC 的分区改变为 SLC，会减少 eMMC 的容量，就是说，此时 eMMC 的实际总容量比标称的总容量会小一点。（MLC 和 SLC 的细节可以参考 <a href="https://linux.codingbelief.com/zh/storage/flash_memory/index.html" target="_blank" rel="noopener">Flash Memory</a> 章节内容）</p>
<p><strong>Extended attribute</strong></p>
<ul>
<li>Default, 未设定 Extended attribute。</li>
<li>System code， 设定 GPP 为 System code 属性，该属性主要用在存放操作系统类的、很少进行擦写更新的分区。</li>
<li>Non-Persistent，设定 GPP 为 Non-Persistent 属性，该属性主要用于存储临时数据的分区，例如 tmp 目录所在分区、 swap 分区等。</li>
</ul>
<p>在 eMMC 标准中，同样也没有定义设定 Extended attribute 后对 eMMC 的影响。Extended attribute 的具体作用，由芯片制造商定义。Extended attribute 主要是跟分区的应用场景有关，厂商可以为不用应用场景的分区做不同的优化处理。</p>
<h2 id="5-User-Data-Area"><a href="#5-User-Data-Area" class="headerlink" title="5. User Data Area"></a>5. User Data Area</h2><p>User Data Area (UDA) 通常是 eMMC 中最大的一个分区，是实际产品中，最主要的存储区域。</p>
<h3 id="5-1-容量大小"><a href="#5-1-容量大小" class="headerlink" title="5.1 容量大小"></a>5.1 容量大小</h3><p>UDA 的容量大小不需要设置，在配置完其他分区大小后，再扣除设置 Enhanced attribute 所损耗的容量，剩下的容量就是 UDA 的容量。</p>
<h3 id="5-2-软件分区"><a href="#5-2-软件分区" class="headerlink" title="5.2 软件分区"></a>5.2 软件分区</h3><p>为了更合理的管理数据，满足不同的应用需求，UDA 在实际产品中，会进行软件再分区。目前主流的软件分区技术有 MBR（Master Boot Record）和 GPT（GUID Partition Table）两种。这两种分区技术的基本原理类似，如下图所示：</p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/uda_partitions.png" alt="img"></p>
<p>软件分区技术一般是将存储介质划分为多个区域，既 SW Partitions，然后通过一个 Partition Table 来维护这些 SW Partitions。在 Partition Table 中，每一个条目都保存着一个 SW Partition 的起始地址、大小等的属性信息。软件系统在启动后，会去扫描 Partition Table，获取存储介质上的各个 SW Partitions 信息，然后根据这些信息，将各个 Partitions 加载到系统中，进行数据存取。</p>
<blockquote>
<p>MBR 和 GPT 此处不展开详细介绍，更多的细节可以参考 wikipedia 上 <a href="https://en.wikipedia.org/wiki/Master_boot_record" target="_blank" rel="noopener">MBR</a> 和 <a href="https://en.wikipedia.org/wiki/GUID_Partition_Table" target="_blank" rel="noopener">GPT</a> 相关介绍。</p>
</blockquote>
<h3 id="5-3-区域属性"><a href="#5-3-区域属性" class="headerlink" title="5.3 区域属性"></a>5.3 区域属性</h3><p>eMMC 标准中，支持为 UDA 中一个特定大小的区域设定 Enhanced attribute。与 GPP 中的 Enhanced attribute 相同，eMMC 标准也没有定义该区域设定 Enhanced attribute 后对 eMMC 的影响。Enhanced attribute 的具体作用，由芯片制造商定义。</p>
<p><strong>Enhanced attribute</strong></p>
<ul>
<li>Default, 未设定 Enhanced attribute。</li>
<li>Enhanced storage media， 设定该区域为 Enhanced storage media。</li>
</ul>
<p>在实际的产品中，UDA 区域设定为 Enhanced storage media 后，一般是把该区域的存储介质从 MLC 改变为 SLC。通常，产品中可以将某一个 SW Partition 设定为 Enhanced storage media，以获得更好的性能和健壮性。</p>
<h2 id="6-eMMC-分区应用实例"><a href="#6-eMMC-分区应用实例" class="headerlink" title="6. eMMC 分区应用实例"></a>6. eMMC 分区应用实例</h2><p>在一个 Android 手机系统中，各个分区的呈现形式如下：</p>
<ul>
<li>mmcblk0 为 eMMC 的块设备;</li>
<li>mmcblk0boot0 和 mmcblk0boot1 对应两个 Boot Area Partitions;</li>
<li>mmcblk0rpmb 则为 RPMB Partition，</li>
<li>mmcblk0px 为 UDA 划分出来的 SW Partitions;</li>
<li>如果存在 GPP，名称则为 mmcblk0gp1、mmcblk0gp2、mmcblk0gp3、mmcblk0gp4;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">root@xxx:&#x2F; # ls &#x2F;dev&#x2F;block&#x2F;mmcblk0*</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0boot0</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0boot1</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0rpmb</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p1</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p2</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p3</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p4</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p5</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p6</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p7</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p8</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p9</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p10</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p11</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p12</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p13</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p14</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p15</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p16</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p17</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p18</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p19</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p20</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p21</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p22</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p23</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p24</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p25</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p26</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p27</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p28</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p29</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p30</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p31</span><br><span class="line">&#x2F;dev&#x2F;block&#x2F;mmcblk0p32</span><br></pre></td></tr></table></figure>

<p>每一个分区会根据实际的功能来设定名称。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">root@xxx:&#x2F; # ls -l &#x2F;dev&#x2F;block&#x2F;platform&#x2F;mtk-msdc.0&#x2F;11230000.msdc0&#x2F;by-name&#x2F;</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 boot -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p22</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 cache -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p30</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 custom -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p3</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 devinfo -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p28</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 expdb -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p4</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 flashinfo -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p32</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 frp -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p5</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 keystore -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p27</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 lk -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p20</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 lk2 -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p21</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 logo -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p23</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 md1arm7 -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p17</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 md1dsp -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p16</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 md1img -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p15</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 md3img -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p18</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 metadata -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p8</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 nvdata -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p7</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 nvram -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p19</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 oemkeystore -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p12</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 para -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p2</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 ppl -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p6</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 proinfo -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p13</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 protect1 -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p9</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 protect2 -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p10</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 recovery -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p1</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 rstinfo -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p14</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 seccfg -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p11</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 secro -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p26</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 system -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p29</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 tee1 -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p24</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 tee2 -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p25</span><br><span class="line">lrwxrwxrwx root root 2015-01-03 04:03 userdata -&gt; &#x2F;dev&#x2F;block&#x2F;mmcblk0p31</span><br></pre></td></tr></table></figure>

<h2 id="7-参考资料"><a href="#7-参考资料" class="headerlink" title="7. 参考资料"></a>7. 参考资料</h2><ol>
<li><a href="http://www.jedec.org/sites/default/files/docs/JESD84-B51.pdf" target="_blank" rel="noopener">Embedded Multi-Media Card (e•MMC) Electrical Standard (5.1)</a> [PDF]</li>
<li><a href="https://en.wikipedia.org/wiki/Disk_partitioning" target="_blank" rel="noopener">Disk partitioning</a> [Web]</li>
<li><a href="https://en.wikipedia.org/wiki/Master_boot_record" target="_blank" rel="noopener">Master Boot Record</a> [Web]</li>
<li><a href="https://en.wikipedia.org/wiki/GUID_Partition_Table" target="_blank" rel="noopener">GUID Partition Table</a> [Web]</li>
</ol>
<p><strong>注</strong>：本文转自蜗窝科技<a href="http://www.wowotech.net，来自【http://www.wowotech.net/basic_tech/emmc_partitions.html】" target="_blank" rel="noopener">www.wowotech.net，来自【http://www.wowotech.net/basic_tech/emmc_partitions.html】</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/25/Linux/Driver/storage/Flash%20Memory/mmc/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91eMMC%20%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/25/Linux/Driver/storage/Flash%20Memory/mmc/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91eMMC%20%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">【转载】eMMC 简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-12-25 10:33:17 / Modified: 10:44:15" itemprop="dateCreated datePublished" datetime="2020-12-25T10:33:17+08:00">2020-12-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/" itemprop="url" rel="index"><span itemprop="name">Driver</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/storage/Flash-Memory/" itemprop="url" rel="index"><span itemprop="name">Flash Memory</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/storage/Flash-Memory/mmc/" itemprop="url" rel="index"><span itemprop="name">mmc</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<p>eMMC 是 embedded MultiMediaCard 的简称。MultiMediaCard，即 MMC， 是一种闪存卡（Flash Memory Card）标准，它定义了 MMC 的架构以及访问　Flash Memory 的接口和协议。而 eMMC 则是对 MMC 的一个拓展，以满足更高标准的性能、成本、体积、稳定、易用等的需求。</p>
<p>eMMC 的整体架构如下图片所示：</p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_architecture.png" alt="img"></p>
<p>​                                                                                                                 图片： eMMC 整体架构</p>
<p>eMMC 内部主要可以分为 Flash Memory、Flash Controller 以及 Host Interface 三大部分。</p>
<h2 id="1-Flash-Memory"><a href="#1-Flash-Memory" class="headerlink" title="1. Flash Memory"></a>1. Flash Memory</h2><p>Flash Memory 是一种非易失性的存储器，通常在嵌入式系统中用于存放系统、应用和数据等，类似与 PC 系统中的硬盘。</p>
<p>目前，绝大部分手机和平板等移动设备中所使用的 eMMC 内部的 Flash Memory 都属于 NAND Flash，关于 NAND Flash 的更多细节可以参考 <a href="https://linux.codingbelief.com/zh/storage/flash_memory/index.html" target="_blank" rel="noopener">Flash Memory</a> 章节。</p>
<p>eMMC 在内部对 Flash Memory 划分了几个主要区域，如下图所示：</p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_partitions.png" alt="img"></p>
<p>​                                                                                    图片：eMMC 内部分区</p>
<ol>
<li>BOOT Area Partition 1 &amp; 2<br>此分区主要是为了支持从 eMMC 启动系统而设计的。<br>该分区的数据，在 eMMC 上电后，可以通过很简单的协议就可以读取出来。同时，大部分的 SOC 都可以通过 GPIO 或者 FUSE 的配置，让 ROM 代码在上电后，将 eMMC BOOT 分区的内容加载到 SOC 内部的 SRAM 中执行。</li>
<li>RPMB Partition<br>RPMB 是 Replay Protected Memory Block 的简称，它通过 HMAC SHA-256 和 Write Counter 来保证保存在 RPMB 内部的数据不被非法篡改。<br>在实际应用中，RPMB 分区通常用来保存安全相关的数据，例如指纹数据、安全支付相关的密钥等。</li>
<li>General Purpose Partition 1～4<br>此区域则主要用于存储系统或者用户数据。 General Purpose Partition 在芯片出厂时，通常是不存在的，需要主动进行配置后，才会存在。</li>
<li>User Data Area<br>此区域则主要用于存储系统和用户数据。<br>User Data Area 通常会进行再分区，例如 Android 系统中，通常在此区域分出 boot、system、userdata 等分区。</li>
</ol>
<p>更多 eMMC 分区相关的细节，请参考 <a href="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_partitions.html" target="_blank" rel="noopener">eMMC 分区管理</a> 章节。</p>
<h2 id="2-Flash-Controller"><a href="#2-Flash-Controller" class="headerlink" title="2. Flash Controller"></a>2. Flash Controller</h2><p>NAND Flash 直接接入 Host 时，Host 端通常需要有 NAND Flash Translation Layer，即 NFTL 或者 NAND Flash 文件系统来做坏块管理、ECC等的功能。</p>
<p>eMMC 则在其内部集成了 Flash Controller，用于完成擦写均衡、坏块管理、ECC校验等功能。相比于直接将 NAND Flash 接入到 Host 端，eMMC 屏蔽了 NAND Flash 的物理特性，可以减少 Host 端软件的复杂度，让 Host 端专注于上层业务，省去对 NAND Flash 进行特殊的处理。同时，eMMC 通过使用 Cache、Memory Array 等技术，在读写性能上也比 NAND Flash 要好很多。</p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_vs_nand_flash.png" alt="img"></p>
<p>​                                                                                                       图片：NAND Flash 与 eMMC</p>
<h2 id="3-Host-Interface"><a href="#3-Host-Interface" class="headerlink" title="3. Host Interface"></a>3. Host Interface</h2><p>eMMC 与 Host 之间的连接如下图所示：</p>
<p><img src="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_host_interfaces.png" alt="img"></p>
<p>​                                                                                                            图片：eMMC Interface</p>
<p>各个信号的用途如下所示：</p>
<p><strong>CLK</strong><br>用于同步的时钟信号</p>
<p><strong>Data Strobe</strong><br>此信号是从 Device 端输出的时钟信号，频率和 CLK 信号相同，用于同步从 Device 端输出的数据。该信号在 eMMC 5.0 中引入。</p>
<p><strong>CMD</strong><br>此信号用于发送 Host 的 command 和 Device 的 response。</p>
<p><strong>DAT0-7</strong><br>用于传输数据的 8 bit 总线。</p>
<p>Host 与 eMMC 之间的通信都是 Host 以一个 Command 开始发起的。针对不同的 Command，Device 会做出不同的响应。详细的通信协议相关内容，请参考 <a href="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_bus_protocol.html" target="_blank" rel="noopener">eMMC 总线协议</a> 章节。</p>
<h2 id="4-参考资料"><a href="#4-参考资料" class="headerlink" title="4. 参考资料"></a>4. 参考资料</h2><ol>
<li><a href="http://www.jedec.org/sites/default/files/docs/JESD84-B51.pdf" target="_blank" rel="noopener">Embedded Multi-Media Card (e•MMC) Electrical Standard (5.1)</a> [PDF]</li>
</ol>
<p><strong>注</strong>：本文转自蜗窝科技<a href="http://www.wowotech.net，来自【http://www.wowotech.net/basic_tech/emmc_intro.html】" target="_blank" rel="noopener">www.wowotech.net，来自【http://www.wowotech.net/basic_tech/emmc_intro.html】</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/25/Linux/Driver/storage/Flash%20Memory/mmc/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91Flash%20Memory%20%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/25/Linux/Driver/storage/Flash%20Memory/mmc/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91Flash%20Memory%20%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">【转载】Flash Memory 简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-12-25 10:18:56 / Modified: 10:32:22" itemprop="dateCreated datePublished" datetime="2020-12-25T10:18:56+08:00">2020-12-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/" itemprop="url" rel="index"><span itemprop="name">Driver</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/storage/Flash-Memory/" itemprop="url" rel="index"><span itemprop="name">Flash Memory</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<p>eMMC 是 Flash Memory 的一类，在详细介绍 eMMC 之前，先简单介绍一下 Flash Memory。</p>
<p>Flash Memory 是一种非易失性的存储器。在嵌入式系统中通常用于存放系统、应用和数据等。在 PC 系统中，则主要用在固态硬盘以及主板 BIOS 中。另外，绝大部分的 U 盘、SDCard 等移动存储设备也都是使用 Flash Memory 作为存储介质。</p>
<h2 id="1-Flash-Memory-的主要特性"><a href="#1-Flash-Memory-的主要特性" class="headerlink" title="1. Flash Memory 的主要特性"></a>1. Flash Memory 的主要特性</h2><p>与传统的硬盘存储器相比，Flash Memory 具有质量轻、能耗低、体积小、抗震能力强等的优点，但也有不少局限性，主要如下：</p>
<ol>
<li>需要先擦除再写入<br>Flash Memory 写入数据时有一定的限制。它只能将当前为 1 的比特改写为 0，而无法将已经为 0 的比特改写为 1，只有在擦除的操作中，才能把整块的比特改写为 1。</li>
<li>块擦除次数有限<br>Flash Memory 的每个数据块都有擦除次数的限制（十万到百万次不等），擦写超过一定次数后，该数据块将无法可靠存储数据，成为坏块。<br>为了最大化的延长 Flash Memory 的寿命，在软件上需要做擦写均衡（Wear Leveling），通过分散写入、动态映射等手段均衡使用各个数据块。同时，软件还需要进行坏块管理（Bad Block Management，BBM），标识坏块，不让坏块参与数据存储。（注：除了擦写导致的坏块外，Flash Memory 在生产过程也会产生坏块，即固有坏块。）</li>
<li>读写干扰<br>由于硬件实现上的物理特性，Flash Memory 在进行读写操作时，有可能会导致邻近的其他比特发生位翻转，导致数据异常。这种异常可以通过重新擦除来恢复。Flash Memory 应用中通常会使用 ECC 等算法进行错误检测和数据修正。</li>
<li>电荷泄漏<br>存储在 Flash Memory 存储单元的电荷，如果长期没有使用，会发生电荷泄漏，导致数据错误。不过这个时间比较长，一般十年左右。此种异常是非永久性的，重新擦除可以恢复。</li>
</ol>
<h2 id="2-NOR-Flash-和-NAND-Flash"><a href="#2-NOR-Flash-和-NAND-Flash" class="headerlink" title="2. NOR Flash 和 NAND Flash"></a>2. NOR Flash 和 NAND Flash</h2><p>根据硬件上存储原理的不同，Flash Memory 主要可以分为 NOR Flash 和 NAND Flash 两类。 主要的差异如下所示：</p>
<ul>
<li>NAND Flash 读取速度与 NOR Flash 相近，根据接口的不同有所差异；</li>
<li>NAND Flash 的写入速度比 NOR Flash 快很多；</li>
<li>NAND Flash 的擦除速度比 NOR Flash 快很多；</li>
<li>NAND Flash 最大擦次数比 NOR Flash 多；</li>
<li>NOR Flash 支持片上执行，可以在上面直接运行代码；</li>
<li>NOR Flash 软件驱动比 NAND Flash 简单；</li>
<li>NOR Flash 可以随机按字节读取数据，NAND Flash 需要按块进行读取。</li>
<li>大容量下 NAND Flash 比 NOR Flash 成本要低很多，体积也更小；</li>
</ul>
<p>（注：NOR Flash 和 NAND Flash 的擦除都是按块块进行的，执行一个擦除或者写入操作时，NOR Flash 大约需要 5s，而 NAND Flash 通常不超过 4ms。）</p>
<h3 id="2-1-NOR-Flash"><a href="#2-1-NOR-Flash" class="headerlink" title="2.1 NOR Flash"></a>2.1 NOR Flash</h3><p>NOR Flash 根据与 CPU 端接口的不同，可以分为 Parallel NOR Flash 和 Serial NOR Flash 两类。<br>Parallel NOR Flash 可以接入到 Host 的 SRAM/DRAM Controller 上，所存储的内容可以直接映射到 CPU 地址空间，不需要拷贝到 RAM 中即可被 CPU 访问，因而支持片上执行。Serial NOR Flash 的成本比 Parallel NOR Flash 低，主要通过 SPI 接口与 Host 连接。</p>
<p><img src="http://jiali.clouddn.com/20201225_004.png" alt=""></p>
<p>​                                                                                            图片： Parallel NOR Flash 与 Serial NOR Flash</p>
<p>鉴于 NOR Flash 擦写速度慢，成本高等特性，NOR Flash 主要应用于小容量、内容更新少的场景，例如 PC 主板 BIOS、路由器系统存储等。</p>
<p>更多 NOR Flash 的相关细节，请参考 <a href="https://linux.codingbelief.com/zh/storage/flash_memory/nor_flash/index.html" target="_blank" rel="noopener">NOR Flash</a> 章节。</p>
<h3 id="2-2-NAND-Flash"><a href="#2-2-NAND-Flash" class="headerlink" title="2.2 NAND Flash"></a>2.2 NAND Flash</h3><p>NAND Flash 需要通过专门的 NFI（NAND Flash Interface）与 Host 端进行通信，如下图所示：</p>
<p><img src="http://jiali.clouddn.com/20201225_005.png" alt=""></p>
<p>​                                                                                                                图片：NAND Flash Interface</p>
<p>NAND Flash 根据每个存储单元内存储比特个数的不同，可以分为 SLC（Single-Level Cell）、MLC（Multi-Level Cell） 和 TLC（Triple-Level Cell） 三类。其中，在一个存储单元中，SLC 可以存储 1 个比特，MLC 可以存储 2 个比特，TLC 则可以存储 3 个比特。</p>
<p>NAND Flash 的一个存储单元内部，是通过不同的电压等级，来表示其所存储的信息的。在 SLC 中，存储单元的电压被分为两个等级，分别表示 0 和 1 两个状态，即 1 个比特。在 MLC 中，存储单元的电压则被分为 4 个等级，分别表示 00 01 10 11 四个状态，即 2 个比特位。同理，在 TLC 中，存储单元的电压被分为 8 个等级，存储 3 个比特信息。</p>
<p><img src="http://jiali.clouddn.com/20201225_006.png" alt=""></p>
<p>​                                                                                                              图片： SLC、MLC 与 TLC</p>
<p>NAND Flash 的单个存储单元存储的比特位越多，读写性能会越差，寿命也越短，但是成本会更低。Table 1 中，给出了特定工艺和技术水平下的成本和寿命数据。</p>
<p><strong>Table 1</strong></p>
<table>
<thead>
<tr>
<th></th>
<th>SLC</th>
<th>MLC</th>
<th>TLC</th>
</tr>
</thead>
<tbody><tr>
<td>制造成本</td>
<td>30-35 美元 / 32GB</td>
<td>17 美元 / 32GB</td>
<td>9-12 美元 / 32GB</td>
</tr>
<tr>
<td>擦写次数</td>
<td>10万次或更高</td>
<td>1万次或更高</td>
<td>5000次甚至更高</td>
</tr>
<tr>
<td>存储单元</td>
<td>1 bit / cell</td>
<td>2 bits / cell</td>
<td>3 bits / cell</td>
</tr>
</tbody></table>
<p>（注：以上数据来源于互联网，仅供参考）</p>
<p>相比于 NOR Flash，NAND Flash 写入性能好，大容量下成本低。目前，绝大部分手机和平板等移动设备中所使用的 eMMC 内部的 Flash Memory 都属于 NAND Flash。PC 中的固态硬盘中也是使用 NAND Flash。</p>
<p>更多 NAND Flash 的相关细节，请参考 <a href="https://linux.codingbelief.com/zh/storage/flash_memory/nand_flash/index.html" target="_blank" rel="noopener">NAND Flash</a> 章节。</p>
<h2 id="3-Raw-Flash-和-Managed-Flash"><a href="#3-Raw-Flash-和-Managed-Flash" class="headerlink" title="3. Raw Flash 和 Managed Flash"></a>3. Raw Flash 和 Managed Flash</h2><p>由于 Flash Memory 存在按块擦写、擦写次数的限制、读写干扰、电荷泄露等的局限，为了最大程度的发挥 Flash Memory 的价值，通常需要有一个特殊的软件层次，实现坏块管理、擦写均衡、ECC、垃圾回收等的功能，这一个软件层次称为 FTL（Flash Translation Layer）。</p>
<p>在具体实现中，根据 FTL 所在的位置的不同，可以把 Flash Memory 分为 Raw Flash 和 Managed Flash 两类。</p>
<p><img src="http://jiali.clouddn.com/20201225_007.png" alt=""></p>
<p>​                                                                                                     图片： Raw Flash 和 Managed Flash</p>
<p><strong>Raw Flash</strong><br>在此类应用中，在 Host 端通常有专门的 FTL 或者 Flash 文件系统来实现坏块管理、擦写均衡等的功能。Host 端的软件复杂度较高，但是整体方案的成本较低，常用于价格敏感的嵌入式产品中。<br>通常我们所说的 NOR Flash 和 NAND Flash 都属于这类型。</p>
<p><strong>Managed Flash</strong><br>Managed Flash 在其内部集成了 Flash Controller，用于完成擦写均衡、坏块管理、ECC校验等功能。相比于直接将 Flash 接入到 Host 端，Managed Flash 屏蔽了 Flash 的物理特性，对 Host 提供标准化的接口，可以减少 Host 端软件的复杂度，让 Host 端专注于上层业务，省去对 Flash 进行特殊的处理。<br><a href="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/index.html" target="_blank" rel="noopener">eMMC</a>、<a href="https://linux.codingbelief.com/zh/storage/flash_memory/sd_card/index.html" target="_blank" rel="noopener">SD Card</a>、<a href="https://linux.codingbelief.com/zh/storage/flash_memory/ufs/index.html" target="_blank" rel="noopener">UFS</a>、U 盘等产品是属于 Managed Flash 这一类。</p>
<h2 id="4-参考资料"><a href="#4-参考资料" class="headerlink" title="4. 参考资料"></a>4. 参考资料</h2><ol>
<li><a href="https://www.micron.com/~/media/documents/products/product-flyer/flyer_nor_nand_flash_guide.pdf" target="_blank" rel="noopener">NOR NAND Flash Guide: Selecting a Flash Storage Solution</a> [PDF]</li>
<li><a href="https://en.wikipedia.org/wiki/Common_Flash_Memory_Interface" target="_blank" rel="noopener">Wiki: Common Flash Memory Interface</a> [Web]</li>
<li>[Quick Guide to Common Flash Interface](<a href="https://www.spansion.com/Support/Application" target="_blank" rel="noopener">https://www.spansion.com/Support/Application</a> Notes/Quick_Guide_to_CFI_AN.pdf) [PDF]</li>
<li><a href="https://www.micron.com/products/nor-flash" target="_blank" rel="noopener">MICRON NOR Flash Technology</a> [Web]</li>
<li><a href="https://www.micron.com/products/nand-flash" target="_blank" rel="noopener">MICRON NAND Flash Technology</a> [Web]</li>
<li><a href="https://zh.wikipedia.org/wiki/闪存" target="_blank" rel="noopener">Wiki：闪存</a> [Web]</li>
<li><a href="https://en.wikipedia.org/wiki/Flash_file_system" target="_blank" rel="noopener">Wiki：Flash File System</a> [Web]</li>
<li><a href="https://www.micron.com/~/media/documents/products/technical-note/nand-flash/tn2961_wear_leveling_in_nand.pdf" target="_blank" rel="noopener">Wear Leveling in Micron® NAND Flash Memory</a> [PDF]</li>
<li><a href="https://flashdba.com/2014/09/17/understanding-flash-the-flash-translation-layer/" target="_blank" rel="noopener">Understanding Flash: The Flash Translation Layer</a> [Web]</li>
<li><a href="http://blog.sina.com.cn/s/blog_4b4b54da01016rx3.html" target="_blank" rel="noopener">谈NAND Flash的底层结构和解析</a> [Web]</li>
<li><a href="http://www.ssdfans.com/?p=45" target="_blank" rel="noopener">闪存基础</a> [Web]</li>
<li><a href="http://www.onfi.org/" target="_blank" rel="noopener">Open NAND Flash Interface (ONFI)</a> [Web]</li>
</ol>
<p><strong>注</strong>：本文转自蜗窝科技<a href="http://www.wowotech.net，来自【http://www.wowotech.net/basic_tech/flash_memory_intro.html】" target="_blank" rel="noopener">www.wowotech.net，来自【http://www.wowotech.net/basic_tech/flash_memory_intro.html】</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/25/Linux/Driver/storage/Flash%20Memory/mmc/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91MMC%20SD%20SDIO%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/25/Linux/Driver/storage/Flash%20Memory/mmc/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91MMC%20SD%20SDIO%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">【转载】MMC/SD/SDIO介绍</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-12-25 09:45:36 / Modified: 11:10:32" itemprop="dateCreated datePublished" datetime="2020-12-25T09:45:36+08:00">2020-12-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/" itemprop="url" rel="index"><span itemprop="name">Driver</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/storage/Flash-Memory/" itemprop="url" rel="index"><span itemprop="name">Flash Memory</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/Driver/storage/Flash-Memory/mmc/" itemprop="url" rel="index"><span itemprop="name">mmc</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>熟悉Linux kernel的人都知道，kernel使用MMC subsystem统一管理MMC、SD、SDIO等设备，为什么呢？到底什么是MMC？SD和SDIO又是什么？为什么可以用MMC统称呢？</p>
<p>在分析Linux kernel的MMC subsystem之前，有必要先介绍一些概念，以便对MMC/SD/SDIO有一个大致的了解，这就是本文的目的。</p>
<h2 id="2-基本概念"><a href="#2-基本概念" class="headerlink" title="2. 基本概念"></a>2. 基本概念</h2><p>MMC是MultiMediaCard的简称，从本质上看，它是一种用于固态非易失性存储的内存卡（memory card）规范[1]，定义了诸如卡的形态、尺寸、容量、电气信号、和主机之间的通信协议等方方面面的内容。</p>
<p>从1997年MMC规范发布至今，基于不同的考量（物理尺寸、电压范围、管脚数量、最大容量、数据位宽、clock频率、安全特性、是否支持SPI mode、是否支持DDR mode、等等），进化出了MMC、SD、microSD、SDIO、eMMC等不同的规范（如下面图片1所示）。虽然乱花迷人，其本质终究还是一样的，丝毫未变，这就是Linux kernel将它们统称为MMC的原因。</p>
<p><img src="http://jiali.clouddn.com/20201225_001.png" alt=""></p>
<p>​                                                                                             图片1 MMC/SD/SDIO evolution</p>
<p>关于该图片，这里强调几点（其它的，大家可参考[1] [2]，不再详细介绍）：</p>
<blockquote>
<p>MMC、SD、SDIO的技术本质是一样的（使用相同的总线规范，等等），都是从MMC规范演化而来；</p>
<p>MMC强调的是多媒体存储（MM，MultiMedia）；</p>
<p>SD强调的是安全和数据保护（S，Secure）；</p>
<p>SDIO是从SD演化出来的，强调的是接口（IO，Input/Output），不再关注另一端的具体形态（可以是WIFI设备、Bluetooth设备、GPS等等）。</p>
</blockquote>
<h2 id="3-规范简介"><a href="#3-规范简介" class="headerlink" title="3. 规范简介"></a>3. 规范简介</h2><p>MMC分别从卡（Card Concept）、总线（Bus Concept）以及控制器（Host Controller）三个方面，定义MMC system的行为，如下面图片2所示：</p>
<p><img src="http://jiali.clouddn.com/20201225_002.png" alt=""></p>
<p>​                                                                                                   图片2 mmc_sd_sdio_hw_block</p>
<p>不同岗位的工程师，可以根据自己的工作性质，重点理解某一部分的规范，下面从嵌入式软件工程师的视角，简单的介绍一下。</p>
<h3 id="3-1-卡的规范"><a href="#3-1-卡的规范" class="headerlink" title="3.1 卡的规范"></a>3.1 卡的规范</h3><p>卡的规范主要规定卡的形状、物理尺寸、管脚，内部block组成、寄存器等等，以eMMC为例[3]：</p>
<p><img src="http://jiali.clouddn.com/20201225_003.png" alt=""></p>
<p>​                                                                                                      图片3 Card Concept(eMMC)</p>
<p>1）有关形状、尺寸的内容，这里不再介绍，感兴趣的同学可参考[1]。</p>
<p>2）卡的内部由如下几个block组成：</p>
<blockquote>
<p>Memory core，存储介质，一般是NAND flash、NOR flash等；</p>
<p>Memory core interface，管理存储介质的接口，用于访问（读、写、擦出等操作）存储介质；</p>
<p>Card interface（CMD、CLK、DATA），总线接口，外界访问卡内部存储介质的接口，和具体的管脚相连；</p>
<p>Card interface controller，将总线接口上的协议转换为Memory core interface的形式，用于访问内部存储介质；</p>
<p>Power模块，提供reset、上电检测等功能；</p>
<p>寄存器（图片1中位于Card interface controller的左侧，那些小矩形），用于提供卡的信息、参数、访问控制等功能。</p>
</blockquote>
<p>3）卡的管脚有VDD、GND、RST、CLK、CMD和DATA等，VDD和GND提供power，RST用于复位，CLK、CMD和DATA为MMC总线协议（具体可参考3.2小节）的物理通道：</p>
<blockquote>
<p>CLK有一条，提供同步时钟，可以在CLK的上升沿（或者下降沿，或者上升沿和下降沿）采集数据；</p>
<p>CMD有一条，用于传输双向的命令。</p>
<p>DATA用于传说双向的数据，根据MMC的类型，可以有一条（1-bit）、四条（4-bit）或者八条（8-bit）。</p>
</blockquote>
<p>4）以eMMC为例，规范定义了OCR, CID, CSD, EXT_CSD, RCA 以及DSR 6组寄存器，具体含义后面再介绍。</p>
<h3 id="3-2-总线规范"><a href="#3-2-总线规范" class="headerlink" title="3.2 总线规范"></a>3.2 总线规范</h3><p>前面我们提到过，MMC的本质是提供一套可以访问固态非易失性存储介质的通信协议，从产业化的角度看，这些存储介质一般集成在一个独立的外部模块中（卡、WIFI模组等），通过物理总线和CPU连接。对任何有线的通信协议来说，总线规范都是非常重要的。关于MMC总线规范，简单总结如下：</p>
<p>1）物理信号有CLK、CMD和DATA三类。</p>
<p>2）电压范围为1.65V和3.6V（参考上面图片2），根据工作电压的不同，MMC卡可以分为两类：</p>
<blockquote>
<p>High Voltage MultiMediaCard，工作电压为2.7V~3.6V。</p>
<p>Dual Voltage MultiMediaCard，工作电压有两种，1.70V<del>1.95V和2.7V</del>3.6V，CPU可以根据需要切换。</p>
</blockquote>
<p>3）数据传输的位宽（称作data bus width mode）是允许动态配置的，包括1-bit (默认)模式、4-bit模式和8-bit模式。</p>
<blockquote>
<p>注1：不使用的数据线，需要保持上拉状态，这就是图片2中的DATA中标出上拉的原因。另外，由于数据线宽度是动态可配的，这要求CPU可以动态的enable/disable数据线的那些上拉电阻。</p>
</blockquote>
<p>4）MMC规范定义了CLK的频率范围，包括0-20MHz、0-26MHz、0-52MHz等几种，结合数据线宽度，基本决定了MMC的访问速度。</p>
<p>5）总线规范定义了一种简单的、主从式的总线协议，MMC卡位从机（slave），CPU为主机（Host）。</p>
<p>6）协议规定了三种可以在总线上传输的信标（token）：</p>
<blockquote>
<p>Command，Host通过CMD线发送给Slave的，用于启动（或结束）一个操作（后面介绍）；</p>
<p>Response，Slave通过CMD线发送给Host，用于回应Host发送的Command；</p>
<p>Data，Host和Slave之间通过数据线传说的数据。方向可以是Host到Slave，也可以是Slave到Host。数据线的个数可以是1、4或者8。在每一个时钟周期，每根数据线上可以传输1bit或者2bits的数据。</p>
</blockquote>
<p>7）一次数据传输过程，需要涉及所有的3个信标。一次数据传输的过程也称作Bus Operation，根据场景的不同，MMC协议规定了很多类型的Bus Operation（具体可参考相应的规范）。</p>
<h3 id="3-3-控制器规范"><a href="#3-3-控制器规范" class="headerlink" title="3.3 控制器规范"></a>3.3 控制器规范</h3><p>Host控制器是MMC总线规范在Host端的实现，也是Linux驱动工程师比较关注的地方，后面将会结合Linux MMC framework的有关内容，再详细介绍。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>本文对MMC/SD/SDIO等做了一个简单的介绍，有了这些基本概念之后，在Linux kernel中编写MMC驱动将不再是一个困难的事情（因为MMC是一个协议，所有有关协议的事情，都很简单，因为协议是固定的），我们只需要如下步骤即可完成：</p>
<blockquote>
<p>1）结合MMC的规范，阅读Host MMC controller的spec，理解有关的功能和操作方法。</p>
<p>2）根据Linux MMC framework的框架，将MMC bus有关的操作方法通过MMC controller实现。</p>
</blockquote>
<p>具体可参考后续MMC framework的分析文档。</p>
<h2 id="5-参考文档"><a href="#5-参考文档" class="headerlink" title="5. 参考文档"></a>5. 参考文档</h2><p>[1] <a href="https://en.wikipedia.org/wiki/MultiMediaCard" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/MultiMediaCard</a></p>
<p>[2] <a href="https://en.wikipedia.org/wiki/Secure_Digital" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Secure_Digital</a></p>
<p>[3] eMM spec（注册后可免费下载），<a href="http://www.jedec.org/standards-documents/results/jesd84-b51" target="_blank" rel="noopener">http://www.jedec.org/standards-documents/results/jesd84-b51</a></p>
<p><strong>注</strong>：本文转自蜗窝科技<a href="http://www.wowotech.net,来自【http://www.wowotech.net/basic_tech/mmc_sd_sdio_intro.html】" target="_blank" rel="noopener">www.wowotech.net,来自【http://www.wowotech.net/basic_tech/mmc_sd_sdio_intro.html】</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/19/IoT/%E8%93%9D%E7%89%99/nordic%20Soc%E5%BC%80%E5%8F%91/2.4G%20nRF24LE1%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/19/IoT/%E8%93%9D%E7%89%99/nordic%20Soc%E5%BC%80%E5%8F%91/2.4G%20nRF24LE1%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">2.4G nRF24LE1原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-19 16:45:49" itemprop="dateCreated datePublished" datetime="2020-11-19T16:45:49+08:00">2020-11-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-11-20 09:44:48" itemprop="dateModified" datetime="2020-11-20T09:44:48+08:00">2020-11-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/" itemprop="url" rel="index"><span itemprop="name">IoT</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/2-4G/" itemprop="url" rel="index"><span itemprop="name">2.4G</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/2-4G/Nordic-Soc%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Nordic Soc开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>什么是2.4G？射频收发器工作在国际ISM频段2.400~2.4835Ghz范围。2.4G协议分为公有协议和私有协议。公有协议，比如，zigbee,ble协议。私有协议就是厂家自己定义的协议，只能跟自家的通信，常说私有2.4G协议，就是自己制定协议，运行2.4G Soc芯片上。本文总结2.4G soc  nRF24LE1射频收发器原理。</p>
<h2 id="2-4G-soc结构"><a href="#2-4G-soc结构" class="headerlink" title="2.4G soc结构"></a>2.4G soc结构</h2><p><img src="http://jiali.clouddn.com/20201119_001.png" alt=""></p>
<p>MCU通过SPI接口控制RF transceiver，具体RF transceiver内部结构如下图</p>
<p><img src="http://jiali.clouddn.com/20201119_002.png" alt=""></p>
<p>MCU通SPI发送命令，来配置RF transceiver的寄存器。</p>
<p> 2.4G soc nRF24LE1的封装如下图</p>
<p><img src="http://jiali.clouddn.com/20201119_003.png" alt=""></p>
<p>管脚定义如下表</p>
<p><img src="http://jiali.clouddn.com/20201119_004.png" alt=""></p>
<h2 id="射频收发器工作原理"><a href="#射频收发器工作原理" class="headerlink" title="射频收发器工作原理"></a>射频收发器工作原理</h2><p><strong>1、工作模式</strong></p>
<ul>
<li>掉电模式</li>
<li>待机模式：待机模式-I和待机模式-II</li>
<li>接收模式</li>
<li>发射模式</li>
</ul>
<p>工作模式的寄存器配置如下表</p>
<p><img src="http://jiali.clouddn.com/20201119_005.png" alt=""></p>
<p><strong>2、Enhanced ShockBurst</strong></p>
<p>MCU负责把读写FIFO，剩下的事情 由ShockBurst完成。 ShockBurst功能如下：</p>
<ul>
<li>根据数据的长度来设置1~32字节范围内的动态数据长度;</li>
<li>自动打包和拆包;</li>
<li>自动进行包的CRC校验:自动应答,自动重传;</li>
<li>MultiCeiver1~6通道星形网络的数据管理</li>
</ul>
<p>在发送端，MCU把数据写入TX FIFO，ShockBurst从TX FIFO取出数据，封装成一个数据包，并发送出去，在接收端，将解调后的数据，拆包并经过CRC校验后，确定是正确的数据，就把数据移动到RX FIFO，产生数据达到RX FIFO中断，MCU判断中断读取RX FIFO数据。</p>
<p>带ACK的ShockBurst处理过程如下：</p>
<ol>
<li><p>先从PTX 发送一个数据包到PRX,增强型ShockBurst将设置PTX 为接收并等待<br>ACK 包。</p>
</li>
<li><p>如果数据包被PRX 所接收,增强型ShockBurst将自动装配并发送一个应答包(ACK<br>包)给PTX 然后返回接收模式。</p>
</li>
<li><p>如果PTX 没有即时收到ACK 包,增强型ShockBurst将会在一个可编程的延时间隔后自动重发此数据包,然后将PTX 设为接收模式等待ACK 包。</p>
<p>在增强型ShockBurst中可以设定重发的次数和重发的间隔参数,而后所有的工作均由增强型ShockBurst自动完成而无需MCU 的干预。</p>
</li>
</ol>
<p>增强型ShockBurst包格式</p>
<p><img src="http://jiali.clouddn.com/20201119_006.png" alt=""></p>
<p>带ACK增强型ShockBurst时序图</p>
<p><img src="http://jiali.clouddn.com/20201119_008.png" alt=""></p>
<p>Tul是SPI发送数据到FIFI的时间，RFCE产生至少10us的脉冲，激活发射模式，再过130us开始发送数据，Toa是空中传输的时间，数据发送完毕，ShockBurst自动把发送模式转换为接收模式，等待ACK。PRX RX FIFO收到数据，产生中断，在中断函数中读取FIFO数据。PRX收到数据，ShockBurst把接收模式转换为发送模式，发送ACK.</p>
<p><strong>3、收发通道和RF收发地址</strong></p>
<p>在接收模式下，可以接收六路PIPE数据，PIPE叫逻辑通道，实际上，不是并行接收六路PIPE，而是串行。接收模式下，多路接收示意图如下</p>
<p><img src="http://jiali.clouddn.com/20201119_007.png" alt=""></p>
<p>从图可以看出， 2.4G soc nRF24LE1,只有一个TX_ADDR寄存器来配置发送地址，由于由六个接收通道，所以，就有六个接收地址配置寄存器RX_ADDR_P0<del>RX_ADDR_P5。默认使能的接收只有RX_ADDR_P0和RX_ADDR_P1通道，其他通道需要手动使能。如果没有设置动态数据长度，则需要配置RX_PW_P0</del>RX_PW_P5对应使能通道的数据长度。</p>
<p><strong>注意：</strong></p>
<p>发送地址和某个接收通道地址要一致。发送地址需要配置TX_ADDR寄存器，与某个PIPE地址要相同。</p>
<p>数据通道地址配置如下图</p>
<p><img src="http://jiali.clouddn.com/20201119_009.png" alt=""></p>
<p>每个数据通道可配置最多5字节地址。数据通道0有一个5字节的独特地址,数据通道1~5使用与之相同的高4 字节地址,而所有6 个数据通道的最低地址字节是不同。</p>
<p><strong>注意:必须确保所有的数据通道地址不相同。</strong></p>
<p><strong>4、RF收发器数据FIFO</strong></p>
<p>RF数据FIFO分为发送FIFO和接收FIFO。这两个FIFO在发射和接收模式下，都可以访问。数据FIFO最多能容纳3个payload，每个payload为1~32byte。MCU通过SPI接口发送SPI 命令来操作数据FIFO。发射模式下，写FIFO的命令：W_TX_PAYLOAD  和W_TX_PAYLOAD_NO_ACK 。接收模式下，写FIFO命令：W_ACK_PAYLOAD 。在发射模式和接收模式下，都可以使用R_RX_PAYLOAD命令读FIFO。</p>
<p>FIFO结构图如下：</p>
<p><img src="http://jiali.clouddn.com/20201119_010.png" alt=""></p>
<p><strong>5、中断</strong></p>
<p>The RF transceiver can send interrupts to the MCU. The interrupt (RFIRQ) is activated when TX_DS,RX_DR or MAX_RT are set high by the state machine in the STATUS register.RFIRQ is deactivated when the MCU writes ‘1’ to the interrupt source bit in the STATUS register.The interrupt mask in the CONFIG register is used to select the IRQ sources that are allowed to activate RFIRQ. By setting one of the mask bits high, the corresponding interrupt source is disabled. By default all interrupt sources are enabled.</p>
<p><strong>Note:</strong> </p>
<p>The 3 bit pipe information in the STATUS register is updated during the RFIRQ high to low transition. The pipe information is unreliable if the STATUS register is read during a RFIRQ high to low transition.</p>
<h2 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h2><p>参考芯片手册。</p>
<p><strong>参考：</strong></p>
<p>《nRF24LE1 Specification》</p>
<p>《nRF无线SOC单片机原理与高级应用》</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/05/IoT/%E8%93%9D%E7%89%99/ble%E6%8A%80%E6%9C%AF/%E8%93%9D%E7%89%99%E8%BF%9E%E6%8E%A5%E4%BA%8B%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/05/IoT/%E8%93%9D%E7%89%99/ble%E6%8A%80%E6%9C%AF/%E8%93%9D%E7%89%99%E8%BF%9E%E6%8E%A5%E4%BA%8B%E4%BB%B6/" class="post-title-link" itemprop="url">蓝牙连接事件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-11-05 10:36:48 / Modified: 15:13:40" itemprop="dateCreated datePublished" datetime="2020-11-05T10:36:48+08:00">2020-11-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/" itemprop="url" rel="index"><span itemprop="name">IoT</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/%E8%93%9D%E7%89%99/" itemprop="url" rel="index"><span itemprop="name">蓝牙</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/%E8%93%9D%E7%89%99/Nordic-Soc%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Nordic Soc开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>对于连接间隔和连接事件之间的关系，还是花了很多时间搞明白，主要是不明白连接事件长度怎么定义的。后来是通过nordic 52382 SDK,了解到连接事件长度是可以设置的。通过设置连接事件长度，就可以在一个连接间隔中，发送多个包，提高数据吞吐量。这篇文章<a href="https://www.cnblogs.com/iini/p/8972635.html" target="_blank" rel="noopener">详解BLE连接建立过程</a>对连接事件讲得明白，对我理解连接事件起到很大帮助。</p>
<h2 id="连接事件"><a href="#连接事件" class="headerlink" title="连接事件"></a>连接事件</h2><p>连接成功后，master和slave在每一个connection interval开始的时候，都必须交互一次，即master给slave发一个包，slave再给master发一个包，整个交互过程称为一个connection event或者gap event。蓝牙芯片只有在connection event期间才把射频模块打开，此时功耗比较高，其余时间蓝牙芯片都是处于idle状态的，因此蓝牙芯片平均功耗就非常低。在nordic nRF5 SDK中，可以设置连接事件长度，实现一个间隔期间发送多个包。Master不可能时时刻刻都有数据发给slave，所以master大部分时候都是发的空包（empty packet）给slave。同样slave也不是时时刻刻都有数据给master，因此slave回复给master的包大部分时候也是空包。另外在一个connection event期间，master也可以发多个包给slave，以提高吞吐率。</p>
<p>连接成功后的通信时序图（每个connection event只发一个包），如下所示</p>
<p><img src="http://jiali.clouddn.com/20201105_001.png" alt=""></p>
<p>实验：一个连接间隔100ms，连接事件保持时间为7.5ms,通过抓包分析，每个连接间隔slave只发送一个包给master，如下所示</p>
<p><img src="http://jiali.clouddn.com/20201105_009.png" alt=""></p>
<p>连接成功后的通信时序图（ connection event可能发多个包），如下所示</p>
<p><img src="http://jiali.clouddn.com/20201105_002.png" alt=""></p>
<p>实验：连接间隔100ms,连接事件保持时间为50ms,抓包可以看出，在100ms内，连续发送了三个包，如下所示</p>
<p><img src="http://jiali.clouddn.com/20201105_0010.png" alt=""></p>
<p>connection event通信细节图，如下所示</p>
<p><img src="http://jiali.clouddn.com/20201105_003.png" alt=""></p>
<p><strong>Slave latency</strong><br>connection event通信细节图中出现了slave latency（slave latency = 1），是什么意思？</p>
<p>答：slave latency = 1，跳过一个连接间隔，也就是说，slave设备在第二个连接间隔才回复一个packet.</p>
<p><strong>那么什么叫slave latency？</strong></p>
<p>如前所述，在每一个connection interval开始的时候，Master和Slave必须交互一次，哪怕两者之间交互的是empty packet（空包），但如果slave定义了slave latency，比如slave latency = 9，此时slave可以间隔9个connection interval才回复一次master，也就是说slave可以在前面9个connection interval期间一直睡眠，直到第10个connection interval到来之后，才回复一个packet给master，这样将大大节省slave的功耗，提高电池续航时间。当然如果slave有数据需要上报给master，它也可以不等到第10个connection interval才上报，直接像正常情况进行传输即可，这样既节省了功耗，又提高了数据传输的实时性。</p>
<p>连接间隔为100ms，连接事件保持时间为50ms，slave latency=2（延迟两个间隔），通信抓包结果如下所示</p>
<p><img src="http://jiali.clouddn.com/20201105_004.png" alt=""></p>
<p>对比，连接间隔也为100ms，连接事件保持时间为7.5ms,slave latency=2,结果跟上面一样，slave仍然跳过两个间隔,才回复一个empty packet,如下图所示</p>
<p><img src="http://jiali.clouddn.com/20201105_008.png" alt=""></p>
<h2 id="连接参数"><a href="#连接参数" class="headerlink" title="连接参数"></a>连接参数</h2><p>阅读nordic nRD5 sdk 发现连接参数配置的宏定义，如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#define MIN_CONN_INTERVAL               MSEC_TO_UNITS(100, UNIT_1_25_MS)  &#x2F;&#x2F;最小间隔 </span><br><span class="line">#define MAX_CONN_INTERVAL               MSEC_TO_UNITS(100, UNIT_1_25_MS) &#x2F;&#x2F;最大间隔</span><br><span class="line">#define SLAVE_LATENCY                   0                               &#x2F;&#x2F;0表示不延迟  </span><br><span class="line">#define CONN_SUP_TIMEOUT                MSEC_TO_UNITS(4000, UNIT_10_MS) &#x2F;&#x2F;监督超时4s</span><br><span class="line">&#x2F;&#x2F;首次调用sd_ble_gap_conn_param_update()更新连接参数，延迟5s才能更新连接参数</span><br><span class="line">#define FIRST_CONN_PARAMS_UPDATE_DELAY  APP_TIMER_TICKS(5000)              </span><br><span class="line">&#x2F;&#x2F;非首次调用sd_ble_gap_conn_param_update()更新连接参数，延迟30s才能更新连接参数</span><br><span class="line">#define NEXT_CONN_PARAMS_UPDATE_DELAY   APP_TIMER_TICKS(30000)             </span><br><span class="line">&#x2F;&#x2F;尝试三次连续参数协商，如果不成功，就放弃连接参数协商</span><br><span class="line">#define MAX_CONN_PARAMS_UPDATE_COUNT    3                                  </span><br><span class="line">&#x2F;&#x2F;广播间隔时间</span><br><span class="line">#define APP_ADV_INTERVAL                320                               </span><br><span class="line">&#x2F;&#x2F;一次广播持续的时间，0表示不超时</span><br><span class="line">#define APP_ADV_DURATION                0</span><br></pre></td></tr></table></figure>

<p><strong>CONN_SUP_TIMEOUT –连接监控超时</strong></p>
<p>有时设备会丢失它们之间的连接，例如当它们移出彼此的传输范围时。 这些设备不知道连接是否丢失，但是如果没有从另一方接收到任何信息，他们可以假设已经有足够的时间了。 我们定义为“足够”以确定连接丢失的时间称为超时 。 连接监控超时（Connection Supervision Timeout）参数定义为在假设连接丢失之前等待数据传输的时间。</p>
<p><strong>总结</strong></p>
<p>由于连接参数对能源消耗有影响，我们应该考虑一下，即使知道中央可能会选择不遵守我们的建议。 一个考虑因素是我们的连接间隔应该与我们期望生成新数据的速率相匹配。 例如，如果我们每秒读取一个传感器，则连接间隔不应该小于此。 如果它更小，那么当没有数据生成时，我们将处理很多请求。 作为相反的示例，对于数据更新非定期（例如鼠标移动）的应用，连接间隔可以确定用户在应用等待更新时经历的延迟。 由于我们重视用户体验超过能量，我们将使用一个短的连接间隔。 我们可以补充短连接间隔，具有高从机延迟，让鼠标在运动之间睡眠更长。</p>
<p>对于电池寿命，我们使用射频越少越好。 所有的参数总体意味着我们可以很少使用射频：在广告模式下，我们可以每10.28秒使用一次射频。</p>
<p>在连接模式下，我们可以设置四秒的最大连接间隔，但是当我们没有生成新数据时，没有无线电活动的最长持续时间可能只要[(max interval) * (slave latency)]。 但是，请记住，我们受到监督超时（supervision timeout）的限制; 如果我们的间隔太大，中央设备可能会断开连接（请记住，我们不能强制中央设备接受我们的监控超时设置，因此可能会出现不匹配）。</p>
<h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><p><strong>Q1:(在nrf52832上面测，发现连接间隔低于10Ms，发送数据失败,但是蓝牙规范是7.5ms?</strong><br><a href="http://930ebbs.com/forum.php?mod=viewthread&amp;tid=1730&amp;fromuid=2151" target="_blank" rel="noopener">http://930ebbs.com/forum.php?mod=viewthread&amp;tid=1730&amp;fromuid=2151</a></p>
<p><img src="http://jiali.clouddn.com/20201105_010.png" alt=""></p>
<p><img src="http://jiali.clouddn.com/20201105_011.png" alt=""></p>
<p><img src="http://jiali.clouddn.com/20201105_012.png" alt=""></p>
<p><img src="http://jiali.clouddn.com/20201105_013.png" alt=""></p>
<p><img src="http://jiali.clouddn.com/20201105_014.png" alt=""></p>
<p><strong>Q2:SDK52382 如何在一个连接保持时间下发送多个数据包?</strong><br><a href="http://930ebbs.com/forum.php?mod=viewthread&amp;tid=1739&amp;fromuid=2151" target="_blank" rel="noopener">http://930ebbs.com/forum.php?mod=viewthread&amp;tid=1739&amp;fromuid=2151</a></p>
<p><img src="http://jiali.clouddn.com/20201105_015.png" alt=""></p>
<p><strong>Q3:设置连接事件保持时间等于连接间隔，会产生怎样的结果 ?</strong></p>
<p>意味着连接事件占满整个连接间隔，导致蓝牙没有时间休眠，一直打开RF收发器，功耗增大。</p>
<p><strong>Q4:52382,sdk16.0射频FIFO大小多大，是否可以调整？如何调整？</strong><br><a href="http://930ebbs.com/forum.php?mod=viewthread&amp;tid=1746&amp;fromuid=2151" target="_blank" rel="noopener">http://930ebbs.com/forum.php?mod=viewthread&amp;tid=1746&amp;fromuid=2151</a><br><img src="http://jiali.clouddn.com/20201105_016.png" alt=""></p>
<p><strong>Q5:在一个连接事件中，任意一个时刻，都能把数据发送出去吗 (比如，连接间隔设置100ms,连接事件保持时间设置为80ms。第一个连接事件到来后50ms,才调用发送函数，这时候，数据能发送出去吗)</strong></p>
<p><strong>Q6:nRF5 SFK,在一个连接事件中，间隔时间调用发送函数，数据是否也是间隔发送出去？(比如，100ms为连接间隔，50ms为连接事件保持的事件NRF_SDH_BLE_GAP_EVENT_LENGTH 设置为40，那么在50ms的连接事件内，间隔4ms发送数据。Ps问：间隔4ms调用发送函数，每次调用是否都把数据发送出去？还是说先缓存起来，等到下一次连接事件，在全部一起发送？)</strong></p>
<p><strong>Q7:快速发送数据时候，当协议栈因缓存不足，产生NRF_ERROR_RESOURCES 的根本原因</strong><br><a href="http://930ebbs.com/forum.php?mod=viewthread&amp;tid=1755&amp;fromuid=2151" target="_blank" rel="noopener">http://930ebbs.com/forum.php?mod=viewthread&amp;tid=1755&amp;fromuid=2151</a></p>
<p>A1:</p>
<p><img src="http://jiali.clouddn.com/20201105_017.png" alt=""></p>
<p>A2:<a href="http://wywiot.com/nordic-ble-soc-2-4ghz-comm-info/?unapproved=18&amp;moderation-hash=5946eeafc1027885e91b90902dc24445#comment-18" target="_blank" rel="noopener">http://wywiot.com/nordic-ble-soc-2-4ghz-comm-info/?unapproved=18&amp;moderation-hash=5946eeafc1027885e91b90902dc24445#comment-18</a></p>
<p><img src="http://jiali.clouddn.com/nordic_sdk_%E6%94%B6%E5%8F%91%E5%99%A8%E7%BC%93%E5%AD%98.png" alt=""></p>
<p>参考：</p>
<p><a href="https://www.cnblogs.com/iini/p/8972635.html" target="_blank" rel="noopener">详解BLE连接建立过程</a></p>
<p><a href="https://blog.csdn.net/zzfenglin/article/details/51304084" target="_blank" rel="noopener">低功耗蓝牙BLE之连接事件、连接参数和更新方法</a></p>
<p><a href="https://www.jianshu.com/p/c8a7cc25d500" target="_blank" rel="noopener">BLE 连接参数</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/12/IoT/%E8%93%9D%E7%89%99/nordic%20Soc%E5%BC%80%E5%8F%91/Power%20Management/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/12/IoT/%E8%93%9D%E7%89%99/nordic%20Soc%E5%BC%80%E5%8F%91/Power%20Management/" class="post-title-link" itemprop="url">Power Management</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-10-12 15:53:08" itemprop="dateCreated datePublished" datetime="2020-10-12T15:53:08+08:00">2020-10-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-11-20 09:42:14" itemprop="dateModified" datetime="2020-11-20T09:42:14+08:00">2020-11-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/" itemprop="url" rel="index"><span itemprop="name">IoT</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/%E8%93%9D%E7%89%99/" itemprop="url" rel="index"><span itemprop="name">蓝牙</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/%E8%93%9D%E7%89%99/Nordic-Soc%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Nordic Soc开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>低功耗蓝牙应用对功耗要求越低越好，功耗越低电池续航时间就越长。本文介绍System OFF mode和System On mode.</p>
<h2 id="电源管理单元"><a href="#电源管理单元" class="headerlink" title="电源管理单元"></a>电源管理单元</h2><p>Power and clock management in nRF52832 is optimized for ultra-low power applications.<br>The core of the power and clock management system is the Power Management Unit (PMU) illustrated As shown in.</p>
<p><img src="http://jiali.clouddn.com/20201012_006.png" alt=""></p>
<p>The user application is not required to actively control power and clock, since the PMU is able to automatically detect which resources are required by the different components in the system at any given time. The PMU will continuously optimize the system based on this information to achieve the lowest power consumption possible without user interaction.</p>
<h2 id="低功耗模式"><a href="#低功耗模式" class="headerlink" title="低功耗模式"></a>低功耗模式</h2><p>nRF5 Soc 有两种休眠模式，它们区别如下：</p>
<p><img src="http://jiali.clouddn.com/20201012_007.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li><p>System OFF mode：System OFF is the deepest power saving mode the system can enter. In this mode, the system’s core functionality is powered down and all ongoing tasks are terminated.</p>
<p>The device can be put into System OFF mode using the POWER register interface. When in System OFF mode, the device can be woken up through one of the following signals:</p>
<ol>
<li>The DETECT signal, optionally generated by the GPIO peripheral</li>
<li>The ANADETECT signal, optionally generated by the LPCOMP module</li>
<li>The SENSE signal, optionally generated by the NFC module to “wake-on-field”</li>
<li>A reset</li>
</ol>
</li>
<li><p>System ON mode：System ON is the default state after power-on reset. In System ON, all functional blocks such as the CPU or peripherals, can be in IDLE or RUN mode, depending on the configuration set by the software and the state of the application executing.</p>
</li>
</ul>
<p>The system can switch on and off the appropriate internal power sources, depending on how much power is needed at any given time. The power requirement of a peripheral is directly related to its activity level, and the activity level of a peripheral is usually raised and lowered when specific tasks are triggered or events are generated.</p>
<h3 id="System-ON"><a href="#System-ON" class="headerlink" title="System ON"></a>System ON</h3><p>在System ON模式下，芯片仍然可以正常发出广播或者与手机保持蓝牙连接，所以大部分BLE应用都是工作在idle模式下，这样既保持了BLE功能又可以实现低功耗。使能softdevice时，进入System ON模式，函数接口如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sd_app_evt_wait()</span><br></pre></td></tr></table></figure>

<p>不带协议栈下进入System ON模式，指令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Wait for an event.</span><br><span class="line">__WFE();</span><br><span class="line">&#x2F;&#x2F; Clear the internal event register.</span><br><span class="line">__SEV();</span><br><span class="line">__WFE();</span><br></pre></td></tr></table></figure>

<p><strong>summary:</strong></p>
<p><img src="http://jiali.clouddn.com/20201012_008.png" alt=""></p>
<p>nRF5 SDK 给出的例子，关键代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**@brief Function for handling the idle state (main loop).</span><br><span class="line"> *</span><br><span class="line"> * @details If there is no pending log operation, then sleep until next the next event occurs.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void idle_state_handle(void)</span><br><span class="line">&#123;</span><br><span class="line">    if (NRF_LOG_PROCESS() &#x3D;&#x3D; false)</span><br><span class="line">    &#123;</span><br><span class="line">        nrf_pwr_mgmt_run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;**@brief Function for application main entry.</span><br><span class="line"> *&#x2F;</span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">    bool     erase_bonds;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Initialize.</span><br><span class="line">    log_init();</span><br><span class="line">    timers_init();</span><br><span class="line">    buttons_leds_init(&amp;erase_bonds);</span><br><span class="line">    power_management_init();</span><br><span class="line">    ble_stack_init();</span><br><span class="line">    gap_params_init();</span><br><span class="line">    gatt_init();</span><br><span class="line">    advertising_init();</span><br><span class="line">    services_init();</span><br><span class="line">    sensor_simulator_init();</span><br><span class="line">    conn_params_init();</span><br><span class="line">    peer_manager_init();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Start execution.</span><br><span class="line">    NRF_LOG_INFO(&quot;Blood Pressure example started.&quot;);</span><br><span class="line">    application_timers_start();</span><br><span class="line"></span><br><span class="line">    advertising_start(erase_bonds);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Enter main loop.</span><br><span class="line">    for (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        idle_state_handle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>nrf_pwr_mgmt_run()函数代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">void nrf_pwr_mgmt_run(void)</span><br><span class="line">&#123;</span><br><span class="line">    PWR_MGMT_FPU_SLEEP_PREPARE();</span><br><span class="line">    PWR_MGMT_SLEEP_LOCK_ACQUIRE();</span><br><span class="line">    PWR_MGMT_CPU_USAGE_MONITOR_SECTION_ENTER();</span><br><span class="line">    PWR_MGMT_DEBUG_PIN_SET();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Wait for an event.</span><br><span class="line">#ifdef SOFTDEVICE_PRESENT</span><br><span class="line">    if (nrf_sdh_is_enabled())  &#x2F;&#x2F;使能协议栈</span><br><span class="line">    &#123;</span><br><span class="line">        ret_code_t ret_code &#x3D; sd_app_evt_wait();</span><br><span class="line">        ASSERT((ret_code &#x3D;&#x3D; NRF_SUCCESS) || (ret_code &#x3D;&#x3D; NRF_ERROR_SOFTDEVICE_NOT_ENABLED));</span><br><span class="line">        UNUSED_VARIABLE(ret_code);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">#endif &#x2F;&#x2F; SOFTDEVICE_PRESENT</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; Wait for an event.</span><br><span class="line">        __WFE();</span><br><span class="line">        &#x2F;&#x2F; Clear the internal event register.</span><br><span class="line">        __SEV();</span><br><span class="line">        __WFE();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PWR_MGMT_DEBUG_PIN_CLEAR();</span><br><span class="line">    PWR_MGMT_CPU_USAGE_MONITOR_SECTION_EXIT();</span><br><span class="line">    PWR_MGMT_SLEEP_LOCK_RELEASE();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="电流消耗"><a href="#电流消耗" class="headerlink" title="电流消耗"></a>电流消耗</h2><p>nordic nRF52382 规格书，给出 System ON 和System OFF模式功耗，如下</p>
<p><img src="http://jiali.clouddn.com/20201012_009.png" alt=""></p>
<p>参考：</p>
<p><a href="https://embeddedcentric.com/lesson-14-nrf5x-power-management-tutorial/" target="_blank" rel="noopener">nrf5x-power-management</a></p>
<p><a href="https://www.cnblogs.com/iini/p/9351048.html" target="_blank" rel="noopener">板子功耗高的原因有哪些</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/12/IoT/%E8%93%9D%E7%89%99/nordic%20Soc%E5%BC%80%E5%8F%91/nRF5%20SDK%20app_scheduler%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/12/IoT/%E8%93%9D%E7%89%99/nordic%20Soc%E5%BC%80%E5%8F%91/nRF5%20SDK%20app_scheduler%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">nRF5 SDK app_scheduler原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-10-12 13:31:14 / Modified: 17:23:20" itemprop="dateCreated datePublished" datetime="2020-10-12T13:31:14+08:00">2020-10-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/" itemprop="url" rel="index"><span itemprop="name">IoT</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/%E8%93%9D%E7%89%99/" itemprop="url" rel="index"><span itemprop="name">蓝牙</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/%E8%93%9D%E7%89%99/Nordic-Soc%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Nordic Soc开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>需要放在main loop里面执行的函数，可以放到app_scheduler队列里面，使用app_scheduler来调度执行。调度程序主要负责从中断上下文向main函数上下文传送执行命令。</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p><strong>Logic in main context:</strong></p>
<ul>
<li>Define an event handler for each type of event expected.</li>
<li>Initialize the scheduler by calling the <a href="https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.sdk5.v15.0.0/group__app__scheduler.html#gaa9670ed0053a67304c3d2d0cb3eb1333" target="_blank" rel="noopener">APP_SCHED_INIT()</a> macro before entering the application main loop.</li>
<li>Call <a href="https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.sdk5.v15.0.0/group__app__scheduler.html#gab725820c32a8d05379db4567cf30e862" target="_blank" rel="noopener">app_sched_execute()</a> from the main loop each time the application wakes up because of an event (typically when <a href="https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.s140.api.v6.0.0/group___n_r_f___s_o_c___f_u_n_c_t_i_o_n_s.html#ga11d88d38ac99fb72cde74c9385d36433" target="_blank" rel="noopener">sd_app_evt_wait()</a> returns).</li>
</ul>
<p><strong>Logic in interrupt context:</strong></p>
<ul>
<li>In the interrupt handler, call <a href="https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.sdk5.v15.0.0/group__app__scheduler.html#ga65ba3e30627bb62882d15cde87b610f0" target="_blank" rel="noopener">app_sched_event_put()</a> with the appropriate data and event handler. This will insert an event into the scheduler’s queue. The <a href="https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.sdk5.v15.0.0/group__app__scheduler.html#gab725820c32a8d05379db4567cf30e862" target="_blank" rel="noopener">app_sched_execute()</a> function will pull this event and call its handler in the main context.</li>
</ul>
<h2 id="app-scheduler设计"><a href="#app-scheduler设计" class="headerlink" title="app_scheduler设计"></a>app_scheduler设计</h2><p>app_scheduler软件设计框架如下</p>
<p><img src="http://jiali.clouddn.com/20201012_001.png" alt=""></p>
<p><strong>1、Applications using the Scheduler</strong></p>
<p>Sequence diagrams illustrating the flow of events for various scenarios in the example applications when using the Scheduler.</p>
<p><img src="http://jiali.clouddn.com/20201012_002.png" alt=""></p>
<p><img src="http://jiali.clouddn.com/20201012_003.png" alt=""></p>
<p><strong>2、Applications not using the Scheduler</strong></p>
<p>Sequence diagrams illustrating the flow of events for various scenarios in the example applications when not using the Scheduler.</p>
<p><img src="http://jiali.clouddn.com/20201012_004.png" alt=""></p>
<p><img src="http://jiali.clouddn.com/20201012_005.png" alt=""></p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* Copyright (c) 2014 Nordic Semiconductor. All Rights Reserved.</span><br><span class="line"> *</span><br><span class="line"> * The information contained herein is property of Nordic Semiconductor ASA.</span><br><span class="line"> * Terms and conditions of usage are described in detail in NORDIC</span><br><span class="line"> * SEMICONDUCTOR STANDARD SOFTWARE LICENSE AGREEMENT.</span><br><span class="line"> *</span><br><span class="line"> * Licensees are granted free, non-transferable use of the information. NO</span><br><span class="line"> * WARRANTY of ANY KIND is provided. This heading must NOT be removed from</span><br><span class="line"> * the file.</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * This example is basically the ble_app_uart example in nRF5 SDK 12.2.0 with nRF51 ADC addon</span><br><span class="line"> * functionality. ADC sampling is triggered with pressing Button 4 (search for BSP_EVENT_KEY_3</span><br><span class="line"> * in this file) on the nRF51-DK board. When Button 4 is pressed, ADC sample task is put into </span><br><span class="line"> * app_scheduler queue, which results in the adc_sample function to be executed in the main </span><br><span class="line"> * context. The ADC outputs the result on UART.</span><br><span class="line"> *</span><br><span class="line"> * In this example, a single ADC channel is configured to sample on Analog Input 2, which maps</span><br><span class="line"> * to physical pin P0.01 on the nRF51 IC. Buffer size is set to 3, which makes the nrf_drv_adc</span><br><span class="line"> * driver return callback first when three samples have been triggered with three calls to </span><br><span class="line"> * nrf_drv_adc_sample function. When Button 4 is pressed once, buffer is allocated and the </span><br><span class="line"> * nrf_drv_adc_sample funciton is called three times which will output three ADC sample results</span><br><span class="line"> * on the UART. The ADC_BUFFER_SIZE constant configures the ADC buffer size. </span><br><span class="line"> *</span><br><span class="line"> * The UART output can be seen by connecting with e.g. Realterm UART terminal program for PC </span><br><span class="line"> * (when nRF51-DK connected to PC via USB) with the UART settings configured in the uart_init </span><br><span class="line"> * function, which is also described in the ble_app_uart documentation at </span><br><span class="line"> * http:&#x2F;&#x2F;infocenter.nordicsemi.com&#x2F;topic&#x2F;com.nordic.infocenter.sdk5.v12.2.0&#x2F;ble_sdk_app_nus_eval.html?cp&#x3D;4_0_1_4_2_2_18_2#project_uart_nus_eval_test</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">#include &lt;stdint.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &quot;nordic_common.h&quot;</span><br><span class="line">#include &quot;nrf.h&quot;</span><br><span class="line">#include &quot;ble_hci.h&quot;</span><br><span class="line">#include &quot;ble_advdata.h&quot;</span><br><span class="line">#include &quot;ble_advertising.h&quot;</span><br><span class="line">#include &quot;ble_conn_params.h&quot;</span><br><span class="line">#include &quot;softdevice_handler.h&quot;</span><br><span class="line">#include &quot;app_timer.h&quot;</span><br><span class="line">#include &quot;app_button.h&quot;</span><br><span class="line">#include &quot;ble_nus.h&quot;</span><br><span class="line">#include &quot;app_uart.h&quot;</span><br><span class="line">#include &quot;app_util_platform.h&quot;</span><br><span class="line">#include &quot;bsp.h&quot;</span><br><span class="line">#include &quot;bsp_btn_ble.h&quot;</span><br><span class="line">#include &quot;nrf_drv_adc.h&quot;</span><br><span class="line">#include &quot;app_scheduler.h&quot;</span><br><span class="line"></span><br><span class="line">#define IS_SRVC_CHANGED_CHARACT_PRESENT 0                                           &#x2F;**&lt; Include the service_changed characteristic. If not enabled, the server&#39;s database cannot be changed for the lifetime of the device. *&#x2F;</span><br><span class="line"></span><br><span class="line">#if (NRF_SD_BLE_API_VERSION &#x3D;&#x3D; 3)</span><br><span class="line">#define NRF_BLE_MAX_MTU_SIZE            GATT_MTU_SIZE_DEFAULT                       &#x2F;**&lt; MTU size used in the softdevice enabling and to reply to a BLE_GATTS_EVT_EXCHANGE_MTU_REQUEST event. *&#x2F;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#define APP_FEATURE_NOT_SUPPORTED       BLE_GATT_STATUS_ATTERR_APP_BEGIN + 2        &#x2F;**&lt; Reply when unsupported features are requested. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define CENTRAL_LINK_COUNT              0                                           &#x2F;**&lt; Number of central links used by the application. When changing this number remember to adjust the RAM settings*&#x2F;</span><br><span class="line">#define PERIPHERAL_LINK_COUNT           1                                           &#x2F;**&lt; Number of peripheral links used by the application. When changing this number remember to adjust the RAM settings*&#x2F;</span><br><span class="line"></span><br><span class="line">#define DEVICE_NAME                     &quot;Nordic_UART&quot;                               &#x2F;**&lt; Name of device. Will be included in the advertising data. *&#x2F;</span><br><span class="line">#define NUS_SERVICE_UUID_TYPE           BLE_UUID_TYPE_VENDOR_BEGIN                  &#x2F;**&lt; UUID type for the Nordic UART Service (vendor specific). *&#x2F;</span><br><span class="line"></span><br><span class="line">#define APP_ADV_INTERVAL                64                                          &#x2F;**&lt; The advertising interval (in units of 0.625 ms. This value corresponds to 40 ms). *&#x2F;</span><br><span class="line">#define APP_ADV_TIMEOUT_IN_SECONDS      180                                         &#x2F;**&lt; The advertising timeout (in units of seconds). *&#x2F;</span><br><span class="line"></span><br><span class="line">#define APP_TIMER_PRESCALER             0                                           &#x2F;**&lt; Value of the RTC1 PRESCALER register. *&#x2F;</span><br><span class="line">#define APP_TIMER_OP_QUEUE_SIZE         4                                           &#x2F;**&lt; Size of timer operation queues. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define MIN_CONN_INTERVAL               MSEC_TO_UNITS(20, UNIT_1_25_MS)             &#x2F;**&lt; Minimum acceptable connection interval (20 ms), Connection interval uses 1.25 ms units. *&#x2F;</span><br><span class="line">#define MAX_CONN_INTERVAL               MSEC_TO_UNITS(75, UNIT_1_25_MS)             &#x2F;**&lt; Maximum acceptable connection interval (75 ms), Connection interval uses 1.25 ms units. *&#x2F;</span><br><span class="line">#define SLAVE_LATENCY                   0                                           &#x2F;**&lt; Slave latency. *&#x2F;</span><br><span class="line">#define CONN_SUP_TIMEOUT                MSEC_TO_UNITS(4000, UNIT_10_MS)             &#x2F;**&lt; Connection supervisory timeout (4 seconds), Supervision Timeout uses 10 ms units. *&#x2F;</span><br><span class="line">#define FIRST_CONN_PARAMS_UPDATE_DELAY  APP_TIMER_TICKS(5000, APP_TIMER_PRESCALER)  &#x2F;**&lt; Time from initiating event (connect or start of notification) to first time sd_ble_gap_conn_param_update is called (5 seconds). *&#x2F;</span><br><span class="line">#define NEXT_CONN_PARAMS_UPDATE_DELAY   APP_TIMER_TICKS(30000, APP_TIMER_PRESCALER) &#x2F;**&lt; Time between each call to sd_ble_gap_conn_param_update after the first call (30 seconds). *&#x2F;</span><br><span class="line">#define MAX_CONN_PARAMS_UPDATE_COUNT    3                                           &#x2F;**&lt; Number of attempts before giving up the connection parameter negotiation. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define DEAD_BEEF                       0xDEADBEEF                                  &#x2F;**&lt; Value used as error code on stack dump, can be used to identify stack location on stack unwind. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define UART_TX_BUF_SIZE                1024                                         &#x2F;**&lt; UART TX buffer size. *&#x2F;</span><br><span class="line">#define UART_RX_BUF_SIZE                256                                         &#x2F;**&lt; UART RX buffer size. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define APP_SCHED_MAX_EVT_SIZE          30</span><br><span class="line">#define APP_SCHED_QUEUE_SIZE            10</span><br><span class="line"></span><br><span class="line">#define ADC_BUFFER_SIZE 3                                                           &#x2F;**&lt; Size of buffer for ADC samples.  *&#x2F;</span><br><span class="line">static nrf_adc_value_t                  adc_buffer[ADC_BUFFER_SIZE];                &#x2F;**&lt; ADC buffer. *&#x2F;</span><br><span class="line">static nrf_drv_adc_channel_t            m_channel_config &#x3D; NRF_DRV_ADC_DEFAULT_CHANNEL(NRF_ADC_CONFIG_INPUT_2); &#x2F;**&lt; Channel instance. Default configuration used. *&#x2F;</span><br><span class="line">static uint8_t                          adc_event_counter &#x3D; 0;</span><br><span class="line"></span><br><span class="line">static ble_nus_t                        m_nus;                                      &#x2F;**&lt; Structure to identify the Nordic UART Service. *&#x2F;</span><br><span class="line">static uint16_t                         m_conn_handle &#x3D; BLE_CONN_HANDLE_INVALID;    &#x2F;**&lt; Handle of the current connection. *&#x2F;</span><br><span class="line"></span><br><span class="line">static ble_uuid_t                       m_adv_uuids[] &#x3D; &#123;&#123;BLE_UUID_NUS_SERVICE, NUS_SERVICE_UUID_TYPE&#125;&#125;;  &#x2F;**&lt; Universally unique service identifier. *&#x2F;</span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for placing the application in low power state while waiting for events.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void power_manage(void)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t err_code &#x3D; sd_app_evt_wait();</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for assert macro callback.</span><br><span class="line"> *</span><br><span class="line"> * @details This function will be called in case of an assert in the SoftDevice.</span><br><span class="line"> *</span><br><span class="line"> * @warning This handler is an example only and does not fit a final product. You need to analyse</span><br><span class="line"> *          how your product is supposed to react in case of Assert.</span><br><span class="line"> * @warning On assert from the SoftDevice, the system can only recover on reset.</span><br><span class="line"> *</span><br><span class="line"> * @param[in] line_num    Line number of the failing ASSERT call.</span><br><span class="line"> * @param[in] p_file_name File name of the failing ASSERT call.</span><br><span class="line"> *&#x2F;</span><br><span class="line">void assert_nrf_callback(uint16_t line_num, const uint8_t * p_file_name)</span><br><span class="line">&#123;</span><br><span class="line">    app_error_handler(DEAD_BEEF, line_num, p_file_name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for the GAP initialization.</span><br><span class="line"> *</span><br><span class="line"> * @details This function will set up all the necessary GAP (Generic Access Profile) parameters of</span><br><span class="line"> *          the device. It also sets the permissions and appearance.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void gap_params_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t                err_code;</span><br><span class="line">    ble_gap_conn_params_t   gap_conn_params;</span><br><span class="line">    ble_gap_conn_sec_mode_t sec_mode;</span><br><span class="line"></span><br><span class="line">    BLE_GAP_CONN_SEC_MODE_SET_OPEN(&amp;sec_mode);</span><br><span class="line"></span><br><span class="line">    err_code &#x3D; sd_ble_gap_device_name_set(&amp;sec_mode,</span><br><span class="line">                                          (const uint8_t *) DEVICE_NAME,</span><br><span class="line">                                          strlen(DEVICE_NAME));</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line"></span><br><span class="line">    memset(&amp;gap_conn_params, 0, sizeof(gap_conn_params));</span><br><span class="line"></span><br><span class="line">    gap_conn_params.min_conn_interval &#x3D; MIN_CONN_INTERVAL;</span><br><span class="line">    gap_conn_params.max_conn_interval &#x3D; MAX_CONN_INTERVAL;</span><br><span class="line">    gap_conn_params.slave_latency     &#x3D; SLAVE_LATENCY;</span><br><span class="line">    gap_conn_params.conn_sup_timeout  &#x3D; CONN_SUP_TIMEOUT;</span><br><span class="line"></span><br><span class="line">    err_code &#x3D; sd_ble_gap_ppcp_set(&amp;gap_conn_params);</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for handling the data from the Nordic UART Service.</span><br><span class="line"> *</span><br><span class="line"> * @details This function will process the data received from the Nordic UART BLE Service and send</span><br><span class="line"> *          it to the UART module.</span><br><span class="line"> *</span><br><span class="line"> * @param[in] p_nus    Nordic UART Service structure.</span><br><span class="line"> * @param[in] p_data   Data to be send to UART module.</span><br><span class="line"> * @param[in] length   Length of the data.</span><br><span class="line"> *&#x2F;</span><br><span class="line">&#x2F;**@snippet [Handling the data received over BLE] *&#x2F;</span><br><span class="line">static void nus_data_handler(ble_nus_t * p_nus, uint8_t * p_data, uint16_t length)</span><br><span class="line">&#123;</span><br><span class="line">    for (uint32_t i &#x3D; 0; i &lt; length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        while (app_uart_put(p_data[i]) !&#x3D; NRF_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line">    while (app_uart_put(&#39;\r&#39;) !&#x3D; NRF_SUCCESS);</span><br><span class="line">    while (app_uart_put(&#39;\n&#39;) !&#x3D; NRF_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;**@snippet [Handling the data received over BLE] *&#x2F;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for initializing services that will be used by the application.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void services_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t       err_code;</span><br><span class="line">    ble_nus_init_t nus_init;</span><br><span class="line"></span><br><span class="line">    memset(&amp;nus_init, 0, sizeof(nus_init));</span><br><span class="line"></span><br><span class="line">    nus_init.data_handler &#x3D; nus_data_handler;</span><br><span class="line"></span><br><span class="line">    err_code &#x3D; ble_nus_init(&amp;m_nus, &amp;nus_init);</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for handling an event from the Connection Parameters Module.</span><br><span class="line"> *</span><br><span class="line"> * @details This function will be called for all events in the Connection Parameters Module</span><br><span class="line"> *          which are passed to the application.</span><br><span class="line"> *</span><br><span class="line"> * @note All this function does is to disconnect. This could have been done by simply setting</span><br><span class="line"> *       the disconnect_on_fail config parameter, but instead we use the event handler</span><br><span class="line"> *       mechanism to demonstrate its use.</span><br><span class="line"> *</span><br><span class="line"> * @param[in] p_evt  Event received from the Connection Parameters Module.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void on_conn_params_evt(ble_conn_params_evt_t * p_evt)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t err_code;</span><br><span class="line"></span><br><span class="line">    if (p_evt-&gt;evt_type &#x3D;&#x3D; BLE_CONN_PARAMS_EVT_FAILED)</span><br><span class="line">    &#123;</span><br><span class="line">        err_code &#x3D; sd_ble_gap_disconnect(m_conn_handle, BLE_HCI_CONN_INTERVAL_UNACCEPTABLE);</span><br><span class="line">        APP_ERROR_CHECK(err_code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for handling errors from the Connection Parameters module.</span><br><span class="line"> *</span><br><span class="line"> * @param[in] nrf_error  Error code containing information about what went wrong.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void conn_params_error_handler(uint32_t nrf_error)</span><br><span class="line">&#123;</span><br><span class="line">    APP_ERROR_HANDLER(nrf_error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for initializing the Connection Parameters module.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void conn_params_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t               err_code;</span><br><span class="line">    ble_conn_params_init_t cp_init;</span><br><span class="line"></span><br><span class="line">    memset(&amp;cp_init, 0, sizeof(cp_init));</span><br><span class="line"></span><br><span class="line">    cp_init.p_conn_params                  &#x3D; NULL;</span><br><span class="line">    cp_init.first_conn_params_update_delay &#x3D; FIRST_CONN_PARAMS_UPDATE_DELAY;</span><br><span class="line">    cp_init.next_conn_params_update_delay  &#x3D; NEXT_CONN_PARAMS_UPDATE_DELAY;</span><br><span class="line">    cp_init.max_conn_params_update_count   &#x3D; MAX_CONN_PARAMS_UPDATE_COUNT;</span><br><span class="line">    cp_init.start_on_notify_cccd_handle    &#x3D; BLE_GATT_HANDLE_INVALID;</span><br><span class="line">    cp_init.disconnect_on_fail             &#x3D; false;</span><br><span class="line">    cp_init.evt_handler                    &#x3D; on_conn_params_evt;</span><br><span class="line">    cp_init.error_handler                  &#x3D; conn_params_error_handler;</span><br><span class="line"></span><br><span class="line">    err_code &#x3D; ble_conn_params_init(&amp;cp_init);</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for putting the chip into sleep mode.</span><br><span class="line"> *</span><br><span class="line"> * @note This function will not return.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void sleep_mode_enter(void)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t err_code &#x3D; bsp_indication_set(BSP_INDICATE_IDLE);</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Prepare wakeup buttons.</span><br><span class="line">    err_code &#x3D; bsp_btn_ble_sleep_mode_prepare();</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Go to system-off mode (this function will not return; wakeup will cause a reset).</span><br><span class="line">    err_code &#x3D; sd_power_system_off();</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for handling advertising events.</span><br><span class="line"> *</span><br><span class="line"> * @details This function will be called for advertising events which are passed to the application.</span><br><span class="line"> *</span><br><span class="line"> * @param[in] ble_adv_evt  Advertising event.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void on_adv_evt(ble_adv_evt_t ble_adv_evt)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t err_code;</span><br><span class="line"></span><br><span class="line">    switch (ble_adv_evt)</span><br><span class="line">    &#123;</span><br><span class="line">        case BLE_ADV_EVT_FAST:</span><br><span class="line">            err_code &#x3D; bsp_indication_set(BSP_INDICATE_ADVERTISING);</span><br><span class="line">            APP_ERROR_CHECK(err_code);</span><br><span class="line">            break;</span><br><span class="line">        case BLE_ADV_EVT_IDLE:</span><br><span class="line">            sleep_mode_enter();</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for the application&#39;s SoftDevice event handler.</span><br><span class="line"> *</span><br><span class="line"> * @param[in] p_ble_evt SoftDevice event.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void on_ble_evt(ble_evt_t * p_ble_evt)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t err_code;</span><br><span class="line"></span><br><span class="line">    switch (p_ble_evt-&gt;header.evt_id)</span><br><span class="line">    &#123;</span><br><span class="line">        case BLE_GAP_EVT_CONNECTED:</span><br><span class="line">            err_code &#x3D; bsp_indication_set(BSP_INDICATE_CONNECTED);</span><br><span class="line">            APP_ERROR_CHECK(err_code);</span><br><span class="line">            m_conn_handle &#x3D; p_ble_evt-&gt;evt.gap_evt.conn_handle;</span><br><span class="line">            break; &#x2F;&#x2F; BLE_GAP_EVT_CONNECTED</span><br><span class="line"></span><br><span class="line">        case BLE_GAP_EVT_DISCONNECTED:</span><br><span class="line">            err_code &#x3D; bsp_indication_set(BSP_INDICATE_IDLE);</span><br><span class="line">            APP_ERROR_CHECK(err_code);</span><br><span class="line">            m_conn_handle &#x3D; BLE_CONN_HANDLE_INVALID;</span><br><span class="line">            break; &#x2F;&#x2F; BLE_GAP_EVT_DISCONNECTED</span><br><span class="line"></span><br><span class="line">        case BLE_GAP_EVT_SEC_PARAMS_REQUEST:</span><br><span class="line">            &#x2F;&#x2F; Pairing not supported</span><br><span class="line">            err_code &#x3D; sd_ble_gap_sec_params_reply(m_conn_handle, BLE_GAP_SEC_STATUS_PAIRING_NOT_SUPP, NULL, NULL);</span><br><span class="line">            APP_ERROR_CHECK(err_code);</span><br><span class="line">            break; &#x2F;&#x2F; BLE_GAP_EVT_SEC_PARAMS_REQUEST</span><br><span class="line"></span><br><span class="line">        case BLE_GATTS_EVT_SYS_ATTR_MISSING:</span><br><span class="line">            &#x2F;&#x2F; No system attributes have been stored.</span><br><span class="line">            err_code &#x3D; sd_ble_gatts_sys_attr_set(m_conn_handle, NULL, 0, 0);</span><br><span class="line">            APP_ERROR_CHECK(err_code);</span><br><span class="line">            break; &#x2F;&#x2F; BLE_GATTS_EVT_SYS_ATTR_MISSING</span><br><span class="line"></span><br><span class="line">        case BLE_GATTC_EVT_TIMEOUT:</span><br><span class="line">            &#x2F;&#x2F; Disconnect on GATT Client timeout event.</span><br><span class="line">            err_code &#x3D; sd_ble_gap_disconnect(p_ble_evt-&gt;evt.gattc_evt.conn_handle,</span><br><span class="line">                                             BLE_HCI_REMOTE_USER_TERMINATED_CONNECTION);</span><br><span class="line">            APP_ERROR_CHECK(err_code);</span><br><span class="line">            break; &#x2F;&#x2F; BLE_GATTC_EVT_TIMEOUT</span><br><span class="line"></span><br><span class="line">        case BLE_GATTS_EVT_TIMEOUT:</span><br><span class="line">            &#x2F;&#x2F; Disconnect on GATT Server timeout event.</span><br><span class="line">            err_code &#x3D; sd_ble_gap_disconnect(p_ble_evt-&gt;evt.gatts_evt.conn_handle,</span><br><span class="line">                                             BLE_HCI_REMOTE_USER_TERMINATED_CONNECTION);</span><br><span class="line">            APP_ERROR_CHECK(err_code);</span><br><span class="line">            break; &#x2F;&#x2F; BLE_GATTS_EVT_TIMEOUT</span><br><span class="line"></span><br><span class="line">        case BLE_EVT_USER_MEM_REQUEST:</span><br><span class="line">            err_code &#x3D; sd_ble_user_mem_reply(p_ble_evt-&gt;evt.gattc_evt.conn_handle, NULL);</span><br><span class="line">            APP_ERROR_CHECK(err_code);</span><br><span class="line">            break; &#x2F;&#x2F; BLE_EVT_USER_MEM_REQUEST</span><br><span class="line"></span><br><span class="line">        case BLE_GATTS_EVT_RW_AUTHORIZE_REQUEST:</span><br><span class="line">        &#123;</span><br><span class="line">            ble_gatts_evt_rw_authorize_request_t  req;</span><br><span class="line">            ble_gatts_rw_authorize_reply_params_t auth_reply;</span><br><span class="line"></span><br><span class="line">            req &#x3D; p_ble_evt-&gt;evt.gatts_evt.params.authorize_request;</span><br><span class="line"></span><br><span class="line">            if (req.type !&#x3D; BLE_GATTS_AUTHORIZE_TYPE_INVALID)</span><br><span class="line">            &#123;</span><br><span class="line">                if ((req.request.write.op &#x3D;&#x3D; BLE_GATTS_OP_PREP_WRITE_REQ)     ||</span><br><span class="line">                    (req.request.write.op &#x3D;&#x3D; BLE_GATTS_OP_EXEC_WRITE_REQ_NOW) ||</span><br><span class="line">                    (req.request.write.op &#x3D;&#x3D; BLE_GATTS_OP_EXEC_WRITE_REQ_CANCEL))</span><br><span class="line">                &#123;</span><br><span class="line">                    if (req.type &#x3D;&#x3D; BLE_GATTS_AUTHORIZE_TYPE_WRITE)</span><br><span class="line">                    &#123;</span><br><span class="line">                        auth_reply.type &#x3D; BLE_GATTS_AUTHORIZE_TYPE_WRITE;</span><br><span class="line">                    &#125;</span><br><span class="line">                    else</span><br><span class="line">                    &#123;</span><br><span class="line">                        auth_reply.type &#x3D; BLE_GATTS_AUTHORIZE_TYPE_READ;</span><br><span class="line">                    &#125;</span><br><span class="line">                    auth_reply.params.write.gatt_status &#x3D; APP_FEATURE_NOT_SUPPORTED;</span><br><span class="line">                    err_code &#x3D; sd_ble_gatts_rw_authorize_reply(p_ble_evt-&gt;evt.gatts_evt.conn_handle,</span><br><span class="line">                                                               &amp;auth_reply);</span><br><span class="line">                    APP_ERROR_CHECK(err_code);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; break; &#x2F;&#x2F; BLE_GATTS_EVT_RW_AUTHORIZE_REQUEST</span><br><span class="line"></span><br><span class="line">#if (NRF_SD_BLE_API_VERSION &#x3D;&#x3D; 3)</span><br><span class="line">        case BLE_GATTS_EVT_EXCHANGE_MTU_REQUEST:</span><br><span class="line">            err_code &#x3D; sd_ble_gatts_exchange_mtu_reply(p_ble_evt-&gt;evt.gatts_evt.conn_handle,</span><br><span class="line">                                                       NRF_BLE_MAX_MTU_SIZE);</span><br><span class="line">            APP_ERROR_CHECK(err_code);</span><br><span class="line">            break; &#x2F;&#x2F; BLE_GATTS_EVT_EXCHANGE_MTU_REQUEST</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">        default:</span><br><span class="line">            &#x2F;&#x2F; No implementation needed.</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for dispatching a SoftDevice event to all modules with a SoftDevice</span><br><span class="line"> *        event handler.</span><br><span class="line"> *</span><br><span class="line"> * @details This function is called from the SoftDevice event interrupt handler after a</span><br><span class="line"> *          SoftDevice event has been received.</span><br><span class="line"> *</span><br><span class="line"> * @param[in] p_ble_evt  SoftDevice event.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void ble_evt_dispatch(ble_evt_t * p_ble_evt)</span><br><span class="line">&#123;</span><br><span class="line">    ble_conn_params_on_ble_evt(p_ble_evt);</span><br><span class="line">    ble_nus_on_ble_evt(&amp;m_nus, p_ble_evt);</span><br><span class="line">    on_ble_evt(p_ble_evt);</span><br><span class="line">    ble_advertising_on_ble_evt(p_ble_evt);</span><br><span class="line">    bsp_btn_ble_on_ble_evt(p_ble_evt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for the SoftDevice initialization.</span><br><span class="line"> *</span><br><span class="line"> * @details This function initializes the SoftDevice and the BLE event interrupt.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void ble_stack_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t err_code;</span><br><span class="line"></span><br><span class="line">    nrf_clock_lf_cfg_t clock_lf_cfg &#x3D; NRF_CLOCK_LFCLKSRC;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Initialize SoftDevice.</span><br><span class="line">    SOFTDEVICE_HANDLER_INIT(&amp;clock_lf_cfg, NULL);</span><br><span class="line"></span><br><span class="line">    ble_enable_params_t ble_enable_params;</span><br><span class="line">    err_code &#x3D; softdevice_enable_get_default_config(CENTRAL_LINK_COUNT,</span><br><span class="line">                                                    PERIPHERAL_LINK_COUNT,</span><br><span class="line">                                                    &amp;ble_enable_params);</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;Check the ram settings against the used number of links</span><br><span class="line">    CHECK_RAM_START_ADDR(CENTRAL_LINK_COUNT,PERIPHERAL_LINK_COUNT);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Enable BLE stack.</span><br><span class="line">#if (NRF_SD_BLE_API_VERSION &#x3D;&#x3D; 3)</span><br><span class="line">    ble_enable_params.gatt_enable_params.att_mtu &#x3D; NRF_BLE_MAX_MTU_SIZE;</span><br><span class="line">#endif</span><br><span class="line">    err_code &#x3D; softdevice_enable(&amp;ble_enable_params);</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Subscribe for BLE events.</span><br><span class="line">    err_code &#x3D; softdevice_ble_evt_handler_set(ble_evt_dispatch);</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void adc_sample(void)</span><br><span class="line">&#123;</span><br><span class="line">    ret_code_t ret_code;</span><br><span class="line">	</span><br><span class="line">    ret_code &#x3D; nrf_drv_adc_buffer_convert(adc_buffer, ADC_BUFFER_SIZE);        &#x2F;&#x2F; Allocate buffer for ADC</span><br><span class="line">    APP_ERROR_CHECK(ret_code);</span><br><span class="line">	</span><br><span class="line">    for (uint32_t i &#x3D; 0; i &lt; ADC_BUFFER_SIZE; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        while((NRF_ADC-&gt;BUSY &amp; ADC_BUSY_BUSY_Msk) &#x3D;&#x3D; ADC_BUSY_BUSY_Busy) &#123;&#125;    &#x2F;&#x2F;Wait until the ADC is finished sampling</span><br><span class="line">        printf(&quot;Start sampling ... \r\n&quot;);</span><br><span class="line">        nrf_drv_adc_sample();</span><br><span class="line">    &#125;					</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for handling events from the BSP module.</span><br><span class="line"> *</span><br><span class="line"> * @param[in]   event   Event generated by button press.</span><br><span class="line"> *&#x2F;</span><br><span class="line">void bsp_event_handler(bsp_event_t event)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t err_code;</span><br><span class="line">    switch (event)</span><br><span class="line">    &#123;</span><br><span class="line">        case BSP_EVENT_SLEEP:</span><br><span class="line">            sleep_mode_enter();</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        case BSP_EVENT_DISCONNECT:</span><br><span class="line">            err_code &#x3D; sd_ble_gap_disconnect(m_conn_handle, BLE_HCI_REMOTE_USER_TERMINATED_CONNECTION);</span><br><span class="line">            if (err_code !&#x3D; NRF_ERROR_INVALID_STATE)</span><br><span class="line">            &#123;</span><br><span class="line">                APP_ERROR_CHECK(err_code);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        case BSP_EVENT_WHITELIST_OFF:</span><br><span class="line">            if (m_conn_handle &#x3D;&#x3D; BLE_CONN_HANDLE_INVALID)</span><br><span class="line">            &#123;</span><br><span class="line">                err_code &#x3D; ble_advertising_restart_without_whitelist();</span><br><span class="line">                if (err_code !&#x3D; NRF_ERROR_INVALID_STATE)</span><br><span class="line">                &#123;</span><br><span class="line">                    APP_ERROR_CHECK(err_code);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        </span><br><span class="line">        case BSP_EVENT_KEY_3:</span><br><span class="line">            printf(&quot;\r\n    BUTTON 4 is pressed...\r\n&quot;);                      &#x2F;&#x2F;Indicate on UART that Button 4 is pressed</span><br><span class="line">            app_sched_event_put(0,0,(app_sched_event_handler_t)adc_sample);    &#x2F;&#x2F;Put adc_sample function into the scheduler queue, which will then be executed in the main context (lowest priority) when app_sched_execute is called in the main loop</span><br><span class="line">            break;	</span><br><span class="line"></span><br><span class="line">        default:</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief   Function for handling app_uart events.</span><br><span class="line"> *</span><br><span class="line"> * @details This function will receive a single character from the app_uart module and append it to</span><br><span class="line"> *          a string. The string will be be sent over BLE when the last character received was a</span><br><span class="line"> *          &#39;new line&#39; i.e &#39;\r\n&#39; (hex 0x0D) or if the string has reached a length of</span><br><span class="line"> *          @ref NUS_MAX_DATA_LENGTH.</span><br><span class="line"> *&#x2F;</span><br><span class="line">&#x2F;**@snippet [Handling the data received over UART] *&#x2F;</span><br><span class="line">void uart_event_handle(app_uart_evt_t * p_event)</span><br><span class="line">&#123;</span><br><span class="line">    static uint8_t data_array[BLE_NUS_MAX_DATA_LEN];</span><br><span class="line">    static uint8_t index &#x3D; 0;</span><br><span class="line">    uint32_t       err_code;</span><br><span class="line"></span><br><span class="line">    switch (p_event-&gt;evt_type)</span><br><span class="line">    &#123;</span><br><span class="line">        case APP_UART_DATA_READY:</span><br><span class="line">            UNUSED_VARIABLE(app_uart_get(&amp;data_array[index]));</span><br><span class="line">            index++;</span><br><span class="line"></span><br><span class="line">            if ((data_array[index - 1] &#x3D;&#x3D; &#39;\n&#39;) || (index &gt;&#x3D; (BLE_NUS_MAX_DATA_LEN)))</span><br><span class="line">            &#123;</span><br><span class="line">                err_code &#x3D; ble_nus_string_send(&amp;m_nus, data_array, index);</span><br><span class="line">                if (err_code !&#x3D; NRF_ERROR_INVALID_STATE)</span><br><span class="line">                &#123;</span><br><span class="line">                    APP_ERROR_CHECK(err_code);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                index &#x3D; 0;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        case APP_UART_COMMUNICATION_ERROR:</span><br><span class="line">            APP_ERROR_HANDLER(p_event-&gt;data.error_communication);</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        case APP_UART_FIFO_ERROR:</span><br><span class="line">            APP_ERROR_HANDLER(p_event-&gt;data.error_code);</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        default:</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;**@snippet [Handling the data received over UART] *&#x2F;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief  Function for initializing the UART module.</span><br><span class="line"> *&#x2F;</span><br><span class="line">&#x2F;**@snippet [UART Initialization] *&#x2F;</span><br><span class="line">static void uart_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t                     err_code;</span><br><span class="line">    const app_uart_comm_params_t comm_params &#x3D;</span><br><span class="line">    &#123;</span><br><span class="line">        RX_PIN_NUMBER,</span><br><span class="line">        TX_PIN_NUMBER,</span><br><span class="line">        RTS_PIN_NUMBER,</span><br><span class="line">        CTS_PIN_NUMBER,</span><br><span class="line">        APP_UART_FLOW_CONTROL_DISABLED,</span><br><span class="line">        false,</span><br><span class="line">        UART_BAUDRATE_BAUDRATE_Baud115200</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    APP_UART_FIFO_INIT( &amp;comm_params,</span><br><span class="line">                       UART_RX_BUF_SIZE,</span><br><span class="line">                       UART_TX_BUF_SIZE,</span><br><span class="line">                       uart_event_handle,</span><br><span class="line">                       APP_IRQ_PRIORITY_LOWEST,</span><br><span class="line">                       err_code);</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;**@snippet [UART Initialization] *&#x2F;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for initializing the Advertising functionality.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void advertising_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t               err_code;</span><br><span class="line">    ble_advdata_t          advdata;</span><br><span class="line">    ble_advdata_t          scanrsp;</span><br><span class="line">    ble_adv_modes_config_t options;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Build advertising data struct to pass into @ref ble_advertising_init.</span><br><span class="line">    memset(&amp;advdata, 0, sizeof(advdata));</span><br><span class="line">    advdata.name_type          &#x3D; BLE_ADVDATA_FULL_NAME;</span><br><span class="line">    advdata.include_appearance &#x3D; false;</span><br><span class="line">    advdata.flags              &#x3D; BLE_GAP_ADV_FLAGS_LE_ONLY_LIMITED_DISC_MODE;</span><br><span class="line"></span><br><span class="line">    memset(&amp;scanrsp, 0, sizeof(scanrsp));</span><br><span class="line">    scanrsp.uuids_complete.uuid_cnt &#x3D; sizeof(m_adv_uuids) &#x2F; sizeof(m_adv_uuids[0]);</span><br><span class="line">    scanrsp.uuids_complete.p_uuids  &#x3D; m_adv_uuids;</span><br><span class="line"></span><br><span class="line">    memset(&amp;options, 0, sizeof(options));</span><br><span class="line">    options.ble_adv_fast_enabled  &#x3D; true;</span><br><span class="line">    options.ble_adv_fast_interval &#x3D; APP_ADV_INTERVAL;</span><br><span class="line">    options.ble_adv_fast_timeout  &#x3D; APP_ADV_TIMEOUT_IN_SECONDS;</span><br><span class="line"></span><br><span class="line">    err_code &#x3D; ble_advertising_init(&amp;advdata, &amp;scanrsp, &amp;options, on_adv_evt, NULL);</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Function for initializing buttons and leds.</span><br><span class="line"> *</span><br><span class="line"> * @param[out] p_erase_bonds  Will be true if the clear bonding button was pressed to wake the application up.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void buttons_leds_init(bool * p_erase_bonds)</span><br><span class="line">&#123;</span><br><span class="line">    bsp_event_t startup_event;</span><br><span class="line"></span><br><span class="line">    uint32_t err_code &#x3D; bsp_init(BSP_INIT_LED | BSP_INIT_BUTTONS,</span><br><span class="line">                                 APP_TIMER_TICKS(100, APP_TIMER_PRESCALER),</span><br><span class="line">                                 bsp_event_handler);</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line"></span><br><span class="line">    err_code &#x3D; bsp_btn_ble_init(NULL, &amp;startup_event);</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line"></span><br><span class="line">    *p_erase_bonds &#x3D; (startup_event &#x3D;&#x3D; BSP_EVENT_CLEAR_BONDING_DATA);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @brief ADC interrupt handler.</span><br><span class="line"> * Prints ADC results on hardware UART and over BLE via the NUS service.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void adc_event_handler(nrf_drv_adc_evt_t const * p_event)</span><br><span class="line">&#123;</span><br><span class="line">    uint8_t adc_result[ADC_BUFFER_SIZE*2];	</span><br><span class="line">	</span><br><span class="line">    if (p_event-&gt;type &#x3D;&#x3D; NRF_DRV_ADC_EVT_DONE)</span><br><span class="line">    &#123;</span><br><span class="line">        adc_event_counter++;</span><br><span class="line">        printf(&quot;    ADC event counter: %d\r\n&quot;, adc_event_counter);</span><br><span class="line">        for (uint32_t i &#x3D; 0; i &lt; p_event-&gt;data.done.size; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            printf(&quot;Sample value %u: %d\r\n&quot;, (unsigned int)i+1, p_event-&gt;data.done.p_buffer[i]);</span><br><span class="line">            adc_result[(i*2)] &#x3D; p_event-&gt;data.done.p_buffer[i] &gt;&gt; 8;</span><br><span class="line">            adc_result[(i*2)+1] &#x3D; p_event-&gt;data.done.p_buffer[i];					</span><br><span class="line">        &#125;</span><br><span class="line">				</span><br><span class="line">        if(ADC_BUFFER_SIZE &lt;&#x3D; 10)</span><br><span class="line">        &#123;</span><br><span class="line">            ble_nus_string_send(&amp;m_nus, &amp;adc_result[0], ADC_BUFFER_SIZE*2);</span><br><span class="line">        &#125;					</span><br><span class="line">        LEDS_INVERT(BSP_LED_3_MASK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @brief ADC initialization.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void adc_config(void)</span><br><span class="line">&#123;</span><br><span class="line">    ret_code_t ret_code;</span><br><span class="line">    nrf_drv_adc_config_t config &#x3D; NRF_DRV_ADC_DEFAULT_CONFIG;</span><br><span class="line"></span><br><span class="line">    ret_code &#x3D; nrf_drv_adc_init(&amp;config, adc_event_handler);</span><br><span class="line">    APP_ERROR_CHECK(ret_code);</span><br><span class="line"></span><br><span class="line">    nrf_drv_adc_channel_enable(&amp;m_channel_config);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**@brief Application main function.</span><br><span class="line"> *&#x2F;</span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t err_code;</span><br><span class="line">    bool erase_bonds;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Initialize.</span><br><span class="line">    APP_SCHED_INIT(APP_SCHED_MAX_EVT_SIZE, APP_SCHED_QUEUE_SIZE);            &#x2F;&#x2F;Initialize scheduler</span><br><span class="line">    APP_TIMER_INIT(APP_TIMER_PRESCALER, APP_TIMER_OP_QUEUE_SIZE, false);</span><br><span class="line">    uart_init();</span><br><span class="line"></span><br><span class="line">    buttons_leds_init(&amp;erase_bonds);</span><br><span class="line">    ble_stack_init();</span><br><span class="line">    gap_params_init();</span><br><span class="line">    services_init();</span><br><span class="line">    advertising_init();</span><br><span class="line">    conn_params_init();</span><br><span class="line"></span><br><span class="line">    printf(&quot;\r\nUART Start!\r\n&quot;);</span><br><span class="line">    err_code &#x3D; ble_advertising_start(BLE_ADV_MODE_FAST);</span><br><span class="line">    APP_ERROR_CHECK(err_code);</span><br><span class="line">    </span><br><span class="line">    adc_config();                &#x2F;&#x2F;Initialize ADC</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Enter main loop.</span><br><span class="line">    for (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        power_manage();          &#x2F;&#x2F; Enter sleep mode</span><br><span class="line">        app_sched_execute();     &#x2F;&#x2F;Let scheduler execute whatever is in the scheduler queue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @&#125;</span><br><span class="line"> *&#x2F;</span><br></pre></td></tr></table></figure>

<p>Q&amp;S</p>
<p>问题1：app_sched_execute followed by sd_app_evt_wait</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">app_sched_execute followed by sd_app_evt_wait</span><br><span class="line">Hello,</span><br><span class="line">I am working on a project based on the nRF51822 with the softdevice S110.</span><br><span class="line">I am trying to develop an application using the main loop provided in an example application:</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Enter main loop</span><br><span class="line">for (;;)</span><br><span class="line">&#123;</span><br><span class="line">    app_sched_execute();</span><br><span class="line">    &lt;&lt;-- interrupt raised here that calls app_sched_event_put</span><br><span class="line">    sd_app_evt_wait();</span><br><span class="line">&#125;</span><br><span class="line">I am puzzled by this code for the idle loop, I do not understand how the system handles a situation where an interrupt is raised between the execution of app_shed_execute and sd_app_evt_wait. If the interrupt invokes a app_sched_event_put, then the system will still go to (deep) sleep mode and will not execute the event handler until the next loop which could come much later. Am I missing something in the architecture?</span><br><span class="line"></span><br><span class="line">Thanks Louis</span><br></pre></td></tr></table></figure>

<p>答：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**@brief Waits for an application event.</span><br><span class="line"> *</span><br><span class="line"> * An application event is either an application interrupt or a pended interrupt when the interrupt</span><br><span class="line"> * is disabled.</span><br><span class="line"> *</span><br><span class="line"> * When the application waits for an application event by calling this function, an interrupt that</span><br><span class="line"> * is enabled will be taken immediately on pending since this function will wait in thread mode,</span><br><span class="line"> * then the execution will return in the application&#39;s main thread.</span><br><span class="line"> *</span><br><span class="line"> * In order to wake up from disabled interrupts, the SEVONPEND flag has to be set in the Cortex-M</span><br><span class="line"> * MCU&#39;s System Control Register (SCR), CMSIS_SCB. In that case, when a disabled interrupt gets</span><br><span class="line"> * pended, this function will return to the application&#39;s main thread.</span><br><span class="line"> *</span><br><span class="line"> * @note The application must ensure that the pended flag is cleared using ::sd_nvic_ClearPendingIRQ</span><br><span class="line"> *       in order to sleep using this function. This is only necessary for disabled interrupts, as</span><br><span class="line"> *       the interrupt handler will clear the pending flag automatically for enabled interrupts.</span><br><span class="line"> *</span><br><span class="line"> * @note If an application interrupt has happened since the last time sd_app_evt_wait was</span><br><span class="line"> *       called this function will return immediately and not go to sleep. This is to avoid race</span><br><span class="line"> *       conditions that can occur when a flag is updated in the interrupt handler and processed</span><br><span class="line"> *       in the main loop.</span><br><span class="line"> *</span><br><span class="line"> * @post An application interrupt has happened or a interrupt pending flag is set.</span><br><span class="line"> *</span><br><span class="line"> * @retval ::NRF_SUCCESS</span><br><span class="line"> *&#x2F;</span><br><span class="line">SVCALL(SD_APP_EVT_WAIT, uint32_t, sd_app_evt_wait(void));</span><br></pre></td></tr></table></figure>

<p>sd_app_evt_wait()函数是电源管理函数，执行该函数，系统进入sleep on 模式。产生中断，可唤醒系统，从sd_app_evt_wait()返回后，执行app_sched_execute()。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* @note If an application interrupt has happened since the last time sd_app_evt_wait was</span><br><span class="line"> *       called this function will return immediately and not go to sleep. This is to avoid race</span><br><span class="line"> *       conditions that can occur when a flag is updated in the interrupt handler and processed</span><br><span class="line"> *       in the main loop.</span><br><span class="line"> 大概意思就是如果在调用sd_app_evt_wait之前，产生了中断，那么sd_app_evt_wait()不进入休眠，立即返回。这样避免了因进去休眠，本次中断产生的任务不能立即执行的情况</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a href="https://infocenter.nordicsemi.com/index.jsp" target="_blank" rel="noopener">Schedule handling library</a></p>
<p><a href="https://www.cnblogs.com/zjutlitao/p/5092871.html" target="_blank" rel="noopener">图解nRF51 SDK中的Schedule handling library 和Timer library</a></p>
<p><a href="https://embeddedcentric.com/lesson-14-nrf5x-power-management-tutorial/" target="_blank" rel="noopener">nrf5x-power-management-tutorial</a></p>
<p><a href="https://blog.csdn.net/huitailang_1_1/article/details/88556149" target="_blank" rel="noopener">nordic 调度器代码分析</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/10/IoT/%E8%93%9D%E7%89%99/nordic%20Soc%E5%BC%80%E5%8F%91/nordic%20Soc%20Ble%E5%8D%8F%E8%AE%AE%E6%A0%88%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Meng">
      <meta itemprop="description" content="冒险，创新，永不放弃">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tech Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/10/IoT/%E8%93%9D%E7%89%99/nordic%20Soc%E5%BC%80%E5%8F%91/nordic%20Soc%20Ble%E5%8D%8F%E8%AE%AE%E6%A0%88%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">nordic Soc Ble协议栈介绍</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-10-10 09:53:57" itemprop="dateCreated datePublished" datetime="2020-10-10T09:53:57+08:00">2020-10-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-12 17:23:04" itemprop="dateModified" datetime="2020-10-12T17:23:04+08:00">2020-10-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/" itemprop="url" rel="index"><span itemprop="name">IoT</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/%E8%93%9D%E7%89%99/" itemprop="url" rel="index"><span itemprop="name">蓝牙</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/%E8%93%9D%E7%89%99/Nordic-Soc%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Nordic Soc开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>nordic 厂家提供的sdk，分为两部分，一部分是蓝牙协议栈以Hex格式提供，可以单独烧录；另一部份是应用程序，应用程序只需要通过SVC宏调用协议栈的接口函数就可以了。蓝牙协议栈可以单独编译，应用层单独编译时候，不在重新编译蓝牙协议栈。本文简单介绍nordic sdk 软件框架。</p>
<h2 id="nordic-Soc-SDK框架"><a href="#nordic-Soc-SDK框架" class="headerlink" title="nordic Soc SDK框架"></a>nordic Soc SDK框架</h2><p>本文是根据S132协议栈来介绍。The S132 SoftDevice is a precompiled and linked binary image implementing a Bluetooth 5.1 Low Energy<br>protocol stack for the nRF52 Series of SoCs。</p>
<p>SDK框架如下</p>
<p><img src="http://jiali.clouddn.com/20201010.png" alt=""></p>
<p>It includes the standard ARM Cortex Microcontroller Software Interface Standard (CMSIS) interface for nRF52 hardware, the MBR, profile and application code, application specific peripheral drivers, and a firmware module identified as a SoftDevice。</p>
<ul>
<li>nRF SoftDevice 提供的API接口用SVCALL声明，API以头文件的形式提供。</li>
<li>nRF SoftDevice以hex文件格式提供给用户</li>
</ul>
<p>A SoftDevice consists of three main components:<br>• SoC Library: implementation and nRF Application Programming Interface (API) for shared hardware<br>resource management (application coexistence)<br>• SoftDevice Manager (SDM): implementation and nRF API for SoftDevice management (enabling/<br>disabling the SoftDevice, etc.)<br>• Bluetooth 5.1 Low Energy protocol stack: implementation of protocol stack and API</p>
<h2 id="应用程序编程接口"><a href="#应用程序编程接口" class="headerlink" title="应用程序编程接口"></a>应用程序编程接口</h2><p>应用层调用协议栈提供的接口，是通过SVC中断实现。通过SVC中断，找到API接口对应的内存位置，然后执行。</p>
<p>应用层调用协议栈函数流程如下图。</p>
<p><img src="http://jiali.clouddn.com/20201010_002.png" alt=""></p>
<p><strong><em>1、协议栈提供两种类型接口：</em></strong></p>
<ul>
<li>操作Soc外设，比如flash</li>
<li>ble低功耗蓝牙</li>
</ul>
<p><strong>2、SVC number的范围</strong></p>
<p><img src="http://jiali.clouddn.com/20201010_003.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Note: The SVC number allocation does not change with the state of the SoftDevice (enabled or</span><br><span class="line">disabled).</span><br></pre></td></tr></table></figure>

<p>协议栈使用0x10<del>0xff，应用层使用0x00</del>0x0f。</p>
<p>协议栈使用SVC number的范围在ble_ranges.h定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">#define BLE_SVC_BASE           0x60       &#x2F;**&lt; Common BLE SVC base. *&#x2F;</span><br><span class="line">#define BLE_SVC_LAST           0x6B       &#x2F;**&lt; Common BLE SVC last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_GAP_SVC_BASE       0x6C       &#x2F;**&lt; GAP BLE SVC base. *&#x2F;</span><br><span class="line">#define BLE_GAP_SVC_LAST       0x9A       &#x2F;**&lt; GAP BLE SVC last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_GATTC_SVC_BASE     0x9B       &#x2F;**&lt; GATTC BLE SVC base. *&#x2F;</span><br><span class="line">#define BLE_GATTC_SVC_LAST     0xA7       &#x2F;**&lt; GATTC BLE SVC last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_GATTS_SVC_BASE     0xA8       &#x2F;**&lt; GATTS BLE SVC base. *&#x2F;</span><br><span class="line">#define BLE_GATTS_SVC_LAST     0xB7       &#x2F;**&lt; GATTS BLE SVC last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_L2CAP_SVC_BASE     0xB8       &#x2F;**&lt; L2CAP BLE SVC base. *&#x2F;</span><br><span class="line">#define BLE_L2CAP_SVC_LAST     0xBF       &#x2F;**&lt; L2CAP BLE SVC last. *&#x2F;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#define BLE_EVT_INVALID        0x00       &#x2F;**&lt; Invalid BLE Event. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_EVT_BASE           0x01       &#x2F;**&lt; Common BLE Event base. *&#x2F;</span><br><span class="line">#define BLE_EVT_LAST           0x0F       &#x2F;**&lt; Common BLE Event last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_GAP_EVT_BASE       0x10       &#x2F;**&lt; GAP BLE Event base. *&#x2F;</span><br><span class="line">#define BLE_GAP_EVT_LAST       0x2F       &#x2F;**&lt; GAP BLE Event last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_GATTC_EVT_BASE     0x30       &#x2F;**&lt; GATTC BLE Event base. *&#x2F;</span><br><span class="line">#define BLE_GATTC_EVT_LAST     0x4F       &#x2F;**&lt; GATTC BLE Event last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_GATTS_EVT_BASE     0x50       &#x2F;**&lt; GATTS BLE Event base. *&#x2F;</span><br><span class="line">#define BLE_GATTS_EVT_LAST     0x6F       &#x2F;**&lt; GATTS BLE Event last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_L2CAP_EVT_BASE     0x70       &#x2F;**&lt; L2CAP BLE Event base. *&#x2F;</span><br><span class="line">#define BLE_L2CAP_EVT_LAST     0x8F       &#x2F;**&lt; L2CAP BLE Event last. *&#x2F;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#define BLE_OPT_INVALID        0x00       &#x2F;**&lt; Invalid BLE Option. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_OPT_BASE           0x01       &#x2F;**&lt; Common BLE Option base. *&#x2F;</span><br><span class="line">#define BLE_OPT_LAST           0x1F       &#x2F;**&lt; Common BLE Option last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_GAP_OPT_BASE       0x20       &#x2F;**&lt; GAP BLE Option base. *&#x2F;</span><br><span class="line">#define BLE_GAP_OPT_LAST       0x3F       &#x2F;**&lt; GAP BLE Option last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_GATT_OPT_BASE      0x40       &#x2F;**&lt; GATT BLE Option base. *&#x2F;</span><br><span class="line">#define BLE_GATT_OPT_LAST      0x5F       &#x2F;**&lt; GATT BLE Option last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_GATTC_OPT_BASE     0x60       &#x2F;**&lt; GATTC BLE Option base. *&#x2F;</span><br><span class="line">#define BLE_GATTC_OPT_LAST     0x7F       &#x2F;**&lt; GATTC BLE Option last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_GATTS_OPT_BASE     0x80       &#x2F;**&lt; GATTS BLE Option base. *&#x2F;</span><br><span class="line">#define BLE_GATTS_OPT_LAST     0x9F       &#x2F;**&lt; GATTS BLE Option last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_L2CAP_OPT_BASE     0xA0       &#x2F;**&lt; L2CAP BLE Option base. *&#x2F;</span><br><span class="line">#define BLE_L2CAP_OPT_LAST     0xBF       &#x2F;**&lt; L2CAP BLE Option last. *&#x2F;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#define BLE_CFG_INVALID        0x00       &#x2F;**&lt; Invalid BLE configuration. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_CFG_BASE           0x01       &#x2F;**&lt; Common BLE configuration base. *&#x2F;</span><br><span class="line">#define BLE_CFG_LAST           0x1F       &#x2F;**&lt; Common BLE configuration last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_CONN_CFG_BASE      0x20       &#x2F;**&lt; BLE connection configuration base. *&#x2F;</span><br><span class="line">#define BLE_CONN_CFG_LAST      0x3F       &#x2F;**&lt; BLE connection configuration last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_GAP_CFG_BASE       0x40       &#x2F;**&lt; GAP BLE configuration base. *&#x2F;</span><br><span class="line">#define BLE_GAP_CFG_LAST       0x5F       &#x2F;**&lt; GAP BLE configuration last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_GATT_CFG_BASE      0x60       &#x2F;**&lt; GATT BLE configuration base. *&#x2F;</span><br><span class="line">#define BLE_GATT_CFG_LAST      0x7F       &#x2F;**&lt; GATT BLE configuration last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_GATTC_CFG_BASE     0x80       &#x2F;**&lt; GATTC BLE configuration base. *&#x2F;</span><br><span class="line">#define BLE_GATTC_CFG_LAST     0x9F       &#x2F;**&lt; GATTC BLE configuration last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_GATTS_CFG_BASE     0xA0       &#x2F;**&lt; GATTS BLE configuration base. *&#x2F;</span><br><span class="line">#define BLE_GATTS_CFG_LAST     0xBF       &#x2F;**&lt; GATTS BLE configuration last. *&#x2F;</span><br><span class="line"></span><br><span class="line">#define BLE_L2CAP_CFG_BASE     0xC0       &#x2F;**&lt; L2CAP BLE configuration base. *&#x2F;</span><br><span class="line">#define BLE_L2CAP_CFG_LAST     0xDF       &#x2F;**&lt; L2CAP BLE configuration last. *&#x2F;</span><br></pre></td></tr></table></figure>

<h2 id="硬件外设资源访问"><a href="#硬件外设资源访问" class="headerlink" title="硬件外设资源访问"></a>硬件外设资源访问</h2><p><strong>1、Soc的外设资源访问</strong></p>
<p>在协议栈开启下，应用程序并不能访问所有的Soc外设资源。下面列出协议栈在开启与不开启的情况下，应用程序能访问的硬件外设资源。</p>
<p><img src="http://jiali.clouddn.com/20201010_008.png" alt=""></p>
<p><img src="http://jiali.clouddn.com/20201010_004.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Note: Some of the peripherals in this table are not present on all devices. For a complete</span><br><span class="line">overview of the peripherals on a device, see the relevant product specification (Table 1: Additional</span><br><span class="line">documentation on page 14).</span><br></pre></td></tr></table></figure>

<p><strong>2、软中断资源访问</strong></p>
<p>Software interrupts are used by the SoftDevice to signal events to the application。</p>
<p>Allocation of software interrupt vectors to SoftDevice signals如下图。</p>
<p><img src="http://jiali.clouddn.com/20201010_007.png" alt=""></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>nordic协议栈不熟悉情况下，出现问题，不知道怎么排查。因为协议栈封装后，根本不知道底层实现细节，而且协议栈也使用了一些硬件外设资源。初级开发者，容易使用协议栈占用的硬件资源，从而导致程序异常。因此，需要阅读《SoftDevice Specification》来了解协议栈</p>
<p>参考：</p>
<p><a href="http://wywiot.com/nordic-ble-soc-sw-primary-sd/" target="_blank" rel="noopener">NORDIC BLE SOC 软件入门-协议栈</a></p>
<p><a href="https://blog.csdn.net/wulazula/article/details/80847262" target="_blank" rel="noopener">Nordic协议栈与应用层API的实现方式</a></p>
<p><a href="https://blog.csdn.net/wulazula/article/details/80280855" target="_blank" rel="noopener">协议栈与app的调用方式</a></p>
<p>《SoftDevice Specification》第七章System on Chip resource requirements、</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="David Meng"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">David Meng</p>
  <div class="site-description" itemprop="description">冒险，创新，永不放弃</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">70</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/jialimeng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jialimeng" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jiali201209@163.com" title="E-Mail → mailto:jiali201209@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://ilinuxkernel.com/" title="http:&#x2F;&#x2F;ilinuxkernel.com" rel="noopener" target="_blank">Linux Kernel Exploration</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.wowotech.net/" title="http:&#x2F;&#x2F;www.wowotech.net" rel="noopener" target="_blank">蜗窝科技</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tinylab.org/" title="http:&#x2F;&#x2F;tinylab.org" rel="noopener" target="_blank">泰晓科技</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Meng</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
